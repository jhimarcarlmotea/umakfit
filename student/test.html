<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Fitness Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@600;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        /* Notification Styles */
        .notification-bell-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
        }

        .notification-bell-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .notification-bell-btn i {
            font-size: 20px;
        }

        .notification-bell-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        .notification-bell-container {
            position: relative;
            display: inline-block;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            width: 24rem;
            max-width: calc(100vw - 2rem);
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 9999;
            max-height: 480px;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }

        .notification-dropdown-header {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0.75rem 0.75rem 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        @media (min-width: 640px) {
            .notification-dropdown-header {
                padding: 1rem 1.25rem;
            }
        }

        .notification-dropdown-body {
            max-height: 360px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f9fafb;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item strong {
            color: #111827;
            font-size: 0.875rem;
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .notification-item p {
            color: #6b7280;
            font-size: 0.8125rem;
            margin-bottom: 0.25rem;
            line-height: 1.5;
        }

        .notification-item small {
            color: #9ca3af;
            font-size: 0.6875rem;
            display: block;
        }

        .notification-dropdown-footer {
            padding: 0.5rem 0.75rem;
            border-top: 2px solid #e5e7eb;
            background-color: #f9fafb;
            border-radius: 0 0 0.75rem 0.75rem;
            position: sticky;
            bottom: 0;
        }

        @media (min-width: 640px) {
            .notification-dropdown-footer {
                padding: 0.75rem 1rem;
            }
        }

        .notification-empty {
            padding: 1.5rem 2rem;
            text-align: center;
            color: #9ca3af;
        }

        .notification-empty i {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .notification-empty p {
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* Category Card Styles */
        .category-card {
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-4px);
        }

        .test-item {
            transition: all 0.2s ease;
        }

        .test-item:hover {
            background: #f8f9fa;
        }

        .category-icon-wrapper {
            transition: transform 0.3s ease;
        }

        .category-card:hover .category-icon-wrapper {
            transform: scale(1.05);
        }

        /* Fitness Category Card Styles */
        .fitness-category-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fitness-category-card:hover {
            transform: translateY(-4px);
        }

        /* Test Workout Card */
        .test-workout-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .test-workout-card:hover {
            transform: translateX(4px);
        }

        /* Workout Start Button */
        .workout-start-btn {
            position: relative;
            overflow: hidden;
        }

        .workout-start-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .workout-start-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Diagonal Pattern Animation */
        @keyframes slidePattern {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 40px 40px;
            }
        }

        .fitness-category-card:hover .absolute.inset-0.opacity-5 > div {
            animation: slidePattern 20s linear infinite;
        }

        /* Collapsible Category Styles */
        .category-collapsed .category-tests {
            max-height: 0 !important;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .category-expanded .category-tests {
            max-height: 600px;
            overflow-y: auto;
            transition: max-height 0.5s ease-in;
        }

        .category-tests {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .category-tests {
            scrollbar-gutter: stable;
        }

        .category-tests::-webkit-scrollbar {
            width: 8px;
        }

        .category-tests::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
            margin: 4px 0;
        }

        .category-tests::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .category-tests::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .category-header {
            cursor: pointer;
            user-select: none;
        }

        .chevron-icon {
            transition: transform 0.3s ease;
        }

        .category-expanded .chevron-icon {
            transform: rotate(180deg);
        }

        .scroll-indicator {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, white, transparent);
            height: 30px;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
        }

        .scroll-indicator i {
            color: #94a3b8;
            font-size: 16px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        /* Overdue Section Styles */
        #overdue-section.expanded #overdueTestsContainer {
            max-height: 600px;
            margin-top: 0;
        }

        #overdue-section.expanded #overdueChevron {
            transform: rotate(180deg);
        }

        .overdue-scroll-container {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 8px;
            scrollbar-gutter: stable;
        }

        .overdue-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .overdue-scroll-container::-webkit-scrollbar-track {
            background: #fee2e2;
            border-radius: 10px;
            margin: 4px 0;
        }

        .overdue-scroll-container::-webkit-scrollbar-thumb {
            background: #ef4444;
            border-radius: 10px;
            border: 2px solid #fee2e2;
        }

        .overdue-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #dc2626;
        }

        .overdue-scroll-indicator {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.95), transparent);
            height: 30px;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 6px;
        }

        .overdue-scroll-indicator i {
            color: #ef4444;
            font-size: 16px;
            animation: bounce 2s infinite;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .overdue-test-card {
            animation: slideInUp 0.3s ease-out forwards;
        }

        .overdue-test-card:nth-child(1) { animation-delay: 0.05s; }
        .overdue-test-card:nth-child(2) { animation-delay: 0.1s; }
        .overdue-test-card:nth-child(3) { animation-delay: 0.15s; }
        .overdue-test-card:nth-child(4) { animation-delay: 0.2s; }
        .overdue-test-card:nth-child(5) { animation-delay: 0.25s; }

        /* Performance Dashboard Mobile Carousel */
        .performance-carousel-wrapper {
            position: relative;
        }

        .performance-carousel {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            gap: 1rem;
            padding: 0.5rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .performance-carousel::-webkit-scrollbar {
            display: none;
        }

        .performance-card {
            flex: 0 0 calc(100% - 3rem);
            min-width: calc(100% - 3rem);
            scroll-snap-align: center;
            scroll-snap-stop: always;
        }

        @media (min-width: 640px) {
            .performance-card {
                flex: 0 0 calc(50% - 1.5rem);
                min-width: calc(50% - 1.5rem);
            }
        }

        @media (min-width: 1024px) {
            .performance-carousel {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                overflow-x: visible;
                scroll-snap-type: none;
                gap: 1.5rem;
            }
            
            .performance-card {
                flex: none;
                min-width: auto;
            }
        }

        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #d1d5db;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .carousel-dot.active {
            background-color: #3b82f6;
            width: 24px;
            border-radius: 4px;
        }

        @media (min-width: 1024px) {
            .carousel-indicators {
                display: none;
            }
        }

        @keyframes swipeHint {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-5px);
            }
        }

        .swipe-hint {
            animation: swipeHint 2s ease-in-out infinite;
        }

        /* Mobile Responsive Optimizations for Categories */
        @media (max-width: 640px) {
            .fitness-category-card .category-header {
                padding: 1rem !important;
            }
            
            .fitness-category-card .category-tests {
                padding: 0.75rem !important;
            }
            
            .fitness-category-card .category-header .w-16,
            .fitness-category-card .category-header .w-20 {
                width: 3rem !important;
                height: 3rem !important;
            }
            
            .fitness-category-card .category-header img {
                width: 2rem !important;
                height: 2rem !important;
            }
            
            .fitness-category-card .category-header h3 {
                font-size: 0.875rem !important;
                line-height: 1.2 !important;
            }
            
            .fitness-category-card .category-header p {
                font-size: 0.7rem !important;
            }
            
            .test-workout-card {
                padding: 0.75rem !important;
            }
            
            .test-workout-card h4 {
                font-size: 0.875rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .test-workout-card .grid {
                gap: 0.5rem !important;
                font-size: 0.7rem !important;
            }
            
            .test-workout-card button,
            .test-workout-card div[class*="px-"] {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
            }
            
            .category-tests > div > .grid {
                gap: 0.5rem !important;
            }
            
            .category-tests.scrollable {
                max-height: 400px !important;
            }
            
            .category-header .chevron-icon {
                font-size: 1.25rem !important;
            }
            
            .notification-dropdown {
                width: calc(100vw - 2rem);
                right: 0;
                left: auto;
            }
        }

        @media (max-width: 480px) {
            .fitness-category-card .category-header {
                padding: 0.75rem !important;
            }
            
            .fitness-category-card .category-tests {
                padding: 0.5rem !important;
            }
            
            .test-workout-card {
                padding: 0.625rem !important;
            }
            
            .test-workout-card h4 {
                font-size: 0.8rem !important;
            }
            
            .category-tests.scrollable {
                max-height: 350px !important;
            }
        }

        /* Hamburger Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            z-index: 60;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Mobile Drawer */
        .mobile-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);
            z-index: 55;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .mobile-drawer.active {
            right: 0;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 1023px) {
            .hamburger {
                display: flex;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/98 flex flex-col items-center justify-center z-50">
        <img src="UMakfit Logo (2).png" alt="UMakFit Logo" class="h-40 sm:h-48 w-auto object-contain mb-4 animate-pulse">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium text-sm md:text-base">Loading Tests...</div>
    </div>

    <div id="mainContent" class="hidden">
        <!-- Navigation -->
        <nav class="shadow-lg" style="background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);">
            <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-5">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
                    <!-- Logo -->
                    <a href="#" class="flex items-center gap-2 sm:gap-3">
                        <img src="UMakfit Logo (2).png" 
                             alt="UMak Logo" class="h-12 sm:h-14 md:h-16 w-auto object-contain">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <a href="./studentDashboard.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-speedometer2"></i> 
                            <span class="hidden xl:inline">Dashboard</span>
                        </a>
                        <a href="#" onclick="checkProfileBeforeTest(event)" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="bi bi-clipboard-check"></i> 
                            <span class="hidden xl:inline">Test</span>
                        </a>
                        <a href="./studentlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-book"></i> 
                            <span class="hidden xl:inline">Lesson</span>
                        </a>
                        <a href="./studentgrades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-award"></i> 
                            <span class="hidden xl:inline">Grades</span>
                        </a>
                        <a href="./progress.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-graph-up"></i> 
                            <span class="hidden xl:inline">Progress</span>
                        </a>
                        <a href="./achievements.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-trophy"></i> 
                            <span class="hidden xl:inline">Achievements</span>
                        </a>
                        
                        <!-- Notification Bell - Desktop -->
                        <div class="relative">
                            <button id="notificationBellBtn" class="notification-bell-btn">
                                <i class="bi bi-bell-fill text-base xl:text-lg"></i>
                                <span id="navNotificationCount" class="notification-bell-badge hidden">0</span>
                            </button>
                            
                            <!-- Notification Dropdown - Desktop -->
                            <div id="notificationDropdown" class="notification-dropdown hidden">
                                <div class="notification-dropdown-header">
                                    <h6 class="font-bold text-gray-900 text-sm sm:text-base flex items-center gap-2">
                                        <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                                    </h6>
                                    <button id="closeNotificationBtn" class="text-gray-400 hover:text-gray-600 p-1 transition-colors">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <div id="notificationDropdownBody" class="notification-dropdown-body">
                                    <div class="notification-empty">
                                        <i class="bi bi-bell-slash"></i>
                                        <p>No notifications yet</p>
                                    </div>
                                </div>
                                <div class="notification-dropdown-footer">
                                    <button onclick="window.location.href='./notifications.html'" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-3 sm:px-4 rounded-lg font-semibold text-xs sm:text-sm hover:from-blue-600 hover:to-blue-700 hover:shadow-lg transition-all">
                                        View All Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout()" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <!-- Mobile Notification Bell -->
                        <div class="relative">
                            <button id="notificationBellBtnMobile" class="notification-bell-btn">
                                <i class="bi bi-bell-fill text-base sm:text-lg"></i>
                                <span id="navNotificationCountMobile" class="notification-bell-badge hidden">0</span>
                            </button>
                            
                            <!-- Mobile Notification Dropdown -->
                            <div id="notificationDropdownMobile" class="notification-dropdown hidden fixed right-2 left-2 top-20 max-h-[calc(100vh-6rem)] overflow-y-auto">
                                <div class="notification-dropdown-header">
                                    <h6 class="font-bold text-gray-900 text-sm sm:text-base flex items-center gap-2">
                                        <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                                    </h6>
                                    <button id="closeNotificationBtnMobile" class="text-gray-400 hover:text-gray-600 p-1 transition-colors">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <div id="notificationDropdownBodyMobile" class="notification-dropdown-body">
                                    <div class="notification-empty">
                                        <i class="bi bi-bell-slash"></i>
                                        <p>No notifications yet</p>
                                    </div>
                                </div>
                                <div class="notification-dropdown-footer">
                                    <button onclick="window.location.href='./notifications.html'" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-3 sm:px-4 rounded-lg font-semibold text-xs sm:text-sm hover:from-blue-600 hover:to-blue-700 hover:shadow-lg transition-all">
                                        View All Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <!-- Mobile Profile Dropdown -->
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout()" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hamburger Menu Button -->
                        <div class="hamburger" id="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Drawer Overlay -->
        <div class="drawer-overlay" id="drawerOverlay"></div>

        <!-- Mobile Drawer -->
        <div class="mobile-drawer" id="mobileDrawer">
            <div class="p-6 pt-8">
                <!-- Drawer Header -->
                <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/20">
                    <img src="https://c.animaapp.com/vkhEa8zW/img/screenshot-2025-09-19-2-53-51-pm-removebg-preview-3@2x.png" 
                         alt="UMak Logo" class="h-12 w-auto object-contain">
                    <span class="text-2xl font-extrabold font-manrope" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        UMakFIT
                    </span>
                </div>

                <!-- Navigation Links -->
                <nav class="space-y-2">
                    <a href="./studentDashboard.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                        <i class="bi bi-speedometer2 mr-3"></i>Dashboard
                    </a>
                    <a href="#" onclick="checkProfileBeforeTest(event)" class="mobile-nav-link block text-white bg-white/10 font-semibold py-3 px-4 rounded-lg transition-all">
                        <i class="bi bi-clipboard-check mr-3"></i>Test
                    </a>
                    <a href="./studentlesson.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                        <i class="bi bi-book mr-3"></i>Lesson
                    </a>
                    <a href="./studentgrades.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                        <i class="bi bi-award mr-3"></i>Grades
                    </a>
                    <a href="./progress.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                        <i class="bi bi-graph-up mr-3"></i>Progress
                    </a>
                    <a href="./achievements.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                        <i class="bi bi-trophy mr-3"></i>Achievements
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 max-w-7xl">
            <!-- Hero Section - Clean Title Only -->
            <div class="relative mb-4 sm:mb-8">
                <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-md flex-shrink-0">
                        <i class="bi bi-clipboard-check text-lg sm:text-xl md:text-2xl text-white"></i>
                    </div>
                    <h1 class="text-lg sm:text-2xl md:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent leading-tight">
                        Fitness Assessment
                    </h1>
                </div>
                <p class="text-xs sm:text-sm md:text-base text-gray-600 max-w-2xl pl-0 sm:pl-14">
                    Track your progress, challenge yourself, and achieve your fitness goals.
                </p>
            </div>

            <!-- Performance Dashboard -->
            <div class="bg-white rounded-2xl p-6 lg:p-8 mb-8 shadow-lg border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <i class="bi bi-bar-chart-fill text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Performance</h2>
                    </div>
                    <!-- Swipe hint - only visible on mobile -->
                    <div class="lg:hidden flex items-center gap-2 text-gray-400 text-xs">
                        <i class="bi bi-arrow-left-right swipe-hint"></i>
                    </div>
                </div>
                
                <!-- Carousel Container -->
                <div class="performance-carousel-wrapper overflow-hidden -mx-2">
                    <div class="performance-carousel" id="performanceCarousel">
                        <!-- Tests Done Card -->
                        <div class="performance-card group relative bg-white rounded-2xl p-6 text-center border-2 border-blue-200 hover:border-blue-400 hover:shadow-xl transition-all duration-300">
                            <div class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="bi bi-check-circle-fill text-white text-2xl"></i>
                            </div>
                            <div id="testsDone" class="text-4xl lg:text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent mb-2">0</div>
                            <div class="text-xs font-bold uppercase tracking-wider text-gray-600">Tests Completed</div>
                        </div>

                        <!-- Average Score Card -->
                        <div class="performance-card group relative bg-white rounded-2xl p-6 text-center border-2 border-purple-200 hover:border-purple-400 hover:shadow-xl transition-all duration-300">
                            <div class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="bi bi-graph-up text-white text-2xl"></i>
                            </div>
                            <div id="avgScore" class="text-4xl lg:text-5xl font-extrabold bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent mb-2">0</div>
                            <div class="text-xs font-bold uppercase tracking-wider text-gray-600">Average Score</div>
                        </div>

                        <!-- Best Score Card -->
                        <div class="performance-card group relative bg-white rounded-2xl p-6 text-center border-2 border-green-200 hover:border-green-400 hover:shadow-xl transition-all duration-300">
                            <div class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="bi bi-trophy-fill text-white text-2xl"></i>
                            </div>
                            <div id="bestScore" class="text-4xl lg:text-5xl font-extrabold bg-gradient-to-r from-green-600 to-green-800 bg-clip-text text-transparent mb-2">0</div>
                            <div class="text-xs font-bold uppercase tracking-wider text-gray-600">Best Score</div>
                        </div>

                        <!-- Day Streak Card -->
                        <div class="performance-card group relative bg-white rounded-2xl p-6 text-center border-2 border-orange-200 hover:border-orange-400 hover:shadow-xl transition-all duration-300">
                            <div class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="bi bi-fire text-white text-2xl"></i>
                            </div>
                            <div id="dayStreak" class="text-4xl lg:text-5xl font-extrabold bg-gradient-to-r from-orange-600 to-orange-800 bg-clip-text text-transparent mb-2">0</div>
                            <div class="text-xs font-bold uppercase tracking-wider text-gray-600">Day Streak</div>
                        </div>
                    </div>
                </div>
                
                <!-- Carousel Indicators (dots) - Only on mobile -->
                <div class="carousel-indicators lg:hidden" id="carouselIndicators">
                    <div class="carousel-dot active" data-index="0"></div>
                    <div class="carousel-dot" data-index="1"></div>
                    <div class="carousel-dot" data-index="2"></div>
                    <div class="carousel-dot" data-index="3"></div>
                </div>
            </div>

            <!-- Category Cards Container -->
            <div id="categoryCardsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8"></div>

            <!-- Overdue Tests Section -->
            <div class="bg-white rounded-2xl p-4 lg:p-6 mb-8 shadow-lg border-2 border-red-200" id="overdue-section">
                <!-- Clickable Header -->
                <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 -m-4 lg:-m-6 p-4 lg:p-6 rounded-t-2xl transition-colors" onclick="toggleOverdueSection()">
                    <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center shadow-md">
                        <i class="bi bi-exclamation-triangle-fill text-white text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-900">Overdue Tests</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="overdueCount" class="hidden bg-red-500 text-white text-sm font-bold px-3 py-1.5 rounded-full">0</span>
                        <i id="overdueChevron" class="bi bi-chevron-down text-2xl text-gray-400 transition-transform duration-300"></i>
                    </div>
                </div>
                
                <!-- Collapsible Container with Scroll -->
                <div id="overdueTestsContainer" class="max-h-0 overflow-hidden transition-all duration-500">
                    <div class="overdue-scroll-container mt-4">
                        <div id="overdueTestsContent">
                            <div class="text-center py-12">
                                <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-2xl flex items-center justify-center">
                                    <i class="bi bi-check-circle-fill text-4xl text-green-600"></i>
                                </div>
                                <p class="text-lg font-bold text-gray-800 mb-2">All Caught Up!</p>
                                <small class="text-sm text-gray-500">No overdue tests</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test History Section -->
            <div class="bg-white rounded-2xl p-6 lg:p-8 shadow-lg border border-gray-100">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                        <i class="bi bi-clock-history text-white text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Recent Test History</h2>
                </div>
                <div id="testHistoryContainer">
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center">
                            <i class="bi bi-clipboard-data text-4xl text-gray-400"></i>
                        </div>
                        <p class="text-lg font-semibold text-gray-600 mb-2">No Test History Yet</p>
                        <small class="text-sm text-gray-400">Your completed tests will appear here</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let studentData = null;
        let availableTests = [];
        let overdueTests = [];
        let allTestHistory = [];
        let showAllHistory = false;
        const VISIBLE_HISTORY_COUNT = 2;

        const testCategories = {
            'Cardiorespiratory Endurance': {
                tests: ['3-Minute Step Test'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-148@2x.png',
                subtitle: 'Heart and lung fitness tests'
            },
            'Muscular Strength and Endurance': {
                tests: ['Curl-Up Test', 'Push-Up Test'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-150@2x.png',
                subtitle: 'Strength and endurance tests'
            },
            'Flexibility': {
                tests: ['Sit-and-Reach'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-48@2x.png',
                subtitle: 'Range of motion tests'
            },
            'Body Composition': {
                tests: ['Skinfold Caliper Measurements'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-151@2x.png',
                subtitle: 'Body fat and mass tests'
            }
        };

        // ========== NOTIFICATION SYSTEM ==========
        
        async function checkUnreadNotifications() {
            try {
                if (!studentData || !studentData.section) return;

                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('section', '==', studentData.section)
                );
                
                const notificationsSnapshot = await getDocs(notificationsQuery);
                
                const readNotifications = JSON.parse(localStorage.getItem(`readNotifications_${studentData.email}`) || '[]');
                
                let unreadCount = 0;
                notificationsSnapshot.forEach(doc => {
                    if (!readNotifications.includes(doc.id)) {
                        unreadCount++;
                    }
                });
                
                const countBadge = document.getElementById('navNotificationCount');
                const countBadgeMobile = document.getElementById('navNotificationCountMobile');
                
                if (unreadCount > 0) {
                    if (countBadge) {
                        countBadge.textContent = unreadCount;
                        countBadge.classList.remove('hidden');
                    }
                    if (countBadgeMobile) {
                        countBadgeMobile.textContent = unreadCount;
                        countBadgeMobile.classList.remove('hidden');
                    }
                } else {
                    if (countBadge) countBadge.classList.add('hidden');
                    if (countBadgeMobile) countBadgeMobile.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking unread notifications:', error);
            }
        }

        async function loadNotificationDropdown(isMobile = false) {
            try {
                const activeBodyId = isMobile ? 'notificationDropdownBodyMobile' : 'notificationDropdownBody';
                const dropdownBody = document.getElementById(activeBodyId);
                
                if (!dropdownBody) return;

                if (!studentData || !studentData.section) {
                    dropdownBody.innerHTML = `
                        <div class="notification-empty">
                            <i class="bi bi-bell-slash"></i>
                            <p>No section assigned</p>
                        </div>
                    `;
                    return;
                }

                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('section', '==', studentData.section)
                );
                
                const notificationsSnapshot = await getDocs(notificationsQuery);
                const readNotifications = JSON.parse(localStorage.getItem(`readNotifications_${studentData.email}`) || '[]');
                
                if (!notificationsSnapshot.empty) {
                    const seenNotifications = new Set();
                    const uniqueNotifications = [];
                    
                    notificationsSnapshot.forEach(doc => {
                        const notification = doc.data();
                        const contentKey = `${notification.title}|${notification.message}|${notification.createdAt?.toDate?.().getTime() || ''}`;
                        
                        if (!seenNotifications.has(contentKey)) {
                            seenNotifications.add(contentKey);
                            uniqueNotifications.push({ id: doc.id, ...notification });
                        }
                    });
                    
                    uniqueNotifications.sort((a, b) => {
                        const dateA = a.createdAt?.toDate?.() || new Date(0);
                        const dateB = b.createdAt?.toDate?.() || new Date(0);
                        return dateB - dateA;
                    });
                    
                    const unreadNotificationIds = [];
                    uniqueNotifications.forEach(notification => {
                        if (!readNotifications.includes(notification.id)) {
                            unreadNotificationIds.push(notification.id);
                        }
                    });
                    
                    let html = '';
                    uniqueNotifications.slice(0, 5).forEach(notification => {
                        const createdDate = notification.createdAt?.toDate?.();
                        const dateStr = createdDate ? createdDate.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Recently';
                        
                        const isRead = readNotifications.includes(notification.id);
                        
                        html += `
                            <div class="notification-item ${isRead ? 'bg-gray-50' : 'bg-white'}" data-notification-id="${notification.id}">
                                <strong>${notification.title || 'Notification'}</strong>
                                <p>${notification.message || ''}</p>
                                <small>${dateStr}</small>
                            </div>
                        `;
                    });
                    
                    dropdownBody.innerHTML = html;
                    
                    if (unreadNotificationIds.length > 0) {
                        markNotificationsAsRead(unreadNotificationIds);
                    }
                    
                } else {
                    dropdownBody.innerHTML = `
                        <div class="notification-empty">
                            <i class="bi bi-bell-slash"></i>
                            <p>No notifications yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function markNotificationsAsRead(notificationIds) {
            if (!studentData || !studentData.email || !notificationIds.length) return;
            
            const readNotifications = JSON.parse(localStorage.getItem(`readNotifications_${studentData.email}`) || '[]');
            const updatedReadNotifications = [...new Set([...readNotifications, ...notificationIds])];
            
            localStorage.setItem(`readNotifications_${studentData.email}`, JSON.stringify(updatedReadNotifications));
            updateNotificationBadgeAfterRead(notificationIds);
        }

        async function updateNotificationBadgeAfterRead(markedAsReadIds) {
            try {
                if (!studentData || !studentData.section) return;
                
                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('section', '==', studentData.section)
                );
                
                const notificationsSnapshot = await getDocs(notificationsQuery);
                const uniqueNotificationIds = new Set();
                
                notificationsSnapshot.forEach(doc => {
                    uniqueNotificationIds.add(doc.id);
                });
                
                const readNotifications = JSON.parse(localStorage.getItem(`readNotifications_${studentData.email}`) || '[]');
                
                let unreadCount = 0;
                uniqueNotificationIds.forEach(notificationId => {
                    if (!readNotifications.includes(notificationId)) {
                        unreadCount++;
                    }
                });
                
                const countBadge = document.getElementById('navNotificationCount');
                const countBadgeMobile = document.getElementById('navNotificationCountMobile');
                
                if (unreadCount > 0) {
                    if (countBadge) {
                        countBadge.textContent = unreadCount;
                        countBadge.classList.remove('hidden');
                    }
                    if (countBadgeMobile) {
                        countBadgeMobile.textContent = unreadCount;
                        countBadgeMobile.classList.remove('hidden');
                    }
                } else {
                    if (countBadge) countBadge.classList.add('hidden');
                    if (countBadgeMobile) countBadgeMobile.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        function toggleNotificationDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 1024;
            const dropdown = isMobile ? 
                document.getElementById('notificationDropdownMobile') : 
                document.getElementById('notificationDropdown');
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                loadNotificationDropdown(isMobile);
                
                const profileDropdown = document.getElementById('profileDropdown');
                const profileDropdownMobile = document.getElementById('profileDropdownMobile');
                if (profileDropdown) profileDropdown.classList.add('hidden');
                if (profileDropdownMobile) profileDropdownMobile.classList.add('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function closeNotificationDropdown() {
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationDropdownMobile = document.getElementById('notificationDropdownMobile');
            if (notificationDropdown) notificationDropdown.classList.add('hidden');
            if (notificationDropdownMobile) notificationDropdownMobile.classList.add('hidden');
        }

        function setupNotificationListener() {
            try {
                if (!studentData || !studentData.section) return;

                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('section', '==', studentData.section)
                );
                
                onSnapshot(notificationsQuery, (snapshot) => {
                    console.log(' Notification update detected!');
                    checkUnreadNotifications();
                }, (error) => {
                    console.error(' Error in notification listener:', error);
                });
                
            } catch (error) {
                console.error('Error setting up notification listener:', error);
            }
        }

        // ========== END NOTIFICATION SYSTEM ==========

        // Profile dropdown functions
        window.toggleProfileDropdown = function() {
            const isMobile = window.innerWidth < 1024;
            const dropdown = document.getElementById(isMobile ? 'profileDropdownMobile' : 'profileDropdown');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationDropdownMobile = document.getElementById('notificationDropdownMobile');
            
            // Close notification dropdowns when opening profile
            if (notificationDropdown) notificationDropdown.classList.add('hidden');
            if (notificationDropdownMobile) notificationDropdownMobile.classList.add('hidden');
            
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeProfileOnClickOutside);
                }, 100);
            } else {
                document.removeEventListener('click', closeProfileOnClickOutside);
            }
        };

        function closeProfileOnClickOutside(event) {
            const isMobile = window.innerWidth < 1024;
            const dropdown = document.getElementById(isMobile ? 'profileDropdownMobile' : 'profileDropdown');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationDropdownMobile = document.getElementById('notificationDropdownMobile');
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const notificationBtn = document.getElementById('notificationBellBtn');
            const notificationBtnMobile = document.getElementById('notificationBellBtnMobile');
            
            // Close profile dropdown if clicked outside
            if (!dropdown.contains(event.target) && !profileBtn?.contains(event.target) && !profileBtnMobile?.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
            
            // Close notification dropdown if clicked outside
            if (notificationDropdown && !notificationDropdown.contains(event.target) && !notificationBtn?.contains(event.target)) {
                notificationDropdown.classList.add('hidden');
            }
            
            // Close mobile notification dropdown if clicked outside
            if (notificationDropdownMobile && !notificationDropdownMobile.contains(event.target) && !notificationBtnMobile?.contains(event.target)) {
                notificationDropdownMobile.classList.add('hidden');
            }
            
            // Remove listener if all are closed
            const allClosed = dropdown.classList.contains('hidden') && 
                             (!notificationDropdown || notificationDropdown.classList.contains('hidden')) &&
                             (!notificationDropdownMobile || notificationDropdownMobile.classList.contains('hidden'));
            
            if (allClosed) {
                document.removeEventListener('click', closeProfileOnClickOutside);
            }
        }

        window.handleLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '../login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        };

        // Setup event listeners
        function setupEventListeners() {
            const notificationBtn = document.getElementById('notificationBellBtn');
            const notificationBtnMobile = document.getElementById('notificationBellBtnMobile');
            
            if (notificationBtn) notificationBtn.addEventListener('click', toggleNotificationDropdown);
            if (notificationBtnMobile) notificationBtnMobile.addEventListener('click', toggleNotificationDropdown);
            
            const closeNotificationBtn = document.getElementById('closeNotificationBtn');
            const closeNotificationBtnMobile = document.getElementById('closeNotificationBtnMobile');
            
            if (closeNotificationBtn) {
                closeNotificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeNotificationDropdown();
                });
            }
            
            if (closeNotificationBtnMobile) {
                closeNotificationBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeNotificationDropdown();
                });
            }
            
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            
            if (profileBtn) profileBtn.addEventListener('click', toggleProfileDropdown);
            if (profileBtnMobile) profileBtnMobile.addEventListener('click', toggleProfileDropdown);
            
            document.addEventListener('click', (event) => {
                if (!event.target.closest('#notificationBellBtn') && 
                    !event.target.closest('#notificationBellBtnMobile') && 
                    !event.target.closest('#notificationDropdown') && 
                    !event.target.closest('#notificationDropdownMobile')) {
                    closeNotificationDropdown();
                }
                
                if (!event.target.closest('#profilePictureBtn') && 
                    !event.target.closest('#profilePictureBtnMobile') && 
                    !event.target.closest('#profileDropdown') && 
                    !event.target.closest('#profileDropdownMobile')) {
                    const profileDropdown = document.getElementById('profileDropdown');
                    const profileDropdownMobile = document.getElementById('profileDropdownMobile');
                    if (profileDropdown) profileDropdown.classList.add('hidden');
                    if (profileDropdownMobile) profileDropdownMobile.classList.add('hidden');
                }
            });
        }

        // Hamburger Menu and Drawer functionality
        const hamburger = document.getElementById('hamburger');
        const mobileDrawer = document.getElementById('mobileDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

        if (hamburger) {
            hamburger.addEventListener('click', (e) => {
                e.stopPropagation();
                hamburger.classList.toggle('active');
                mobileDrawer.classList.toggle('active');
                drawerOverlay.classList.toggle('active');
                document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
            });
        }

        if (drawerOverlay) {
            drawerOverlay.addEventListener('click', () => {
                hamburger.classList.remove('active');
                mobileDrawer.classList.remove('active');
                drawerOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
        }

        mobileNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                hamburger.classList.remove('active');
                mobileDrawer.classList.remove('active');
                drawerOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
        });

        function updateProfileUI() {
            if (!currentUser || !studentData) return;
            
            const photoURL = currentUser?.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(studentData?.displayName || 'User') + '&background=3b82f6&color=fff&size=128';
            
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            if (profileBtn) profileBtn.src = photoURL;
            if (profileBtnMobile) profileBtnMobile.src = photoURL;
            
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            if (dropdownPic) dropdownPic.src = photoURL;
            if (dropdownPicMobile) dropdownPicMobile.src = photoURL;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = studentData?.displayName || 'Student';
            if (dropdownNameMobile) dropdownNameMobile.textContent = studentData?.displayName || 'Student';
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = studentData?.email || currentUser?.email || '';
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = studentData?.email || currentUser?.email || '';
        }

        function getCategoryForTest(testName) {
            for (const [category, data] of Object.entries(testCategories)) {
                if (data.tests.some(t => {
                    const testLower = testName.toLowerCase();
                    const categoryTestLower = t.toLowerCase();
                    return testLower.includes(categoryTestLower) || categoryTestLower.includes(testLower);
                })) {
                    return category;
                }
            }
            return 'Cardiorespiratory Endurance';
        }

        async function loadStudentData(user) {
            try {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('email', '==', user.email)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                studentData = {
                    displayName: user.displayName || user.email.split('@')[0] || 'Student',
                    email: user.email,
                    section: 'Not Assigned',
                    testsDone: 0,
                    overallScore: 0,
                    weekStreak: 0
                };
                
                if (!studentsSnapshot.empty) {
                    studentsSnapshot.forEach((doc) => {
                        const data = doc.data();
                        studentData = { 
                            ...studentData,
                            ...data,
                            testsDone: data.testsDone || 0,
                            overallScore: data.overallScore || 0,
                            weekStreak: data.weekStreak || 0,
                            section: data.section || 'Not Assigned'
                        };
                    });
                }
                
                await calculateAndUpdateStats();
                updateProfileUI();
                return studentData;
            } catch (error) {
                console.error('Error loading student data:', error);
                return null;
            }
        }

        async function calculateAndUpdateStats() {
            try {
                const resultsQuery = query(
                    collection(db, 'testResults'),
                    where('studentEmail', '==', studentData.email),
                    where('status', 'in', ['completed', 'overdue', 'late'])
                );
                
                const resultsSnapshot = await getDocs(resultsQuery);
                
                const testGroups = {};
                let overallBestScore = 0;
                const testDates = [];
                const OVERDUE_PENALTY = 0.10;
                
                resultsSnapshot.forEach((doc) => {
                    const result = doc.data();
                    
                    const isProfessorOverride = result.isProfessorOverride === true;
                    
                    let score = 0;
                    
                    if (isProfessorOverride && typeof result.score === 'number' && !isNaN(result.score)) {
                        score = result.score;
                    } else {
                        score = calculateTestScore(
                            result.testName, 
                            result.result || result.resultData, 
                            result.testTarget
                        );
                        
                        const isOverdue = (result.status === 'overdue' || result.status === 'late');
                        if (isOverdue && !isProfessorOverride) {
                            const penalty = score * OVERDUE_PENALTY;
                            score = Math.max(0, score - penalty);
                        }
                    }
                    
                    score = Math.max(0, Math.min(100, score));
                    
                    const testId = result.testId || doc.id;
                    
                    if (!testGroups[testId] || score > testGroups[testId].score) {
                        testGroups[testId] = {
                            score: score,
                            testName: result.testName
                        };
                    }
                    
                    if (score > overallBestScore) {
                        overallBestScore = score;
                    }
                    
                    const testDate = result.submittedAt?.toDate?.() || new Date(result.submittedAt || result.date);
                    testDates.push(testDate);
                });
                
                let totalScore = 0;
                let testCount = 0;
                
                Object.values(testGroups).forEach(test => {
                    if (typeof test.score === 'number' && !isNaN(test.score) && test.score >= 0) {
                        totalScore += test.score;
                        testCount++;
                    }
                });
                
                const avgScore = testCount > 0 ? (totalScore / testCount).toFixed(1) : '0.0';
                const dayStreak = calculateDayStreak(testDates);
                
                document.getElementById('testsDone').textContent = testCount;
                document.getElementById('avgScore').textContent = avgScore;
                document.getElementById('bestScore').textContent = Math.round(overallBestScore);
                document.getElementById('dayStreak').textContent = dayStreak;
                
            } catch (error) {
                console.error('Error calculating stats:', error);
                document.getElementById('testsDone').textContent = '0';
                document.getElementById('avgScore').textContent = '0.0';
                document.getElementById('bestScore').textContent = '0';
                document.getElementById('dayStreak').textContent = '0';
            }
        }

        function calculateDayStreak(testDates) {
            if (testDates.length === 0) return 0;
            
            testDates.sort((a, b) => b - a);
            
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            for (const testDate of testDates) {
                const date = new Date(testDate);
                date.setHours(0, 0, 0, 0);
                
                const diffTime = currentDate - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === streak) {
                    streak++;
                    currentDate = date;
                } else if (diffDays > streak) {
                    break;
                }
            }
            
            return streak;
        }

        async function loadAvailableTests() {
            try {
                if (!studentData || !studentData.section || studentData.section === 'Not Assigned') {
                    renderEmptyState();
                    return;
                }

                console.log(' Loading tests for section:', studentData.section);
                console.log(' Student email:', studentData.email);
                
                const testsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('section', '==', studentData.section)
                );
                
                const testsSnapshot = await getDocs(testsQuery);
                availableTests = [];
                overdueTests = [];
                const now = new Date();
                const seenTestIds = new Set();
                
                console.log(` Found ${testsSnapshot.size} total tests for section ${studentData.section}`);
                
                const completedTestsQuery = query(
                    collection(db, 'testResults'),
                    where('studentEmail', '==', studentData.email)
                );
                const completedTestsSnapshot = await getDocs(completedTestsQuery);
                
                const testStatus = new Map();
                
                completedTestsSnapshot.forEach(doc => {
                    const result = doc.data();
                    const testId = result.testId;
                    const score = calculateTestScore(result.testName, result.resultData || result.result, result.testTarget);
                    
                    if (!testStatus.has(testId)) {
                        testStatus.set(testId, {
                            attempts: 0,
                            bestScore: 0,
                            scores: []
                        });
                    }
                    
                    const status = testStatus.get(testId);
                    status.attempts++;
                    status.scores.push(score);
                    if (score > status.bestScore) {
                        status.bestScore = score;
                    }
                });
                
                const permissionsQuery = query(
                    collection(db, 'testPermissions'),
                    where('studentEmail', '==', studentData.email)
                );
                const permissionsSnapshot = await getDocs(permissionsQuery);
                const enabledTests = new Set();
                
                permissionsSnapshot.forEach(doc => {
                    const permission = doc.data();
                    enabledTests.add(permission.testId);
                    console.log(` Professor enabled test: ${permission.testName} for ${studentData.email}`);
                });
                
                if (!testsSnapshot.empty) {
                    for (const doc of testsSnapshot.docs) {
                        const test = { id: doc.id, ...doc.data() };
                        
                        if (seenTestIds.has(test.id)) {
                            console.log(` Skipping duplicate test: ${test.testName} (ID: ${test.id})`);
                            continue;
                        }
                        seenTestIds.add(test.id);
                        
                        let isStudentSelected = false;
                        
                        if (test.selectedStudents && Array.isArray(test.selectedStudents)) {
                            isStudentSelected = test.selectedStudents.includes(studentData.email);
                            console.log(` Test: ${test.testName} - Student ${isStudentSelected ? 'IS' : 'NOT'} selected`);
                        } else {
                            isStudentSelected = true;
                            console.log(` Test: ${test.testName} - No student filter (visible to all)`);
                        }
                        
                        if (test.isVisible !== true || test.isActive !== true) {
                            console.log(` Skipping test ${test.testName}: Not visible or not active`);
                            continue;
                        }
                        
                        console.log(` Processing test: ${test.testName}`, {
                            isVisible: test.isVisible,
                            isActive: test.isActive,
                            section: test.section,
                            isStudentSelected: isStudentSelected
                        });
                        
                        let deadlineDateTime;
                        if (test.deadlineDateTime) {
                            deadlineDateTime = new Date(test.deadlineDateTime);
                        } else {
                            deadlineDateTime = new Date(test.deadline);
                            if (test.deadlineTime) {
                                const [hours, minutes] = test.deadlineTime.split(':').map(Number);
                                deadlineDateTime.setHours(hours, minutes, 0, 0);
                            } else {
                                deadlineDateTime.setHours(23, 59, 59, 999);
                            }
                        }
                        
                        console.log(` Test deadline: ${deadlineDateTime}, Now: ${now}`);
                        
                        const status = testStatus.get(test.id);
                        const isUnlimited = test.attemptsAllowed === 0;
                        const isPerfect = status ? status.bestScore === 100 : false;
                        const hasAttemptsLeft = status ? status.attempts < test.attemptsAllowed : true;
                        
                        test.isViewOnly = !isStudentSelected;
                        
                        if (deadlineDateTime < now) {
                            if (enabledTests.has(test.id) && isStudentSelected) {
                                console.log(` Test ${test.testName}: Overdue but ENABLED by professor`);
                                test.professorEnabled = true;
                                overdueTests.push(test);
                            } else if (!status || status.attempts === 0) {
                                console.log(` Test ${test.testName}: Overdue${!isStudentSelected ? ' (VIEW ONLY - Not Selected)' : ''}`);
                                overdueTests.push(test);
                            } else {
                                console.log(` Test ${test.testName}: Overdue but already completed`);
                            }
                            
                        } else {
                            if (!status) {
                                console.log(` Adding test ${test.testName}: Never attempted${!isStudentSelected ? ' (VIEW ONLY)' : ''}`);
                                availableTests.push(test);
                            } else {
                                if (!isPerfect && (isUnlimited || hasAttemptsLeft)) {
                                    console.log(` Adding test ${test.testName}: Can retry${!isStudentSelected ? ' (VIEW ONLY)' : ''}`);
                                    availableTests.push(test);
                                } else {
                                    console.log(` Skipping test ${test.testName}: ${isPerfect ? 'Perfect score achieved' : 'No attempts left'}`);
                                }
                            }
                        }
                    }
                } else {
                    console.log(' No tests found for section:', studentData.section);
                }
                
                console.log(` Total available tests: ${availableTests.length}, Overdue: ${overdueTests.length}`);
                await renderCategoryCards();
                renderOverdueTests(overdueTests);
                
            } catch (error) {
                console.error(' Error loading tests:', error);
                console.error('Error details:', error.message);
                renderEmptyState();
            }
        }

        function setupTestUpdatesForStudent() {
            try {
                if (!studentData || !studentData.section) return;
                
                console.log(' Setting up real-time test updates for student section:', studentData.section);
                
                const testsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('section', '==', studentData.section)
                );
                
                onSnapshot(testsQuery, (snapshot) => {
                    console.log(' Real-time test update detected!');
                    console.log('Total tests in snapshot:', snapshot.size);
                    
                    snapshot.docChanges().forEach((change) => {
                        const testData = change.doc.data();
                        
                        if (testData.isVisible === true && testData.isActive === true) {
                            if (change.type === 'added') {
                                console.log(' NEW VISIBLE TEST ADDED:', testData.testName);
                                console.log(' Test details:', {
                                    id: change.doc.id,
                                    testName: testData.testName,
                                    section: testData.section,
                                    deadline: testData.deadline,
                                    isVisible: testData.isVisible,
                                    isActive: testData.isActive
                                });
                            }
                            if (change.type === 'modified') {
                                console.log(' TEST MODIFIED:', testData.testName);
                            }
                        }
                        
                        if (change.type === 'removed') {
                            console.log(' TEST REMOVED:', testData.testName);
                        }
                    });
                    
                    loadAvailableTests();
                }, (error) => {
                    console.error(' Error in real-time listener:', error);
                });
                
            } catch (error) {
                console.error('Error setting up test updates for student:', error);
            }
        }

        function formatDeadline(deadline, deadlineTime) {
            if (!deadline) return 'No deadline';
            
            const date = new Date(deadline);
            
            const dateText = date.toLocaleDateString('en-US', { 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            let timeText = '';
            if (deadlineTime) {
                const [hours, minutes] = deadlineTime.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const hour12 = hours % 12 || 12;
                timeText = ` at ${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
            }
            
            return dateText + timeText;
        }

        async function renderCategoryCards() {
            const container = document.getElementById('categoryCardsContainer');
            
            if (availableTests.length === 0) {
                renderEmptyState();
                return;
            }
            
            const uniqueTests = [];
            const seenIds = new Set();
            
            availableTests.forEach(test => {
                if (!seenIds.has(test.id)) {
                    seenIds.add(test.id);
                    uniqueTests.push(test);
                }
            });
            
            console.log(` After deduplication: ${uniqueTests.length} unique tests`);
            
            const categorizedTests = {
                'Cardiorespiratory Endurance': [],
                'Muscular Strength and Endurance': [],
                'Flexibility': [],
                'Body Composition': []
            };
            
            uniqueTests.forEach(test => {
                const category = getCategoryForTest(test.testName);
                if (categorizedTests[category]) {
                    categorizedTests[category].push(test);
                } else {
                    categorizedTests['Cardiorespiratory Endurance'].push(test);
                }
            });
            
            let html = '';
            
            const attemptPromises = uniqueTests.map(async (test) => {
                try {
                    const attemptQuery = query(
                        collection(db, 'testResults'),
                        where('testId', '==', test.id),
                        where('studentEmail', '==', studentData.email)
                    );
                    const attemptSnapshot = await getDocs(attemptQuery);
                    const currentAttempts = attemptSnapshot.size;
                    
                    let bestScore = 0;
                    attemptSnapshot.forEach(doc => {
                        const result = doc.data();
                        const score = calculateTestScore(result.testName, result.result, result.testTarget);
                        if (score > bestScore) bestScore = score;
                    });
                    
                    return {
                        testId: test.id,
                        attempts: currentAttempts,
                        bestScore: bestScore,
                        testData: test
                    };
                } catch (error) {
                    console.error(`Error fetching attempts for test ${test.id}:`, error);
                    return {
                        testId: test.id,
                        attempts: 0,
                        bestScore: 0,
                        testData: test
                    };
                }
            });
            
            const attemptsData = await Promise.all(attemptPromises);
            const attemptsMap = new Map();
            attemptsData.forEach(data => {
                attemptsMap.set(data.testId, data);
            });
            
            for (const [category, tests] of Object.entries(categorizedTests)) {
                const categoryData = testCategories[category];
                
                if (!categoryData) continue;
                
                const categoryId = category.replace(/\s+/g, '-').toLowerCase();
                
                html += `
                    <div class="fitness-category-card group category-collapsed" id="category-${categoryId}">
                        <!-- Category Header - CLICKABLE -->
                        <div class="category-header relative overflow-hidden bg-white rounded-t-2xl p-5 sm:p-6 border-2 border-gray-200 hover:bg-gray-50 transition-colors cursor-pointer z-10" onclick="toggleCategory('${categoryId}')">
                            <!-- Diagonal stripe pattern -->
                            <div class="absolute inset-0 opacity-5 pointer-events-none">
                                <div class="absolute inset-0" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);"></div>
                            </div>
                            
                            <div class="relative flex items-center gap-4">
                                <!-- Icon -->
                                <div class="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-2xl flex items-center justify-center shadow-md transform group-hover:scale-105 transition-transform duration-300 border-2 border-gray-200">
                                    <img class="w-10 h-10 sm:w-12 sm:h-12 object-contain" src="${categoryData.icon}" alt="${category}" />
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg sm:text-xl font-black text-gray-900 mb-1 uppercase tracking-tight leading-tight">${category}</h3>
                                    <p class="text-xs sm:text-sm text-gray-600 font-medium">${categoryData.subtitle}</p>
                                    <div class="mt-2 flex items-center gap-2 text-xs text-gray-500">
                                        <i class="bi bi-lightning-charge-fill"></i>
                                        <span>${tests.length} Test${tests.length !== 1 ? 's' : ''} Available</span>
                                    </div>
                                </div>
                                
                                <!-- Chevron Icon -->
                                <div class="flex-shrink-0">
                                    <i class="bi bi-chevron-down text-2xl text-gray-400 chevron-icon"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tests Grid - COLLAPSIBLE -->
                        <div class="category-tests ${tests.length > 2 ? 'scrollable' : ''} bg-white rounded-b-2xl border-x-2 border-b-2 border-gray-200">
                            <div class="p-4 sm:p-5">
                `;
                
                if (tests.length === 0) {
                    html += `
                        <div class="text-center py-12">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 flex items-center justify-center">
                                <i class="bi bi-inbox text-3xl text-gray-300"></i>
                            </div>
                            <p class="text-sm font-semibold text-gray-400">No tests in this category</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="relative">
                            <div class="grid grid-cols-1 gap-3 sm:gap-4">
                    `;
                    
                    tests.forEach(test => {
                        const attemptData = attemptsMap.get(test.id) || { attempts: 0, bestScore: 0 };
                        const currentAttempts = attemptData.attempts;
                        const bestScore = attemptData.bestScore;
                        const isUnlimited = test.attemptsAllowed === 0;
                        const hasAttempts = currentAttempts > 0;
                        const isPerfect = bestScore === 100;
                        const canRetry = isUnlimited ? (bestScore < 100) : (currentAttempts < test.attemptsAllowed && bestScore < 100);
                        const attemptsLeft = test.attemptsAllowed - currentAttempts;

                        const isViewOnly = test.isViewOnly === true;

                        let statusIcon = 'circle';
                        let statusText = 'Not Started';
                        const testDateTime = new Date(`${test.date}T${test.time || '00:00'}`);
                        const now = new Date();
                        const isFutureTest = testDateTime > now;

                        if (isFutureTest) {
                            statusIcon = 'calendar-event';
                            const dateStr = testDateTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            const timeStr = testDateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                            statusText = `Available on ${dateStr} at ${timeStr}`;

                        } else if (isViewOnly) {
                            statusIcon = 'eye';
                            statusText = 'View Only';
                        } else if (isPerfect) {
                            statusIcon = 'check-circle-fill';
                            statusText = 'Perfect Score';
                        } else if (hasAttempts) {
                            statusIcon = 'arrow-clockwise';
                            statusText = `Best: ${bestScore}/100`;
                        } else {
                            statusIcon = 'play-circle';
                            statusText = 'Ready to Start';
                        }
                        
                        html += `
                            <div class="test-workout-card group/test relative bg-gray-50 rounded-xl border-2 border-gray-200 overflow-hidden hover:border-gray-400 hover:shadow-md transition-all duration-300">
                                <!-- Status indicator strip -->
                                <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gray-900"></div>
                                
                                <div class="pl-4 pr-3 sm:pr-4 py-4">
                                    <div class="flex flex-col sm:flex-row gap-4">
                                        <!-- Test Info Section -->
                                        <div class="flex-1 min-w-0">
                                            <!-- Test Name & Status Badge -->
                                            <div class="flex items-start gap-2 mb-3">
                                                <div class="flex-1 min-w-0">
                                                    <h4 class="text-base sm:text-lg font-bold text-gray-900 leading-tight mb-1">${test.testName}</h4>
                                                    <div class="flex items-center gap-2">
                                                        <i class="bi bi-${statusIcon} text-gray-700 text-sm"></i>
                                                        <span class="text-xs sm:text-sm font-semibold text-gray-700">${statusText}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Test Details Grid -->
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs sm:text-sm">
                                                <div class="flex items-center gap-2 text-gray-600">
                                                    <i class="bi bi-calendar-check text-gray-400"></i>
                                                    <span class="font-medium">${test.date || 'No date set'}</span>
                                                </div>
                                                
                                                <div class="flex items-center gap-2 text-gray-600">
                                                    <i class="bi bi-alarm text-gray-400"></i>
                                                    <span class="font-medium">${formatDeadline(test.deadline, test.deadlineTime)}</span>
                                                </div>
                                                
                                                ${hasAttempts ? `
                                                    <div class="flex items-center gap-2 text-gray-700">
                                                        <i class="bi bi-trophy-fill text-gray-400"></i>
                                                        <span class="font-bold">${isPerfect ? '100/100' : `${bestScore}/100`}</span>
                                                    </div>
                                                    
                                                    <div class="flex items-center gap-2 text-gray-600">
                                                        <i class="bi bi-repeat text-gray-400"></i>
                                                        <span class="font-medium">
                                                            ${isUnlimited ? `${currentAttempts} attempt${currentAttempts !== 1 ? 's' : ''}` : `${currentAttempts}/${test.attemptsAllowed} attempts`}
                                                        </span>
                                                    </div>
                                                ` : `
                                                    <div class="flex items-center gap-2 text-gray-700">
                                                        <i class="bi bi-infinity text-gray-400"></i>
                                                        <span class="font-bold">${isUnlimited ? 'Unlimited tries' : `${test.attemptsAllowed} attempt${test.attemptsAllowed !== 1 ? 's' : ''}`}</span>
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                        
                                        <!-- Action Button Section -->
                                        <div class="flex sm:flex-col justify-end items-end sm:items-stretch gap-2 sm:min-w-[140px]">
                                            ${isFutureTest ? `
                                                <div class="flex-1 sm:flex-initial px-5 py-3 bg-blue-100 text-blue-700 rounded-xl font-bold text-sm uppercase tracking-wide flex items-center justify-center gap-2 border-2 border-blue-300 cursor-not-allowed" title="Test will be available on ${testDateTime.toLocaleDateString()} at ${testDateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}">
                                                    <i class="bi bi-calendar-check"></i>
                                                    <span>Available Soon</span>
                                                </div>
                                            ` : isViewOnly ? `
                                                <div class="flex-1 sm:flex-initial px-5 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm uppercase tracking-wide flex items-center justify-center gap-2 border-2 border-gray-300 cursor-not-allowed" title="You have not been selected for this test">
                                                    <i class="bi bi-eye"></i>
                                                    <span>View Only</span>
                                                </div>
                                            ` : canRetry ? `
                                                <button onclick="startTest('${test.id}')" class="workout-start-btn flex-1 sm:flex-initial px-5 py-3 bg-gray-900 text-white rounded-xl font-bold text-sm uppercase tracking-wide hover:bg-black hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
                                                    <i class="bi bi-${hasAttempts ? 'arrow-clockwise' : 'play-fill'}"></i>
                                                    <span>${hasAttempts ? 'Retry' : 'Start'}</span>
                                                </button>
                                            ` : isPerfect ? `
                                                <div class="flex-1 sm:flex-initial px-5 py-3 bg-gray-200 text-gray-800 rounded-xl font-bold text-sm uppercase tracking-wide flex items-center justify-center gap-2 border-2 border-gray-300">
                                                    <i class="bi bi-trophy-fill"></i>
                                                    <span>Complete</span>
                                                </div>
                                            ` : !hasAttempts ? `
                                                <button onclick="startTest('${test.id}')" class="workout-start-btn flex-1 sm:flex-initial px-5 py-3 bg-gray-900 text-white rounded-xl font-bold text-sm uppercase tracking-wide hover:bg-black hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
                                                    <i class="bi bi-play-fill"></i>
                                                    <span>Start</span>
                                                </button>
                                            ` : `
                                                <div class="flex-1 sm:flex-initial px-5 py-3 bg-gray-200 text-gray-500 rounded-xl font-bold text-sm uppercase tracking-wide flex items-center justify-center gap-2 border-2 border-gray-300">
                                                    <i class="bi bi-x-circle"></i>
                                                    <span>Locked</span>
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    if (tests.length > 2) {
                        html += `
                            <div class="scroll-indicator">
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        `;
                    }
                    html += `</div>`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        window.toggleCategory = function(categoryId) {
            const categoryElement = document.getElementById(`category-${categoryId}`);
            
            if (categoryElement.classList.contains('category-expanded')) {
                categoryElement.classList.remove('category-expanded');
                categoryElement.classList.add('category-collapsed');
            } else {
                categoryElement.classList.remove('category-collapsed');
                categoryElement.classList.add('category-expanded');
            }
        };

        async function renderOverdueTests(overdueTestsArray) {
            const container = document.getElementById('overdueTestsContent');
            const countBadge = document.getElementById('overdueCount');
            
            const uniqueOverdueTests = [];
            const seenIds = new Set();
            
            overdueTestsArray.forEach(test => {
                if (!seenIds.has(test.id)) {
                    seenIds.add(test.id);
                    uniqueOverdueTests.push(test);
                }
            });
            
            countBadge.textContent = uniqueOverdueTests.length;
            
            if (uniqueOverdueTests.length === 0) {
                countBadge.classList.add('hidden');
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-2xl flex items-center justify-center">
                            <i class="bi bi-check-circle-fill text-4xl text-green-600"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-800 mb-2">All Caught Up!</p>
                        <small class="text-sm text-gray-500">No overdue tests</small>
                    </div>
                `;
                return;
            }
            
            countBadge.classList.remove('hidden');
            
            const completionPromises = uniqueOverdueTests.map(async (test) => {
                try {
                    const resultsQuery = query(
                        collection(db, 'testResults'),
                        where('testId', '==', test.id),
                        where('studentEmail', '==', studentData.email)
                    );
                    const resultsSnapshot = await getDocs(resultsQuery);
                    
                    let bestScore = 0;
                    let attempts = 0;
                    
                    resultsSnapshot.forEach(doc => {
                        const result = doc.data();
                        const score = calculateTestScore(result.testName, result.result, result.testTarget);
                        attempts++;
                        if (score > bestScore) bestScore = score;
                    });
                    
                    return {
                        testId: test.id,
                        completed: attempts > 0,
                        bestScore: bestScore,
                        attempts: attempts
                    };
                } catch (error) {
                    return {
                        testId: test.id,
                        completed: false,
                        bestScore: 0,
                        attempts: 0
                    };
                }
            });
            
            const completionData = await Promise.all(completionPromises);
            const completionMap = new Map();
            completionData.forEach(data => {
                completionMap.set(data.testId, data);
            });
            
            let html = '<div class="space-y-3">';
            
            uniqueOverdueTests.forEach((test) => {
                const isProfessorEnabled = test.professorEnabled === true;
                const completion = completionMap.get(test.id) || { completed: false, bestScore: 0, attempts: 0 };
                const isCompleted = completion.completed;
                const isViewOnly = test.isViewOnly === true;
                
                html += `
                    <div class="bg-white border-2 ${isCompleted ? 'border-red-200' : 'border-red-300'} rounded-xl p-4 hover:shadow-md transition-all">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-3">
                            <!-- Test Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start gap-3 mb-2">
                                    <div class="flex-shrink-0 w-10 h-10 ${isCompleted ? 'bg-red-500' : 'bg-red-500'} rounded-lg flex items-center justify-center">
                                        <i class="bi bi-${isCompleted ? 'check-circle-fill' : isProfessorEnabled ? 'unlock-fill' : isViewOnly ? 'eye-fill' : 'exclamation-triangle-fill'} text-white"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-900 text-base mb-1">${test.testName}</h4>
                                        <div class="flex flex-wrap items-center gap-2 text-sm">
                                            ${isViewOnly ? `
                                                <span class="bg-gray-500 text-white text-xs font-semibold px-2 py-1 rounded-full">
                                                    <i class="bi bi-eye"></i> View Only
                                                </span>
                                            ` : ''}
                                            ${isProfessorEnabled && !isCompleted && !isViewOnly ? `
                                                <span class="bg-blue-500 text-white text-xs font-semibold px-2 py-1 rounded-full">
                                                    <i class="bi bi-unlock"></i> Enabled
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ml-13 text-sm">
                                    ${isCompleted ? `
                                        <p class="text-red-600 font-semibold">
                                            Score: ${completion.bestScore}/100  ${completion.attempts} Attempt${completion.attempts > 1 ? 's' : ''}
                                        </p>
                                    ` : `
                                        <p class="text-red-600 font-semibold">
                                            ${isViewOnly ? 'Not selected for this test' : `Overdue: ${formatDeadline(test.deadline, test.deadlineTime)}`}
                                        </p>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <div class="w-full lg:w-auto lg:min-w-[140px]">
                                ${isCompleted ? `
                                    <div class="w-full px-4 py-2.5 bg-red-500 text-white rounded-lg font-bold text-sm text-center">
                                        <i class="bi bi-check-circle-fill mr-1"></i>
                                        Done
                                    </div>
                                ` : isViewOnly ? `
                                    <div class="w-full px-4 py-2.5 bg-gray-300 text-gray-600 rounded-lg font-semibold text-sm text-center cursor-not-allowed">
                                        <i class="bi bi-eye-slash"></i> View Only
                                    </div>
                                ` : isProfessorEnabled ? `
                                    <button onclick="startOverdueTest('${test.id}', '${encodeURIComponent(test.testName)}')" 
                                        class="w-full px-4 py-2.5 bg-blue-500 text-white rounded-lg font-bold text-sm hover:bg-blue-600 transition-all">
                                        <i class="bi bi-play-fill mr-1"></i>
                                        Take Test
                                    </button>
                                ` : `
                                    <div class="w-full px-4 py-2.5 bg-gray-300 text-gray-700 rounded-lg font-semibold text-sm text-center">
                                        <i class="bi bi-lock-fill mr-1"></i>
                                        Locked
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (uniqueOverdueTests.length > 3) {
                html += `
                    <div class="overdue-scroll-indicator">
                        <i class="bi bi-chevron-down"></i>
                    </div>
                `;
            }
            
            html += `
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="bi bi-info-circle text-blue-600 text-xl flex-shrink-0"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-semibold mb-1">Need Help?</p>
                            <p>Contact your professor to request access to overdue tests.</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        window.toggleOverdueSection = function() {
            const section = document.getElementById('overdue-section');
            const container = document.getElementById('overdueTestsContainer');
            
            if (section.classList.contains('expanded')) {
                section.classList.remove('expanded');
                container.style.maxHeight = '0';
            } else {
                section.classList.add('expanded');
                const scrollContainer = container.querySelector('.overdue-scroll-container');
                const contentHeight = scrollContainer ? scrollContainer.scrollHeight : 500;
                container.style.maxHeight = Math.min(contentHeight + 24, 600) + 'px';
            }
        };

        function renderEmptyState() {
            const container = document.getElementById('categoryCardsContainer');
            
            let html = '';
            for (const [category, categoryData] of Object.entries(testCategories)) {
                html += `
                    <div class="fitness-category-card group">
                        <div class="relative overflow-hidden bg-white rounded-t-2xl p-5 sm:p-6 border-2 border-gray-200">
                            <div class="absolute inset-0 opacity-5">
                                <div class="absolute inset-0" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);"></div>
                            </div>
                            
                            <div class="relative flex items-center gap-4">
                                <div class="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-2xl flex items-center justify-center shadow-md border-2 border-gray-200">
                                    <img class="w-10 h-10 sm:w-12 sm:h-12 object-contain" src="${categoryData.icon}" alt="${category}" />
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg sm:text-xl font-black text-gray-900 mb-1 uppercase tracking-tight leading-tight">${category}</h3>
                                    <p class="text-xs sm:text-sm text-gray-600 font-medium">${categoryData.subtitle}</p>
                                    <div class="mt-2 flex items-center gap-2 text-xs text-gray-500">
                                        <i class="bi bi-lightning-charge-fill"></i>
                                        <span>0 Tests Available</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-b-2xl p-8 border-x-2 border-b-2 border-gray-200 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 flex items-center justify-center">
                                <i class="bi bi-inbox text-3xl text-gray-300"></i>
                            </div>
                            <p class="text-sm font-semibold text-gray-400">No tests available in this category</p>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function loadRecentTestHistory() {
            try {
                if (!studentData) return;

                const historyQuery = query(
                    collection(db, 'testResults'),
                    where('studentEmail', '==', studentData.email)
                );
                
                onSnapshot(historyQuery, (snapshot) => {
                    console.log(' Real-time test results update detected!');
                    
                    const testGroups = {};
                    
                    snapshot.forEach((doc) => {
                        const result = { id: doc.id, ...doc.data() };
                        const score = calculateTestScore(result.testName, result.result, result.testTarget);
                        const testId = result.testId || doc.id;
                        
                        if (!testGroups[testId] || score > testGroups[testId].score) {
                            testGroups[testId] = {
                                ...result,
                                score: score
                            };
                        }
                    });
                    
                    allTestHistory = Object.values(testGroups);
                    
                    allTestHistory.sort((a, b) => {
                        const dateA = a.submittedAt?.toDate ? a.submittedAt.toDate() : (a.submittedAt ? new Date(a.submittedAt) : new Date(0));
                        const dateB = b.submittedAt?.toDate ? b.submittedAt.toDate() : (b.submittedAt ? new Date(b.submittedAt) : new Date(0));
                        return dateB - dateA;
                    });
                    
                    renderTestHistory();
                    calculateAndUpdateStats();
                    
                    loadAvailableTests();
                    
                }, (error) => {
                    console.error(' Error in test results listener:', error);
                    const container = document.getElementById('testHistoryContainer');
                    container.innerHTML = `
                        <div class="text-center py-8 sm:py-12">
                            <div class="text-5xl sm:text-6xl mb-3 sm:mb-4"></div>
                            <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">Error Loading History</p>
                            <small class="text-sm text-gray-400">Please refresh the page to try again</small>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Error setting up test history listener:', error);
                const container = document.getElementById('testHistoryContainer');
                container.innerHTML = `
                    <div class="text-center py-8 sm:py-12">
                        <div class="text-5xl sm:text-6xl mb-3 sm:mb-4"></div>
                        <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">Error Loading History</p>
                        <small class="text-sm text-gray-400">Please refresh the page to try again</small>
                    </div>
                `;
            }
        }

        function renderTestHistory() {
            const container = document.getElementById('testHistoryContainer');
            
            if (allTestHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 sm:py-12">
                        <div class="text-5xl sm:text-6xl mb-3 sm:mb-4"></div>
                        <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">No Test History Yet</p>
                        <small class="text-sm text-gray-400">Your completed tests will appear here</small>
                    </div>
                `;
                return;
            }

            const visibleHistory = showAllHistory ? allTestHistory : allTestHistory.slice(0, VISIBLE_HISTORY_COUNT);
            const hiddenCount = allTestHistory.length - visibleHistory.length;

            let html = `
                <div class="mb-3 sm:mb-4">
                    <small class="text-xs sm:text-sm text-gray-500">
                        Showing ${visibleHistory.length} of ${allTestHistory.length} test results
                    </small>
                </div>
                <div class="space-y-2 sm:space-y-3">
            `;

            visibleHistory.forEach((result) => {
                const score = result.score || calculateTestScore(result.testName, result.result, result.testTarget);
                const rating = getRating(score);
                const date = result.submittedAt?.toDate 
                    ? result.submittedAt.toDate().toLocaleDateString() 
                    : new Date().toLocaleDateString();
                
                html += `
                    <div class="bg-gray-50 rounded-lg sm:rounded-xl p-3 sm:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 hover:bg-gray-100 transition-colors">
                        <div class="flex-1 min-w-0 w-full sm:w-auto">
                            <h4 class="font-semibold text-gray-900 text-sm sm:text-base mb-1">${result.testName}</h4>
                            <p class="${rating.class} text-xs sm:text-sm font-medium mb-1">Score: ${score}/100  ${rating.text}</p>
                            <small class="text-gray-500 text-xs">Completed: ${date}</small>
                        </div>
                        <button onclick="viewResult('${result.id}')" class="w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-sm hover:from-blue-600 hover:to-blue-700 hover:-translate-y-0.5 hover:shadow-lg transition-all whitespace-nowrap">
                            View Result
                        </button>
                    </div>
                `;
            });

            html += `</div>`;

            if (allTestHistory.length > VISIBLE_HISTORY_COUNT) {
                html += `
                    <div class="text-center mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-gray-200">
                        <button onclick="toggleHistoryViewMoreLess()" class="inline-flex items-center gap-2 px-4 sm:px-6 py-2 sm:py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-sm hover:from-blue-600 hover:to-blue-700 hover:-translate-y-0.5 hover:shadow-lg transition-all">
                            <i class="bi bi-${showAllHistory ? 'chevron-up' : 'chevron-down'}"></i>
                            ${showAllHistory ? 'View Less' : `View More (${hiddenCount} more)`}
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        window.toggleHistoryViewMoreLess = function() {
            showAllHistory = !showAllHistory;
            renderTestHistory();
            
            if (showAllHistory) {
                setTimeout(() => {
                    document.getElementById('testHistoryContainer').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }, 100);
            }
        };

        window.startOverdueTest = function(testId, encodedTestName) {
            if (!isProfileComplete(studentData)) {
                showProfileRequiredModal();
                return;
            }
            
            const testName = decodeURIComponent(encodedTestName);
            console.log(`Starting overdue test: ${testName} (ID: ${testId})`);
            window.location.href = `./testdetails.html?testId=${testId}&testName=${encodedTestName}&isOverdue=true`;
        };

        window.checkProfileBeforeTest = function(event) {
            event.preventDefault();
            
            if (!isProfileComplete(studentData)) {
                showProfileRequiredModal();
                return false;
            }
            
            window.location.href = './test.html';
        };

        function isProfileComplete(studentData) {
            if (!studentData) return false;
            
            const requiredFields = {
                age: studentData.age > 0,
                gender: studentData.gender && studentData.gender !== 'Not Specified',
                height: studentData.height > 0,
                weight: studentData.weight > 0,
                contactNumber: studentData.contactNumber && 
                            studentData.contactNumber !== 'Not Provided' &&
                            studentData.contactNumber.trim() !== ''
            };
            
            console.log('Profile Check:', requiredFields);
            
            return Object.values(requiredFields).every(field => field === true);
        }

        function showProfileRequiredModal() {
            let modal = document.getElementById('profileRequiredModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'profileRequiredModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] px-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 sm:p-8 animate-fade-in">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="bi bi-exclamation-triangle text-3xl text-yellow-600"></i>
                            </div>
                            <h3 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Profile Incomplete</h3>
                            <p class="text-sm sm:text-base text-gray-600">
                                You need to complete your profile before taking any tests. Please provide your age, gender, height, weight, and contact number.
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="closeProfileRequiredModal()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                Cancel
                            </button>
                            <button onclick="goToEditProfile()" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-blue-700 transition-all">
                                Edit Profile
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.classList.remove('hidden');
        }

        window.closeProfileRequiredModal = function() {
            const modal = document.getElementById('profileRequiredModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        window.goToEditProfile = function() {
            window.location.href = './studentProfile.html?editProfile=true';
        };

        window.startTest = function(testId) {
            if (!isProfileComplete(studentData)) {
                showProfileRequiredModal();
                return;
            }
            
            const test = availableTests.find(t => t.id === testId);
            
            if (test) {
                const testDateTime = new Date(`${test.date}T${test.time || '00:00'}`);
                const now = new Date();

                if (testDateTime > now) {
                    const dateStr = testDateTime.toLocaleDateString('en-US', { 
                        weekday: 'long',
                        month: 'long', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                    const timeStr = testDateTime.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit', 
                        hour12: true 
                    });
                    
                    alert(` This test is not available yet.\n\nIt will be available on ${dateStr} at ${timeStr}.\n\nPlease check back at that time.`);
                    return;
                }
                
                if (test.isViewOnly === true) {
                    alert(' You cannot start this test.\n\nYou have not been selected by your professor to take this test.\n\nPlease contact your professor if you believe this is an error.');
                    return;
                }
                
                window.location.href = `./testdetails.html?testId=${testId}&testName=${encodeURIComponent(test.testName)}`;
                return;
            }
            
            const overdueTest = overdueTests.find(t => t.id === testId);
            if (overdueTest) {
                if (overdueTest.isViewOnly === true) {
                    alert(' You cannot start this test.\n\nYou have not been selected by your professor to take this test.\n\nPlease contact your professor if you believe this is an error.');
                    return;
                }
                window.location.href = `./testdetails.html?testId=${testId}&testName=${encodeURIComponent(overdueTest.testName)}&isOverdue=true`;
                return;
            }
            
            console.error(`Test not found: ${testId}`);
            alert('Test not found. Please refresh the page and try again.');
        };

        window.viewResult = function(resultId) {
            window.location.href = `./studentresult.html?resultId=${resultId}`;
        };

        function showProfileRequiredModalWithRedirect() {
            let modal = document.getElementById('profileRequiredModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'profileRequiredModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] px-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 sm:p-8 animate-fade-in">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="bi bi-exclamation-triangle text-3xl text-yellow-600"></i>
                            </div>
                            <h3 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Profile Incomplete</h3>
                            <p class="text-sm sm:text-base text-gray-600">
                                You need to complete your profile before accessing tests. Please provide your age, gender, height, weight, and contact number.
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="cancelAndGoBack()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                Cancel
                            </button>
                            <button onclick="goToEditProfile()" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-blue-700 transition-all">
                                Edit Profile
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.classList.remove('hidden');
        }

        window.cancelAndGoBack = function() {
            window.history.back();
        };

        function calculateTestScore(testName, result, testTarget = null) {
            const normalized = testName.toLowerCase().trim();
            
            if (result && typeof result === 'object' && result !== null) {
                if (result.score !== undefined && result.score !== null) {
                    const score = parseFloat(result.score);
                    if (!isNaN(score) && score >= 0 && score <= 100) {
                        console.log(` Using stored professor score: ${score} for ${testName}`);
                        return score;
                    }
                }
            }
            
            let numericValue = 0;
            
            if (typeof result === 'object' && result !== null) {
                numericValue = result.repetitions || result.time || result.distance || 
                              result.value || result.result || result.count || 
                              result.score || 0;
            } else if (typeof result === 'string') {
                const match = result.match(/(\d+\.?\d*)/);
                if (match) {
                    numericValue = parseFloat(match[1]);
                } else {
                    numericValue = parseFloat(result) || 0;
                }
            } else {
                numericValue = parseFloat(result) || 0;
            }
            
            console.log(` Calculating: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
            
            if (testTarget && testTarget > 0) {
                if (normalized.includes('push-up') || normalized.includes('pushup') || 
                    normalized.includes('sit-up') || normalized.includes('situp') ||
                    normalized.includes('curl-up')) {
                    
                    const reps = numericValue;
                    if (reps >= testTarget) return 100;
                    
                    const percentage = (reps / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    console.log(` Strength Test: ${reps}/${testTarget} reps  ${score}%`);
                    return Math.round(score);
                }
                
                if (normalized.includes('plank')) {
                    let seconds = numericValue;
                    if (seconds >= testTarget) return 100;
                    
                    const percentage = (seconds / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    console.log(` Plank Test: ${seconds}s/${testTarget}s  ${score}%`);
                    return Math.round(score);
                }
                
                if (normalized.includes('sit-and-reach')) {
                    const distance = numericValue;
                    if (distance >= testTarget) return 100;
                    
                    const percentage = (distance / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    console.log(` Flexibility Test: ${distance}cm/${testTarget}cm  ${score}%`);
                    return Math.round(score);
                }
                
                if (normalized.includes('grip')) {
                    if (numericValue >= testTarget) return 100;
                    
                    const percentage = (numericValue / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('mile') || normalized.includes('run')) {
                    if (numericValue <= testTarget) return 100;
                    
                    const percentage = (testTarget / numericValue) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('step test') || normalized.includes('3-minute')) {
                    if (numericValue <= testTarget) return 100;
                    
                    const percentage = (testTarget / numericValue) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
            }
            
            if (normalized.includes('push-up') || normalized.includes('pushup')) {
                const reps = numericValue;
                if (reps >= 40) return 100;
                if (reps >= 35) return 95;
                if (reps >= 30) return 90;
                if (reps >= 25) return 85;
                if (reps >= 20) return 80;
                if (reps >= 15) return 75;
                if (reps >= 10) return 70;
                if (reps >= 5) return 65;
                return 60;
            } else if (normalized.includes('sit-up') || normalized.includes('situp') || normalized.includes('curl-up')) {
                const reps = numericValue;
                if (reps >= 50) return 100;
                if (reps >= 45) return 95;
                if (reps >= 40) return 90;
                if (reps >= 35) return 85;
                if (reps >= 30) return 80;
                if (reps >= 25) return 75;
                if (reps >= 20) return 70;
                if (reps >= 15) return 65;
                return 60;
            } else if (normalized.includes('plank')) {
                let seconds = numericValue;
                if (seconds >= 180) return 100;
                if (seconds >= 150) return 95;
                if (seconds >= 120) return 90;
                if (seconds >= 100) return 85;
                if (seconds >= 80) return 80;
                if (seconds >= 60) return 75;
                if (seconds >= 45) return 70;
                if (seconds >= 30) return 65;
                return 60;
            } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
                const heartRate = numericValue;
                if (heartRate <= 70) return 100;
                if (heartRate <= 80) return 95;
                if (heartRate <= 90) return 90;
                if (heartRate <= 100) return 85;
                if (heartRate <= 110) return 80;
                if (heartRate <= 120) return 75;
                if (heartRate <= 130) return 70;
                return 65;
            } else if (normalized.includes('mile') || normalized.includes('run')) {
                let totalSeconds = numericValue;
                if (totalSeconds <= 360) return 100;
                if (totalSeconds <= 420) return 95;
                if (totalSeconds <= 480) return 90;
                if (totalSeconds <= 540) return 85;
                if (totalSeconds <= 600) return 80;
                if (totalSeconds <= 660) return 75;
                if (totalSeconds <= 720) return 70;
                if (totalSeconds <= 780) return 65;
                return 60;
            } else if (normalized.includes('sit-and-reach')) {
                const distance = numericValue;
                if (distance >= 25) return 100;
                if (distance >= 20) return 95;
                if (distance >= 15) return 90;
                if (distance >= 10) return 85;
                if (distance >= 5) return 80;
                if (distance >= 0) return 75;
                if (distance >= -5) return 70;
                return 65;
            } else if (normalized.includes('grip')) {
                const strength = numericValue;
                if (strength >= 60) return 100;
                if (strength >= 55) return 95;
                if (strength >= 50) return 90;
                if (strength >= 45) return 85;
                if (strength >= 40) return 80;
                if (strength >= 35) return 75;
                if (strength >= 30) return 70;
                return 65;
            }
            
            console.log(` Unknown test type: ${testName}, using default score`);
            return 75;
        }

        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'text-green-600' };
            if (score >= 80) return { text: 'Good', class: 'text-blue-600' };
            if (score >= 70) return { text: 'Fair', class: 'text-yellow-600' };
            return { text: 'Needs Improvement', class: 'text-red-600' };
        }

        function initPerformanceCarousel() {
            const carousel = document.getElementById('performanceCarousel');
            const indicators = document.querySelectorAll('.carousel-dot');
            
            if (!carousel || window.innerWidth >= 1024) return;
            
            let currentIndex = 0;
            let isScrolling = false;
            let autoSwipeInterval;
            let isUserInteracting = false;
            
            const CARDS_COUNT = 4;
            const AUTO_SWIPE_DELAY = 3000;
            
            function autoSwipe() {
                if (isUserInteracting) return;
                
                currentIndex = (currentIndex + 1) % CARDS_COUNT;
                scrollToIndex(currentIndex);
            }
            
            function scrollToIndex(index) {
                isScrolling = true;
                const cardWidth = carousel.querySelector('.performance-card').offsetWidth;
                const gap = 16;
                
                carousel.scrollTo({
                    left: index * (cardWidth + gap),
                    behavior: 'smooth'
                });
                
                indicators.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
                
                setTimeout(() => {
                    isScrolling = false;
                }, 500);
            }
            
            function startAutoSwipe() {
                stopAutoSwipe();
                autoSwipeInterval = setInterval(autoSwipe, AUTO_SWIPE_DELAY);
            }
            
            function stopAutoSwipe() {
                if (autoSwipeInterval) {
                    clearInterval(autoSwipeInterval);
                    autoSwipeInterval = null;
                }
            }
            
            function updateIndicators() {
                if (isScrolling) return;
                
                const scrollLeft = carousel.scrollLeft;
                const cardWidth = carousel.querySelector('.performance-card').offsetWidth;
                const gap = 16;
                const newIndex = Math.round(scrollLeft / (cardWidth + gap));
                
                if (newIndex !== currentIndex && newIndex >= 0 && newIndex < indicators.length) {
                    currentIndex = newIndex;
                    indicators.forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentIndex);
                    });
                }
            }
            
            let scrollTimeout;
            carousel.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateIndicators, 100);
            });
            
            indicators.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    stopAutoSwipe();
                    isUserInteracting = true;
                    currentIndex = index;
                    scrollToIndex(index);
                    
                    setTimeout(() => {
                        isUserInteracting = false;
                        startAutoSwipe();
                    }, 5000);
                });
            });
            
            let startX = 0;
            let scrollStart = 0;
            let isDragging = false;
            
            carousel.addEventListener('touchstart', (e) => {
                stopAutoSwipe();
                isUserInteracting = true;
                isDragging = true;
                startX = e.touches[0].pageX;
                scrollStart = carousel.scrollLeft;
                carousel.style.scrollSnapType = 'none';
            }, { passive: true });
            
            carousel.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const x = e.touches[0].pageX;
                const walk = (startX - x) * 1.2;
                carousel.scrollLeft = scrollStart + walk;
            }, { passive: true });
            
            carousel.addEventListener('touchend', () => {
                isDragging = false;
                carousel.style.scrollSnapType = 'x mandatory';
                
                const cardWidth = carousel.querySelector('.performance-card').offsetWidth;
                const gap = 16;
                currentIndex = Math.round(carousel.scrollLeft / (cardWidth + gap));
                scrollToIndex(currentIndex);
                
                setTimeout(() => {
                    isUserInteracting = false;
                    startAutoSwipe();
                }, 5000);
            });
            
            let mouseStartX = 0;
            let mouseScrollStart = 0;
            let isMouseDragging = false;
            
            carousel.addEventListener('mousedown', (e) => {
                stopAutoSwipe();
                isUserInteracting = true;
                isMouseDragging = true;
                mouseStartX = e.pageX;
                mouseScrollStart = carousel.scrollLeft;
                carousel.style.cursor = 'grabbing';
                carousel.style.scrollSnapType = 'none';
            });
            
            carousel.addEventListener('mousemove', (e) => {
                if (!isMouseDragging) return;
                e.preventDefault();
                const x = e.pageX;
                const walk = (mouseStartX - x) * 1.2;
                carousel.scrollLeft = mouseScrollStart + walk;
            });
            
            carousel.addEventListener('mouseup', () => {
                isMouseDragging = false;
                carousel.style.cursor = 'grab';
                carousel.style.scrollSnapType = 'x mandatory';
                
                setTimeout(() => {
                    isUserInteracting = false;
                    startAutoSwipe();
                }, 5000);
            });
            
            carousel.addEventListener('mouseleave', () => {
                if (isMouseDragging) {
                    isMouseDragging = false;
                    carousel.style.cursor = 'grab';
                    carousel.style.scrollSnapType = 'x mandatory';
                }
            });
            
            carousel.addEventListener('mouseenter', () => {
                stopAutoSwipe();
                isUserInteracting = true;
            });
            
            carousel.addEventListener('mouseleave', () => {
                isUserInteracting = false;
                startAutoSwipe();
            });
            
            startAutoSwipe();
            
            window.addEventListener('beforeunload', stopAutoSwipe);
        }

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    currentUser = user;
                    await loadStudentData(user);
                    
                    if (!isProfileComplete(studentData)) {
                        loadingScreen.classList.add('hidden');
                        showProfileRequiredModalWithRedirect();
                        return;
                    }
                    
                    await loadAvailableTests();
                    await loadRecentTestHistory();
                    setupTestUpdatesForStudent();
                    
                    setupNotificationListener();
                    await checkUnreadNotifications();
                    
                    setupEventListeners();
                    
                    loadingScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    
                    setTimeout(initPerformanceCarousel, 100);
                    
                } catch (error) {
                    console.error('Error loading page:', error);
                    alert('Error loading page. Please try again.');
                }
            } else {
                window.location.href = '../login/index.html';
            }
        });

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (window.innerWidth < 1024) {
                    initPerformanceCarousel();
                }
            }, 250);
        });

        // Make functions globally available
        window.toggleNotificationDropdown = toggleNotificationDropdown;
        window.closeNotificationDropdown = closeNotificationDropdown;
    </script>
</body>
</html>