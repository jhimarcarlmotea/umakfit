<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMak Fitness - Grades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        /* Scrollbar styling for test results */
        #testResultsContainer::-webkit-scrollbar {
            width: 8px;
        }

        #testResultsContainer::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        #testResultsContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        #testResultsContainer::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Mobile scroll optimization */
        @media (max-width: 768px) {
            #testResultsContainer {
                -webkit-overflow-scrolling: touch;
            }
        }
            /* Hamburger Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            z-index: 60;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Mobile Drawer */
        .mobile-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);
            z-index: 55;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .mobile-drawer.active {
            right: 0;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 1023px) {
            .hamburger {
                display: flex;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
   <!-- Loading Screen -->
<div id="loadingScreen" class="fixed inset-0 bg-white/98 flex flex-col items-center justify-center z-50">
    <img src="UMakfit Logo (2).png" alt="UMakFit Logo" class="h-40 sm:h-48 w-auto object-contain mb-4 animate-pulse">
    <div class="spinner"></div>
    <div class="mt-5 text-gray-600 font-medium text-sm md:text-base">Loading Grades...</div>
</div>

    <div id="mainContent" class="hidden">
<!-- Navigation -->
<nav class="shadow-lg" style="background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);">
    <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-5">
        <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
            <!-- Logo -->
            <a href="#" class="flex items-center gap-2 sm:gap-3">
                <img src="UMakfit Logo (2).png" 
                     alt="UMak Logo" class="h-12 sm:h-14 md:h-16 w-auto object-contain">
                <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                    UMakFit
                </span>
            </a>
            
            <!-- Desktop Navigation -->
            <div class="hidden lg:flex items-center gap-2 flex-wrap">
                <a href="./studentDashboard.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-speedometer2"></i> 
                    <span class="hidden xl:inline">Dashboard</span>
                </a>
                <a href="./test.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-clipboard-check"></i> 
                    <span class="hidden xl:inline">Tests</span>
                </a>
                <a href="./studentlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-book"></i> 
                    <span class="hidden xl:inline">Lessons</span>
                </a>
                <a href="#" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
                    <i class="bi bi-award"></i> 
                    <span class="hidden xl:inline">Grades</span>
                </a>
                <a href="./progress.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-graph-up"></i> 
                    <span class="hidden xl:inline">Progress</span>
                </a>
                <a href="./achievements.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-trophy"></i> 
                    <span class="hidden xl:inline">Achievements</span>
                </a>
                
                <!-- Notification Bell -->
                <div class="relative">
                    <button id="notificationBellBtn" 
                            class="w-9 h-9 xl:w-10 xl:h-10 bg-white/20 border-2 border-white/30 rounded-full flex items-center justify-center text-white hover:bg-white/30 hover:scale-110 transition-all">
                        <i class="bi bi-bell-fill text-base xl:text-lg"></i>
                        <span id="navNotificationCount" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[18px] h-4.5 flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Notification Dropdown -->
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 sm:w-96 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-2xl z-[9999] max-h-[480px] overflow-y-auto">
                        <div class="p-3 sm:p-4 border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                            <h6 class="font-bold text-gray-900 text-sm sm:text-base flex items-center gap-2">
                                <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                            </h6>
                            <button onclick="closeNotificationDropdown()" class="text-gray-400 hover:text-gray-600 p-1">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div id="notificationDropdownBody" class="max-h-96 overflow-y-auto">
                            <div class="p-6 sm:p-8 text-center text-gray-400">
                                <i class="bi bi-bell-slash text-4xl sm:text-5xl mb-3 block"></i>
                                <p class="text-gray-600 text-sm sm:text-base">No notifications yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Dropdown -->
                <div class="relative">
                    <img src="" alt="Profile" id="profilePictureBtn"
                         class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                    
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999]">
                        <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                            <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                            <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                            <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                        </div>
                        <div class="p-2">
                            <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                            </a>
                            <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                            <div onclick="handleLogout()" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                <span class="font-medium text-sm sm:text-base">Logout</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Right Icons -->
<div class="flex lg:hidden items-center gap-2 sm:gap-3">
    <!-- Mobile Notification Bell -->
    <div class="relative">
        <button id="notificationBellBtnMobile" 
                class="w-9 h-9 sm:w-10 sm:h-10 bg-white/20 border-2 border-white/30 rounded-full flex items-center justify-center text-white hover:bg-white/30 hover:scale-110 transition-all">
            <i class="bi bi-bell-fill text-base sm:text-lg"></i>
            <span id="navNotificationCountMobile" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[18px] h-4.5 flex items-center justify-center">0</span>
        </button>
        
        <!-- Mobile Notification Dropdown -->
        <div id="notificationDropdownMobile" class="hidden fixed right-2 top-20 w-96 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-2xl z-[9999] max-h-[480px] overflow-y-auto">
            <div class="p-4 border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                <h6 class="font-bold text-gray-900 text-base flex items-center gap-2">
                    <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                </h6>
                <button onclick="closeNotificationDropdownMobile()" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div id="notificationDropdownBodyMobile" class="max-h-96 overflow-y-auto">
                <div class="p-8 text-center text-gray-400">
                    <i class="bi bi-bell-slash text-5xl mb-3 block"></i>
                    <p class="text-gray-600">No notifications yet</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Profile -->
    <div class="relative">
        <img src="" alt="Profile" id="profilePictureBtnMobile" onclick="toggleProfileDropdown()"
             class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
        
        <!-- Mobile Profile Dropdown -->
        <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
            <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
            </div>
            <div class="p-2">
                <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                    <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                </a>
                <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                <div onclick="handleLogout()" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                    <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                    <span class="font-medium text-sm sm:text-base">Logout</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hamburger Menu Button -->
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>
</nav>
        
        <!-- Mobile Drawer Overlay -->
<div class="drawer-overlay" id="drawerOverlay"></div>

<!-- Mobile Drawer -->
<div class="mobile-drawer" id="mobileDrawer">
    <div class="p-6 pt-8">
        <!-- Drawer Header -->
        <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/20">
            <img src="https://c.animaapp.com/vkhEa8zW/img/screenshot-2025-09-19-2-53-51-pm-removebg-preview-3@2x.png" 
                 alt="UMak Logo" class="h-12 w-auto object-contain">
            <span class="text-2xl font-extrabold font-manrope" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                UMakFIT
            </span>
        </div>

        <nav class="space-y-2">
            <a href="./studentDashboard.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                <i class="bi bi-speedometer2 mr-3"></i>Dashboard
            </a>
            <a href="./test.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                <i class="bi bi-clipboard-check mr-3"></i>Test
            </a>
            <a href="./studentlesson.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                <i class="bi bi-book mr-3"></i>Lessons
            </a>
            <a href="./studentgrades.html" class="mobile-nav-link block text-white bg-white/10 font-semibold py-3 px-4 rounded-lg transition-all">
                <i class="bi bi-award mr-3"></i>Grades
            </a>
            <a href="./progress.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                <i class="bi bi-graph-up mr-3"></i>Progress
            </a>
            <a href="./achievements.html" class="mobile-nav-link block text-white/80 hover:text-white hover:bg-white/10 font-medium py-3 px-4 rounded-lg transition-all">
                <i class="bi bi-trophy mr-3"></i>Achievements
            </a>
        </nav>
    </div>
</div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <!-- Page Header -->
<div class="relative mb-4 sm:mb-8">
    <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
        <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-md flex-shrink-0">
            <i class="bi bi-award-fill text-lg sm:text-xl md:text-2xl text-white"></i>
        </div>
        <h1 class="text-lg sm:text-2xl md:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent leading-tight">
            My Grades
        </h1>
    </div>
    <p class="text-xs sm:text-sm md:text-base text-gray-600 max-w-2xl pl-0 sm:pl-14">
        Track your test scores and overall academic performance.
    </p>
</div>

            <!-- Overall Summary -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-6">
    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
        <i class="bi bi-graph-up-arrow text-white text-xl"></i>
    </div>
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Performance Overview</h2>
        <p class="text-sm text-gray-500">Your overall performance summary</p>
    </div>
</div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
       <div class="text-center md:text-left">
            <p class="text-sm text-gray-500 mb-2 font-medium uppercase tracking-wide">Average Score</p>
            <p class="text-5xl font-bold text-blue-600" id="finalGrade">--</p>
        </div>
        <div class="text-center md:text-left">
            <p class="text-sm text-gray-500 mb-2 font-medium uppercase tracking-wide">Tests Completed</p>
            <p class="text-5xl font-bold text-gray-900">
                <span id="completedTests">--</span><span class="text-3xl text-gray-400" id="totalTests">/0</span>
            </p>
        </div>
        <div class="text-center md:text-left">
            <p class="text-sm text-gray-500 mb-2 font-medium uppercase tracking-wide">Completion Rate</p>
            <p class="text-5xl font-bold text-gray-900" id="completionRate">--</p>
        </div>
    </div>
</div>

           <!-- Grades by Category -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                <i class="bi bi-list-check text-white text-lg"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-900">Performance by Category</h2>
                <p class="text-sm text-gray-500">Average scores across fitness categories</p>
            </div>
        </div>
    </div>
    
    <!-- Table Header - Desktop Only -->
    <div class="hidden md:block px-6 py-3 bg-gray-50 border-b border-gray-200">
        <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-600">
            <div class="col-span-5">Category</div>
            <div class="col-span-3 text-center">Tests Taken</div>
            <div class="col-span-4 text-right">Average Score</div>
        </div>
    </div>
    
    <div id="categoriesContainer" class="divide-y divide-gray-100">
        <!-- Categories will be dynamically inserted -->
    </div>
</div>
            

                        <!-- Detailed Test Results -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col" style="max-height: 600px;">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                <i class="bi bi-clipboard-data text-white text-lg"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-900">Recent Test Results</h2>
                <p class="text-sm text-gray-500">Your most recent fitness assessments</p>
            </div>
        </div>
    </div>
    
               <!-- Table Header - Desktop Only -->
    <div class="hidden md:block px-6 py-3 bg-gray-50 border-b border-gray-200 flex-shrink-0">
        <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-600">
            <div class="col-span-4">Test Name</div>
            <div class="col-span-3">Category</div>
            <div class="col-span-2 text-center">Date</div>
            <div class="col-span-2 text-right">Score</div>
            <div class="col-span-1 text-right">Action</div>
        </div>
    </div>
    
    <div id="testResultsContainer" class="divide-y divide-gray-100 overflow-y-auto flex-1">
                <!-- Test results will be dynamically inserted -->
            </div>
        </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
     
        let cachedStudentData = null;
        let cachedTestResults = null;

        
        async function loadEssentialData(user) {
            try {
                // Load student data and test results in parallel
                const [studentDataResult, assignedTestsResult] = await Promise.allSettled([
                    loadStudentData(user),
                    // Pre-load assigned tests count
                    getDocs(query(
                        collection(db, 'scheduledTests'),
                        where('section', '==', studentData?.section || ''),
                        where('isVisible', '==', true),
                        where('isActive', '==', true)
                    ))
                ]);
                
                // Cache the data
                if (studentDataResult.status === 'fulfilled') {
                    cachedStudentData = studentDataResult.value;
                }
                
                return cachedStudentData;
            } catch (error) {
                console.error('Error in parallel loading:', error);
                return null;
            }
        }
        let currentUser = null;

                // Toggle notification dropdown
                function toggleNotificationDropdown(event) {
                    event?.stopPropagation();
                    const dropdown = document.getElementById('notificationDropdown');
                    
                    if (dropdown.classList.contains('hidden')) {
                        dropdown.classList.remove('hidden');
                        loadNotificationDropdown();
                        closeProfileDropdown();
                    } else {
                        dropdown.classList.add('hidden');
                    }
                }

                window.closeNotificationDropdown = function() {
                    document.getElementById('notificationDropdown').classList.add('hidden');
                }

                // Toggle profile dropdown
                function toggleProfileDropdown(event) {
                    event?.stopPropagation();
                    const dropdown = document.getElementById('profileDropdown');
                    
                    if (dropdown.classList.contains('hidden')) {
                        dropdown.classList.remove('hidden');
                        closeNotificationDropdown();
                    } else {
                        dropdown.classList.add('hidden');
                    }
                }

                function closeProfileDropdown() {
                    document.getElementById('profileDropdown').classList.add('hidden');
                }

                // Close dropdowns when clicking outside
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('#notificationBellBtn') && 
                        !event.target.closest('#notificationDropdown')) {
                        closeNotificationDropdown();
                    }
                    
                    if (!event.target.closest('#profilePictureBtn') && 
                        !event.target.closest('#profileDropdown')) {
                        closeProfileDropdown();
                    }
                });
                    // Hamburger Menu and Drawer functionality
                const hamburger = document.getElementById('hamburger');
                const mobileDrawer = document.getElementById('mobileDrawer');
                const drawerOverlay = document.getElementById('drawerOverlay');
                const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

                // Toggle drawer
                if (hamburger) {
                    hamburger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hamburger.classList.toggle('active');
                        mobileDrawer.classList.toggle('active');
                        drawerOverlay.classList.toggle('active');
                        document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
                    });
                }

                // Close drawer when overlay is clicked
                if (drawerOverlay) {
                    drawerOverlay.addEventListener('click', () => {
                        hamburger.classList.remove('active');
                        mobileDrawer.classList.remove('active');
                        drawerOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }

                // Close drawer when nav link is clicked
                mobileNavLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        hamburger.classList.remove('active');
                        mobileDrawer.classList.remove('active');
                        drawerOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
                // Update profile UI
                function updateProfileUI() {
                if (!currentUser || !studentData) return;
                
                const photoURL = currentUser?.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(studentData?.displayName || studentData?.firstName + ' ' + studentData?.lastName || 'User') + '&background=3b82f6&color=fff&size=128';
                
                // Desktop
                const profileBtn = document.getElementById('profilePictureBtn');
                if (profileBtn) profileBtn.src = photoURL;
                
                const dropdownPic = document.getElementById('profileDropdownPicture');
                if (dropdownPic) dropdownPic.src = photoURL;
                
                const dropdownName = document.getElementById('profileDropdownName');
                if (dropdownName) dropdownName.textContent = studentData?.displayName || `${studentData?.firstName || ''} ${studentData?.lastName || ''}`.trim() || 'Student';
                
                const dropdownEmail = document.getElementById('profileDropdownEmail');
                if (dropdownEmail) dropdownEmail.textContent = studentData?.email || currentUser?.email || '';
                
                // Mobile
                const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
                if (profileBtnMobile) profileBtnMobile.src = photoURL;
                
                const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
                if (dropdownPicMobile) dropdownPicMobile.src = photoURL;
                
                const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
                if (dropdownNameMobile) dropdownNameMobile.textContent = studentData?.displayName || `${studentData?.firstName || ''} ${studentData?.lastName || ''}`.trim() || 'Student';
                
                const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
                if (dropdownEmailMobile) dropdownEmailMobile.textContent = studentData?.email || currentUser?.email || '';
            }
                async function loadNotificationDropdown(isMobile = false) {
                try {
                    if (!studentData || !studentData.section) return;

                    const notificationsQuery = query(
                        collection(db, 'notifications'),
                        where('section', '==', studentData.section)
                    );
                    
                    const notificationsSnapshot = await getDocs(notificationsQuery);
                    const dropdownBody = document.getElementById(isMobile ? 'notificationDropdownBodyMobile' : 'notificationDropdownBody');
                    
                    if (!notificationsSnapshot.empty) {
                        const notifications = [];
                        notificationsSnapshot.forEach(doc => {
                            notifications.push({ id: doc.id, ...doc.data() });
                        });
                        
                        notifications.sort((a, b) => {
                            const dateA = a.createdAt?.toDate?.() || new Date(0);
                            const dateB = b.createdAt?.toDate?.() || new Date(0);
                            return dateB - dateA;
                        });
                        
                        let html = '';
                        notifications.slice(0, 5).forEach(notification => {
                            const createdDate = notification.createdAt?.toDate?.();
                            const dateStr = createdDate ? createdDate.toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : 'Recently';
                            
                            html += `
                                <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer">
                                    <strong class="text-gray-900 text-sm block mb-1 font-semibold">${notification.title || 'Notification'}</strong>
                                    <p class="text-gray-600 text-sm mb-1 leading-relaxed">${notification.message || ''}</p>
                                    <small class="text-gray-400 text-xs">${dateStr}</small>
                                </div>
                            `;
                        });
                        
                        dropdownBody.innerHTML = html;
                    } else {
                        dropdownBody.innerHTML = `
                            <div class="p-8 text-center text-gray-400">
                                <i class="bi bi-bell-slash text-5xl mb-3 block"></i>
                                <p class="text-gray-600">No notifications yet</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }

                // Logout handler
                window.handleLogout = async function() {
                    if (confirm('Are you sure you want to logout?')) {
                        try {
                            await signOut(auth);
                            window.location.href = '../login/index.html';
                        } catch (error) {
                            console.error('Error logging out:', error);
                            alert('Error logging out. Please try again.');
                        }
                    }
                }

                // Event listeners
                document.addEventListener('DOMContentLoaded', () => {
                    const notificationBtn = document.getElementById('notificationBellBtn');
                    if (notificationBtn) {
                        notificationBtn.addEventListener('click', toggleNotificationDropdown);
                    }
                    
                    const profileBtn = document.getElementById('profilePictureBtn');
                    if (profileBtn) {
                        profileBtn.addEventListener('click', toggleProfileDropdown);
                    }
                });
        let studentData = null;

                    const testCategories = {
                'Cardiorespiratory Endurance': {
                    tests: ['3-Minute Step Test'],
                    icon: '‚ù§Ô∏è',
                    color: 'from-red-500 to-pink-500'
                },
                'Muscular Strength and Endurance': {
                    tests: ['Curl-Up Test', 'Push-Up Test'],
                    icon: 'üí™',
                    color: 'from-blue-500 to-indigo-500'
                },
                'Flexibility': {
                    tests: ['Sit-and-Reach'],
                    icon: 'ü§∏',
                    color: 'from-green-500 to-emerald-500'
                },
                'Body Composition': {
                    tests: ['Skinfold Caliper Measurements'],
                    icon: '‚öñÔ∏è',
                    color: 'from-purple-500 to-violet-500'
                }
            };
        function getCategoryForTest(testName) {
        for (const [category, data] of Object.entries(testCategories)) {
            if (data.tests.some(t => {
                const testLower = testName.toLowerCase();
                const categoryTestLower = t.toLowerCase();
                return testLower.includes(categoryTestLower) || categoryTestLower.includes(testLower);
            })) {
                return category;
            }
        }
        return 'Cardiorespiratory Endurance'; 
    }

        function calculateScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    // ‚≠ê CRITICAL: Check if this is a professor override with pre-calculated score
    if (result && typeof result === 'object' && result !== null) {
        // If professor already set a final score, use it directly
        if (result.score !== undefined && result.score !== null) {
            const score = parseFloat(result.score);
            if (!isNaN(score) && score >= 0 && score <= 100) {
                console.log(`‚úÖ Using stored professor score: ${score} for ${testName}`);
                return score;
            }
        }
    }
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || 
                      result.value || result.result || result.count || 
                      result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    console.log(`üéØ Calculating: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
    
    // Use test target if available - THIS IS THE KEY SECTION
    if (testTarget && testTarget > 0) {
        // REPETITION TESTS (push-ups, sit-ups, curl-ups)
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp') ||
            normalized.includes('curl-up')) {
            
            const reps = numericValue;
            if (reps >= testTarget) return 100;
            
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            // Apply grading scale
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // PLANK (time-based in seconds)
        if (normalized.includes('plank')) {
            let seconds = numericValue;
            if (seconds >= testTarget) return 100;
            
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // SIT-AND-REACH (flexibility in cm)
        if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            if (distance >= testTarget) return 100;
            
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // GRIP STRENGTH (kg)
        if (normalized.includes('grip')) {
            if (numericValue >= testTarget) return 100;
            
            const percentage = (numericValue / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // 1-MILE RUN (seconds - LOWER IS BETTER)
        if (normalized.includes('mile') || normalized.includes('run')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // STEP TEST (heart rate - LOWER IS BETTER)
        if (normalized.includes('step test') || normalized.includes('3-minute')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    // Fallback to default scoring if no target set
    return calculateDefaultScore(normalized, numericValue);
}
        function getGradeLetter(score) {
            if (score >= 95) return 'A+';
            if (score >= 90) return 'A';
            if (score >= 85) return 'B+';
            if (score >= 80) return 'B';
            if (score >= 75) return 'C+';
            if (score >= 70) return 'C';
            if (score >= 65) return 'D';
            return 'F';
        }

        function getGradeColor(score) {
            if (score >= 90) return 'text-green-600';
            if (score >= 80) return 'text-blue-600';
            if (score >= 70) return 'text-yellow-600';
            return 'text-red-600';
        }

        async function loadStudentData(user) {
            try {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('email', '==', user.email)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                if (!studentsSnapshot.empty) {
                    studentsSnapshot.forEach((doc) => {
                        studentData = doc.data();
                    });
                }
                return studentData;
            } catch (error) {
                console.error('Error loading student data:', error);
                return null;
            }
        }

        async function loadGrades() {
    try {
        if (!studentData || !studentData.email) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            return;
        }

        // Get all assigned tests (including overdue ones)
        const assignedTestsQuery = query(
            collection(db, 'scheduledTests'),
            where('section', '==', studentData.section),
            where('isVisible', '==', true),
            where('isActive', '==', true)
        );
        
        let totalAssignedTests = 0;
        let overdueTests = 0;
        let completedTests = 0;
        
        // Set up listener for assigned tests
        onSnapshot(assignedTestsQuery, async (assignedSnapshot) => {
            const now = new Date();
            const seenTestIds = new Set();
            totalAssignedTests = 0;
            overdueTests = 0;
            
            // Count unique tests that are either available now or overdue
            assignedSnapshot.forEach((doc) => {
                const test = doc.data();
                const testId = doc.id;
                
                // Skip duplicate test IDs
                if (seenTestIds.has(testId)) {
                    return;
                }
                seenTestIds.add(testId);
                
                // ‚≠ê NEW: Check if student is selected for this test
                let isStudentSelected = true; // Default to true for backward compatibility
                if (test.selectedStudents && Array.isArray(test.selectedStudents)) {
                    isStudentSelected = test.selectedStudents.includes(studentData.email);
                }
                
                // Only count tests that the student is selected for
                if (!isStudentSelected) {
                    return;
                }
                
                // Parse test date and deadline
                let testDateTime;
                if (test.date && test.time) {
                    testDateTime = new Date(`${test.date}T${test.time}`);
                } else if (test.date) {
                    testDateTime = new Date(test.date);
                    testDateTime.setHours(0, 0, 0, 0);
                } else {
                    testDateTime = new Date(0); // Very old date
                }
                
                let deadlineDateTime;
                if (test.deadlineDateTime) {
                    deadlineDateTime = new Date(test.deadlineDateTime);
                } else if (test.deadline) {
                    deadlineDateTime = new Date(test.deadline);
                    if (test.deadlineTime) {
                        const [hours, minutes] = test.deadlineTime.split(':').map(Number);
                        deadlineDateTime.setHours(hours, minutes, 0, 0);
                    } else {
                        deadlineDateTime.setHours(23, 59, 59, 999);
                    }
                } else {
                    deadlineDateTime = new Date(8640000000000000); // Very far future
                }
                
                // Check if test is available (test date has passed)
                const isTestAvailable = testDateTime <= now;
                
                // Check if test is overdue
                const isOverdue = deadlineDateTime < now;
                
                // Only count tests that are either:
                // 1. Available now (test date passed, deadline not passed)
                // 2. Overdue (deadline passed)
                if (isTestAvailable || isOverdue) {
                    totalAssignedTests++;
                    
                    if (isOverdue) {
                        overdueTests++;
                    }
                }
            });
            
            console.log(`üìä Total assigned tests for student: ${totalAssignedTests}`);
            console.log(`‚ö†Ô∏è Overdue tests: ${overdueTests}`);
            
            document.getElementById('totalTests').textContent = `/${totalAssignedTests}`;
            
            // Now load the completed tests to calculate completion rate
            const resultsQuery = query(
                collection(db, 'testResults'),
                where('studentEmail', '==', studentData.email)
            );
            
            const resultsSnapshot = await getDocs(resultsQuery);
            
            // Count unique tests completed (best score per test)
            const completedTestIds = new Set();
            resultsSnapshot.forEach((doc) => {
                const result = doc.data();
                completedTestIds.add(result.testId);
            });
            
            completedTests = completedTestIds.size;
            
            console.log(`‚úÖ Unique tests completed: ${completedTests}`);
            
            // Calculate actual completion rate (completed / total assigned)
            const completionRate = totalAssignedTests > 0 ? 
                Math.round((completedTests / totalAssignedTests) * 100) : 0;
            
            document.getElementById('completedTests').textContent = completedTests;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // Load real-time updates for test results
            setupRealTimeGradeListener(overdueTests);
        });
        
    } catch (error) {
        console.error('Error loading grades:', error);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
    }
}


    async function setupRealTimeGradeListener(overdueCount) {
    try {
        const resultsQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email),
            where('status', 'in', ['completed', 'overdue', 'late'])
        );
        
        onSnapshot(resultsQuery, (resultsSnapshot) => {
            const testResults = [];
            const categoryScores = {};
            const OVERDUE_PENALTY = 0.10;
            
            // Initialize categories
            Object.keys(testCategories).forEach(cat => {
                categoryScores[cat] = { scores: [], tests: [] };
            });
            
            const testGroups = {};
            let hasOverdueWithPenalty = false;

            resultsSnapshot.forEach((doc) => {
                const result = doc.data();
                
                // ‚≠ê CRITICAL: Always use submittedAt for the test date
                let testDate = new Date();
                if (result.submittedAt) {
                    if (typeof result.submittedAt.toDate === 'function') {
                        testDate = result.submittedAt.toDate();
                    } else if (result.submittedAt instanceof Date) {
                        testDate = result.submittedAt;
                    } else if (typeof result.submittedAt === 'string' || typeof result.submittedAt === 'number') {
                        testDate = new Date(result.submittedAt);
                    } else if (result.submittedAt.seconds) {
                        testDate = new Date(result.submittedAt.seconds * 1000);
                    }
                }
                
                // ‚≠ê Check if professor override exists first
                const isProfessorOverride = result.isProfessorOverride === true;
                
                let score = 0;
                
                if (isProfessorOverride && typeof result.score === 'number' && !isNaN(result.score)) {
                    // Use professor's score directly
                    score = result.score;
                } else {
                    // Calculate normally
                    score = calculateScore(
                        result.testName, 
                        result.result || result.resultData, 
                        result.testTarget
                    );
                    
                    // ‚≠ê Apply penalty ONLY if overdue AND not professor override
                    const isOverdue = (result.status === 'overdue' || result.status === 'late');
                    if (isOverdue && !isProfessorOverride) {
                        const penalty = score * OVERDUE_PENALTY;
                        score = Math.max(0, score - penalty);
                        hasOverdueWithPenalty = true;
                    }
                }
                
                // Validate score
                score = Math.max(0, Math.min(100, score));
                
                const category = getCategoryForTest(result.testName);
                const testId = result.testId || doc.id;
                
                // Keep highest score per test
                if (!testGroups[testId] || score > testGroups[testId].score) {
                    testGroups[testId] = {
                        ...result,
                        score,
                        category,
                        id: doc.id,
                        isProfessorOverride: isProfessorOverride,
                        isOverdue: result.status === 'overdue' || result.status === 'late',
                        submittedAt: testDate
                    };
                }
            });

            // ‚≠ê Calculate totals from BEST scores only
            let totalScore = 0;
            let testCount = 0;
            
            Object.values(testGroups).forEach(result => {
                // Ensure score is valid
                if (typeof result.score === 'number' && !isNaN(result.score) && result.score >= 0) {
                    testResults.push(result);
                    
                    if (categoryScores[result.category]) {
                        categoryScores[result.category].scores.push(result.score);
                        categoryScores[result.category].tests.push({
                            name: result.testName,
                            score: result.score,
                            isOverdue: result.isOverdue
                        });
                    }
                    
                    // ‚≠ê Add to total for average calculation
                    totalScore += result.score;
                    testCount++;
                }
            });
            
            // ‚≠ê Calculate average with one decimal place - EXACT same as test.html
            const avgScore = testCount > 0 ? (totalScore / testCount).toFixed(1) : '0.0';
            const finalGrade = document.getElementById('finalGrade');
            
            if (hasOverdueWithPenalty) {
                finalGrade.innerHTML = `
                    ${avgScore}
                    <div class="text-xs text-red-600 font-normal mt-2">
                        ‚ö†Ô∏è 10% penalty applied to overdue test(s)<br>
                        <span class="text-[10px]">Retake tests to remove penalty</span>
                    </div>
                `;
            } else {
                finalGrade.textContent = avgScore;
            }
            
            document.getElementById('completedTests').textContent = testCount;
            
            renderCategoryGrades(categoryScores);
            renderTestResults(testResults);
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        });
        
    } catch (error) {
        console.error('Error in real-time listener:', error);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
    }
}
        function validateScore(score) {
    if (score === null || score === undefined || score === '' || isNaN(score)) {
        return 0;
    }
    
    const numScore = parseFloat(score);
    if (isNaN(numScore)) {
        return 0;
    }
    
    // Ensure score is between 0 and 100
    return Math.max(0, Math.min(100, numScore));
}
        function renderCategoryGrades(categoryScores) {
    const container = document.getElementById('categoriesContainer');
    
    if (!container) {
        console.error('Categories container not found');
        return;
    }
    
    let html = '';
    let hasData = false;
    
    Object.entries(categoryScores).forEach(([category, data]) => {
        if (data.scores.length > 0) {
            hasData = true;
            const avgScore = (data.scores.reduce((a, b) => a + b, 0) / data.scores.length).toFixed(1);
            
            const scoreColor = parseFloat(avgScore) >= 85 ? 'text-green-600' : 
                              parseFloat(avgScore) >= 75 ? 'text-blue-600' : 
                              parseFloat(avgScore) >= 65 ? 'text-yellow-600' : 'text-red-600';
            
            // Count overdue tests in this category
            const overdueCount = data.tests.filter(test => test.isOverdue).length;
            
            html += `
                <div class="px-4 py-4 md:px-6 hover:bg-gray-50 transition-colors">
                    <!-- Mobile Layout -->
                    <div class="block md:hidden">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-900 text-sm">${category}</h4>
                            ${overdueCount > 0 ? 
                                `<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">${overdueCount} overdue</span>` 
                                : ''}
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">${data.scores.length} test${data.scores.length !== 1 ? 's' : ''}</p>
                                <span class="text-2xl font-bold ${scoreColor}">${avgScore}</span>
                                <span class="text-xs text-gray-400 ml-1">/ 100</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desktop Layout -->
                    <div class="hidden md:grid grid-cols-12 gap-4 items-center">
                        <div class="col-span-5">
                            <h4 class="font-semibold text-gray-900">${category}</h4>
                            <p class="text-xs text-gray-500 mt-0.5">
                                ${data.scores.length} test${data.scores.length !== 1 ? 's' : ''}
                                ${overdueCount > 0 ? 
                                    ` ‚Ä¢ <span class="text-red-600">${overdueCount} overdue</span>` 
                                    : ''}
                            </p>
                        </div>
                        <div class="col-span-3 text-center">
                            <span class="text-gray-600">${data.scores.length} taken</span>
                        </div>
                        <div class="col-span-4 text-right flex items-center justify-end gap-4">
                            <span class="text-3xl font-bold ${scoreColor}">${avgScore}</span>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    if (!hasData) {
        html = `
            <div class="px-6 py-12 text-center">
                <i class="bi bi-inbox text-gray-300 text-5xl mb-3 block"></i>
                <p class="text-gray-500">No category data available yet</p>
                <p class="text-gray-400 text-sm mt-2">Complete tests to see your performance by category</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        function renderTestResults(testResults) {
    const container = document.getElementById('testResultsContainer');
    
    if (!container) {
        console.error('Test results container not found');
        return;
    }
    
    if (!testResults || testResults.length === 0) {
        container.innerHTML = `
            <div class="px-6 py-12 text-center">
                <i class="bi bi-clipboard-x text-gray-300 text-5xl mb-3 block"></i>
                <p class="text-gray-500 font-medium">No test results yet</p>
                <p class="text-gray-400 text-sm mt-2">Complete tests to see your results here</p>
            </div>
        `;
        return;
    }
    
    // Sort by date - most recent first
    testResults.sort((a, b) => {
    let dateA = new Date(0);
    let dateB = new Date(0);
    
    // Parse dateA
    if (a.submittedAt) {
        if (typeof a.submittedAt.toDate === 'function') {
            dateA = a.submittedAt.toDate();
        } else if (a.submittedAt instanceof Date) {
            dateA = a.submittedAt;
        } else if (a.submittedAt.seconds) {
            dateA = new Date(a.submittedAt.seconds * 1000);
        } else {
            dateA = new Date(a.submittedAt);
        }
    }
    
    // Parse dateB
    if (b.submittedAt) {
        if (typeof b.submittedAt.toDate === 'function') {
            dateB = b.submittedAt.toDate();
        } else if (b.submittedAt instanceof Date) {
            dateB = b.submittedAt;
        } else if (b.submittedAt.seconds) {
            dateB = new Date(b.submittedAt.seconds * 1000);
        } else {
            dateB = new Date(b.submittedAt);
        }
    }
    
    return dateB - dateA; // Most recent first
});
    
    console.log('Rendering', testResults.length, 'test results');
    
    let html = '';
    testResults.forEach((result) => {
        const scoreColor = result.score >= 85 ? 'text-green-600' : 
                          result.score >= 75 ? 'text-blue-600' : 
                          result.score >= 65 ? 'text-yellow-600' : 'text-red-600';
        
        const date = result.submittedAt?.toDate 
            ? result.submittedAt.toDate().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            })
            : (result.submittedAt ? new Date(result.submittedAt).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }) : 'N/A');
        
        // Check if test is overdue
        const isOverdue = result.status === 'overdue' || result.status === 'late';
        const isProfessorOverride = result.isProfessorOverride === true;
        
        html += `
            <div class="px-6 py-4 hover:bg-gray-50 transition-colors ${isOverdue && !isProfessorOverride ? 'bg-red-50/30' : ''}">
                <!-- Mobile Layout -->
                <div class="block md:hidden">
                    <div class="mb-3">
                        <h4 class="font-semibold text-gray-900 text-sm mb-1">
                            ${result.testName}
                            ${isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚úì Professor Set</span>' : 
                                ''}
                            ${isOverdue && !isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-semibold">‚ö†Ô∏è Overdue (-10%)</span>' : 
                                ''}
                        </h4>
                        <p class="text-xs text-gray-500">${result.category}</p>
                        <p class="text-xs text-gray-400 mt-1">
                            <i class="bi bi-calendar3"></i> ${date}
                        </p>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-2xl font-bold ${scoreColor}">${result.score.toFixed(1)}</span>
                            <span class="text-xs text-gray-400 ml-1">/ 100</span>
                            ${isOverdue && !isProfessorOverride ? 
                                '<p class="text-xs text-red-600 mt-1">Penalty applied</p>' : 
                                ''}
                        </div>
                        <a href="./studentresult.html?resultId=${result.id}" 
                           class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1">
                            View <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Desktop Layout -->
                <div class="hidden md:grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-4">
                        <h4 class="font-semibold text-gray-900">
                            ${result.testName}
                            ${isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚úì Professor Set</span>' : 
                                ''}
                            ${isOverdue && !isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-semibold">‚ö†Ô∏è Overdue (-10%)</span>' : 
                                ''}
                        </h4>
                        <p class="text-xs text-gray-500 mt-1">${result.category}</p>
                    </div>
                    <div class="col-span-3">
                        <div class="flex flex-col">
                            <span class="text-gray-600 text-sm">${result.category}</span>
                            ${isOverdue && !isProfessorOverride ? 
                                '<span class="text-xs text-red-600 font-semibold mt-1">‚ö†Ô∏è Submitted Late</span>' : 
                                ''}
                        </div>
                    </div>
                    <div class="col-span-2 text-center">
                        <span class="text-gray-600 text-sm">
                            <i class="bi bi-calendar3"></i> ${date}
                        </span>
                    </div>
                    <div class="col-span-2 text-right">
                        <div>
                            <span class="text-3xl font-bold ${scoreColor}">${result.score.toFixed(1)}</span>
                            <span class="text-xs text-gray-400 ml-1">/ 100</span>
                            ${isOverdue && !isProfessorOverride ? 
                                '<p class="text-xs text-red-600 mt-1 font-medium">With penalty</p>' : 
                                ''}
                        </div>
                    </div>
                    <div class="col-span-1 text-right">
                        <a href="./studentresult.html?resultId=${result.id}" 
                           class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1 hover:gap-2 transition-all">
                            View <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}
            const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');

        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Mobile notification dropdown
        const notificationBellBtnMobile = document.getElementById('notificationBellBtnMobile');
        const notificationDropdownMobile = document.getElementById('notificationDropdownMobile');

        if (notificationBellBtnMobile) {
            notificationBellBtnMobile.addEventListener('click', toggleNotificationDropdownMobile);
        }

        function toggleNotificationDropdownMobile(event) {
        event?.stopPropagation();
        const isHidden = notificationDropdownMobile.classList.contains('hidden');
        
        if (isHidden) {
            notificationDropdownMobile.classList.remove('hidden');
            closeProfileDropdownMobile();
            loadNotificationDropdown(true); // Pass true for mobile
        } else {
            notificationDropdownMobile.classList.add('hidden');
        }
    }

        window.closeNotificationDropdownMobile = function() {
            notificationDropdownMobile.classList.add('hidden');
        }

        // Mobile profile dropdown
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        if (profilePictureBtnMobile) {
            profilePictureBtnMobile.addEventListener('click', toggleProfileDropdownMobile);
        }

        function toggleProfileDropdownMobile(event) {
            event?.stopPropagation();
            const isHidden = profileDropdownMobile.classList.contains('hidden');
            
            if (isHidden) {
                profileDropdownMobile.classList.remove('hidden');
                closeNotificationDropdownMobile();
            } else {
                profileDropdownMobile.classList.add('hidden');
            }
        }

        function closeProfileDropdownMobile() {
            profileDropdownMobile.classList.add('hidden');
        }

        // Close mobile dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#notificationBellBtnMobile') && 
                !event.target.closest('#notificationDropdownMobile')) {
                closeNotificationDropdownMobile();
            }
            
            if (!event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdownMobile();
            }
        });
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;  
        // Hide loading screen faster by showing main content while loading data
        setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }, 1500); // Max 1.5 second loading screen
        
        // Load data in background
        await loadEssentialData(user);
        await loadGrades();
        updateProfileUI();  
    } else {
        window.location.href = '../login/index.html';
    }
});
    </script>
</body>
</html>