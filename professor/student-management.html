<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Student Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        
        .header-top { 
            background-color: #ffffff; 
            padding: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
        }
        .nav-section { 
            background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%); 
            padding: 20px 0; 
            margin-top: 74px; 
        }
        .nav-pills-custom { display: flex; flex-wrap: wrap; gap: 8px; }
        .nav-pills-custom .nav-link { 
            padding: 12px 18px;
            border-radius: 8px; 
            background-color: #ffffff; 
            font-weight: 600;
            transition: all 0.3s; 
        }
        .nav-pills-custom .nav-link.active { 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
        }
        
        .page-header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }
        
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table thead {
            background: #f8fafc;
        }
        .custom-table th {
            padding: 14px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }
        .custom-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #475569;
        }
        .custom-table tr:hover {
            background-color: #f8fafc;
        }
        
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-view {
            background: #3b82f6;
            color: white;
        }
        .btn-view:hover {
            background: #2563eb;
        }
        
        .loading { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.95); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
        }
        .spinner { 
            border: 4px solid #f1f5f9; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="header-top">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 700; color: #1e3a8a; font-size: 24px;">
                        <i class="fas fa-graduation-cap"></i> University of Makati
                    </div>
                    <button class="btn btn-warning" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="container">
                <ul class="nav nav-pills-custom">
                    <li class="nav-item">
                        <a class="nav-link" href="professor.html">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="student-management.html">
                            <i class="fas fa-user-graduate"></i> Student Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="activities.html">
                            <i class="fas fa-running"></i> Activities
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="lessons.html">
                            <i class="fas fa-book"></i> Lessons
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="monitoring.html">
                            <i class="fas fa-desktop"></i> Monitor Activities
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="grades.html">
                            <i class="fas fa-chart-bar"></i> Grades
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="container" style="margin-top: 30px; margin-bottom: 50px;">
            <div class="page-header">
                <h2 style="margin: 0; color: #1e3a8a;">
                    <i class="fas fa-user-graduate"></i> Student Management
                </h2>
                <p style="margin-top: 8px; color: #64748b;">View and manage students in your assigned sections</p>
            </div>
            
            <div class="mb-3">
                <label class="form-label" style="font-weight: 600;">Select Section</label>
                <select class="form-select" id="sectionFilter" onchange="loadStudents()">
                    <option value="">Loading sections...</option>
                </select>
            </div>
            
            <div class="table-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchStudents" placeholder="Search students by name or student number..." onkeyup="filterStudents()">
                </div>
                
                <div class="table-responsive">
                    <table class="custom-table" id="studentsTable">
                        <thead>
                            <tr>
                                <th>Student Number</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Section</th>
                                <th>Gender</th>
                                <th>Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="text-muted">Select a section to view students</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentProfessor = null;
        let allStudents = [];

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            
            if (user) {
                try {
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists() && userDoc.data().role === 'professor') {
                        currentProfessor = { id: user.uid, ...userDoc.data() };
                        await loadProfessorSections();
                        
                        loadingScreen.style.display = 'none';
                        mainContent.style.display = 'block';
                    } else {
                        alert('Access Denied');
                        await signOut(auth);
                        window.location.href = '/login/index.html';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading page');
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        async function loadProfessorSections() {
            try {
                const sectionsQuery = query(
                    collection(db, 'sections'),
                    where('professorId', '==', currentProfessor.id)
                );
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                const sectionSelect = document.getElementById('sectionFilter');
                sectionSelect.innerHTML = '<option value="">All Sections</option>';
                
                sectionsSnapshot.forEach(doc => {
                    const section = doc.data();
                    const option = document.createElement('option');
                    option.value = section.name;
                    option.textContent = `${section.name} (${section.studentCount || 0} students)`;
                    sectionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sections:', error);
            }
        }

        window.loadStudents = async function() {
            try {
                const selectedSection = document.getElementById('sectionFilter').value;
                
                let studentsQuery;
                if (selectedSection) {
                    studentsQuery = query(
                        collection(db, 'students'),
                        where('section', '==', selectedSection)
                    );
                } else {
                    const sectionsQuery = query(
                        collection(db, 'sections'),
                        where('professorId', '==', currentProfessor.id)
                    );
                    const sectionsSnapshot = await getDocs(sectionsQuery);
                    const sectionNames = [];
                    sectionsSnapshot.forEach(doc => {
                        sectionNames.push(doc.data().name);
                    });
                    
                    if (sectionNames.length === 0) {
                        renderStudentsTable([]);
                        return;
                    }
                    
                    studentsQuery = query(
                        collection(db, 'students'),
                        where('section', 'in', sectionNames)
                    );
                }
                
                const studentsSnapshot = await getDocs(studentsQuery);
                allStudents = [];
                
                studentsSnapshot.forEach(doc => {
                    allStudents.push({ id: doc.id, ...doc.data() });
                });
                
                renderStudentsTable(allStudents);
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        };

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">No students found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            students.forEach(student => {
                html += `
                    <tr>
                        <td>${student.studentNumber || 'N/A'}</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.email}</td>
                        <td>${student.section}</td>
                        <td>${student.gender || 'N/A'}</td>
                        <td>${student.contactNumber || 'N/A'}</td>
                        <td>
                            <button class="btn-action btn-view" onclick="viewStudentDetails('${student.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        window.filterStudents = function() {
            const searchTerm = document.getElementById('searchStudents').value.toLowerCase();
            const filteredStudents = allStudents.filter(student => {
                const fullName = `${student.firstName} ${student.lastName}`.toLowerCase();
                const studentNumber = (student.studentNumber || '').toLowerCase();
                return fullName.includes(searchTerm) || studentNumber.includes(searchTerm);
            });
            renderStudentsTable(filteredStudents);
        };

        window.viewStudentDetails = function(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                alert(`Student Details:\n\nName: ${student.firstName} ${student.lastName}\nStudent Number: ${student.studentNumber}\nEmail: ${student.email}\nSection: ${student.section}\nGender: ${student.gender}\nContact: ${student.contactNumber}`);
            }
        };

        window.handleLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                await signOut(auth);
                window.location.href = '/login/index.html';
            }
        };
    </script>
</body>
</html>