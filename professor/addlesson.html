<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Add Lesson</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; }
        
        /* Custom animations */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Navigation styles */
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom styles not covered by Tailwind */
        .gradient-text {
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* File preview styles */
        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .file-preview-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .file-preview-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .file-preview-details {
            flex: 1;
        }
        
        .file-preview-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .file-preview-size {
            font-size: 12px;
            color: #64748b;
        }
        
        .uploaded-file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .uploaded-file-item i {
            color: #2563eb;
        }
        
        .uploaded-file-item a {
            color: #1e40af;
            text-decoration: none;
            flex: 1;
        }
        
        .uploaded-file-item a:hover {
            text-decoration: underline;
        }
        
        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-published {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-draft {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-scheduled {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* YouTube preview styles */
        .youtube-preview-container {
            background: #f8fafc;
            border: 2px dashed #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .youtube-iframe {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            border: none;
        }
        
        @media (min-width: 768px) {
            .youtube-iframe {
                height: 250px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col justify-center items-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading Lesson Management...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- Navigation Banner - MATCHING GRADES PAGE -->
      <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4 py-3 sm:py-4">
            <!-- Logo -->
            <a href="#" class="flex items-center gap-2 sm:gap-3">
                <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                    UMakFit
                </span>
            </a>
            
            <!-- Desktop Navigation -->
            <div class="hidden lg:flex items-center gap-2 flex-wrap">
                <!-- Dashboard -->
                <a href="professor.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="fas fa-tachometer-alt"></i> 
                    <span>Dashboard</span>
                </a>
                
                <!-- Student Management -->
                <a href="studentmanagement.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="fas fa-users"></i> 
                    <span>Student Management</span>
                </a>
                
                <!-- Add Activities -->
                <a href="addactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="fas fa-dumbbell"></i> 
                    <span>Add Activities</span>
                </a>
                
                <!-- Add Lesson -->
                <a href="addlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="fas fa-book-open"></i> 
                    <span>Add Lesson</span>
                </a>
                
                <!-- Monitoring Activities -->
                <a href="monitoringactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="fas fa-chart-bar"></i> 
                    <span>Monitoring Activities</span>
                </a>
                
                <!-- Grades -->
                <a href="grades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="fas fa-graduation-cap"></i> 
                    <span>Grades</span>
                </a>
                
                <!-- Profile Dropdown -->
                <div class="relative">
                    <img src="" alt="Profile" id="profilePictureBtn"
                         class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                    
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                        <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                            <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                            <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                            <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                        </div>
                        <div class="p-2">
                            <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                            </a>
                            <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                            <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                <span class="font-medium text-sm sm:text-base">Logout</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Right Icons -->
            <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                <!-- Mobile Profile -->
                <div class="relative">
                    <img src="" alt="Profile" id="profilePictureBtnMobile"
                         class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                    
                    <!-- Mobile Profile Dropdown -->
                    <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                        <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                            <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                            <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                            <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                        </div>
                        <div class="p-2">
                            <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                            </a>
                            <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                            <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                <span class="font-medium text-sm sm:text-base">Logout</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Menu Button -->
                <button id="mobileMenuButton" class="text-white p-1 sm:p-2">
                    <i class="bi bi-list text-2xl sm:text-3xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2 pb-3">
            <a href="professor.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
            </a>
            <a href="studentmanagement.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                <i class="fas fa-users mr-2"></i> Student Management
            </a>
            <a href="addactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                <i class="fas fa-dumbbell mr-2"></i> Add Activities
            </a>
            <a href="addlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                <i class="fas fa-book-open mr-2"></i> Add Lesson
            </a>
            <a href="monitoringactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                <i class="fas fa-chart-bar mr-2"></i> Monitoring Activities
            </a>
            <a href="grades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                <i class="fas fa-graduation-cap mr-2"></i> Grades
            </a>
        </div>
    </div>
</nav>

        
        <!-- Main Content -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-10 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex items-center mb-5">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mr-4">
                            <i class="fas fa-book-open text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-blue-900 font-bold text-3xl">Lesson Management</h1>
                            <p class="text-gray-600 font-medium text-base mt-2">Create and manage educational lessons for your students</p>
                        </div>
                    </div>
                </div>

                <!-- Lessons Container -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-book"></i>
                            My Lessons
                        </h3>
                        <button class="mt-2 sm:mt-0 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="showAddLessonModal()">
                            <i class="fas fa-plus"></i>
                            <span>Create New Lesson</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="lessonsGrid">
                        <div class="col-span-3">
                            <div class="flex flex-col items-center justify-center py-12">
                                <div class="text-5xl mb-3 opacity-40">ðŸ“š</div>
                                <div class="text-gray-700 font-semibold mb-1">No Lessons Created Yet</div>
                                <div class="text-gray-500 text-sm text-center max-w-md">
                                    You haven't created any lessons yet.<br>
                                    Click "Create New Lesson" button above to get started!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-950 mt-10 py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h4 class="text-yellow-500 font-bold text-lg text-center mb-5">About CTBL</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The Center for Technology Based Learning serves as the learning management system operating hub, 
                        reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                        center's daily operations.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        Working closely with the Office of the President, the Center for Information Technology, and the 
                        Deans and Directors to support the LMS end-users' day-to-day activity.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The center focuses on implementing new forms of training and determining the validity of data to 
                        support the university's educational objectives.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lesson Modal -->
    <div class="modal-overlay" id="lessonModal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900" id="modalTitle">Create New Lesson</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="closeLessonModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="lessonForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Lesson Title <span class="text-red-500">*</span></label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonTitle" required placeholder="Enter lesson title">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Section <span class="text-red-500">*</span></label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonSection" required>
                                <option value="">Select Section</option>
                            </select>
                            <small class="text-gray-600 mt-1 block" id="sectionStudentInfo"></small>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Lesson Type</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonType">
                            <option value="lecture">Lecture</option>
                            <option value="reading">Reading Material</option>
                            <option value="video">Video Lesson</option>
                            <option value="quiz">Quiz</option>
                            <option value="assignment">Assignment</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Description</label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonDescription" rows="3" placeholder="Brief description of the lesson"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Content <span class="text-red-500">*</span></label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonContent" rows="6" required placeholder="Enter lesson content..."></textarea>
                        <small class="text-gray-500 text-xs mt-1">You can use HTML formatting for rich text content</small>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">YouTube Video Link (Optional)</label>
                        <input type="url" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               id="youtubeLink" 
                               placeholder="https://www.youtube.com/watch?v=..." 
                               pattern="https?://(www\.)?(youtube\.com|youtu\.be)/.+">
                        <small class="text-gray-500 text-xs mt-1 block">
                            ðŸ“¹ Paste a full YouTube URL (e.g., https://www.youtube.com/watch?v=VIDEO_ID)
                        </small>
                        <div id="youtubePreview" class="mt-3"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Publish Date</label>
                            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="publishDate">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonStatus">
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Upload Files (Optional)</label>
                        <input type="file" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="lessonFiles" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png">
                        <small class="text-gray-500 text-xs mt-1 block">
                            ðŸ“Ž Supported: PDF, Word, PowerPoint, Images (Max 50MB per file)
                        </small>
                        <div id="filePreviewContainer" class="mt-3"></div>
                    </div>
                    
                    <input type="hidden" id="lessonId">
                </form>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" onclick="closeLessonModal()">Cancel</button>
                <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" id="saveLessonBtn" onclick="saveLesson()">Create Lesson</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, addDoc, updateDoc, deleteDoc, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentProfessor = null;
        let assignedSections = [];
        let allLessons = [];
        let editingLessonId = null;
        let selectedFiles = [];

        // DOM Elements for navigation
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        // Event Listeners for navigation
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile menu toggle
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', toggleMobileMenu);
            }
            
            // Profile dropdowns
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', closeAllDropdowns);
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        // Profile dropdown
        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 1024;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                document.body.classList.add('dropdown-open');
            } else {
                dropdown.classList.add('hidden');
                document.body.classList.remove('dropdown-open');
            }
        }

        function closeProfileDropdown() {
            profileDropdown.classList.add('hidden');
            profileDropdownMobile.classList.add('hidden');
            document.body.classList.remove('dropdown-open');
        }

        // Close all dropdowns when clicking outside
        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        // View profile function
        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        // Logout function
        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        // Function to update profile picture with Google photo
        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = currentProfessor?.fullName || currentProfessor?.name || userName || 'Professor';
            const email = currentProfessor?.email || 'professor@umak.edu.ph';
            
            // Use provided photo URL or create initial avatar
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            // Update all profile pictures
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            // Update names
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            // Update emails
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        // Function para i-validate at mag-extract ng YouTube ID
        function extractYouTubeId(url) {
            if (!url || typeof url !== 'string') return null;
            
            // Clean the URL
            const cleanUrl = url.trim();
            if (!cleanUrl) return null;
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
                /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /(?:youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
                /(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
                /(?:youtube\.com\/live\/)([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = cleanUrl.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            // Try to extract from any YouTube URL format
            const urlObj = new URL(cleanUrl);
            if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('youtu.be')) {
                if (urlObj.pathname.includes('/watch') && urlObj.searchParams.get('v')) {
                    return urlObj.searchParams.get('v');
                } else if (urlObj.pathname.includes('/embed/')) {
                    return urlObj.pathname.split('/embed/')[1]?.split('?')[0];
                } else if (urlObj.hostname.includes('youtu.be')) {
                    return urlObj.pathname.substring(1);
                }
            }
            
            return null;
        }

        // Function para mag-show ng YouTube preview
        function showYouTubePreview(url) {
            const previewDiv = document.getElementById('youtubePreview');
            const videoId = extractYouTubeId(url);
            
            if (videoId && previewDiv) {
                previewDiv.innerHTML = `
                    <div class="youtube-preview-container">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fab fa-youtube text-red-600 text-xl"></i>
                            <span class="text-sm font-medium text-gray-700">YouTube Preview:</span>
                        </div>
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}" 
                            class="youtube-iframe"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen
                            title="YouTube video preview">
                        </iframe>
                        <p class="text-xs text-gray-500 mt-3">
                            <i class="fas fa-info-circle mr-1"></i> Video will be embedded in the lesson and playable directly
                        </p>
                    </div>
                `;
            } else if (previewDiv) {
                previewDiv.innerHTML = '';
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('User authenticated:', user.email);
                    
                    // Update profile picture with Google photo
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    currentProfessor = { id: user.uid, email: user.email };
                    
                    await loadProfessorData();
                    await loadAssignedSections();
                    await loadLessons();
                    
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                    // Initialize file input
                    const fileInput = document.getElementById('lessonFiles');
                    if (fileInput) {
                        fileInput.addEventListener('change', handleFileSelection);
                    }
                    
                    // Initialize section dropdown listener
                    const sectionSelect = document.getElementById('lessonSection');
                    if (sectionSelect) {
                        sectionSelect.addEventListener('change', function() {
                            updateSectionStudentInfo();
                        });
                    }
                    
                    // Initialize YouTube link listener
                    const youtubeInput = document.getElementById('youtubeLink');
                    if (youtubeInput) {
                        youtubeInput.addEventListener('input', function(e) {
                            showYouTubePreview(e.target.value);
                        });
                    }
                    
                } catch (error) {
                    console.error('Error loading lesson management:', error);
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    alert('Error loading lesson data: ' + error.message);
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            const maxSize = 50 * 1024 * 1024; // 50MB
            
            files.forEach(file => {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 50MB.`);
                    return;
                }
                
                const exists = selectedFiles.find(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            });
            
            displayFilePreview();
            event.target.value = '';
        }

        function displayFilePreview() {
            const container = document.getElementById('filePreviewContainer');
            if (!container) return;
            
            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="mb-2"><strong class="text-sm text-gray-700">Selected Files:</strong></div>';
            
            selectedFiles.forEach((file, index) => {
                const size = formatFileSize(file.size);
                const icon = getFileIcon(file.name);
                
                html += `
                    <div class="file-preview-item">
                        <div class="file-preview-info">
                            <div class="file-preview-icon">
                                <i class="${icon}"></i>
                            </div>
                            <div class="file-preview-details">
                                <div class="file-preview-name">${file.name}</div>
                                <div class="file-preview-size">${size}</div>
                            </div>
                        </div>
                        <button type="button" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200" onclick="removeSelectedFile(${index})">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.removeSelectedFile = function(index) {
            selectedFiles.splice(index, 1);
            displayFilePreview();
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',
                'ppt': 'fas fa-file-powerpoint',
                'pptx': 'fas fa-file-powerpoint',
                'xls': 'fas fa-file-excel',
                'xlsx': 'fas fa-file-excel',
                'jpg': 'fas fa-file-image',
                'jpeg': 'fas fa-file-image',
                'png': 'fas fa-file-image',
                'gif': 'fas fa-file-image',
                'mp4': 'fas fa-file-video',
                'avi': 'fas fa-file-video',
                'mov': 'fas fa-file-video',
                'zip': 'fas fa-file-archive',
                'rar': 'fas fa-file-archive'
            };
            return iconMap[ext] || 'fas fa-file';
        }

        async function loadProfessorData() {
            try {
                const professorsQuery = query(
                    collection(db, 'professors'),
                    where('email', '==', currentProfessor.email)
                );
                const professorsSnapshot = await getDocs(professorsQuery);
                
                if (!professorsSnapshot.empty) {
                    const professorData = professorsSnapshot.docs[0].data();
                    currentProfessor = {
                        ...currentProfessor,
                        name: professorData.fullName || professorData.name,
                        fullName: professorData.fullName || professorData.name,
                        firstName: professorData.firstName,
                        lastName: professorData.lastName
                    };
                } else {
                    const userRef = doc(db, 'users', currentProfessor.id);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.role !== 'professor') {
                            await signOut(auth);
                            window.location.href = '/login/index.html';
                            return;
                        }
                        
                        currentProfessor = {
                            ...currentProfessor,
                            name: userData.name || userData.fullName,
                            fullName: userData.name || userData.fullName
                        };
                    }
                }
            } catch (error) {
                console.error('Error loading professor data:', error);
            }
        }

        async function loadAssignedSections() {
            try {
                assignedSections = [];
                
                console.log('Loading sections for professor:', currentProfessor.email);
                
                let professorFullName = null;
                
                const professorsQuery = query(
                    collection(db, 'professors'),
                    where('email', '==', currentProfessor.email)
                );
                const professorsSnapshot = await getDocs(professorsQuery);
                
                if (!professorsSnapshot.empty) {
                    const profData = professorsSnapshot.docs[0].data();
                    professorFullName = profData.fullName || profData.name;
                }
                
                if (!professorFullName) {
                    const userRef = doc(db, 'users', currentProfessor.id);
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        professorFullName = userData.name || userData.fullName;
                    }
                }
                
                const sectionsQuery = query(collection(db, 'sections'));
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                for (const docSnap of sectionsSnapshot.docs) {
                    const sectionData = docSnap.data();
                    
                    const sectionProfessor = sectionData.professor || '';
                    const isProfessorMatch = 
                        sectionProfessor === professorFullName ||
                        sectionProfessor.toLowerCase() === professorFullName?.toLowerCase() ||
                        (professorFullName && sectionProfessor.toLowerCase().includes(professorFullName.toLowerCase()));
                    
                    if (isProfessorMatch) {
                        const studentList = Array.isArray(sectionData.students) ? sectionData.students : [];
                        const studentCount = studentList.length;
                        
                        assignedSections.push({
                            id: docSnap.id,
                            section: sectionData.name,
                            students: studentCount,
                            studentList: studentList,
                            courseCode: sectionData.courseCode || 'PE 3',
                            professor: sectionProfessor
                        });
                    }
                }
                
                const sectionSelect = document.getElementById('lessonSection');
                if (!sectionSelect) return;
                
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
                
                if (assignedSections.length === 0) {
                    sectionSelect.innerHTML = '<option value="">No sections assigned</option>';
                } else {
                    assignedSections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section.section;
                        const count = section.students || 0;
                        option.textContent = `${section.section} (${count} student${count !== 1 ? 's' : ''})`;
                        sectionSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error loading assigned sections:', error);
            }
        }

        function updateSectionStudentInfo() {
            const selectedSection = document.getElementById('lessonSection').value;
            const sectionInfo = assignedSections.find(s => s.section === selectedSection);
            const infoElement = document.getElementById('sectionStudentInfo');
            
            if (sectionInfo && infoElement) {
                const studentCount = sectionInfo.students || 0;
                if (studentCount > 0) {
                    infoElement.textContent = `âœ“ This lesson will be available to ${studentCount} student${studentCount !== 1 ? 's' : ''} in this section`;
                    infoElement.className = 'text-green-600 text-xs mt-1 font-medium';
                } else {
                    infoElement.textContent = 'âš ï¸ No students enrolled in this section';
                    infoElement.className = 'text-yellow-600 text-xs mt-1 font-medium';
                }
            } else if (infoElement) {
                infoElement.textContent = '';
            }
        }

        async function loadLessons() {
            try {
                allLessons = [];
                
                const lessonsQuery = query(
                    collection(db, 'lessons'),
                    where('professorEmail', '==', currentProfessor.email)
                );
                
                const lessonsSnapshot = await getDocs(lessonsQuery);
                
                lessonsSnapshot.forEach(docSnap => {
                    const lesson = docSnap.data();
                    allLessons.push({
                        id: docSnap.id,
                        ...lesson,
                        createdAt: lesson.createdAt?.toDate() || new Date(),
                        publishDate: lesson.publishDate?.toDate() || null,
                        updatedAt: lesson.updatedAt?.toDate() || null
                    });
                });
                
                allLessons.sort((a, b) => b.createdAt - a.createdAt);
                displayLessons();
                
            } catch (error) {
                console.error('Error loading lessons:', error);
                alert('Error loading lessons: ' + error.message);
                displayLessons();
            }
        }

        function displayLessons() {
            const lessonsGrid = document.getElementById('lessonsGrid');
            
            if (allLessons.length === 0) {
                lessonsGrid.innerHTML = `
                    <div class="col-span-3">
                        <div class="flex flex-col items-center justify-center py-12">
                            <div class="text-5xl mb-3 opacity-40">ðŸ“š</div>
                            <div class="text-gray-700 font-semibold mb-1">No Lessons Created Yet</div>
                            <div class="text-gray-500 text-sm text-center max-w-md">
                                You haven't created any lessons yet.<br>
                                Click "Create New Lesson" button above to get started!
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            allLessons.forEach(lesson => {
                const date = lesson.publishDate ? 
                    lesson.publishDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    lesson.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                const contentPreview = lesson.content && lesson.content.length > 120 ? 
                    lesson.content.substring(0, 120) + '...' : 
                    (lesson.content || 'No content');
                
                let badgeClass = 'badge-draft';
                let badgeText = lesson.status || 'draft';
                if (lesson.status === 'published') {
                    badgeClass = 'badge-published';
                    badgeText = 'Published';
                } else if (lesson.status === 'scheduled') {
                    badgeClass = 'badge-scheduled';
                    badgeText = 'Scheduled';
                } else {
                    badgeText = 'Draft';
                }
                
                const hasFiles = lesson.materials && lesson.materials.length > 0;
                const fileCount = hasFiles ? lesson.materials.length : 0;
                const hasYouTube = lesson.youtubeVideoId && lesson.youtubeVideoId.trim() !== '';
                
                html += `
                    <div class="bg-gray-50 rounded-xl border border-gray-200 p-5 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:border-blue-500">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-gray-900 font-bold text-lg">${lesson.title || 'Untitled Lesson'}</h4>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                        
                        <div class="space-y-1 mb-3 text-sm text-gray-600">
                            <div class="flex items-center gap-2"><i class="fas fa-chalkboard-teacher w-4"></i> ${lesson.section || 'No Section'}</div>
                            <div class="flex items-center gap-2"><i class="fas fa-calendar-alt w-4"></i> ${date}</div>
                            <div class="flex items-center gap-2"><i class="fas fa-tag w-4"></i> ${lesson.type || 'lecture'}</div>
                            ${hasYouTube ? `
                                <div class="flex items-center gap-2">
                                    <i class="fab fa-youtube text-red-600 w-4"></i> 
                                    <span>Includes Video</span>
                                </div>
                            ` : ''}
                            ${hasFiles ? `<div class="flex items-center gap-2"><i class="fas fa-paperclip w-4"></i> ${fileCount} file${fileCount > 1 ? 's' : ''}</div>` : ''}
                        </div>
                        
                        ${lesson.description ? `
                            <div class="mb-3">
                                <div class="text-blue-900 font-medium text-sm mb-1">Description:</div>
                                <div class="text-gray-700 text-sm">${lesson.description}</div>
                            </div>
                        ` : ''}
                        
                        <div class="mb-3">
                            <div class="text-blue-900 font-medium text-sm mb-1">Content Preview:</div>
                            <div class="text-gray-700 text-sm">${contentPreview}</div>
                        </div>
                        
                        ${hasFiles ? `
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="text-blue-900 font-medium text-sm mb-2 flex items-center gap-1">
                                    <i class="fas fa-folder-open"></i> Attached Files:
                                </div>
                                <div class="space-y-1">
                                    ${lesson.materials.map((file, index) => `
                                        <div class="uploaded-file-item">
                                            <i class="${getFileIcon(file.name)}"></i>
                                            <a href="#" onclick="viewFile('${lesson.id}', ${index}); return false;">${file.name}</a>
                                            <span class="text-xs text-gray-500">${formatFileSize(file.size)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                            <div class="flex gap-2">
                                <button class="px-3 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600 flex items-center gap-1" onclick="editLesson('${lesson.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 flex items-center gap-1" onclick="deleteLesson('${lesson.id}')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                            <div>
                                ${lesson.status === 'published' ? `
                                    <button class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1" onclick="viewLessonDetails('${lesson.id}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                ` : `
                                    <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 flex items-center gap-1" onclick="publishLesson('${lesson.id}')">
                                        <i class="fas fa-paper-plane"></i> Publish
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            lessonsGrid.innerHTML = html;
        }

        window.showAddLessonModal = function() {
            editingLessonId = null;
            selectedFiles = [];
            document.getElementById('modalTitle').textContent = 'Create New Lesson';
            document.getElementById('saveLessonBtn').textContent = 'Create Lesson';
            
            document.getElementById('lessonForm').reset();
            document.getElementById('lessonId').value = '';
            document.getElementById('filePreviewContainer').innerHTML = '';
            document.getElementById('sectionStudentInfo').textContent = '';
            document.getElementById('youtubePreview').innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('publishDate').value = today;
            
            document.getElementById('lessonModal').style.display = 'flex';
        };

        window.closeLessonModal = function() {
            document.getElementById('lessonModal').style.display = 'none';
            editingLessonId = null;
            selectedFiles = [];
            document.getElementById('filePreviewContainer').innerHTML = '';
        };

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        window.viewFile = function(lessonId, fileIndex) {
            const lesson = allLessons.find(l => l.id === lessonId);
            if (!lesson || !lesson.materials || !lesson.materials[fileIndex]) {
                alert('File not found');
                return;
            }
            
            const file = lesson.materials[fileIndex];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.style.zIndex = '3000';
            
            let content = '';
            
            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                content = `
                    <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-900">${file.name}</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6" style="overflow: auto; max-height: calc(90vh - 120px);">
                            <img src="${file.data}" alt="${file.name}" class="max-w-full h-auto">
                        </div>
                        <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                            <a href="${file.data}" download="${file.name}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        </div>
                    </div>
                `;
            } else if (fileExt === 'pdf') {
                content = `
                    <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-900">${file.name}</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-0" style="height: calc(90vh - 120px);">
                            <iframe src="${file.data}" class="w-full h-full border-0"></iframe>
                        </div>
                        <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                            <a href="${file.data}" download="${file.name}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-900">${file.name}</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.modal-overlay').remove()">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-10 text-center">
                            <i class="${getFileIcon(file.name)} text-6xl text-blue-500 mb-4"></i>
                            <p class="text-gray-600 mb-2">Preview not available for this file type.</p>
                            <p class="text-gray-500 text-sm">Click download to view the file.</p>
                        </div>
                        <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                            <a href="${file.data}" download="${file.name}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        };

        async function saveLesson() {
            const title = document.getElementById('lessonTitle').value.trim();
            const section = document.getElementById('lessonSection').value;
            const type = document.getElementById('lessonType').value;
            const description = document.getElementById('lessonDescription').value.trim();
            const content = document.getElementById('lessonContent').value.trim();
            const youtubeLink = document.getElementById('youtubeLink').value.trim();
            const publishDate = document.getElementById('publishDate').value;
            const status = document.getElementById('lessonStatus').value;

            if (!title || !section || !content) {
                alert('Please fill in all required fields: Title, Section, and Content');
                return;
            }

            const sectionInfo = assignedSections.find(s => s.section === section);
            if (!sectionInfo || !sectionInfo.studentList || sectionInfo.studentList.length === 0) {
                if (!confirm('Warning: This section has no students. Continue anyway?')) {
                    return;
                }
            }

            try {
                const saveBtn = document.getElementById('saveLessonBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                let newUploadedFiles = [];
                const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB limit
                
                if (selectedFiles.length > 0) {
                    console.log(`Processing ${selectedFiles.length} new files...`);
                    
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        
                        if (file.size > MAX_FILE_SIZE) {
                            newUploadedFiles.push({
                                name: file.name,
                                data: '',
                                size: file.size,
                                type: file.type || 'application/octet-stream',
                                uploadedAt: new Date().toISOString(),
                                note: 'File too large - please upload to cloud storage'
                            });
                            console.warn(`File ${file.name} exceeds size limit, metadata only stored`);
                            continue;
                        }
                        
                        try {
                            const base64Data = await fileToBase64(file);
                            
                            const fileObject = {
                                name: file.name,
                                data: base64Data,
                                size: file.size,
                                type: file.type || 'application/octet-stream',
                                uploadedAt: new Date().toISOString()
                            };
                            
                            JSON.stringify(fileObject);
                            newUploadedFiles.push(fileObject);
                            
                        } catch (fileError) {
                            console.error(`Error processing file ${file.name}:`, fileError);
                            alert(`Failed to process file: ${file.name}\nError: ${fileError.message}`);
                        }
                    }
                }

                saveBtn.textContent = 'Saving lesson...';

                // Extract YouTube ID
                const youtubeVideoId = extractYouTubeId(youtubeLink);

                const lessonData = {
                    title: title,
                    section: section,
                    type: type,
                    description: description,
                    content: content,
                    youtubeLink: youtubeLink || '',
                    youtubeVideoId: youtubeVideoId || '',
                    publishDate: publishDate ? new Date(publishDate) : new Date(),
                    status: status,
                    professorEmail: currentProfessor.email,
                    professorName: currentProfessor.name || currentProfessor.fullName || 'Professor',
                    professorId: currentProfessor.id,
                    materials: [],
                    updatedAt: serverTimestamp()
                };

                let lessonId;
                let isNew = false;

                if (editingLessonId) {
                    const lessonRef = doc(db, 'lessons', editingLessonId);
                    const existingDoc = await getDoc(lessonRef);
                    
                    if (existingDoc.exists()) {
                        const existingData = existingDoc.data();
                        let existingMaterials = existingData.materials || [];
                        
                        existingMaterials = existingMaterials.map(m => ({
                            name: String(m.name || ''),
                            data: String(m.data || ''),
                            size: Number(m.size || 0),
                            type: String(m.type || 'application/octet-stream'),
                            uploadedAt: String(m.uploadedAt || new Date().toISOString())
                        }));
                        
                        lessonData.materials = [...existingMaterials, ...newUploadedFiles];
                    } else {
                        lessonData.materials = newUploadedFiles;
                    }
                    
                    await updateDoc(lessonRef, lessonData);
                    lessonId = editingLessonId;
                    
                } else {
                    lessonData.createdAt = serverTimestamp();
                    lessonData.materials = newUploadedFiles;
                    
                    const docRef = await addDoc(collection(db, 'lessons'), lessonData);
                    lessonId = docRef.id;
                    isNew = true;
                }

                if (status === 'published') {
                    await createLessonNotification(lessonData, lessonId);
                }

                closeLessonModal();
                selectedFiles = [];
                
                let successMsg = `Lesson ${isNew ? 'created' : 'updated'} successfully!`;
                if (newUploadedFiles.length > 0) successMsg += ` ${newUploadedFiles.length} file(s) added.`;
                if (youtubeVideoId) successMsg += ` YouTube video embedded.`;
                
                alert(successMsg);
                
                await loadLessons();
                
            } catch (error) {
                console.error('Error saving lesson:', error);
                
                let errorMsg = 'Error saving lesson: ';
                if (error.code === 'invalid-argument') {
                    errorMsg += 'One or more files are too large or contain invalid data. Please try with smaller files.';
                } else {
                    errorMsg += error.message;
                }
                
                alert(errorMsg);
                
                const saveBtn = document.getElementById('saveLessonBtn');
                saveBtn.disabled = false;
                saveBtn.textContent = editingLessonId ? 'Update Lesson' : 'Create Lesson';
            }
        }

        async function createLessonNotification(lessonData, lessonId) {
            try {
                const sectionInfo = assignedSections.find(s => s.section === lessonData.section);
                
                if (!sectionInfo || !sectionInfo.studentList || sectionInfo.studentList.length === 0) {
                    console.log('No students found in section');
                    return;
                }
                
                console.log(`Creating notifications for ${sectionInfo.studentList.length} students in ${lessonData.section}`);
                
                const notificationPromises = sectionInfo.studentList.map(student => {
                    const notificationData = {
                        type: 'new_lesson',
                        title: `New Lesson: ${lessonData.title}`,
                        message: `A new ${lessonData.type} lesson "${lessonData.title}" has been published for ${lessonData.section}.`,
                        section: lessonData.section,
                        lessonId: lessonId,
                        lessonTitle: lessonData.title,
                        professorEmail: currentProfessor.email,
                        studentEmail: student.email,
                        studentId: student.studentId || student.uid || student.email,
                        isRead: false,
                        createdAt: serverTimestamp()
                    };
                    
                    return addDoc(collection(db, 'notifications'), notificationData);
                });
                
                await Promise.all(notificationPromises);
                console.log(`âœ“ Successfully created ${notificationPromises.length} notifications`);
                
            } catch (error) {
                console.error('Error creating notifications:', error);
                alert('Lesson saved but failed to create some notifications. Students may not be notified.');
            }
        }

        async function editLesson(lessonId) {
            try {
                const lesson = allLessons.find(l => l.id === lessonId);
                if (!lesson) {
                    alert('Lesson not found');
                    return;
                }

                editingLessonId = lessonId;
                selectedFiles = [];
                
                document.getElementById('modalTitle').textContent = 'Edit Lesson';
                document.getElementById('saveLessonBtn').textContent = 'Update Lesson';

                document.getElementById('lessonTitle').value = lesson.title || '';
                document.getElementById('lessonSection').value = lesson.section || '';
                document.getElementById('lessonType').value = lesson.type || 'lecture';
                document.getElementById('lessonDescription').value = lesson.description || '';
                document.getElementById('lessonContent').value = lesson.content || '';
                document.getElementById('youtubeLink').value = lesson.youtubeLink || '';
                
                if (lesson.youtubeLink) {
                    showYouTubePreview(lesson.youtubeLink);
                }
                
                if (lesson.publishDate) {
                    const date = new Date(lesson.publishDate);
                    const formattedDate = date.toISOString().split('T')[0];
                    document.getElementById('publishDate').value = formattedDate;
                } else {
                    document.getElementById('publishDate').value = '';
                }
                
                document.getElementById('lessonStatus').value = lesson.status || 'draft';
                document.getElementById('lessonId').value = lessonId;

                const filePreviewContainer = document.getElementById('filePreviewContainer');
                if (lesson.materials && lesson.materials.length > 0) {
                    let html = '<div class="mb-2"><strong class="text-sm text-gray-700">Existing Files:</strong></div>';
                    
                    lesson.materials.forEach((file, index) => {
                        const size = formatFileSize(file.size);
                        const icon = getFileIcon(file.name);
                        
                        html += `
                            <div class="file-preview-item" style="background: #e0f2fe; border-color: #93c5fd;">
                                <div class="file-preview-info">
                                    <div class="file-preview-icon" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
                                        <i class="${icon}"></i>
                                    </div>
                                    <div class="file-preview-details">
                                        <div class="file-preview-name">${file.name}</div>
                                        <div class="file-preview-size">${size}</div>
                                    </div>
                                </div>
                                <button type="button" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200" onclick="removeExistingFile('${lessonId}', ${index})">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        `;
                    });
                    
                    filePreviewContainer.innerHTML = html;
                } else {
                    filePreviewContainer.innerHTML = '';
                }

                document.getElementById('lessonModal').style.display = 'flex';
                
                setTimeout(() => {
                    const fileInput = document.getElementById('lessonFiles');
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    updateSectionStudentInfo();
                }, 100);
                
            } catch (error) {
                console.error('Error loading lesson for editing:', error);
                alert('Error loading lesson: ' + error.message);
            }
        }

        window.removeExistingFile = async function(lessonId, fileIndex) {
            if (!confirm('Are you sure you want to remove this file?')) {
                return;
            }
            
            try {
                const lesson = allLessons.find(l => l.id === lessonId);
                if (!lesson || !lesson.materials) return;
                
                lesson.materials.splice(fileIndex, 1);
                
                const lessonRef = doc(db, 'lessons', lessonId);
                await updateDoc(lessonRef, {
                    materials: lesson.materials,
                    updatedAt: serverTimestamp()
                });
                
                await loadLessons();
                
                const filePreviewContainer = document.getElementById('filePreviewContainer');
                const updatedLesson = allLessons.find(l => l.id === lessonId);
                
                if (updatedLesson.materials && updatedLesson.materials.length > 0) {
                    let html = '<div class="mb-2"><strong class="text-sm text-gray-700">Existing Files:</strong></div>';
                    
                    updatedLesson.materials.forEach((file, index) => {
                        const size = formatFileSize(file.size);
                        const icon = getFileIcon(file.name);
                        
                        html += `
                            <div class="file-preview-item" style="background: #e0f2fe; border-color: #93c5fd;">
                                <div class="file-preview-info">
                                    <div class="file-preview-icon" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
                                        <i class="${icon}"></i>
                                    </div>
                                    <div class="file-preview-details">
                                        <div class="file-preview-name">${file.name}</div>
                                        <div class="file-preview-size">${size}</div>
                                    </div>
                                </div>
                                <button type="button" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200" onclick="removeExistingFile('${lessonId}', ${index})">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        `;
                    });
                    
                    filePreviewContainer.innerHTML = html;
                } else {
                    filePreviewContainer.innerHTML = '<div class="mb-2"><strong class="text-sm text-gray-700">No files attached</strong></div>';
                }
                
                alert('File removed successfully!');
            } catch (error) {
                console.error('Error removing file:', error);
                alert('Error removing file: ' + error.message);
            }
        };

        async function deleteLesson(lessonId) {
            if (!confirm('Are you sure you want to delete this lesson? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'lessons', lessonId));
                alert('Lesson deleted successfully!');
                await loadLessons();
                
            } catch (error) {
                console.error('Error deleting lesson:', error);
                alert('Error deleting lesson: ' + error.message);
            }
        }

        async function publishLesson(lessonId) {
            try {
                const lesson = allLessons.find(l => l.id === lessonId);
                if (!lesson) return;

                if (lesson.status !== 'published') {
                    const lessonRef = doc(db, 'lessons', lessonId);
                    await updateDoc(lessonRef, {
                        status: 'published',
                        publishDate: new Date(),
                        updatedAt: serverTimestamp()
                    });

                    await createLessonNotification(lesson, lessonId);
                    
                    alert('Lesson published successfully!');
                    await loadLessons();
                } else {
                    alert(`Viewing lesson: ${lesson.title}\n\nThis would open the lesson view page for students.`);
                }
                
            } catch (error) {
                console.error('Error publishing lesson:', error);
                alert('Error publishing lesson: ' + error.message);
            }
        }

        window.viewLessonDetails = function(lessonId) {
            const lesson = allLessons.find(l => l.id === lessonId);
            if (!lesson) {
                alert('Lesson not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.style.zIndex = '3000';
            
            const date = lesson.publishDate ? 
                lesson.publishDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 
                lesson.createdAt.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="flex justify-between items-center p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-book-open mr-2"></i> ${lesson.title}</h3>
                        <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6" style="max-height: 70vh; overflow-y: auto;">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-5 rounded-lg mb-5">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><i class="fas fa-chalkboard-teacher"></i> <strong>Section:</strong> ${lesson.section}</div>
                                <div><i class="fas fa-calendar-alt"></i> <strong>Date:</strong> ${date}</div>
                                <div><i class="fas fa-tag"></i> <strong>Type:</strong> ${lesson.type}</div>
                                <div><i class="fas fa-info-circle"></i> <strong>Status:</strong> ${lesson.status}</div>
                            </div>
                        </div>
                        
                        ${lesson.description ? `
                            <div class="mb-5">
                                <h4 class="text-blue-900 font-medium mb-2 flex items-center gap-2"><i class="fas fa-align-left"></i> Description</h4>
                                <p class="text-gray-700">${lesson.description}</p>
                            </div>
                        ` : ''}
                        
                        ${lesson.youtubeVideoId ? `
                            <div class="mb-5">
                                <h4 class="text-blue-900 font-medium mb-2 flex items-center gap-2">
                                    <i class="fab fa-youtube text-red-600"></i> YouTube Video
                                </h4>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <div class="aspect-w-16 aspect-h-9">
                                        <iframe 
                                            src="https://www.youtube.com/embed/${lesson.youtubeVideoId}" 
                                            class="w-full h-64 rounded"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                            allowfullscreen
                                            title="YouTube video player">
                                        </iframe>
                                    </div>
                                    ${lesson.youtubeLink ? `
                                        <p class="text-sm text-gray-600 mt-2">
                                            <a href="${lesson.youtubeLink}" target="_blank" class="text-blue-600 hover:underline">
                                                <i class="fas fa-external-link-alt mr-1"></i> Open in YouTube
                                            </a>
                                        </p>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="mb-5">
                            <h4 class="text-blue-900 font-medium mb-2 flex items-center gap-2"><i class="fas fa-file-alt"></i> Lesson Content</h4>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-700">
                                ${lesson.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        ${lesson.materials && lesson.materials.length > 0 ? `
                            <div>
                                <h4 class="text-blue-900 font-medium mb-2 flex items-center gap-2"><i class="fas fa-paperclip"></i> Attached Files (${lesson.materials.length})</h4>
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    ${lesson.materials.map((file, index) => `
                                        <div class="uploaded-file-item bg-white mb-2">
                                            <i class="${getFileIcon(file.name)}"></i>
                                            <a href="#" onclick="viewFile('${lesson.id}', ${index}); return false;">${file.name}</a>
                                            <span class="text-xs text-gray-500">${formatFileSize(file.size)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                        <button class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center gap-2" onclick="this.closest('.modal-overlay').remove(); editLesson('${lesson.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // Make functions globally available
        window.saveLesson = saveLesson;
        window.editLesson = editLesson;
        window.deleteLesson = deleteLesson;
        window.publishLesson = publishLesson;
        window.viewLessonDetails = viewLessonDetails;
        window.viewFile = viewFile;
    </script>
</body>
</html>