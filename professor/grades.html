<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Grades Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; 
        }
        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Custom animations */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }
        
        @keyframes bounceSlow {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 1s ease-out;
        }
        
        .animate-slide-in-left {
            animation: slideInLeft 1s ease-out;
        }
        
        .animate-slide-in-right {
            animation: slideInRight 1s ease-out;
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        .animate-float-delayed {
            animation: float 6s ease-in-out infinite 3s;
        }
        
        .animate-bounce-slow {
            animation: bounceSlow 2s ease-in-out infinite;
        }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Hamburger Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            z-index: 60;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Mobile Drawer */
        .mobile-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);
            z-index: 55;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .mobile-drawer.active {
            right: 0;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .desktop-nav {
                display: none;
            }
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            width: 100%;
        }
        
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        /* Desktop table */
        @media screen and (min-width: 769px) {
            .custom-table {
                min-width: 800px;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .custom-table thead {
                background: linear-gradient(90deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%);
            }
            
            .custom-table th {
                font-weight: 600;
                color: white;
                font-size: 14px;
                text-align: left;
                padding: 15px 12px;
                border-bottom: 2px solid #e2e8f0;
                white-space: nowrap;
                cursor: pointer;
                user-select: none;
            }
            
            .custom-table th:hover {
                background-color: rgba(255,255,255,0.1);
            }
            
            .custom-table td {
                font-weight: 400;
                color: #000;
                font-size: 14px;
                padding: 16px 12px;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .custom-table tbody tr {
                transition: all 0.2s ease;
            }
            
            .custom-table tbody tr:hover {
                background-color: #f8fafc;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            }
        }
        
        /* Mobile Responsive Table */
        @media screen and (max-width: 768px) {
            .table-responsive {
                overflow-x: visible;
                border: none;
                background: transparent;
            }
            
            .custom-table {
                min-width: 0;
                width: 100%;
                background: transparent;
                border: none;
            }
            
            .custom-table thead {
                display: none;
            }
            
            .custom-table tbody tr {
                display: block;
                margin-bottom: 16px;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                background: white;
                padding: 16px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .custom-table tbody tr:active {
                transform: translateY(2px);
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            }
            
            .custom-table tbody td {
                display: block;
                padding: 12px 8px 12px 45%;
                border: none;
                border-bottom: 1px solid #f1f5f9;
                text-align: left;
                position: relative;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .custom-table tbody td:before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: 40%;
                font-weight: 600;
                color: #4b5563;
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .custom-table tbody td:last-child {
                border-bottom: none;
                justify-content: flex-end;
                padding-left: 12px;
            }
            
            .custom-table tbody td:last-child:before {
                display: none;
            }
            
            /* Hide test count badge position */
            .custom-table tbody td:first-child {
                position: relative;
            }
        }
        
        /* Grade colors */
        .grade-excellent { color: #10b981; font-weight: 600; }
        .grade-good { color: #3b82f6; font-weight: 600; }
        .grade-fair { color: #f59e0b; font-weight: 600; }
        .grade-poor { color: #ef4444; font-weight: 600; }
        
        /* Badges */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            min-width: 100px;
        }
        
        .badge-excellent {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .badge-good {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .badge-fair {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* ============ FIXED MODAL STYLES - NO VERTICAL SCROLL ON MODAL ITSELF ============ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .modal-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            background-color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: white;
        }
        
        .modal-footer {
            flex-shrink: 0;
            display: flex;
            justify-content: flex-end;
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
            background-color: #f9fafb;
            border-radius: 0 0 12px 12px;
        }
        
        .modal-close-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background-color: #f3f4f6;
            color: #4b5563;
            font-size: 20px;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .modal-close-btn:hover {
            background-color: #e5e7eb;
            color: #111827;
        }
        
        .student-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        
        .student-basic-info {
            flex: 1;
            min-width: 0;
        }
        
        .student-name {
            font-weight: 700;
            color: #1e3a8a;
            font-size: 20px;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .student-id {
            font-weight: 500;
            color: #64748b;
            font-size: 14px;
            word-wrap: break-word;
        }
        
        .score-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .score-excellent {
            background-color: #d1fae5;
            color: #065f46;
        }
        .score-good {
            background-color: #fef3c7;
            color: #92400e;
        }
        .score-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .summary-stat {
            text-align: center;
        }
        
        .summary-stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .summary-stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .filter-select {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .filter-select:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Mobile adjustments */
        @media screen and (max-width: 768px) {
            .modal-content {
                max-height: 90vh;
                width: 95%;
            }
            
            .modal-header {
                padding: 12px 16px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .modal-footer {
                padding: 12px 16px;
            }
            
            .student-name {
                font-size: 18px;
            }
            
            .student-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .summary-card {
                padding: 16px;
                margin: 0 0 16px 0;
                border-radius: 12px;
                width: 100%;
            }
            
            .summary-stat-value {
                font-size: 22px;
            }
            
            .summary-stat-label {
                font-size: 11px;
            }
            
            .empty-state {
                padding: 40px 20px;
            }
            
            .empty-icon {
                font-size: 48px;
            }
            
            .empty-title {
                font-size: 18px;
            }
            
            .empty-text {
                font-size: 13px;
            }
            
            button {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/98 flex flex-col items-center justify-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium text-sm md:text-base">Loading Grades Management...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- ✅ UPDATED NAVIGATION BANNER - MATCHING LANDING PAGE DESIGN -->
        <header class="shadow-lg fixed w-full top-0 z-50" style="background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 flex items-center justify-center overflow-visible">
                            <img src="UMakfit Logo (2).png" alt="UMakFIT Logo" class="w-20 h-20 object-contain">
                        </div>
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-montserrat gradient-text">
                            UMakFIT
                        </span>
                    </div>

                    <!-- Desktop Navigation -->
                    <div class="desktop-nav hidden md:flex items-center gap-8">
                        <a href="professor.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                        </a>
                        <a href="studentmanagement.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-users mr-2"></i>Students
                        </a>
                        <a href="addactivities.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-dumbbell mr-2"></i>Activities
                        </a>
                        <a href="addlesson.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-book-open mr-2"></i>Lessons
                        </a>
                        <a href="monitoringactivities.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>Monitoring
                        </a>
                        <a href="grades.html" class="text-white font-medium px-3 py-2 rounded-lg" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);">
                            <i class="fas fa-graduation-cap mr-2"></i>Grades
                        </a>
                    </div>

                    <!-- Desktop Profile -->
                    <div class="hidden md:block relative">
                        <img src="" alt="Profile" id="profilePictureBtn"
                             class="w-10 h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                        
                        <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                            <div class="p-6 border-b-2 border-gray-200 text-center">
                                <img src="" alt="Profile" id="profileDropdownPicture" class="w-20 h-20 rounded-full mx-auto mb-3 border-3 border-blue-500 object-cover">
                                <h6 id="profileDropdownName" class="font-bold text-gray-900 text-lg">Loading...</h6>
                                <p id="profileDropdownEmail" class="text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                            </div>
                            <div class="p-2">
                                <a href="professor-profile.html" onclick="showViewProfile(event)" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                    <i class="bi bi-person-circle text-blue-500 text-xl"></i>
                                    <span class="font-medium text-gray-700 text-base">View Profile</span>
                                </a>
                                <div class="h-px bg-gray-200 my-2"></div>
                                <div onclick="handleLogout(event)" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                    <i class="fas fa-sign-out-alt text-xl"></i>
                                    <span class="font-medium text-base">Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Right Icons -->
                    <div class="flex md:hidden items-center gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="professor-profile.html" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hamburger Menu -->
                        <div class="hamburger" id="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Mobile Drawer Overlay -->
            <div class="drawer-overlay" id="drawerOverlay"></div>

            <!-- Mobile Drawer -->
            <div class="mobile-drawer" id="mobileDrawer">
                <div class="p-6 pt-8">
                    <!-- Drawer Header -->
                    <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/20">
                        <div class="w-12 h-12 flex items-center justify-center overflow-visible">
                            <img src="UMakfit Logo (2).png" alt="UMakFIT Logo" class="w-14 h-14 object-contain">
                        </div>
                        <span class="text-2xl font-extrabold font-montserrat gradient-text">
                            UMakFIT
                        </span>
                    </div>

                    <!-- Navigation Links -->
                    <nav class="space-y-2 mb-8">
                        <a href="professor.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                        </a>
                        <a href="studentmanagement.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-users mr-3"></i>Student Management
                        </a>
                        <a href="addactivities.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-dumbbell mr-3"></i>Add Activities
                        </a>
                        <a href="addlesson.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-book-open mr-3"></i>Add Lesson
                        </a>
                        <a href="monitoringactivities.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-chart-bar mr-3"></i>Monitoring Activities
                        </a>
                        <a href="grades.html" class="mobile-nav-link block text-white font-medium py-3 px-4 rounded-lg" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);">
                            <i class="fas fa-graduation-cap mr-3"></i>Grades
                        </a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content - with top padding to account for fixed header -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-32 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex items-center mb-5">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center mr-4">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-blue-900 font-bold text-3xl">Grades Management</h1>
                            <p class="text-gray-600 font-medium text-base mt-2">View final grades and student performance overview</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Overview -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-chart-pie"></i>
                            Grades Overview
                        </h3>
                        <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="calculateFinalGrades()">
                            <i class="fas fa-calculator"></i>
                            <span>Calculate Final</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                            <div class="text-blue-900 font-bold text-3xl mb-2" id="totalStudents">0</div>
                            <div class="text-blue-700 font-medium text-sm">Total Students</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                            <div class="text-green-900 font-bold text-3xl mb-2" id="passedStudents">0</div>
                            <div class="text-green-700 font-medium text-sm">Passed</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-6 border border-yellow-200">
                            <div class="text-yellow-900 font-bold text-3xl mb-2" id="failedStudents">0</div>
                            <div class="text-yellow-700 font-medium text-sm">Failed</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                            <div class="text-purple-900 font-bold text-3xl mb-2" id="overallAverage">0.0%</div>
                            <div class="text-purple-700 font-medium text-sm">Overall Average</div>
                        </div>
                    </div>
                </div>
                
                <!-- Final Grades Summary - WITH FILTERS -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-graduation-cap"></i>
                            Score Summary
                        </h3>
                        <div class="flex gap-2 mt-2 sm:mt-0">
                            <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="exportGrades()">
                                <i class="fas fa-download"></i>
                                <span>Export Grades</span>
                            </button>
                            <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="saveFinalGradesToPDF()" id="savePdfBtn" style="display: none;">
                                <i class="fas fa-file-pdf"></i>
                                <span>Save as PDF</span>
                            </button>
                        </div>
                    </div>

                    <!-- ⭐ FILTER SECTION -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-filter text-blue-600"></i>
                                Filter by Section
                            </label>
                            <select id="filterSection" class="filter-select w-full" onchange="applyFilters()">
                                <option value="">All Sections</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-sort text-blue-600"></i>
                                Sort by
                            </label>
                            <select id="sortBy" class="filter-select w-full" onchange="applyFilters()">
                                <option value="highest">Highest to Lowest Score</option>
                                <option value="lowest">Lowest to Highest Score</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ⭐ SUMMARY STATISTICS -->
                    <div id="resultsSummary" class="summary-card" style="display: none; margin-bottom: 20px;">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="summary-stat">
                                <div class="summary-stat-label">Total Results</div>
                                <div class="summary-stat-value" id="totalResults">0</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-label">Unique Students</div>
                                <div class="summary-stat-value" id="uniqueStudents">0</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-label">Average Score</div>
                                <div class="summary-stat-value" id="averageScore">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ⭐ FINAL GRADES TABLE - CLICKABLE -->
                    <div class="table-responsive">
                        <table class="custom-table" id="finalGradesTable">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Section</th>
                                    <th>Total Activities</th>
                                    <th>Average Score</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="finalGradesBody">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <div class="empty-icon">⏳</div>
                                            <div class="empty-title">Calculating Final Grades...</div>
                                            <div class="empty-text">Please wait while we calculate final grades from student activity scores.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ✅ UPDATED FOOTER - MATCHING LANDING PAGE DESIGN -->
        <footer class="bg-gradient-to-r from-blue-900 to-blue-800 text-white py-8 sm:py-12">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 text-center lg:text-left">
                    <!-- About UmakFit & College of Human Kinetics -->
                    <div>
                        <div class="flex items-center justify-center lg:justify-start gap-3 mb-4">
                            <img src="Umaklogo.png" 
                                 alt="UMak Logo" class="h-12 w-auto object-contain">
                            <div>
                                <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-1">UMakFit</h6>
                                <p class="text-xs lg:text-sm text-blue-200 font-medium">College of Human Kinetics</p>
                            </div>
                        </div>
                        <p class="text-sm lg:text-base leading-relaxed text-blue-100">
                            UMakFit is the official fitness assessment and tracking platform of the College of Human Kinetics at University of Makati. 
                            Our mission is to promote health, wellness, and physical fitness through comprehensive assessment and personalized tracking.
                        </p>
                        <div class="mt-4 flex flex-wrap gap-2 justify-center lg:justify-start">
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Fitness Tracking</span>
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Performance Assessment</span>
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Health & Wellness</span>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div>
                        <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-4 lg:mb-6">Quick Links</h6>
                        <div class="grid grid-cols-2 gap-4 lg:gap-6">
                            <div class="space-y-3">
                                <a href="professor.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-tachometer mr-2"></i>Dashboard
                                </a>
                                <a href="studentmanagement.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-people mr-2"></i>Students
                                </a>
                                <a href="addactivities.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-dumbbell mr-2"></i>Activities
                                </a>
                            </div>
                            <div class="space-y-3">
                                <a href="addlesson.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-book mr-2"></i>Lessons
                                </a>
                                <a href="monitoringactivities.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-graph-up mr-2"></i>Monitoring
                                </a>
                                <a href="grades.html" class="block text-yellow-300 hover:text-yellow-200 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base font-semibold">
                                    <i class="bi bi-mortarboard mr-2"></i>Grades
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Contact & Social -->
                    <div>
                        <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-4 lg:mb-6">Get In Touch</h6>
                        <div class="space-y-4 lg:space-y-5">
                            <div class="flex items-start gap-3">
                                <i class="bi bi-geo-alt-fill text-yellow-400 text-lg lg:text-xl mt-1"></i>
                                <p class="text-sm lg:text-base text-blue-100">
                                    College of Human Kinetics<br>
                                    University of Makati<br>
                                   3rd floor, Administration Building, University of Makati, 
                                   JP Rizal Ext., West Rembo, Taguig City
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="bi bi-envelope-fill text-yellow-400 text-lg lg:text-xl"></i>
                                <a href="mailto:chk@umak.edu.ph" class="text-blue-100 hover:text-yellow-300 transition-colors text-sm lg:text-base">
                                    chk@umak.edu.ph
                                </a>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="bi bi-telephone-fill text-yellow-400 text-lg lg:text-xl"></i>
                                <span class="text-blue-100 text-sm lg:text-base">+63 933 189 7230</span>
                            </div>
                            <div class="flex items-center gap-4 pt-3 justify-center lg:justify-start">
                                <a href="https://www.facebook.com/profile.php?id=61577064971920" target="_blank" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-facebook text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-twitter text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-instagram text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-youtube text-white text-lg lg:text-xl"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="border-t border-blue-600/50 mt-8 lg:mt-12 pt-6 lg:pt-8">
                    <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                        <!-- Copyright -->
                        <div class="text-center lg:text-left">
                            <p class="text-xs lg:text-sm text-blue-200">
                                © 2025 University of Makati - College of Human Kinetics. All Rights Reserved.
                            </p>
                        </div>
                        
                        <!-- University Links -->
                        <div class="flex flex-wrap justify-center gap-3 lg:gap-4">
                            <a href="https://umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                University of Makati
                            </a>
                            <span class="text-blue-400">•</span>
                            <a href="https://library.umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                UMak Online Library
                            </a>
                            <span class="text-blue-400">•</span>
                            <a href="https://tbl.umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                TBL Hub
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Student Grades Details Modal -->
    <div id="studentGradesModal" class="modal-overlay" style="display: none;" onclick="closeStudentGradesModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-clipboard-list"></i> 
                    <span id="modalStudentName">Student Grades Details</span>
                </h3>
                <button class="modal-close-btn" onclick="closeStudentGradesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body" id="modalBodyContent">
                <div id="studentInfoHeader" class="student-info-header" style="display: none;">
                    <div class="student-avatar" id="studentAvatar">??</div>
                    <div class="student-basic-info">
                        <div class="student-name" id="studentNameDetail">Student Name</div>
                        <div class="student-id" id="studentSectionDetail">Section</div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="custom-table" style="min-width: 100%;">
                        <thead style="position: sticky; top: 0; background: linear-gradient(90deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%); z-index: 10;">
                            <tr>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>Result</th>
                                <th>Score</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody id="studentGradesTableBody">
                            <!-- Grades will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="px-6 py-2.5 bg-gray-700 hover:bg-gray-800 text-white rounded-lg font-semibold transition-all" onclick="closeStudentGradesModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Grade Modal -->
    <div id="editGradeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-bold text-gray-900">Edit Grade</h3>
                <button class="modal-close-btn" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Student</label>
                    <input type="text" id="editStudentName" readonly 
                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Activity</label>
                    <input type="text" id="editActivityName" readonly 
                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="editScore">Score (0-100)</label>
                    <input type="number" id="editScore" min="0" max="100" step="0.1" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="editRemarks">Remarks</label>
                    <textarea id="editRemarks" rows="3" placeholder="Add remarks about this grade..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <input type="hidden" id="editGradeId">
            </div>
            <div class="modal-footer">
                <button onclick="closeEditModal()" 
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-all duration-300 mr-2">
                    Cancel
                </button>
                <button onclick="saveGrade()" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-300 hover:shadow-lg">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, updateDoc, addDoc, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentProfessor = null;
        let assignedSections = [];
        let allGrades = [];
        let allActivities = [];
        let allStudents = [];
        let currentFinalGrades = [];
        let filteredFinalGrades = [];

        // DOM Elements for navigation
        const hamburger = document.getElementById('hamburger');
        const mobileDrawer = document.getElementById('mobileDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        // ============ ⭐ EXACT SCORING FUNCTION FROM STUDENT GRADES PAGE ============
        function calculateActivityScore(testName, result, testTarget = null) {
            const normalized = testName.toLowerCase().trim();
            
            // ⭐ CRITICAL: Check if this is a professor override with pre-calculated score
            if (result && typeof result === 'object' && result !== null) {
                if (result.score !== undefined && result.score !== null) {
                    const score = parseFloat(result.score);
                    if (!isNaN(score) && score >= 0 && score <= 100) {
                        console.log(`✅ Using stored professor score: ${score} for ${testName}`);
                        return score;
                    }
                }
            }
            
            // Extract numeric value from result
            let numericValue = 0;
            
            if (typeof result === 'object' && result !== null) {
                numericValue = result.repetitions || result.time || result.distance || 
                              result.value || result.result || result.count || 
                              result.score || 0;
            } else if (typeof result === 'string') {
                const match = result.match(/(\d+\.?\d*)/);
                if (match) {
                    numericValue = parseFloat(match[1]);
                } else {
                    numericValue = parseFloat(result) || 0;
                }
            } else {
                numericValue = parseFloat(result) || 0;
            }
            
            console.log(`🎯 Calculating: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
            
            // Use test target if available
            if (testTarget && testTarget > 0) {
                if (normalized.includes('push-up') || normalized.includes('pushup') || 
                    normalized.includes('sit-up') || normalized.includes('situp') ||
                    normalized.includes('curl-up')) {
                    
                    const reps = numericValue;
                    if (reps >= testTarget) return 100;
                    
                    const percentage = (reps / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('plank')) {
                    let seconds = numericValue;
                    if (seconds >= testTarget) return 100;
                    
                    const percentage = (seconds / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('sit-and-reach')) {
                    const distance = numericValue;
                    if (distance >= testTarget) return 100;
                    
                    const percentage = (distance / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('grip')) {
                    if (numericValue >= testTarget) return 100;
                    
                    const percentage = (numericValue / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('mile') || normalized.includes('run')) {
                    if (numericValue <= testTarget) return 100;
                    
                    const percentage = (testTarget / numericValue) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
                
                if (normalized.includes('step test') || normalized.includes('3-minute')) {
                    if (numericValue <= testTarget) return 100;
                    
                    const percentage = (testTarget / numericValue) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return Math.round(score);
                }
            }
            
            // ============ FALLBACK DEFAULT SCORING ============
            
            if (normalized.includes('push-up') || normalized.includes('pushup')) {
                const reps = numericValue;
                if (reps >= 40) return 100;
                if (reps >= 35) return 95;
                if (reps >= 30) return 90;
                if (reps >= 25) return 85;
                if (reps >= 20) return 80;
                if (reps >= 15) return 75;
                if (reps >= 10) return 70;
                if (reps >= 5) return 65;
                return 60;
            }
            
            if (normalized.includes('sit-up') || normalized.includes('situp')) {
                const reps = numericValue;
                if (reps >= 50) return 100;
                if (reps >= 45) return 95;
                if (reps >= 40) return 90;
                if (reps >= 35) return 85;
                if (reps >= 30) return 80;
                if (reps >= 25) return 75;
                if (reps >= 20) return 70;
                if (reps >= 15) return 65;
                return 60;
            }
            
            if (normalized.includes('curl-up')) {
                const reps = numericValue;
                if (reps >= 75) return 100;
                if (reps >= 60) return 95;
                if (reps >= 50) return 90;
                if (reps >= 40) return 85;
                if (reps >= 30) return 80;
                if (reps >= 25) return 75;
                if (reps >= 20) return 70;
                return 65;
            }
            
            if (normalized.includes('plank')) {
                let seconds = 0;
                if (typeof numericValue === 'string' && numericValue.includes(':')) {
                    const [mins, secs] = numericValue.split(':').map(Number);
                    seconds = (mins * 60) + (secs || 0);
                } else {
                    seconds = numericValue;
                }
                
                if (seconds >= 180) return 100;
                if (seconds >= 150) return 95;
                if (seconds >= 120) return 90;
                if (seconds >= 100) return 85;
                if (seconds >= 80) return 80;
                if (seconds >= 60) return 75;
                if (seconds >= 45) return 70;
                if (seconds >= 30) return 65;
                return 60;
            }
            
            if (normalized.includes('step test') || normalized.includes('3-minute')) {
                const heartRate = numericValue;
                if (heartRate <= 70) return 100;
                if (heartRate <= 80) return 95;
                if (heartRate <= 90) return 90;
                if (heartRate <= 100) return 85;
                if (heartRate <= 110) return 80;
                if (heartRate <= 120) return 75;
                if (heartRate <= 130) return 70;
                return 65;
            }
            
            if (normalized.includes('mile') || normalized.includes('run')) {
                let totalSeconds = 0;
                if (typeof numericValue === 'string' && numericValue.includes(':')) {
                    const [minutes, seconds] = numericValue.split(':').map(Number);
                    totalSeconds = (minutes * 60) + (seconds || 0);
                } else {
                    totalSeconds = numericValue;
                }
                
                if (totalSeconds <= 360) return 100;
                if (totalSeconds <= 420) return 95;
                if (totalSeconds <= 480) return 90;
                if (totalSeconds <= 540) return 85;
                if (totalSeconds <= 600) return 80;
                if (totalSeconds <= 660) return 75;
                if (totalSeconds <= 720) return 70;
                if (totalSeconds <= 780) return 65;
                return 60;
            }
            
            if (normalized.includes('sit-and-reach')) {
                const distance = numericValue;
                if (distance >= 25) return 100;
                if (distance >= 20) return 95;
                if (distance >= 15) return 90;
                if (distance >= 10) return 85;
                if (distance >= 5) return 80;
                if (distance >= 0) return 75;
                if (distance >= -5) return 70;
                return 65;
            }
            
            if (normalized.includes('grip')) {
                const strength = numericValue;
                if (strength >= 60) return 100;
                if (strength >= 55) return 95;
                if (strength >= 50) return 90;
                if (strength >= 45) return 85;
                if (strength >= 40) return 80;
                if (strength >= 35) return 75;
                if (strength >= 30) return 70;
                return 65;
            }
            
            if (normalized.includes('bmi')) {
                const bmi = numericValue;
                if (bmi >= 18.5 && bmi <= 24.9) return 100;
                if (bmi >= 17.5 && bmi < 18.5) return 85;
                if (bmi >= 25 && bmi <= 27) return 85;
                if (bmi >= 15 && bmi < 17.5) return 70;
                if (bmi > 27 && bmi <= 30) return 70;
                return 60;
            }
            
            return 75;
        }

        // Hamburger Menu Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            if (hamburger && mobileDrawer && drawerOverlay) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    mobileDrawer.classList.toggle('active');
                    drawerOverlay.classList.toggle('active');
                    document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
                });

                drawerOverlay.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    mobileDrawer.classList.remove('active');
                    drawerOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });

                mobileNavLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        hamburger.classList.remove('active');
                        mobileDrawer.classList.remove('active');
                        drawerOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
            }
            
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            document.addEventListener('click', closeAllDropdowns);
        });

        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 768;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function closeProfileDropdown() {
            if (profileDropdown) profileDropdown.classList.add('hidden');
            if (profileDropdownMobile) profileDropdownMobile.classList.add('hidden');
        }

        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = currentProfessor?.name || currentProfessor?.fullName || userName || 'Professor';
            const email = currentProfessor?.email || 'professor@umak.edu.ph';
            
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('User authenticated:', user.email);
                    
                    await loadProfessorData(user);
                    updateProfilePicture(user.photoURL, user.displayName);
                    await loadAssignedSections();
                    await loadAllData();
                    
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Error loading grades:', error);
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    alert('Error loading grades data: ' + error.message);
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        async function loadProfessorData(user) {
            try {
                console.log('Loading professor data for:', user.email);
                
                const userEmail = user.email.toLowerCase();
                
                const professorsQuery = query(
                    collection(db, 'professors'),
                    where('email', '==', userEmail)
                );
                const professorsSnapshot = await getDocs(professorsQuery);
                
                if (!professorsSnapshot.empty) {
                    const professorDoc = professorsSnapshot.docs[0];
                    currentProfessor = { id: professorDoc.id, ...professorDoc.data() };
                    console.log('✓ Professor found in professors collection:', currentProfessor);
                } else {
                    const usersQuery = query(
                        collection(db, 'users'),
                        where('email', '==', userEmail),
                        where('role', '==', 'professor')
                    );
                    const usersSnapshot = await getDocs(usersQuery);
                    
                    if (!usersSnapshot.empty) {
                        const userDoc = usersSnapshot.docs[0];
                        currentProfessor = { id: userDoc.id, ...userDoc.data() };
                        console.log('✓ Professor found in users collection:', currentProfessor);
                    } else {
                        currentProfessor = {
                            name: user.displayName || 'Professor',
                            email: user.email
                        };
                        console.log('⚠️ Using minimal professor data');
                    }
                }
                
            } catch (error) {
                console.error('Error loading professor data:', error);
                currentProfessor = {
                    name: user.displayName || 'Professor',
                    email: user.email
                };
            }
        }

        async function loadAssignedSections() {
            try {
                assignedSections = [];
                const sectionSet = new Set();
                
                console.log('Loading sections for professor:', currentProfessor.email);

                const methods = [
                    async () => {
                        const professorQuery = query(
                            collection(db, 'professorProfiles'),
                            where('email', '==', currentProfessor.email)
                        );
                        const professorSnapshot = await getDocs(professorQuery);
                        
                        if (!professorSnapshot.empty) {
                            const professorData = professorSnapshot.docs[0].data();
                            const professorName = professorData.fullName || professorData.name || '';
                            
                            const sectionsQuery = query(
                                collection(db, 'sections'),
                                where('professor', '==', professorName)
                            );
                            const sectionsSnapshot = await getDocs(sectionsQuery);
                            
                            sectionsSnapshot.forEach(doc => {
                                const data = doc.data();
                                if (data.name && !sectionSet.has(data.name)) {
                                    sectionSet.add(data.name);
                                    assignedSections.push({ 
                                        section: data.name,
                                        professorName: professorName 
                                    });
                                }
                            });
                        }
                    },
                    
                    async () => {
                        const sectionsQuery = query(
                            collection(db, 'sections'),
                            where('professorEmail', '==', currentProfessor.email)
                        );
                        const sectionsSnapshot = await getDocs(sectionsQuery);
                        
                        sectionsSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.name && !sectionSet.has(data.name)) {
                                sectionSet.add(data.name);
                                assignedSections.push({ 
                                    section: data.name,
                                    professorName: data.professor || currentProfessor.email 
                                });
                            }
                        });
                    },
                    
                    async () => {
                        const testResultsQuery = query(
                            collection(db, 'testResults'),
                            where('professorEmail', '==', currentProfessor.email)
                        );
                        const testResultsSnapshot = await getDocs(testResultsQuery);
                        
                        const uniqueSections = new Set();
                        testResultsSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.section) {
                                uniqueSections.add(data.section);
                            }
                        });
                        
                        uniqueSections.forEach(sectionName => {
                            if (!sectionSet.has(sectionName)) {
                                sectionSet.add(sectionName);
                                assignedSections.push({ 
                                    section: sectionName,
                                    professorName: currentProfessor.email 
                                });
                            }
                        });
                    }
                ];

                for (const method of methods) {
                    try {
                        await method();
                    } catch (error) {
                        console.warn('Method failed:', error.message);
                    }
                }

                const sectionSelect = document.getElementById('filterSection');
                sectionSelect.innerHTML = '<option value="">All Sections</option>';

                if (assignedSections.length === 0) {
                    console.log('No sections found. Loading all sections for debugging.');
                    const allSectionsQuery = query(collection(db, 'sections'));
                    const allSectionsSnapshot = await getDocs(allSectionsQuery);
                    
                    allSectionsSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.name && !sectionSet.has(data.name)) {
                            sectionSet.add(data.name);
                            assignedSections.push({ 
                                section: data.name,
                                professorName: data.professor || 'Unknown' 
                            });
                        }
                    });
                }

                assignedSections.forEach(sec => {
                    const option = document.createElement('option');
                    option.value = sec.section;
                    option.textContent = sec.section;
                    sectionSelect.appendChild(option.cloneNode(true));
                });

                console.log('Assigned sections:', assignedSections);

            } catch (error) {
                console.error('Error in loadAssignedSections:', error);
            }
        }

        async function loadAllData() {
            await loadActivities();
            await loadStudents();
            await loadGrades();
            if (allGrades.length > 0) {
                setTimeout(() => {
                    calculateAndDisplayFinalGrades();
                }, 500);
            }
        }

        async function loadGrades() {
            try {
                allGrades = [];
                console.log('Loading grades for', assignedSections.length, 'sections');

                if (assignedSections.length === 0) {
                    return;
                }

                const bestScoresMap = new Map();

                for (const section of assignedSections) {
                    try {
                        const gradesQuery = query(
                            collection(db, 'testResults'),
                            where('section', '==', section.section),
                            where('status', '==', 'completed')
                        );
                        
                        const gradesSnapshot = await getDocs(gradesQuery);
                        
                        gradesSnapshot.forEach(docSnap => {
                            const data = docSnap.data();
                            
                            if (data.status !== 'completed') return;
                            
                            const studentEmail = data.studentEmail;
                            const testId = data.testId || docSnap.id;
                            const testName = data.testName || 'Unknown Activity';
                            
                            const testKey = `${studentEmail}_${testId}`;
                            
                            const score = calculateActivityScore(
                                testName,
                                data.result || data.resultData || data.repetitions || data,
                                data.testTarget || null
                            );
                            
                            const validScore = Math.max(0, Math.min(100, score));
                            
                            let submittedDate = new Date();
                            if (data.submittedAt) {
                                if (typeof data.submittedAt.toDate === 'function') {
                                    submittedDate = data.submittedAt.toDate();
                                } else if (typeof data.submittedAt === 'string') {
                                    submittedDate = new Date(data.submittedAt);
                                } else if (data.submittedAt.seconds) {
                                    submittedDate = new Date(data.submittedAt.seconds * 1000);
                                }
                            }

                            const dateKey = submittedDate.toISOString().split('T')[0];
                            
                            if (!bestScoresMap.has(testKey) || validScore > bestScoresMap.get(testKey).score) {
                                
                                let displayResult = '-';
                                if (data.result !== undefined && data.result !== null) {
                                    if (typeof data.result === 'number') {
                                        displayResult = data.result;
                                    } else if (typeof data.result === 'string') {
                                        const match = data.result.match(/(\d+\.?\d*)/);
                                        displayResult = match ? parseFloat(match[1]) : data.result;
                                    } else if (typeof data.result === 'object') {
                                        displayResult = data.result.value || data.result.repetitions || 
                                                    data.result.time || data.result.distance || 0;
                                    }
                                } else if (data.resultData) {
                                    if (typeof data.resultData === 'object') {
                                        displayResult = data.resultData.value || data.resultData.repetitions || 
                                                    data.resultData.time || 0;
                                    } else {
                                        displayResult = data.resultData;
                                    }
                                } else if (data.repetitions !== undefined) {
                                    displayResult = data.repetitions;
                                }

                                bestScoresMap.set(testKey, {
                                    id: docSnap.id,
                                    studentName: data.studentName || 'Unknown Student',
                                    section: data.section || section.section,
                                    testName: testName,
                                    result: displayResult,
                                    testUnit: data.testUnit || '',
                                    score: validScore,
                                    date: submittedDate.toLocaleDateString('en-US', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    }),
                                    dateObject: submittedDate,
                                    formattedDate: dateKey,
                                    remarks: data.remarks || '',
                                    studentEmail: studentEmail || '',
                                    studentId: data.studentId || '',
                                    professorEmail: data.professorEmail || '',
                                    submittedAt: data.submittedAt || '',
                                    isProfessorOverride: data.isProfessorOverride || false,
                                    testTarget: data.testTarget || null
                                });
                            }
                        });
                        
                    } catch (error) {
                        console.error(`Error loading grades for ${section.section}:`, error);
                    }
                }

                allGrades = Array.from(bestScoresMap.values());

                allGrades.sort((a, b) => {
                    try {
                        const dateA = a.dateObject;
                        const dateB = b.dateObject;
                        return dateB - dateA;
                    } catch (e) {
                        return 0;
                    }
                });

                console.log(`✅ Total unique best scores loaded: ${allGrades.length}`);

            } catch (error) {
                console.error('Error in loadGrades:', error);
            }
        }

        function calculateAndDisplayFinalGrades() {
            try {
                if (allGrades.length === 0) {
                    console.log('No grades available for final calculation');
                    return;
                }

                console.log('Auto-calculating final grades from', allGrades.length, 'unique best scores');

                const studentGradesMap = {};
                
                allGrades.forEach(grade => {
                    const studentKey = grade.studentEmail || 
                                    `${grade.studentName}_${grade.section}`.toLowerCase();
                    
                    if (!studentGradesMap[studentKey]) {
                        studentGradesMap[studentKey] = {
                            name: grade.studentName,
                            section: grade.section,
                            email: grade.studentEmail || '',
                            studentId: grade.studentId || '',
                            scores: [],
                            totalScore: 0,
                            activityCount: 0,
                            activityNames: [],
                            activityInstances: []
                        };
                    }
                    
                    if (grade.score !== undefined && grade.score !== null) {
                        studentGradesMap[studentKey].scores.push(grade.score);
                        studentGradesMap[studentKey].totalScore += grade.score;
                        studentGradesMap[studentKey].activityCount++;
                        
                        studentGradesMap[studentKey].activityInstances.push({
                            name: grade.testName,
                            date: grade.date,
                            formattedDate: grade.formattedDate,
                            score: grade.score,
                            result: grade.result || '',
                            gradeStatus: getGradeStatus(grade.score)
                        });
                        
                        const activityWithDate = `${grade.testName} (${grade.date})`;
                        if (!studentGradesMap[studentKey].activityNames.includes(activityWithDate)) {
                            studentGradesMap[studentKey].activityNames.push(activityWithDate);
                        }
                    }
                });

                console.log('✅ Found', Object.keys(studentGradesMap).length, 'unique students');

                const finalGrades = [];
                Object.keys(studentGradesMap).forEach(studentKey => {
                    const student = studentGradesMap[studentKey];
                    
                    const averageScore = student.scores.length > 0 ? 
                        student.totalScore / student.scores.length : 0;

                    const finalGrade = averageScore.toFixed(2);
                    const gradeStatus = getGradeStatus(averageScore);
                    const statusText = averageScore >= 70 ? 'Passed' : 'Failed';
                    const badgeClass = getBadgeClass(averageScore);
                    
                    finalGrades.push({
                        studentKey: studentKey,
                        name: student.name,
                        section: student.section,
                        totalActivities: student.activityCount,
                        activityNames: student.activityNames,
                        activityInstances: student.activityInstances,
                        scores: student.scores,
                        totalScore: student.totalScore,
                        averageScore: parseFloat(averageScore.toFixed(2)),
                        finalGrade: finalGrade,
                        status: gradeStatus,
                        statusText: statusText,
                        badgeClass: badgeClass,
                        email: student.email,
                        studentId: student.studentId
                    });
                });

                finalGrades.sort((a, b) => b.averageScore - a.averageScore);

                console.log('✅ Auto-calculated final grades for', finalGrades.length, 'students');
                
                currentFinalGrades = finalGrades;
                filteredFinalGrades = [...finalGrades];
                
                displayFinalGrades(filteredFinalGrades);
                updateFinalGradesStats(filteredFinalGrades);
                
            } catch (error) {
                console.error('Error auto-calculating final grades:', error);
            }
        }

        window.applyFilters = function() {
            const sectionFilter = document.getElementById('filterSection').value;
            const sortBy = document.getElementById('sortBy').value;
            
            console.log('Applying filters - Section:', sectionFilter, 'Sort:', sortBy);
            
            let filtered = [...currentFinalGrades];
            
            if (sectionFilter) {
                filtered = filtered.filter(grade => grade.section === sectionFilter);
                console.log('After section filter:', filtered.length, 'students');
            }
            
            if (sortBy === 'highest') {
                filtered.sort((a, b) => b.averageScore - a.averageScore);
            } else if (sortBy === 'lowest') {
                filtered.sort((a, b) => a.averageScore - b.averageScore);
            } else if (sortBy === 'name-asc') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'name-desc') {
                filtered.sort((a, b) => b.name.localeCompare(a.name));
            }
            
            filteredFinalGrades = filtered;
            displayFinalGrades(filteredFinalGrades);
            updateFinalGradesStats(filteredFinalGrades);
        };

        async function loadActivities() {
            try {
                allActivities = [];
                
                const scheduledQuery = query(
                    collection(db, 'scheduledTests'),
                    where('professorEmail', '==', currentProfessor.email)
                );
                const scheduledSnapshot = await getDocs(scheduledQuery);
                
                scheduledSnapshot.forEach(docSnap => {
                    const activity = docSnap.data();
                    if (!allActivities.find(a => a.testName === activity.testName)) {
                        allActivities.push({
                            id: docSnap.id,
                            name: activity.testName,
                            section: activity.section,
                            type: 'scheduled'
                        });
                    }
                });
                
                if (allGrades.length > 0) {
                    const uniqueActivities = new Set();
                    allGrades.forEach(grade => {
                        if (grade.testName && !uniqueActivities.has(grade.testName)) {
                            uniqueActivities.add(grade.testName);
                            allActivities.push({
                                id: `result_${grade.id}`,
                                name: grade.testName,
                                section: grade.section,
                                type: 'completed'
                            });
                        }
                    });
                }
                
                console.log('Loaded activities:', allActivities.length);
                
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        async function loadStudents() {
            try {
                allStudents = [];
                const studentIds = new Set();
                
                for (const section of assignedSections) {
                    const studentsQuery = query(
                        collection(db, 'students'),
                        where('section', '==', section.section)
                    );
                    const studentsSnapshot = await getDocs(studentsQuery);
                    
                    studentsSnapshot.forEach(docSnap => {
                        const student = docSnap.data();
                        const uniqueId = student.email || student.umakId || docSnap.id;
                        
                        if (!studentIds.has(uniqueId)) {
                            studentIds.add(uniqueId);
                            allStudents.push({
                                id: docSnap.id,
                                ...student,
                                section: section.section
                            });
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function getGradeStatus(score) {
            if (score >= 90) return 'grade-excellent';
            if (score >= 80) return 'grade-good';
            if (score >= 70) return 'grade-fair';
            return 'grade-poor';
        }

        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 70) return 'score-good';
            return 'score-poor';
        }

        function getBadgeClass(score) {
            if (score >= 90) return 'badge-excellent';
            if (score >= 80) return 'badge-good';
            if (score >= 70) return 'badge-fair';
            return 'badge-poor';
        }

        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'badge-excellent' };
            if (score >= 80) return { text: 'Good', class: 'badge-good' };
            if (score >= 70) return { text: 'Fair', class: 'badge-fair' };
            return { text: 'Needs Improvement', class: 'badge-poor' };
        }

        function displayFinalGrades(finalGrades) {
            const tableBody = document.getElementById('finalGradesBody');
            
            if (finalGrades.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-icon">📈</div>
                                <div class="empty-title">No Student Grades Found</div>
                                <div class="empty-text">
                                    No student grades match your current filters.<br>
                                    Try adjusting your filter settings or add activities first.
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                document.getElementById('savePdfBtn').style.display = 'none';
                
                return;
            }
            
            const summaryCard = document.getElementById('resultsSummary');
            if (finalGrades.length > 0) {
                summaryCard.style.display = 'block';
                
                let totalResults = 0;
                let totalScore = 0;
                
                finalGrades.forEach(grade => {
                    totalResults += grade.totalActivities;
                    totalScore += grade.averageScore;
                });
                
                document.getElementById('totalResults').textContent = totalResults;
                document.getElementById('uniqueStudents').textContent = finalGrades.length;
                
                const avgScore = totalScore / finalGrades.length;
                document.getElementById('averageScore').textContent = avgScore.toFixed(2) + '%';
            }
            
            let html = '';
            finalGrades.forEach((grade, index) => {
                const badgeClass = getBadgeClass(grade.averageScore);
                const rating = getRating(grade.averageScore);
                
                html += `
                    <tr onclick="showStudentGrades('${grade.studentKey}')" style="cursor: pointer;">
                        <td data-label="Student Name">
                            <div style="position: relative;">
                                <strong>${grade.name || 'Unknown Student'}</strong>
                                ${grade.email ? `<br><small class="text-gray-500">${grade.email}</small>` : ''}
                            </div>
                        </td>
                        <td data-label="Section">${grade.section || 'N/A'}</td>
                        <td data-label="Total Activities"><strong>${grade.totalActivities}</strong></td>
                        <td data-label="Average Score">
                            <span class="${grade.status}">${grade.averageScore.toFixed(2)}%</span>
                        </td>
                        <td data-label="Status">
                            <span class="badge ${badgeClass}">
                                ${grade.statusText}
                            </span>
                        </td>
                        <td data-label="Actions">
                            <button class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded-lg flex items-center gap-1 transition-all duration-300" onclick="event.stopPropagation(); showStudentGrades('${grade.studentKey}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            document.getElementById('savePdfBtn').style.display = 'inline-flex';
        }

        window.showStudentGrades = function(studentKey) {
            const studentData = currentFinalGrades.find(g => g.studentKey === studentKey);
            if (!studentData) return;
            
            console.log('📋 Opening grades details for:', studentData.name);
            
            document.getElementById('modalStudentName').textContent = `${studentData.name}'s Grades Details (${studentData.totalActivities} activities)`;
            
            const nameParts = studentData.name.split(' ');
            const initials = (nameParts[0]?.charAt(0) || '') + (nameParts[nameParts.length - 1]?.charAt(0) || '');
            
            document.getElementById('studentAvatar').textContent = initials.toUpperCase();
            document.getElementById('studentNameDetail').textContent = studentData.name;
            document.getElementById('studentSectionDetail').textContent = `${studentData.section} • ${studentData.email || ''}`;
            document.getElementById('studentInfoHeader').style.display = 'flex';
            
            const sortedActivities = studentData.activityInstances.sort((a, b) => {
                const dateA = new Date(a.date || a.formattedDate || '');
                const dateB = new Date(b.date || b.formattedDate || '');
                return dateB - dateA;
            });
            
            let html = '';
            sortedActivities.forEach((activity) => {
                const dateFormatted = activity.date || activity.formattedDate || 'N/A';
                const rating = getRating(activity.score);
                const scoreClass = getScoreClass(activity.score);
                
                html += `
                <tr>
                    <td>${dateFormatted}</td>
                    <td><strong>${activity.name}</strong></td>
                    <td>${activity.result || '-'}</td>
                    <td>
                        <span class="score-badge ${scoreClass}">${activity.score.toFixed(1)}%</span>
                    </td>
                    <td>
                        <span class="badge ${rating.class}">${rating.text}</span>
                    </td>
                </tr>
                `;
            });
            
            document.getElementById('studentGradesTableBody').innerHTML = html;
            
            document.getElementById('studentGradesModal').style.display = 'flex';
            
            const modalBody = document.getElementById('modalBodyContent');
            if (modalBody) {
                modalBody.scrollTop = 0;
            }
        };

        window.closeStudentGradesModal = function() {
            document.getElementById('studentGradesModal').style.display = 'none';
        };
        
        function updateFinalGradesStats(finalGrades) {
            if (finalGrades.length === 0) {
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('passedStudents').textContent = '0';
                document.getElementById('failedStudents').textContent = '0';
                document.getElementById('overallAverage').textContent = '0.00%';
                return;
            }
            
            const totalStudents = finalGrades.length;
            const passedStudents = finalGrades.filter(g => g.averageScore >= 70).length;
            const failedStudents = totalStudents - passedStudents;
            
            const totalAverage = finalGrades.reduce((sum, grade) => sum + grade.averageScore, 0);
            const overallAverage = totalAverage / totalStudents;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('passedStudents').textContent = passedStudents;
            document.getElementById('failedStudents').textContent = failedStudents;
            document.getElementById('overallAverage').textContent = overallAverage.toFixed(2) + '%';
        }

        window.calculateFinalGrades = function() {
            try {
                if (allGrades.length === 0) {
                    alert('No grades available to calculate final grades.');
                    return;
                }

                calculateAndDisplayFinalGrades();
                alert(`✅ Successfully calculated final grades for ${currentFinalGrades.length} students using BEST scores!`);

            } catch (error) {
                console.error('Error calculating final grades:', error);
                alert('Error calculating final grades: ' + error.message);
            }
        }

        window.exportGrades = function() {
            if (filteredFinalGrades.length === 0) {
                alert('No final grades to export');
                return;
            }
            
            let csv = 'Student Name,Section,Total Activities,Average Score,Status\n';
            
            filteredFinalGrades.forEach(grade => {
                csv += `"${grade.name || ''}","${grade.section || ''}",${grade.totalActivities || 0},${grade.averageScore || 0},"${grade.statusText || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `final_grades_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('✅ Final grades exported successfully!');
        }

        window.saveFinalGradesToPDF = function() {
            alert('PDF export feature would be implemented here.\nFor now, you can use the browser\'s Print function (Ctrl+P) and save as PDF.');
        }

        window.editGrade = editGrade;
        window.closeEditModal = closeEditModal;
        window.saveGrade = saveGrade;
        window.calculateFinalGrades = calculateFinalGrades;
        window.exportGrades = exportGrades;
        window.saveFinalGradesToPDF = saveFinalGradesToPDF;
        window.showStudentGrades = showStudentGrades;
        window.closeStudentGradesModal = closeStudentGradesModal;

        function editGrade(gradeId) {
            const grade = allGrades.find(g => g.id === gradeId);
            if (!grade) {
                alert('Grade not found');
                return;
            }
            
            document.getElementById('editStudentName').value = grade.studentName || '';
            document.getElementById('editActivityName').value = grade.testName || '';
            document.getElementById('editScore').value = grade.score || 0;
            document.getElementById('editRemarks').value = grade.remarks || '';
            document.getElementById('editGradeId').value = gradeId;
            
            document.getElementById('editGradeModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editGradeModal').style.display = 'none';
        }

        async function saveGrade() {
            const gradeId = document.getElementById('editGradeId').value;
            const newScore = parseFloat(document.getElementById('editScore').value);
            const remarks = document.getElementById('editRemarks').value;
            
            if (isNaN(newScore) || newScore < 0 || newScore > 100) {
                alert('Please enter a valid score between 0 and 100');
                return;
            }
            
            try {
                const gradeRef = doc(db, 'testResults', gradeId);
                await updateDoc(gradeRef, {
                    score: newScore,
                    remarks: remarks,
                    isProfessorOverride: true,
                    updatedAt: new Date()
                });
                
                alert('✅ Grade updated successfully!');
                closeEditModal();
                await loadGrades();
                
            } catch (error) {
                console.error('Error updating grade:', error);
                alert('Error updating grade: ' + error.message);
            }
        }
    </script>
</body>
</html>