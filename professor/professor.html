<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Professor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; }
        
        /* Custom animations */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom styles not covered by Tailwind */
        .gradient-text {
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .nav-shadow {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Profile Dropdown Styles */
        .profile-container {
            position: relative;
        }
        .profile-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .profile-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .profile-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .profile-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 280px;
            display: none;
            z-index: 1001;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        .profile-dropdown.show {
            display: block;
            animation: dropdownSlide 0.3s ease-out;
        }
        .profile-dropdown-header {
            padding: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .profile-dropdown-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }
        .profile-dropdown-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .profile-dropdown-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .profile-dropdown-email {
            font-size: 13px;
            opacity: 0.9;
        }
        .profile-dropdown-menu {
            padding: 8px 0;
        }
        .profile-dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
        .profile-dropdown-item:hover {
            background: #f8fafc;
            color: #3b82f6;
        }
        .profile-dropdown-item i {
            width: 20px;
            font-size: 16px;
        }
        .profile-dropdown-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 8px 0;
        }
        .profile-dropdown-item.logout {
            color: #dc2626;
        }
        .profile-dropdown-item.logout:hover {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col justify-center items-center z-50">
        <div class="w-12 h-12 border-4 border-gray-100 border-t-blue-500 rounded-full spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading Dashboard...</div>
    </div>
    
    <div id="dashboardContent" class="hidden">
        <!-- Header -->
        <div class="bg-white custom-shadow border-b border-gray-200 fixed top-0 w-full z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-2">
                        <img class="h-10 w-auto" src="umaklogo.png" alt="University of Makati">
                        <span class="text-blue-900 font-bold text-xl">University of Makati</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Profile Dropdown -->
                        <div class="profile-container">
                            <div class="profile-circle" id="profileCircle" onclick="toggleProfileDropdown()">
                                <!-- Profile picture will be loaded here -->
                            </div>
                            <div class="profile-dropdown" id="profileDropdown">
                                <div class="profile-dropdown-header">
                                    <div class="profile-dropdown-avatar" id="profileDropdownAvatar">
                                        <!-- Profile picture will be loaded here -->
                                    </div>
                                    <div class="profile-dropdown-name" id="dropdownName">Professor</div>
                                    <div class="profile-dropdown-email" id="dropdownEmail">professor@umak.edu.ph</div>
                                </div>
                                <div class="profile-dropdown-menu">
                                    <a href="#" class="profile-dropdown-item" onclick="showViewProfile(event)">
                                        <i class="fas fa-user"></i>
                                        <span>View Profile</span>
                                    </a>
                                    <div class="profile-dropdown-divider"></div>
                                    <a href="#" class="profile-dropdown-item logout" onclick="handleLogout(event)">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Logout</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="bg-gradient-to-b from-blue-900 to-blue-500 nav-shadow mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                    <div class="flex items-center space-x-3">
                        <img class="h-14 w-auto" src="logo.png" alt="UMakFit">
                        <h1 class="font-manrope font-extrabold text-3xl gradient-text">UMakFit</h1>
                    </div>
                    <div class="flex flex-wrap gap-2 overflow-x-auto pb-1">
                        <a href="#" class="bg-white text-black font-manrope font-semibold text-sm py-3 px-5 rounded-lg flex items-center space-x-2 shadow-sm hover:-translate-y-0.5 transition-all duration-300 hover:shadow-md bg-gradient-to-r from-yellow-400 to-yellow-500 shadow-yellow-500/30">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="studentmanagement.html" class="bg-white text-black font-manrope font-semibold text-sm py-3 px-5 rounded-lg flex items-center space-x-2 shadow-sm hover:-translate-y-0.5 transition-all duration-300 hover:shadow-md">
                            <i class="fas fa-users"></i>
                            <span>Student Management</span>
                        </a>
                        <a href="addactivities.html" class="bg-white text-black font-manrope font-semibold text-sm py-3 px-5 rounded-lg flex items-center space-x-2 shadow-sm hover:-translate-y-0.5 transition-all duration-300 hover:shadow-md">
                            <i class="fas fa-dumbbell"></i>
                            <span>Add Activities</span>
                        </a>
                        <a href="addlesson.html" class="bg-white text-black font-manrope font-semibold text-sm py-3 px-5 rounded-lg flex items-center space-x-2 shadow-sm hover:-translate-y-0.5 transition-all duration-300 hover:shadow-md">
                            <i class="fas fa-book-open"></i>
                            <span>Add Lesson</span>
                        </a>
                        <a href="monitoringactivities.html" class="bg-white text-black font-manrope font-semibold text-sm py-3 px-5 rounded-lg flex items-center space-x-2 shadow-sm hover:-translate-y-0.5 transition-all duration-300 hover:shadow-md">
                            <i class="fas fa-chart-bar"></i>
                            <span>Monitoring Activities</span>
                        </a>
                        <a href="grades.html" class="bg-white text-black font-manrope font-semibold text-sm py-3 px-5 rounded-lg flex items-center space-x-2 shadow-sm hover:-translate-y-0.5 transition-all duration-300 hover:shadow-md">
                            <i class="fas fa-graduation-cap"></i>
                            <span>Grades</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-10 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Profile Section -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex items-center mb-5">
                        <h2 class="text-blue-900 font-bold text-3xl">Professor Profile</h2>
                    </div>
                    <div class="w-full h-0.5 bg-gradient-to-r from-transparent via-gray-200 to-transparent my-6"></div>
                    <div class="bg-gray-50 rounded-xl border border-gray-100 p-6 flex items-center space-x-8">
                        <img class="w-16 h-16 rounded-full object-cover border-3 border-gray-200" id="userPhoto" src="https://c.animaapp.com/tzMzyNnw/img/image-13@2x.png" alt="Profile">
                        <div class="flex-1 flex flex-wrap gap-x-20 gap-y-6">
                            <div class="min-w-[150px]">
                                <div class="text-gray-500 font-medium text-xs uppercase tracking-wider mb-1">Name</div>
                                <div class="text-blue-900 font-bold text-base" id="userName">Loading...</div>
                            </div>
                            <div class="min-w-[150px]">
                                <div class="text-gray-500 font-medium text-xs uppercase tracking-wider mb-1">Email</div>
                                <div class="text-gray-700 font-medium text-base" id="userEmail">Loading...</div>
                            </div>
                            <div class="min-w-[150px]">
                                <div class="text-gray-500 font-medium text-xs uppercase tracking-wider mb-1">Assigned Sections</div>
                                <div class="text-blue-900 font-bold text-base" id="assignedSections">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10">
                    <!-- Card 1: My Sections -->
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl text-white p-4 md:p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-layer-group text-sm md:text-base"></i>
                            <span class="font-semibold text-xs md:text-sm">My Sections</span>
                        </div>
                        <div class="font-extrabold text-2xl md:text-3xl" id="statSections">0</div>
                    </div>
                    
                    <!-- Card 2: My Students -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl text-white p-4 md:p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-user-graduate text-sm md:text-base"></i>
                            <span class="font-semibold text-xs md:text-sm">My Students</span>
                        </div>
                        <div class="font-extrabold text-2xl md:text-3xl" id="statStudents">0</div>
                    </div>
                    
                    <!-- Card 3: Pending Activities -->
                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl text-white p-4 md:p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-clock text-sm md:text-base"></i>
                            <span class="font-semibold text-xs md:text-sm">Pending Activities</span>
                        </div>
                        <div class="font-extrabold text-2xl md:text-3xl" id="statPending">0</div>
                    </div>
                </div>
                
                <!-- My Sections Section -->
                <div id="sectionsContainer" class="hidden bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex items-center mb-5">
                        <i class="fas fa-chalkboard text-gray-700 mr-2"></i>
                        <h3 class="text-gray-900 font-bold text-xl">My Assigned Sections</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="sectionsGrid">
                        <!-- Sections will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Real-time Monitoring -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-5 space-y-3 sm:space-y-0">
                        <div class="flex items-center">
                            <i class="fas fa-desktop text-gray-700 mr-2"></i>
                            <h3 class="text-gray-900 font-bold text-xl">Real-time Activity Monitoring</h3>
                        </div>
                        <div class="flex items-center space-x-2 bg-green-50 text-green-700 font-semibold text-sm py-1.5 px-4 rounded-full border border-green-200">
                            <div class="w-2 h-2 bg-green-500 rounded-full live-dot"></div>
                            <span>Live Updates</span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Monitoring Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">
                        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-user-check text-green-500 mr-2"></i>
                                <h4 class="text-gray-800 font-semibold">Active Activity Sessions</h4>
                            </div>
                            <div class="max-h-72 overflow-y-auto" id="activeTestsList">
                                <div class="py-10 text-center">
                                    <div class="text-5xl mb-3 opacity-40">ðŸ‘¥</div>
                                    <div class="text-gray-700 font-semibold mb-1">No Active Activities</div>
                                    <div class="text-gray-500 text-sm">Students will appear here when they start activities</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-history text-yellow-500 mr-2"></i>
                                <h4 class="text-gray-800 font-semibold">Recent Activity Completions</h4>
                            </div>
                            <div class="max-h-72 overflow-y-auto" id="recentCompletions">
                                <div class="py-10 text-center">
                                    <div class="text-5xl mb-3 opacity-40">âœ…</div>
                                    <div class="text-gray-700 font-semibold mb-1">No Recent Activities</div>
                                    <div class="text-gray-500 text-sm">Completed activities will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-950 mt-10 py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h4 class="text-yellow-500 font-bold text-lg text-center mb-5">About CTBL</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The Center for Technology Based Learning serves as the learning management system operating hub, 
                        reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                        center's daily operations.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        Working closely with the Office of the President, the Center for Information Technology, and the 
                        Deans and Directors to support the LMS end-users' day-to-day activity.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The center focuses on implementing new forms of training and determining the validity of data to 
                        support the university's educational objectives.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentProfessor = null;
        let professorSections = [];
        let professorStudents = [];

        // Profile dropdown toggle
        window.toggleProfileDropdown = function(event) {
            if (event) event.preventDefault();
            document.getElementById('profileDropdown').classList.toggle('show');
        };

        // View profile function
        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            document.getElementById('profileDropdown').classList.remove('show');
        };

        // Logout function
        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            document.getElementById('profileDropdown').classList.remove('show');
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileContainer = document.querySelector('.profile-container');
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileContainer && !profileContainer.contains(event.target)) {
                profileDropdown.classList.remove('show');
            }
        });

        // Function to update profile picture
        function updateProfilePicture(photoURL, userName) {
            const profileCircle = document.getElementById('profileCircle');
            const profileDropdownAvatar = document.getElementById('profileDropdownAvatar');
            const userPhoto = document.getElementById('userPhoto');
            const initial = userName ? userName.charAt(0).toUpperCase() : 'P';
            
            if (photoURL) {
                // Create image element for profile circle
                const circleImg = document.createElement('img');
                circleImg.src = photoURL;
                circleImg.alt = userName || 'Profile';
                circleImg.onerror = function() {
                    // If image fails to load, show initial
                    profileCircle.innerHTML = initial;
                    profileCircle.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%)';
                    profileCircle.style.color = 'white';
                };
                
                // Update profile circle
                profileCircle.innerHTML = '';
                profileCircle.appendChild(circleImg);
                
                // Create image element for dropdown avatar
                const dropdownImg = document.createElement('img');
                dropdownImg.src = photoURL;
                dropdownImg.alt = userName || 'Profile';
                dropdownImg.onerror = function() {
                    // If image fails to load, show initial
                    profileDropdownAvatar.innerHTML = initial;
                    profileDropdownAvatar.style.background = 'rgba(255,255,255,0.2)';
                    profileDropdownAvatar.style.color = 'white';
                };
                
                // Update dropdown avatar
                profileDropdownAvatar.innerHTML = '';
                profileDropdownAvatar.appendChild(dropdownImg);
                
                // Update profile photo in main content
                userPhoto.src = photoURL;
                userPhoto.onerror = function() {
                    // If image fails to load, use default
                    userPhoto.src = 'https://c.animaapp.com/tzMzyNnw/img/image-13@2x.png';
                };
            } else {
                // No photo URL, use initial
                profileCircle.innerHTML = initial;
                profileCircle.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%)';
                profileCircle.style.color = 'white';
                
                profileDropdownAvatar.innerHTML = initial;
                profileDropdownAvatar.style.background = 'rgba(255,255,255,0.2)';
                profileDropdownAvatar.style.color = 'white';
                
                // Keep default image for main photo
                userPhoto.src = 'https://c.animaapp.com/tzMzyNnw/img/image-13@2x.png';
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const dashboardContent = document.getElementById('dashboardContent');
            
            if (user) {
                try {
                    console.log('=== PROFESSOR AUTHENTICATION ===');
                    console.log('User authenticated:', user.email);
                    
                    // Update profile picture with Google photo
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    const userEmail = user.email.toLowerCase();
                    
                    // First try to find professor by email in professors collection
                    const professorsQuery = query(
                        collection(db, 'professors'),
                        where('email', '==', userEmail)
                    );
                    const professorsSnapshot = await getDocs(professorsQuery);
                    
                    if (!professorsSnapshot.empty) {
                        const professorDoc = professorsSnapshot.docs[0];
                        currentProfessor = { id: professorDoc.id, ...professorDoc.data() };
                        console.log('âœ“ Professor found in professors collection:', currentProfessor);
                    } else {
                        // Try users collection
                        const usersQuery = query(
                            collection(db, 'users'),
                            where('email', '==', userEmail),
                            where('role', '==', 'professor')
                        );
                        const usersSnapshot = await getDocs(usersQuery);
                        
                        if (!usersSnapshot.empty) {
                            const userDoc = usersSnapshot.docs[0];
                            currentProfessor = { id: userDoc.id, ...userDoc.data() };
                            console.log('âœ“ Professor found in users collection:', currentProfessor);
                        } else {
                            throw new Error('Professor account not found. Please contact the secretary.');
                        }
                    }
                    
                    // Update UI with professor information
                    const professorName = currentProfessor.fullName || currentProfessor.name || user.displayName || 'Professor';
                    
                    document.getElementById('userName').textContent = professorName;
                    document.getElementById('userEmail').textContent = userEmail;
                    
                    // Update profile dropdown
                    document.getElementById('dropdownName').textContent = professorName;
                    document.getElementById('dropdownEmail').textContent = userEmail;
                    
                    // Load professor's sections and students
                    await loadProfessorSections();
                    await loadProfessorStatistics();
                    setupRealtimeMonitoring();
                    
                    // Show dashboard
                    loadingScreen.style.display = 'none';
                    dashboardContent.style.display = 'block';
                    
                } catch (error) {
                    console.error('=== ERROR IN AUTHENTICATION ===');
                    console.error('Error:', error);
                    
                    loadingScreen.style.display = 'none';
                    alert(error.message || 'Error loading dashboard. Please try again.');
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                }
            } else {
                console.log('No user authenticated, redirecting to login...');
                window.location.href = '/login/index.html';
            }
        });

        async function loadProfessorSections() {
            try {
                console.log('Loading professor sections...');
                
                professorSections = [];
                professorStudents = [];
                
                // Get professor's name for matching
                const professorName = currentProfessor.fullName || currentProfessor.name || '';
                const professorEmail = currentProfessor.email;
                
                console.log('Professor name for matching:', professorName);
                console.log('Professor email:', professorEmail);
                
                // Query sections collection for this professor
                const sectionsQuery = query(
                    collection(db, 'sections')
                );
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                console.log('Total sections in database:', sectionsSnapshot.size);
                
                sectionsSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    
                    // Check if this professor teaches this section
                    const professorMatches = 
                        sectionData.professor === professorName ||
                        sectionData.professorEmail === professorEmail ||
                        (sectionData.professor && professorName.includes(sectionData.professor)) ||
                        (sectionData.professor && sectionData.professor.includes(professorName));
                    
                    if (professorMatches) {
                        console.log(`âœ“ Section assigned: ${sectionData.name}`);
                        
                        professorSections.push({
                            id: doc.id,
                            ...sectionData
                        });
                        
                        // Add students from this section
                        if (sectionData.students && Array.isArray(sectionData.students)) {
                            sectionData.students.forEach(student => {
                                professorStudents.push({
                                    ...student,
                                    section: sectionData.name,
                                    sectionId: doc.id
                                });
                            });
                        }
                    }
                });
                
                console.log(`Found ${professorSections.length} sections with ${professorStudents.length} students`);
                
                // Update UI
                document.getElementById('assignedSections').textContent = professorSections.length;
                document.getElementById('statSections').textContent = professorSections.length;
                document.getElementById('statStudents').textContent = professorStudents.length;
                
                // Display sections if any found
                if (professorSections.length > 0) {
                    document.getElementById('sectionsContainer').classList.remove('hidden');
                    displaySections();
                }
                
            } catch (error) {
                console.error('Error loading sections:', error);
            }
        }

        function displaySections() {
            const sectionsGrid = document.getElementById('sectionsGrid');
            
            if (professorSections.length === 0) {
                sectionsGrid.innerHTML = `
                    <div class="col-span-3">
                        <div class="py-10 text-center">
                            <div class="text-5xl mb-3 opacity-40">ðŸ“š</div>
                            <div class="text-gray-700 font-semibold mb-1">No Sections Assigned</div>
                            <div class="text-gray-500 text-sm">Sections assigned by the secretary will appear here</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            professorSections.forEach(section => {
                const students = section.students || [];
                const firstFewStudents = students.slice(0, 5);
                const remainingCount = Math.max(0, students.length - 5);
                
                let studentsHtml = '';
                firstFewStudents.forEach(student => {
                    const displayName = student.name || student.email || 'Unknown Student';
                    studentsHtml += `<span class="inline-flex items-center bg-white border border-gray-200 rounded px-2 py-1 text-xs text-gray-700 m-1">${displayName}</span>`;
                });
                
                if (remainingCount > 0) {
                    studentsHtml += `<span class="inline-flex items-center bg-white border border-gray-200 rounded px-2 py-1 text-xs text-gray-700 m-1">+${remainingCount} more</span>`;
                }
                
                html += `
                    <div class="bg-gray-50 rounded-xl border border-gray-200 p-5 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:border-yellow-500">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-blue-900 font-bold text-lg">${section.name || 'Unnamed Section'}</div>
                            <div class="bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-full">${students.length} students</div>
                        </div>
                        <div class="mb-4">
                            <div class="flex items-center text-gray-600 text-sm mb-2">
                                <i class="fas fa-book w-5"></i>
                                <span>${section.courseCode || 'PE 3'}</span>
                            </div>
                            <div class="flex items-center text-gray-600 text-sm mb-2">
                                <i class="fas fa-user-tie w-5"></i>
                                <span>${section.professor || 'Professor'}</span>
                            </div>
                            <div class="flex items-center text-gray-600 text-sm">
                                <i class="fas fa-calendar-alt w-5"></i>
                                <span>Updated: ${formatDate(section.lastUpdated || section.createdAt)}</span>
                            </div>
                        </div>
                        ${students.length > 0 ? `
                            <div class="pt-4 border-t border-gray-200">
                                <div class="flex items-center text-gray-700 font-semibold text-sm mb-3">
                                    <i class="fas fa-users mr-1"></i>
                                    <span>Students in this section:</span>
                                </div>
                                <div class="flex flex-wrap">${studentsHtml}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            sectionsGrid.innerHTML = html;
        }

        async function loadProfessorStatistics() {
            try {
                // Initialize stats
                document.getElementById('statPending').textContent = '0';
                
                // Get student IDs for querying activities
                const studentIds = professorStudents.map(s => s.studentId || s.uid || s.email);
                if (studentIds.length === 0) return;
                
                // Query activity results for these students
                const activitiesQuery = query(
                    collection(db, 'activityResults'),
                    where('studentId', 'in', studentIds.slice(0, 10))
                );
                const activitiesSnapshot = await getDocs(activitiesQuery);
                
                let pendingCount = 0;
                
                activitiesSnapshot.forEach(doc => {
                    const activity = doc.data();
                    if (activity.status === 'pending') {
                        pendingCount++;
                    }
                });
                
                // Update stats
                document.getElementById('statPending').textContent = pendingCount;
                
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function setupRealtimeMonitoring() {
            try {
                // Get student IDs for monitoring
                const studentIds = professorStudents.map(s => s.studentId || s.uid || s.email);
                
                if (studentIds.length > 0) {
                    // Set up real-time listener for active tests
                    const activeTestsQuery = query(
                        collection(db, 'activeTests'),
                        where('studentId', 'in', studentIds.slice(0, 10)),
                        where('status', '==', 'active')
                    );
                    
                    onSnapshot(activeTestsQuery, (snapshot) => {
                        updateActiveTestsList(snapshot);
                    });
                    
                    // Set up real-time listener for recent completions
                    const recentCompletionsQuery = query(
                        collection(db, 'activityResults'),
                        where('studentId', 'in', studentIds.slice(0, 10)),
                        where('status', '==', 'completed'),
                        orderBy('submittedAt', 'desc')
                    );
                    
                    onSnapshot(recentCompletionsQuery, (snapshot) => {
                        updateRecentCompletions(snapshot);
                    });
                }
                
            } catch (error) {
                console.error('Error setting up real-time monitoring:', error);
            }
        }

        function updateActiveTestsList(snapshot) {
            const container = document.getElementById('activeTestsList');
            
            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="py-10 text-center">
                        <div class="text-5xl mb-3 opacity-40">ðŸ‘¥</div>
                        <div class="text-gray-700 font-semibold mb-1">No Active Activities</div>
                        <div class="text-gray-500 text-sm">Students will appear here when they start activities</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let count = 0;
            snapshot.forEach((doc) => {
                if (count >= 8) return;
                count++;
                
                const activity = doc.data();
                const progress = activity.progress || 0;
                const studentName = activity.studentName || 'Unknown Student';
                const initials = getInitials(studentName);
                
                // Find student info
                const studentInfo = professorStudents.find(s => 
                    s.studentId === activity.studentId || 
                    s.email === activity.studentEmail ||
                    s.uid === activity.studentId
                );
                
                const section = studentInfo?.section || 'N/A';
                
                html += `
                    <div class="flex items-center p-3 bg-white rounded-lg border border-gray-100 mb-2 hover:bg-gray-50 hover:translate-x-1 transition-all duration-300">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-semibold mr-3">
                            ${initials}
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${studentName}</div>
                            <div class="flex space-x-4 text-xs text-gray-500">
                                <span>${section}</span>
                                <span>${activity.activityName || 'Unnamed Activity'}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1">
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
                            <span class="text-blue-600 font-semibold text-sm">${progress}%</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateRecentCompletions(snapshot) {
            const container = document.getElementById('recentCompletions');
            
            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="py-10 text-center">
                        <div class="text-5xl mb-3 opacity-40">âœ…</div>
                        <div class="text-gray-700 font-semibold mb-1">No Recent Activities</div>
                        <div class="text-gray-500 text-sm">Completed activities will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let count = 0;
            snapshot.forEach((doc) => {
                if (count >= 5) return;
                count++;
                
                const result = doc.data();
                const studentName = result.studentName || 'Unknown Student';
                const activityName = result.activityName || 'Unknown Activity';
                const score = result.score || 0;
                const initials = getInitials(studentName);
                
                // Find student info
                const studentInfo = professorStudents.find(s => 
                    s.studentId === result.studentId || 
                    s.email === result.studentEmail ||
                    s.uid === result.studentId
                );
                
                const section = studentInfo?.section || 'N/A';
                
                html += `
                    <div class="flex items-center p-3 bg-white rounded-lg border border-gray-100 mb-2 hover:bg-gray-50 hover:translate-x-1 transition-all duration-300">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-semibold mr-3">
                            ${initials}
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${studentName}</div>
                            <div class="flex space-x-4 text-xs text-gray-500">
                                <span>${section}</span>
                                <span>${activityName}</span>
                            </div>
                        </div>
                        <div class="text-gray-700 font-medium">Score: ${score}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getInitials(name) {
            if (!name) return '??';
            const nameParts = name.split(' ');
            if (nameParts.length >= 2) {
                return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch (error) {
                return 'Invalid date';
            }
        }
    </script>
</body>
</html>