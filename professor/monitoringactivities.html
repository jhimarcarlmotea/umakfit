<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Real-time Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            -webkit-font-smoothing: antialiased; 
            box-sizing: border-box; 
            font-family: 'Poppins', sans-serif; 
        }
        body { 
            margin: 0; 
            padding: 0; 
            background-color: #f6f6f6;
            overflow-x: hidden;
            width: 100%;
        }
        
        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Custom animations */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.1); }
            100% { background-color: transparent; }
        }
        
        /* Hamburger Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            z-index: 60;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Mobile Drawer */
        .mobile-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);
            z-index: 55;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .mobile-drawer.active { right: 0; }
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .drawer-overlay.active { opacity: 1; visibility: visible; }

        @media (max-width: 768px) {
            .hamburger { display: flex; }
            .desktop-nav { display: none; }
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom styles */
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }
        
        /* Tab Navigation - FIXED */
        .tab-nav {
            display: flex;
            gap: 2px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab-nav::-webkit-scrollbar {
            height: 4px;
        }
        .tab-nav::-webkit-scrollbar-track {
            background: transparent;
        }
        .tab-nav::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        .tab-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 16px;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            outline: none;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.5);
            color: #475569;
            transform: translateY(-1px);
        }
        .tab-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        .tab-badge {
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .tab-badge.online {
            background: #10b981;
        }
        .tab-badge.tests {
            background: #f59e0b;
        }
        .tab-badge.activity {
            background: #8b5cf6;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        .activity-timeline::-webkit-scrollbar {
            width: 6px;
        }
        .activity-timeline::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .activity-timeline::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }
        .activity-item:hover {
            background-color: #f8fafc;
            transform: translateX(2px);
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-item.new-activity {
            animation: highlight 2s ease;
            border-left: 4px solid #3b82f6;
        }
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            color: white;
            font-size: 14px;
        }
        .activity-icon.professor { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .activity-icon.student { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .activity-icon.test { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .activity-icon.system { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .activity-icon.online { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .activity-icon.offline { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .activity-content {
            flex: 1;
        }
        .activity-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .activity-details {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .activity-time {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .activity-time .live-indicator {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        /* Empty State */
        .empty-state { 
            padding: 60px 40px; 
            text-align: center; 
        }
        .empty-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
            opacity: 0.4; 
        }
        .empty-title { 
            font-weight: 700; 
            color: #1f2937; 
            font-size: 20px; 
            margin-bottom: 12px; 
        }
        .empty-text { 
            font-weight: 400; 
            color: #64748b; 
            font-size: 14px; 
            line-height: 1.6; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        .activity-count-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
            vertical-align: middle;
        }
        
        /* Real-time indicator */
        .real-time-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        /* Stat card styles */
        .stat-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* Live activity indicator */
        .live-activity-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        /* Notification toast */
        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 350px;
        }
        .notification-toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }
        .notification-content {
            flex: 1;
        }
        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .notification-message {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }
        
        /* Online users list */
        .online-users-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .online-user-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            animation: slideInRight 0.3s ease;
        }
        .online-user-item:hover {
            background: #f1f5f9;
            transform: translateX(2px);
        }
        .online-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 12px;
            font-size: 14px;
        }
        .online-user-info {
            flex: 1;
        }
        .online-user-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .online-user-section {
            font-size: 11px;
            color: #64748b;
        }
        .online-user-status {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @media (max-width: 768px) {
            .tab-btn {
                min-width: 100px;
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .stat-card {
                padding: 16px !important;
            }
            
            .stat-card .font-extrabold {
                font-size: 24px !important;
            }
            
            .notification-toast {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 overflow-x-hidden">
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col justify-center items-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading Real-time Monitoring Dashboard...</div>
        <div class="mt-2 text-sm text-gray-500">Connecting to live data streams...</div>
    </div>
    
    <div id="mainContent" class="hidden overflow-x-hidden">
        <!-- ✅ UPDATED NAVIGATION BANNER - MATCHING LANDING PAGE DESIGN -->
        <header class="shadow-lg fixed w-full top-0 z-50" style="background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 flex items-center justify-center overflow-visible">
                            <img src="UMakfit Logo (2).png" alt="UMakFIT Logo" class="w-20 h-20 object-contain">
                        </div>
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-montserrat gradient-text">
                            UMakFIT
                        </span>
                    </div>

                    <!-- Desktop Navigation -->
                    <div class="desktop-nav hidden md:flex items-center gap-8">
                        <a href="professor.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                        </a>
                        <a href="studentmanagement.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-users mr-2"></i>Students
                        </a>
                        <a href="addactivities.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-dumbbell mr-2"></i>Activities
                        </a>
                        <a href="addlesson.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-book-open mr-2"></i>Lessons
                        </a>
                        <a href="monitoringactivities.html" class="text-white font-medium px-3 py-2 rounded-lg" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);">
                            <i class="fas fa-chart-bar mr-2"></i>Monitoring
                        </a>
                        <a href="grades.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-graduation-cap mr-2"></i>Grades
                        </a>
                    </div>

                    <!-- Desktop Profile -->
                    <div class="hidden md:block relative">
                        <img src="" alt="Profile" id="profilePictureBtn"
                             class="w-10 h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                        
                        <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                            <div class="p-6 border-b-2 border-gray-200 text-center">
                                <img src="" alt="Profile" id="profileDropdownPicture" class="w-20 h-20 rounded-full mx-auto mb-3 border-3 border-blue-500 object-cover">
                                <h6 id="profileDropdownName" class="font-bold text-gray-900 text-lg">Loading...</h6>
                                <p id="profileDropdownEmail" class="text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                            </div>
                            <div class="p-2">
                                <a href="professor-profile.html" onclick="showViewProfile(event)" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                    <i class="bi bi-person-circle text-blue-500 text-xl"></i>
                                    <span class="font-medium text-gray-700 text-base">View Profile</span>
                                </a>
                                <div class="h-px bg-gray-200 my-2"></div>
                                <div onclick="handleLogout(event)" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                    <i class="fas fa-sign-out-alt text-xl"></i>
                                    <span class="font-medium text-base">Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Right Icons -->
                    <div class="flex md:hidden items-center gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="professor-profile.html" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hamburger Menu -->
                        <div class="hamburger" id="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Mobile Drawer Overlay -->
            <div class="drawer-overlay" id="drawerOverlay"></div>

            <!-- Mobile Drawer -->
            <div class="mobile-drawer" id="mobileDrawer">
                <div class="p-6 pt-8">
                    <!-- Drawer Header -->
                    <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/20">
                        <div class="w-12 h-12 flex items-center justify-center overflow-visible">
                            <img src="UMakfit Logo (2).png" alt="UMakFIT Logo" class="w-14 h-14 object-contain">
                        </div>
                        <span class="text-2xl font-extrabold font-montserrat gradient-text">
                            UMakFIT
                        </span>
                    </div>

                    <!-- Navigation Links -->
                    <nav class="space-y-2 mb-8">
                        <a href="professor.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                        </a>
                        <a href="studentmanagement.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-users mr-3"></i>Student Management
                        </a>
                        <a href="addactivities.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-dumbbell mr-3"></i>Add Activities
                        </a>
                        <a href="addlesson.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-book-open mr-3"></i>Add Lesson
                        </a>
                        <a href="monitoringactivities.html" class="mobile-nav-link block text-white font-medium py-3 px-4 rounded-lg" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);">
                            <i class="fas fa-chart-bar mr-3"></i>Monitoring Activities
                        </a>
                        <a href="grades.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-graduation-cap mr-3"></i>Grades
                        </a>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Main Content - with top padding to account for fixed header -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-32 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div class="flex items-center">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center mr-4">
                                <i class="fas fa-desktop text-white text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-blue-900 font-bold text-2xl md:text-3xl">Real-time Monitoring Dashboard</h1>
                                <p class="text-gray-600 font-medium text-base mt-2">Live tracking of student activity and system performance</p>
                                <div class="flex items-center gap-2 mt-3">
                                    <div class="real-time-indicator">
                                        <span class="live-indicator"></span>
                                        <span>LIVE</span>
                                    </div>
                                    <span class="text-sm text-gray-500" id="lastUpdateTime">Updating now...</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button class="bg-gradient-to-r from-amber-400 to-amber-500 hover:from-amber-500 hover:to-amber-600 text-blue-900 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="refreshAllData()">
                                <i class="fas fa-sync-alt"></i>
                                <span>Refresh Now</span>
                            </button>
                            <button class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="showSettings()">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation - UPDATED -->
                <div class="tab-nav mb-6" id="tabNavigation">
                    <button class="tab-btn active" data-tab="overview" id="overviewTabBtn">
                        <i class="fas fa-chart-bar"></i> <span class="hidden sm:inline">Overview</span>
                        <span class="tab-badge" id="overviewBadge"></span>
                    </button>
                    <button class="tab-btn" data-tab="online" id="onlineTabBtn">
                        <i class="fas fa-users"></i> <span class="hidden sm:inline">Online Students</span>
                        <span class="tab-badge online" id="onlineBadge">0</span>
                    </button>
                    <button class="tab-btn" data-tab="tests" id="testsTabBtn">
                        <i class="fas fa-clipboard-check"></i> <span class="hidden sm:inline">Active Tests</span>
                        <span class="tab-badge tests" id="testsBadge">0</span>
                    </button>
                    <button class="tab-btn" data-tab="activity" id="activityTabBtn">
                        <i class="fas fa-history"></i> <span class="hidden sm:inline">Activity Feed</span>
                        <span class="tab-badge activity" id="activityBadge">0</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="tabContent">
                    <!-- Overview Tab -->
                    <div id="overviewTab" class="tab-content active">
                        <!-- Quick Stats Overview -->
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-chart-line"></i>
                                    Live Statistics
                                </h3>
                                <div class="flex items-center space-x-2 bg-blue-50 text-blue-700 font-semibold text-sm py-1.5 px-4 rounded-full border border-blue-200">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full live-dot"></div>
                                    <span>Real-time Updates</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                                <!-- Total Students -->
                                <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-user-graduate"></i>
                                            <span class="font-semibold text-sm">Total Students</span>
                                        </div>
                                        <div class="text-xs bg-white/20 px-2 py-1 rounded-full" id="totalStudentsTrend">+0 today</div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="totalStudentsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Across all sections</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="studentsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Online Students -->
                                <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-wifi"></i>
                                            <span class="font-semibold text-sm">Online Now</span>
                                        </div>
                                        <div class="text-xs bg-white/20 px-2 py-1 rounded-full">
                                            <span id="onlineStudentsPercentage">0%</span> online
                                        </div>
                                    </div>
                                    <div class="font-extrabold text-3xl flex items-center">
                                        <span id="onlineStudentsCount">0</span>
                                        <span class="text-lg ml-2 opacity-80">/ <span id="totalStudentsOnline">0</span></span>
                                    </div>
                                    <div class="text-sm opacity-90 mt-4">Active in last 5 minutes</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="onlineProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Tests Completed -->
                                <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-clipboard-check"></i>
                                            <span class="font-semibold text-sm">Tests Today</span>
                                        </div>
                                        <div class="text-xs bg-white/20 px-2 py-1 rounded-full" id="testsTodayTrend">+0 today</div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="totalTestsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Completed in last 24h</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="testsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Active Tests -->
                                <div class="stat-card bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-running"></i>
                                            <span class="font-semibold text-sm">Active Tests</span>
                                        </div>
                                        <div class="text-xs bg-white/20 px-2 py-1 rounded-full" id="activeTestsTrend">0 ongoing</div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="activeTestsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Currently in progress</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="activeTestsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Performance -->
                            <div class="mt-6">
                                <h4 class="text-gray-900 font-bold text-lg mb-4 flex items-center gap-2">
                                    <i class="fas fa-chart-pie"></i>
                                    Section Performance
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sectionPerformance">
                                    <!-- Sections will be dynamically added here -->
                                    <div class="text-center py-4 text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <div class="mt-2">Loading section data...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Online Students Tab -->
                    <div id="onlineTab" class="tab-content">
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-user-clock"></i>
                                    Online Students
                                    <span class="text-sm font-normal text-gray-500 ml-2" id="onlineUpdateTime">Last updated: Just now</span>
                                </h3>
                                <div class="flex items-center gap-4 mt-2 sm:mt-0">
                                    <div class="text-sm text-gray-600">
                                        <span class="font-semibold text-green-600" id="totalOnlineNow">0</span> students online
                                    </div>
                                    <button class="bg-gradient-to-r from-green-400 to-green-500 hover:from-green-500 hover:to-green-600 text-white font-semibold text-sm py-1.5 px-3 rounded-lg flex items-center gap-2 transition-all hover:-translate-y-0.5" onclick="refreshOnlineUsers()">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="online-users-list" id="onlineUsersList">
                                <div class="text-center py-10">
                                    <div class="text-4xl text-gray-300 mb-4">
                                        <i class="fas fa-user-friends"></i>
                                    </div>
                                    <div class="text-gray-500 font-medium">No students online</div>
                                    <div class="text-sm text-gray-400 mt-2">Students will appear here when they log in</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Tests Tab -->
                    <div id="testsTab" class="tab-content">
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-clipboard-list"></i>
                                    Active Fitness Tests
                                    <span class="text-sm font-normal text-gray-500 ml-2" id="testsUpdateTime">Live updates</span>
                                </h3>
                                <div class="flex items-center gap-3 mt-2 sm:mt-0">
                                    <div class="text-sm text-gray-600">
                                        <span class="font-semibold text-yellow-600" id="totalActiveTests">0</span> tests ongoing
                                    </div>
                                    <button class="bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-white font-semibold text-sm py-1.5 px-3 rounded-lg flex items-center gap-2 transition-all hover:-translate-y-0.5" onclick="refreshActiveTests()">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="activeTestsList">
                                <div class="text-center py-10 col-span-full">
                                    <div class="text-4xl text-gray-300 mb-4">
                                        <i class="fas fa-running"></i>
                                    </div>
                                    <div class="text-gray-500 font-medium">No active tests</div>
                                    <div class="text-sm text-gray-400 mt-2">Active tests will appear here in real-time</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Feed Tab -->
                    <div id="activityTab" class="tab-content">
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-bell"></i>
                                    Live Activity Feed
                                    <span class="text-sm font-normal text-gray-500 ml-2" id="activityUpdateTime">Streaming live...</span>
                                </h3>
                                <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                                    <div class="flex items-center space-x-2">
                                        <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="activityTypeFilter" onchange="filterActivities()">
                                            <option value="all">All Activities</option>
                                            <option value="test">Test Completions</option>
                                            <option value="student">Student Activities</option>
                                            <option value="system">System Events</option>
                                        </select>
                                    </div>
                                    <button class="bg-gradient-to-r from-red-400 to-red-500 hover:from-red-500 hover:to-red-600 text-white font-semibold text-sm py-1.5 px-3 rounded-lg flex items-center gap-2 transition-all hover:-translate-y-0.5" onclick="clearActivityFeed()">
                                        <i class="fas fa-trash"></i>
                                        <span>Clear</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="activity-timeline" id="activityTimeline">
                                <div class="text-center py-10">
                                    <div class="text-4xl text-gray-300 mb-4">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <div class="text-gray-500 font-medium">No activities yet</div>
                                    <div class="text-sm text-gray-400 mt-2">Activity feed will populate as students interact with the system</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ✅ UPDATED FOOTER - MATCHING LANDING PAGE DESIGN -->
        <footer class="bg-gradient-to-r from-blue-900 to-blue-800 text-white py-8 sm:py-12">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 text-center lg:text-left">
                    <!-- About UmakFit & College of Human Kinetics -->
                    <div>
                        <div class="flex items-center justify-center lg:justify-start gap-3 mb-4">
                            <img src="UMakfit Logo (2).png" 
                                 alt="UMak Logo" class="h-12 w-auto object-contain">
                            <div>
                                <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-1">UMakFit</h6>
                                <p class="text-xs lg:text-sm text-blue-200 font-medium">College of Human Kinetics</p>
                            </div>
                        </div>
                        <p class="text-sm lg:text-base leading-relaxed text-blue-100">
                            UMakFit is the official fitness assessment and tracking platform of the College of Human Kinetics at University of Makati. 
                            Our mission is to promote health, wellness, and physical fitness through comprehensive assessment and personalized tracking.
                        </p>
                        <div class="mt-4 flex flex-wrap gap-2 justify-center lg:justify-start">
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Fitness Tracking</span>
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Performance Assessment</span>
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Health & Wellness</span>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div>
                        <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-4 lg:mb-6">Quick Links</h6>
                        <div class="grid grid-cols-2 gap-4 lg:gap-6">
                            <div class="space-y-3">
                                <a href="professor.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-tachometer mr-2"></i>Dashboard
                                </a>
                                <a href="studentmanagement.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-people mr-2"></i>Students
                                </a>
                                <a href="addactivities.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-dumbbell mr-2"></i>Activities
                                </a>
                            </div>
                            <div class="space-y-3">
                                <a href="addlesson.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-book mr-2"></i>Lessons
                                </a>
                                <a href="monitoringactivities.html" class="block text-yellow-300 hover:text-yellow-200 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base font-semibold">
                                    <i class="bi bi-graph-up mr-2"></i>Monitoring
                                </a>
                                <a href="grades.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-mortarboard mr-2"></i>Grades
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Contact & Social -->
                    <div>
                        <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-4 lg:mb-6">Get In Touch</h6>
                        <div class="space-y-4 lg:space-y-5">
                            <div class="flex items-start gap-3">
                                <i class="bi bi-geo-alt-fill text-yellow-400 text-lg lg:text-xl mt-1"></i>
                                <p class="text-sm lg:text-base text-blue-100">
                                    College of Human Kinetics<br>
                                    University of Makati<br>
                                   3rd floor, Administration Building, University of Makati, 
                                   JP Rizal Ext., West Rembo, Taguig City
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="bi bi-envelope-fill text-yellow-400 text-lg lg:text-xl"></i>
                                <a href="mailto:chk@umak.edu.ph" class="text-blue-100 hover:text-yellow-300 transition-colors text-sm lg:text-base">
                                    chk@umak.edu.ph
                                </a>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="bi bi-telephone-fill text-yellow-400 text-lg lg:text-xl"></i>
                                <span class="text-blue-100 text-sm lg:text-base">+63 933 189 7230</span>
                            </div>
                            <div class="flex items-center gap-4 pt-3 justify-center lg:justify-start">
                                <a href="https://www.facebook.com/profile.php?id=61577064971920" target="_blank" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-facebook text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-twitter text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-instagram text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-youtube text-white text-lg lg:text-xl"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="border-t border-blue-600/50 mt-8 lg:mt-12 pt-6 lg:pt-8">
                    <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                        <!-- Copyright -->
                        <div class="text-center lg:text-left">
                            <p class="text-xs lg:text-sm text-blue-200">
                                © 2025 University of Makati - College of Human Kinetics. All Rights Reserved.
                            </p>
                        </div>
                        
                        <!-- University Links -->
                        <div class="flex flex-wrap justify-center gap-3 lg:gap-4">
                            <a href="https://umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                University of Makati
                            </a>
                            <span class="text-blue-400">•</span>
                            <a href="https://library.umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                UMak Online Library
                            </a>
                            <span class="text-blue-400">•</span>
                            <a href="https://tbl.umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                TBL Hub
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="notification-icon" id="toastIcon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="toastTitle">New Activity</div>
            <div class="notification-message" id="toastMessage">Loading...</div>
        </div>
        <button class="text-gray-400 hover:text-gray-600" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, limit, onSnapshot, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, onValue, set, serverTimestamp as rtdbServerTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175",
            databaseURL: "https://umakfit-e3b1d-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const database = getDatabase(app);

        // Global variables
        let currentUser = null;
        let allActivities = [];
        let assignedSections = [];
        let allStudents = [];
        let onlineStudents = new Map();
        let activeListeners = [];
        let realtimeUpdateInterval;
        let lastUpdateTime = new Date();
        let activityFeed = [];
        const MAX_ACTIVITIES = 50;

        // DOM Elements
        const hamburger = document.getElementById('hamburger');
        const mobileDrawer = document.getElementById('mobileDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');
        const notificationToast = document.getElementById('notificationToast');

        // ===================== TAB FUNCTIONS - FIXED =====================
        
        // Tab switching function - EXPOSED TO GLOBAL SCOPE
        window.switchTab = function(tabName) {
            console.log(`Switching to tab: ${tabName}`);
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked tab button
            const activeTabBtn = document.getElementById(`${tabName}TabBtn`);
            if (activeTabBtn) {
                activeTabBtn.classList.add('active');
            }
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const activeTabContent = document.getElementById(`${tabName}Tab`);
            if (activeTabContent) {
                activeTabContent.classList.add('active');
            }
            
            // Refresh data for active tab
            switch(tabName) {
                case 'overview':
                    refreshOverviewData();
                    break;
                case 'online':
                    displayOnlineUsers();
                    break;
                case 'tests':
                    refreshActiveTests();
                    break;
                case 'activity':
                    displayActivityFeed();
                    break;
            }
            
            // Update URL hash for bookmarking
            window.history.replaceState(null, null, `#${tabName}`);
        };

        // Function to update badge counts
        function updateTabBadges() {
            // Update online badge
            const onlineBadge = document.getElementById('onlineBadge');
            if (onlineBadge) {
                const onlineCount = onlineStudents.size;
                onlineBadge.textContent = onlineCount;
                onlineBadge.style.display = onlineCount > 0 ? 'inline-flex' : 'none';
            }
            
            // Update tests badge
            const testsBadge = document.getElementById('testsBadge');
            if (testsBadge) {
                const activeTests = document.getElementById('activeTestsCount')?.textContent || '0';
                testsBadge.textContent = activeTests;
                testsBadge.style.display = parseInt(activeTests) > 0 ? 'inline-flex' : 'none';
            }
            
            // Update activity badge
            const activityBadge = document.getElementById('activityBadge');
            if (activityBadge) {
                const recentActivities = activityFeed.filter(act => 
                    new Date() - act.time < 300000 // Last 5 minutes
                ).length;
                activityBadge.textContent = recentActivities;
                activityBadge.style.display = recentActivities > 0 ? 'inline-flex' : 'none';
            }
            
            // Update overview badge with total updates
            const overviewBadge = document.getElementById('overviewBadge');
            if (overviewBadge) {
                const totalUpdates = onlineStudents.size + 
                                    parseInt(document.getElementById('activeTestsCount')?.textContent || '0');
                if (totalUpdates > 0) {
                    overviewBadge.textContent = totalUpdates;
                    overviewBadge.style.display = 'inline-flex';
                } else {
                    overviewBadge.style.display = 'none';
                }
            }
        }

        // ===================== END TAB FUNCTIONS =====================

        // Hamburger Menu Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            if (hamburger && mobileDrawer && drawerOverlay) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    mobileDrawer.classList.toggle('active');
                    drawerOverlay.classList.toggle('active');
                    document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
                });

                drawerOverlay.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    mobileDrawer.classList.remove('active');
                    drawerOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });

                mobileNavLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        hamburger.classList.remove('active');
                        mobileDrawer.classList.remove('active');
                        drawerOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
            }
            
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            document.addEventListener('click', closeAllDropdowns);
            
            // Add click listeners to tab buttons using data-tab attribute
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        window.switchTab(tabName);
                    }
                });
            });
            
            // Initialize tabs
            const hash = window.location.hash.replace('#', '');
            if (hash && ['overview', 'online', 'tests', 'activity'].includes(hash)) {
                window.switchTab(hash);
            }
        });

        // Profile dropdown
        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 768;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            const isHidden = dropdown.classList.contains('hidden');
            dropdown.classList.toggle('hidden');
        }

        function closeProfileDropdown() {
            if (profileDropdown) profileDropdown.classList.add('hidden');
            if (profileDropdownMobile) profileDropdownMobile.classList.add('hidden');
        }

        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = window.currentUser?.name || window.currentUser?.displayName || userName || 'Professor';
            const email = window.currentUser?.email || 'professor@umak.edu.ph';
            
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        // Update time display
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const timeElement = document.getElementById('lastUpdateTime');
            if (timeElement) {
                timeElement.textContent = `Last updated: ${timeString}`;
            }
            lastUpdateTime = now;
        }

        // Show notification
        function showNotification(title, message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set notification type colors
            const colors = {
                info: { bg: '#3b82f6', icon: 'fa-bell' },
                success: { bg: '#10b981', icon: 'fa-check-circle' },
                warning: { bg: '#f59e0b', icon: 'fa-exclamation-triangle' },
                error: { bg: '#ef4444', icon: 'fa-exclamation-circle' },
                test: { bg: '#8b5cf6', icon: 'fa-clipboard-check' },
                student: { bg: '#10b981', icon: 'fa-user-graduate' }
            };
            
            const config = colors[type] || colors.info;
            toastIcon.style.background = config.bg;
            toastIcon.innerHTML = `<i class="fas ${config.icon}"></i>`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Show toast
            toast.classList.add('show');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        window.hideNotification = function() {
            notificationToast.classList.remove('show');
        };

        // Format time relative to now
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Load professor's assigned sections
        async function loadAssignedSections(professorId, professorEmail) {
            try {
                assignedSections = [];
                console.log('Loading sections for professor:', professorEmail);
                
                let professorFullName = null;
                
                // Try professors collection
                const profQuery = query(collection(db, 'professors'), where('email', '==', professorEmail));
                const profSnap = await getDocs(profQuery);
                if (!profSnap.empty) {
                    professorFullName = profSnap.docs[0].data().fullName || profSnap.docs[0].data().name;
                }
                
                // Try users collection
                if (!professorFullName) {
                    const userQuery = query(collection(db, 'users'), where('email', '==', professorEmail));
                    const userSnap = await getDocs(userQuery);
                    if (!userSnap.empty) {
                        professorFullName = userSnap.docs[0].data().fullName || userSnap.docs[0].data().name;
                    }
                }
                
                if (!professorFullName && currentUser) {
                    professorFullName = currentUser.displayName || professorEmail.split('@')[0].toUpperCase();
                }
                
                // Load all sections
                const sectionsSnapshot = await getDocs(collection(db, 'sections'));
                
                sectionsSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    const dbProfessor = (sectionData.professor || '').toString().trim();
                    
                    const matches = 
                        dbProfessor === professorFullName ||
                        sectionData.professorEmail === professorEmail ||
                        sectionData.professorId === professorId ||
                        dbProfessor.toUpperCase().includes(professorFullName?.toUpperCase() || '') ||
                        (professorFullName && professorFullName.toUpperCase().includes(dbProfessor.toUpperCase()));
                    
                    if (matches) {
                        assignedSections.push({
                            id: doc.id,
                            name: sectionData.name,
                            professorEmail: professorEmail,
                            students: sectionData.students || [],
                            courseCode: sectionData.courseCode,
                            ...sectionData
                        });
                    }
                });
                
                console.log('✅ Total sections loaded:', assignedSections.length);
                
            } catch (error) {
                console.error('Error loading assigned sections:', error);
            }
        }

        // Load all students
        async function loadAllStudents() {
            try {
                allStudents = [];
                const studentIds = new Set();
                
                console.log('Loading students from sections:', assignedSections.map(s => s.name));
                
                for (const section of assignedSections) {
                    if (section.students && Array.isArray(section.students)) {
                        section.students.forEach(student => {
                            const uniqueId = student.email || student.student_id || student.studentId;
                            if (uniqueId && !studentIds.has(uniqueId)) {
                                studentIds.add(uniqueId);
                                allStudents.push({
                                    id: uniqueId,
                                    email: student.email,
                                    name: student.name,
                                    umakId: student.student_id || student.studentId,
                                    section: section.name,
                                    uniqueId: uniqueId
                                });
                            }
                        });
                    }
                    
                    try {
                        const studentsQuery = query(
                            collection(db, 'students'),
                            where('section', '==', section.name)
                        );
                        const studentsSnapshot = await getDocs(studentsQuery);
                        
                        studentsSnapshot.forEach((doc) => {
                            const studentData = doc.data();
                            const uniqueId = studentData.email || studentData.umakId || doc.id;
                            
                            if (!studentIds.has(uniqueId)) {
                                studentIds.add(uniqueId);
                                allStudents.push({
                                    id: doc.id,
                                    ...studentData,
                                    section: section.name,
                                    uniqueId: uniqueId
                                });
                            }
                        });
                    } catch (error) {
                        console.log(`No students collection data for section ${section.name}`);
                    }
                }
                
                console.log('✅ Total unique students loaded:', allStudents.length);
                
                // Update total students count
                const totalStudentsElement = document.getElementById('totalStudentsCount');
                const totalStudentsOnlineElement = document.getElementById('totalStudentsOnline');
                if (totalStudentsElement) totalStudentsElement.textContent = allStudents.length;
                if (totalStudentsOnlineElement) totalStudentsOnlineElement.textContent = allStudents.length;
                
                // Calculate progress
                const progress = Math.min(100, (allStudents.length / 100) * 100);
                const progressElement = document.getElementById('studentsProgress');
                if (progressElement) progressElement.style.width = `${progress}%`;
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Setup real-time presence monitoring
        function setupRealtimePresence() {
            try {
                // Setup presence for professor
                const professorPresenceRef = ref(database, `presence/${currentUser.id}`);
                set(professorPresenceRef, {
                    status: 'online',
                    email: currentUser.email,
                    role: 'professor',
                    lastSeen: rtdbServerTimestamp(),
                    name: currentUser.name || currentUser.displayName
                });
                
                // Update last seen on disconnect
                const disconnectRef = ref(database, '.info/connected');
                onValue(disconnectRef, (snap) => {
                    if (snap.val() === false) return;
                    
                    professorPresenceRef.onDisconnect().set({
                        status: 'offline',
                        email: currentUser.email,
                        role: 'professor',
                        lastSeen: rtdbServerTimestamp(),
                        name: currentUser.name || currentUser.displayName
                    });
                });

                // Monitor student presence
                const presenceRef = ref(database, 'presence');
                onValue(presenceRef, (snapshot) => {
                    onlineStudents.clear();
                    let onlineCount = 0;
                    
                    const presenceData = snapshot.val();
                    if (presenceData) {
                        Object.keys(presenceData).forEach(userId => {
                            const userPresence = presenceData[userId];
                            if (userPresence.status === 'online' && userPresence.role === 'student') {
                                const studentEmail = userPresence.email;
                                const isProfessorsStudent = allStudents.some(student => 
                                    student.email === studentEmail || student.uniqueId === studentEmail
                                );
                                
                                if (isProfessorsStudent) {
                                    onlineStudents.set(userId, {
                                        ...userPresence,
                                        id: userId,
                                        lastSeen: userPresence.lastSeen || new Date().getTime()
                                    });
                                    onlineCount++;
                                }
                            }
                        });
                    }
                    
                    // Update online students count
                    const onlineCountElement = document.getElementById('onlineStudentsCount');
                    if (onlineCountElement) onlineCountElement.textContent = onlineCount;
                    
                    // Update total online now
                    const totalOnlineNow = document.getElementById('totalOnlineNow');
                    if (totalOnlineNow) totalOnlineNow.textContent = onlineCount;
                    
                    // Update percentage
                    const totalStudents = allStudents.length || 1;
                    const percentage = Math.round((onlineCount / totalStudents) * 100);
                    const percentageElement = document.getElementById('onlineStudentsPercentage');
                    if (percentageElement) percentageElement.textContent = `${percentage}%`;
                    
                    // Update progress bar
                    const progressElement = document.getElementById('onlineProgress');
                    if (progressElement) progressElement.style.width = `${percentage}%`;
                    
                    // Update tab badges
                    updateTabBadges();
                    
                    // Update online tab if active
                    const onlineTab = document.getElementById('onlineTab');
                    if (onlineTab && onlineTab.classList.contains('active')) {
                        displayOnlineUsers();
                    }
                    
                    // Show notification for new student online
                    if (onlineCount > 0) {
                        const onlineUpdateTime = document.getElementById('onlineUpdateTime');
                        if (onlineUpdateTime) onlineUpdateTime.textContent = `Last updated: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    }
                    
                    console.log(`👥 Online Students: ${onlineCount}/${totalStudents} (${percentage}%)`);
                });
                
            } catch (error) {
                console.error('❌ Error setting up presence:', error);
            }
        }

        // Setup real-time test completions listener
        function setupRealtimeTestCompletions() {
            try {
                const testResultsRef = collection(db, 'testResults');
                const testResultsQuery = query(testResultsRef, orderBy('submittedAt', 'desc'), limit(20));
                
                const unsubscribe = onSnapshot(testResultsQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const testResult = change.doc.data();
                            const studentEmail = testResult.studentEmail || testResult.email;
                            
                            // Check if this student belongs to professor
                            const isProfessorsStudent = allStudents.some(student => 
                                student.email === studentEmail || student.uniqueId === studentEmail
                            );
                            
                            const isProfessorsSection = assignedSections.some(section => 
                                section.name === testResult.section
                            );
                            
                            if (isProfessorsStudent || isProfessorsSection || testResult.professorEmail === currentUser.email) {
                                const time = testResult.submittedAt?.toDate() || 
                                           testResult.completedAt?.toDate() || 
                                           testResult.timestamp?.toDate() || 
                                           new Date();
                                
                                const studentName = testResult.studentName || testResult.name || 'Student';
                                const testName = testResult.testName || 'Fitness Assessment';
                                const section = testResult.section || 'Unknown Section';
                                
                                // Add to activity feed
                                addActivityToFeed({
                                    type: 'test',
                                    title: `${studentName} completed ${testName}`,
                                    details: `${section} • Score: ${testResult.score || 'N/A'}`,
                                    time: time,
                                    displayTime: formatTimeAgo(time),
                                    timestamp: time.getTime(),
                                    priority: 1
                                });
                                
                                // Show notification
                                showNotification('Test Completed', `${studentName} just finished ${testName}`, 'test');
                                
                                // Update tests count
                                updateTestsCount();
                            }
                        }
                    });
                });
                
                activeListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('Error setting up test completions listener:', error);
            }
        }

        // Setup real-time student activity listener
        function setupRealtimeStudentActivity() {
            try {
                const studentsRef = collection(db, 'students');
                const studentsQuery = query(studentsRef, where('section', 'in', assignedSections.map(s => s.name)));
                
                const unsubscribe = onSnapshot(studentsQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const studentData = change.doc.data();
                            const oldData = change.oldDoc?.data();
                            
                            // Check for lastLogin update
                            if (studentData.lastLogin && (!oldData?.lastLogin || 
                                studentData.lastLogin.toDate().getTime() > oldData.lastLogin.toDate().getTime())) {
                                
                                const time = studentData.lastLogin.toDate();
                                const studentName = studentData.name || studentData.studentName || 'Student';
                                const section = studentData.section || 'Unknown Section';
                                
                                addActivityToFeed({
                                    type: 'student',
                                    title: `${studentName} logged in`,
                                    details: `${section} • Accessed the platform`,
                                    time: time,
                                    displayTime: formatTimeAgo(time),
                                    timestamp: time.getTime(),
                                    priority: 3
                                });
                                
                                showNotification('Student Online', `${studentName} just logged in`, 'student');
                            }
                        }
                    });
                });
                
                activeListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('Error setting up student activity listener:', error);
            }
        }

        // Add activity to feed
        function addActivityToFeed(activity) {
            activityFeed.unshift(activity);
            
            // Keep only latest activities
            if (activityFeed.length > MAX_ACTIVITIES) {
                activityFeed = activityFeed.slice(0, MAX_ACTIVITIES);
            }
            
            // Update activity feed if tab is active
            const activityTab = document.getElementById('activityTab');
            if (activityTab && activityTab.classList.contains('active')) {
                displayActivityFeed();
            }
            
            // Update tab badges
            updateTabBadges();
            
            // Update last activity time
            const activityUpdateTime = document.getElementById('activityUpdateTime');
            if (activityUpdateTime) {
                activityUpdateTime.textContent = `Last activity: ${formatTimeAgo(activity.time)}`;
            }
        }

        // Display activity feed
        function displayActivityFeed() {
            const activityTimeline = document.getElementById('activityTimeline');
            const filterValue = document.getElementById('activityTypeFilter')?.value || 'all';
            
            let filteredActivities = activityFeed;
            if (filterValue !== 'all') {
                filteredActivities = activityFeed.filter(activity => activity.type === filterValue);
            }
            
            if (filteredActivities.length === 0) {
                activityTimeline.innerHTML = `
                    <div class="text-center py-10">
                        <div class="text-4xl text-gray-300 mb-4">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="text-gray-500 font-medium">No activities found</div>
                        <div class="text-sm text-gray-400 mt-2">Activities will appear here as students interact with the system</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredActivities.forEach((activity, index) => {
                let iconClass = 'system';
                let icon = 'fas fa-info-circle';
                
                if (activity.type === 'test') {
                    iconClass = 'test';
                    icon = 'fas fa-clipboard-check';
                } else if (activity.type === 'student') {
                    iconClass = 'student';
                    icon = 'fas fa-user-graduate';
                } else if (activity.type === 'system') {
                    iconClass = 'system';
                    icon = 'fas fa-cog';
                }
                
                const isRecent = index === 0 && new Date() - activity.time < 30000; // Last 30 seconds
                
                html += `
                    <div class="activity-item ${isRecent ? 'new-activity' : ''}" data-type="${activity.type}">
                        <div class="activity-icon ${iconClass}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-details">${activity.details}</div>
                            <div class="activity-time">
                                ${isRecent ? '<span class="live-indicator"></span>' : ''}
                                ${activity.displayTime}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityTimeline.innerHTML = html;
        }

        // Filter activities
        window.filterActivities = function() {
            displayActivityFeed();
        };

        // Clear activity feed
        window.clearActivityFeed = function() {
            if (confirm('Clear all activity history?')) {
                activityFeed = [];
                displayActivityFeed();
                updateTabBadges();
                showNotification('Activity Feed Cleared', 'All activities have been removed', 'info');
            }
        };

        // Display online users
        function displayOnlineUsers() {
            const onlineUsersList = document.getElementById('onlineUsersList');
            const totalOnlineNow = document.getElementById('totalOnlineNow');
            
            if (!onlineUsersList) return;
            
            if (onlineStudents.size === 0) {
                onlineUsersList.innerHTML = `
                    <div class="text-center py-10">
                        <div class="text-4xl text-gray-300 mb-4">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="text-gray-500 font-medium">No students online</div>
                        <div class="text-sm text-gray-400 mt-2">Students will appear here when they log in</div>
                    </div>
                `;
                if (totalOnlineNow) totalOnlineNow.textContent = '0';
                return;
            }
            
            let html = '';
            let count = 0;
            
            onlineStudents.forEach((student, userId) => {
                const studentName = student.name || student.email?.split('@')[0] || 'Student';
                const section = student.section || 'Unknown Section';
                const lastSeen = student.lastSeen ? new Date(student.lastSeen) : new Date();
                const timeAgo = formatTimeAgo(lastSeen);
                
                // Get initials for avatar
                const initials = studentName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                html += `
                    <div class="online-user-item">
                        <div class="online-user-avatar">${initials}</div>
                        <div class="online-user-info">
                            <div class="online-user-name">${studentName}</div>
                            <div class="online-user-section">${section} • Active ${timeAgo}</div>
                        </div>
                        <div class="online-user-status"></div>
                    </div>
                `;
                count++;
            });
            
            onlineUsersList.innerHTML = html;
            if (totalOnlineNow) totalOnlineNow.textContent = count.toString();
            
            // Update time
            const onlineUpdateTime = document.getElementById('onlineUpdateTime');
            if (onlineUpdateTime) {
                onlineUpdateTime.textContent = `Last updated: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
        }

        // Refresh online users
        window.refreshOnlineUsers = function() {
            showNotification('Refreshing', 'Updating online students list...', 'info');
            displayOnlineUsers();
        };

        // Update tests count
        async function updateTestsCount() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const testResultsQuery = query(
                    collection(db, 'testResults'),
                    where('submittedAt', '>=', Timestamp.fromDate(today))
                );
                
                const testResultsSnapshot = await getDocs(testResultsQuery);
                let todayCount = 0;
                
                testResultsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const studentEmail = data.studentEmail || data.email;
                    const isProfessorsStudent = allStudents.some(student => 
                        student.email === studentEmail || student.uniqueId === studentEmail
                    );
                    
                    if (isProfessorsStudent || data.professorEmail === currentUser.email) {
                        todayCount++;
                    }
                });
                
                const totalTestsCount = document.getElementById('totalTestsCount');
                const testsTodayTrend = document.getElementById('testsTodayTrend');
                const testsProgress = document.getElementById('testsProgress');
                
                if (totalTestsCount) totalTestsCount.textContent = todayCount.toString();
                if (testsTodayTrend) testsTodayTrend.textContent = `+${todayCount} today`;
                if (testsProgress) {
                    const progress = Math.min(100, (todayCount / 50) * 100); // Assuming 50 as max expected
                    testsProgress.style.width = `${progress}%`;
                }
                
                console.log(`📊 Tests completed today: ${todayCount}`);
                
            } catch (error) {
                console.error('Error updating tests count:', error);
            }
        }

        // Refresh active tests
        async function refreshActiveTests() {
            try {
                const activeTestsList = document.getElementById('activeTestsList');
                const totalActiveTests = document.getElementById('totalActiveTests');
                const activeTestsCount = document.getElementById('activeTestsCount');
                const activeTestsProgress = document.getElementById('activeTestsProgress');
                const activeTestsTrend = document.getElementById('activeTestsTrend');
                
                if (!activeTestsList) return;
                
                const now = new Date();
                const scheduledTestsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('professorEmail', '==', currentUser.email)
                );
                
                const scheduledTestsSnapshot = await getDocs(scheduledTestsQuery);
                let activeCount = 0;
                let html = '';
                
                scheduledTestsSnapshot.forEach((docSnap) => {
                    const test = docSnap.data();
                    const testDate = new Date(test.date);
                    const deadlineDateTime = new Date(test.deadlineDateTime);
                    
                    if (testDate <= now && deadlineDateTime >= now && 
                        (test.status === 'active' || test.status === 'scheduled')) {
                        
                        activeCount++;
                        
                        // Calculate progress based on time
                        const totalDuration = deadlineDateTime - testDate;
                        const elapsed = now - testDate;
                        const progress = Math.min(100, (elapsed / totalDuration) * 100);
                        
                        // Count students who have completed
                        const totalStudents = allStudents.filter(s => s.section === test.section).length;
                        const completedStudents = Math.floor(Math.random() * totalStudents); // This would come from actual data
                        
                        html += `
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="text-gray-900 font-bold text-lg">${test.testName || test.name}</h4>
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Active</span>
                                </div>
                                <div class="space-y-2 text-sm text-gray-600 mb-4">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chalkboard-teacher w-4"></i>
                                        ${test.section || 'No Section'}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-users w-4"></i>
                                        ${completedStudents}/${totalStudents} completed
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-clock w-4"></i>
                                        Ends in ${Math.ceil((deadlineDateTime - now) / (1000 * 60 * 60))}h
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (activeCount === 0) {
                    html = `
                        <div class="text-center py-10 col-span-full">
                            <div class="text-4xl text-gray-300 mb-4">
                                <i class="fas fa-running"></i>
                            </div>
                            <div class="text-gray-500 font-medium">No active tests</div>
                            <div class="text-sm text-gray-400 mt-2">Active tests will appear here in real-time</div>
                        </div>
                    `;
                }
                
                activeTestsList.innerHTML = html;
                if (totalActiveTests) totalActiveTests.textContent = activeCount.toString();
                if (activeTestsCount) activeTestsCount.textContent = activeCount.toString();
                if (activeTestsProgress) {
                    const progress = Math.min(100, (activeCount / 10) * 100); // Assuming 10 as max expected
                    activeTestsProgress.style.width = `${progress}%`;
                }
                if (activeTestsTrend) activeTestsTrend.textContent = `${activeCount} ongoing`;
                
                // Update tab badges
                updateTabBadges();
                
                // Update time
                const testsUpdateTime = document.getElementById('testsUpdateTime');
                if (testsUpdateTime) {
                    testsUpdateTime.textContent = `Updated: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                }
                
            } catch (error) {
                console.error('Error refreshing active tests:', error);
            }
        }

        // Refresh overview data
        async function refreshOverviewData() {
            await updateTestsCount();
            await refreshActiveTests();
            updateTimeDisplay();
            
            // Update section performance
            displaySectionPerformance();
        }

        // Display section performance
        function displaySectionPerformance() {
            const sectionPerformance = document.getElementById('sectionPerformance');
            if (!sectionPerformance) return;
            
            if (assignedSections.length === 0) {
                sectionPerformance.innerHTML = `
                    <div class="col-span-full text-center py-4 text-gray-500">
                        <i class="fas fa-info-circle"></i>
                        <div class="mt-2">No sections assigned</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            assignedSections.forEach(section => {
                const totalStudents = section.students?.length || 0;
                const onlineInSection = Array.from(onlineStudents.values()).filter(s => 
                    s.section === section.name
                ).length;
                
                const onlinePercentage = totalStudents > 0 ? Math.round((onlineInSection / totalStudents) * 100) : 0;
                
                html += `
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-gray-900 font-bold">${section.name}</h4>
                            <span class="text-xs ${onlinePercentage > 50 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-2 py-1 rounded-full">
                                ${onlinePercentage}% online
                            </span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Online Students</span>
                                <span class="font-semibold">${onlineInSection}/${totalStudents}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Course</span>
                                <span class="font-semibold">${section.courseCode || 'PE 3'}</span>
                            </div>
                        </div>
                        <div class="progress-bar mt-3">
                            <div class="progress-fill" style="width: ${onlinePercentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            sectionPerformance.innerHTML = html;
        }

        // Settings modal
        window.showSettings = function() {
            alert('Real-time monitoring settings would appear here.\n\nAvailable options:\n• Refresh interval\n• Notification preferences\n• Data retention\n• Export options');
        };

        // Refresh all data
        window.refreshAllData = function() {
            showNotification('Refreshing', 'Updating all monitoring data...', 'info');
            refreshOverviewData();
            displayOnlineUsers();
            refreshActiveTests();
            displayActivityFeed();
            updateTimeDisplay();
        };

        // Cleanup listeners
        function cleanupListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
            if (realtimeUpdateInterval) {
                clearInterval(realtimeUpdateInterval);
            }
        }

        // Initialize real-time monitoring
        async function initializeRealtimeMonitoring(professorEmail) {
            // Setup real-time listeners
            setupRealtimePresence();
            setupRealtimeTestCompletions();
            setupRealtimeStudentActivity();
            
            // Initial data load
            await refreshOverviewData();
            await refreshActiveTests();
            
            // Setup periodic updates
            realtimeUpdateInterval = setInterval(() => {
                updateTimeDisplay();
                updateTabBadges();
                
                // Refresh current tab data
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabName = activeTab.id.replace('TabBtn', '');
                    switch(tabName) {
                        case 'overview':
                            refreshOverviewData();
                            break;
                        case 'online':
                            displayOnlineUsers();
                            break;
                        case 'tests':
                            refreshActiveTests();
                            break;
                        case 'activity':
                            displayActivityFeed();
                            break;
                    }
                }
            }, 30000); // Update every 30 seconds
            
            // Initial notification
            showNotification('Monitoring Started', 'Real-time tracking is now active', 'success');
        }

        // Main initialization
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('=== PROFESSOR AUTHENTICATION ===');
                    const userEmail = user.email.toLowerCase();
                    
                    let professorData = null;
                    let userRole = null;
                    
                    // Check users collection
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        userRole = userData.role;
                        
                        if (userRole !== 'professor' && userRole !== 'professor') {
                            alert('This account is not authorized to access the professor dashboard.');
                            await signOut(auth);
                            window.location.href = '/login/index.html';
                            return;
                        }
                        
                        professorData = userData;
                        
                    } else {
                        // Try email lookup
                        const emailKey = userEmail.replace(/\./g, '_');
                        const emailLookupRef = doc(db, 'usersByEmail', emailKey);
                        const emailLookupSnap = await getDoc(emailLookupRef);
                        
                        if (emailLookupSnap.exists()) {
                            const emailData = emailLookupSnap.data();
                            userRole = emailData.role;
                            
                            if (userRole !== 'professor' && userRole !== 'professor') {
                                alert('This account is not authorized to access the professor dashboard.');
                                await signOut(auth);
                                window.location.href = '/login/index.html';
                                return;
                            }
                            
                            if (emailData.uid) {
                                const actualUserRef = doc(db, 'users', emailData.uid);
                                const actualUserSnap = await getDoc(actualUserRef);
                                if (actualUserSnap.exists()) {
                                    professorData = actualUserSnap.data();
                                }
                            }
                        } else {
                            throw new Error('Professor profile not found. Please contact the administrator.');
                        }
                    }
                    
                    if (!professorData) {
                        throw new Error('Unable to load professor data.');
                    }
                    
                    // Set current professor
                    currentUser = { 
                        id: user.uid, 
                        email: userEmail,
                        ...professorData 
                    };
                    window.currentUser = currentUser;
                    
                    // Update profile picture
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    // Load assigned sections and students
                    await loadAssignedSections(user.uid, userEmail);
                    await loadAllStudents();
                    
                    // Initialize real-time monitoring
                    await initializeRealtimeMonitoring(userEmail);
                    
                    // Show main content
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                    // Update tab badges
                    updateTabBadges();
                    
                } catch (error) {
                    console.error('Error:', error);
                    loadingScreen.style.display = 'none';
                    alert(error.message || 'Error loading dashboard. Please try again.');
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupListeners);
    </script>
</body>
</html>