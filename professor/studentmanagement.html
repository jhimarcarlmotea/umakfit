<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Student Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { 
            font-family: 'Inter', Helvetica, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f6f6f6;
        }
        
        /* Navigation styles */
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .loading-text {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Card styles */
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
        }
        .custom-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .custom-table thead {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%);
        }
        .custom-table th {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: white;
            font-size: 14px;
            text-align: left;
            padding: 15px 12px;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .custom-table td {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .custom-table tbody tr {
            transition: all 0.3s;
            cursor: pointer;
        }
        .custom-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            min-width: 80px;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .score-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .score-excellent {
            background-color: #d1fae5;
            color: #065f46;
        }
        .score-good {
            background-color: #fef3c7;
            color: #92400e;
        }
        .score-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* Action Buttons */
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .btn-view {
            background: #10b981;
            color: white;
        }
        .btn-view:hover {
            background: #059669;
        }
        
        /* Empty State */
        .empty-state {
            padding: 60px 40px;
            text-align: center;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px;
        }
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
            color: #64748b;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Student Info Styles */
        .student-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
        
        .student-basic-info {
            flex: 1;
        }
        
        .student-name {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .student-id {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #64748b;
            font-size: 14px;
        }
        
        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .info-label {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #64748b;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
        }
        
        .info-value-email {
            word-break: break-all;
            font-size: 13px;
            color: #475569;
        }
        
        /* Step Indicator */
        .step.active .step-circle {
            background: #667eea !important;
            color: white !important;
        }
        
        .step.completed .step-circle {
            background: #10b981 !important;
            color: white !important;
        }
        
        /* ‚≠ê NEW: Test Count Badge */
        .test-count-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        
        /* Sorting Dropdown Styles */
        .sort-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .sort-button {
            padding: 8px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #475569;
        }
        
        .sort-button:hover {
            background: #f1f5f9;
        }
        
        .sort-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 100;
            border: 1px solid #e2e8f0;
            margin-top: 5px;
        }
        
        .sort-dropdown-content.show {
            display: block;
        }
        
        .sort-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .sort-option:last-child {
            border-bottom: none;
        }
        
        .sort-option:hover {
            background-color: #f8fafc;
        }
        
        .sort-option.active {
            background-color: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .sort-icon {
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Filter Dropdown Styles */
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .filter-button {
            padding: 8px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #475569;
        }
        
        .filter-button:hover {
            background: #f1f5f9;
        }
        
        .filter-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 100;
            border: 1px solid #e2e8f0;
            margin-top: 5px;
        }
        
        .filter-dropdown-content.show {
            display: block;
        }
        
        .filter-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .filter-option:last-child {
            border-bottom: none;
        }
        
        .filter-option:hover {
            background-color: #f8fafc;
        }
        
        .filter-option.active {
            background-color: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .filter-checkbox {
            margin-right: 8px;
        }
        
        .filter-count {
            margin-left: auto;
            font-size: 12px;
            color: #94a3b8;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }
        
        .modal-header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Responsive Table Styles */
        @media (max-width: 768px) {
            /* Hide tables on mobile */
            .custom-table {
                display: none;
            }
            
            /* Mobile card view for sections */
            .mobile-cards-container {
                display: block;
            }
            
            .section-card {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .section-card-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                padding-bottom: 8px;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .section-card-label {
                font-weight: 600;
                color: #64748b;
                font-size: 13px;
                min-width: 120px;
            }
            
            .section-card-value {
                flex: 1;
                text-align: right;
                color: #1e293b;
                font-weight: 500;
                font-size: 14px;
            }
            
            /* Mobile card view for students */
            .student-card {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .student-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .student-card-info {
                flex: 1;
            }
            
            .student-card-name {
                font-weight: 700;
                color: #1e3a8a;
                font-size: 16px;
                margin-bottom: 4px;
            }
            
            .student-card-id {
                color: #64748b;
                font-size: 13px;
            }
            
            .student-card-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            
            .student-card-detail {
                text-align: center;
                padding: 10px;
                background: #f8fafc;
                border-radius: 6px;
            }
            
            .student-card-label-small {
                display: block;
                font-size: 11px;
                color: #64748b;
                margin-bottom: 4px;
            }
            
            .student-card-value {
                display: block;
                font-weight: 600;
                color: #1e293b;
                font-size: 14px;
            }
            
            /* Show mobile containers, hide tables */
            .mobile-sections-container,
            .mobile-students-container {
                display: block;
            }
            
            /* Hide table-responsive container on mobile */
            .table-responsive {
                display: none;
            }
            
            /* Adjust modal for mobile */
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            /* Mobile pagination */
            .mobile-pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 20px;
                gap: 10px;
            }
            
            .mobile-pagination-button {
                padding: 8px 16px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
            }
            
            .mobile-pagination-button:disabled {
                background: #94a3b8;
                cursor: not-allowed;
            }
            
            .mobile-pagination-info {
                font-size: 14px;
                color: #64748b;
            }
        }
        
        @media (min-width: 769px) {
            /* Hide mobile containers on desktop */
            .mobile-sections-container,
            .mobile-students-container {
                display: none;
            }
            
            /* Show tables on desktop */
            .table-responsive {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Student Management...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- Navigation Banner -->
        <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4 py-3 sm:py-4">
                    <!-- Logo -->
                    <a href="#" class="flex items-center gap-2 sm:gap-3">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <a href="professor.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-tachometer-alt"></i> 
                            <span>Dashboard</span>
                        </a>
                        
                        <a href="studentmanagement.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-users"></i> 
                            <span>Student Management</span>
                        </a>
                        
                        <a href="addactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-dumbbell"></i> 
                            <span>Add Activities</span>
                        </a>
                        
                        <a href="addlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-book-open"></i> 
                            <span>Add Lesson</span>
                        </a>
                        
                        <a href="monitoringactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-chart-bar"></i> 
                            <span>Monitoring Activities</span>
                        </a>
                        
                        <a href="grades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-graduation-cap"></i> 
                            <span>Grades</span>
                        </a>
                        
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="mobileMenuButton" class="text-white p-1 sm:p-2">
                            <i class="bi bi-list text-2xl sm:text-3xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Navigation Menu -->
                <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2 pb-3">
                    <a href="professor.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                    </a>
                    <a href="studentmanagement.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-users mr-2"></i> Student Management
                    </a>
                    <a href="addactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-dumbbell mr-2"></i> Add Activities
                    </a>
                    <a href="addlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-book-open mr-2"></i> Add Lesson
                    </a>
                    <a href="monitoringactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-chart-bar mr-2"></i> Monitoring Activities
                    </a>
                    <a href="grades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-graduation-cap mr-2"></i> Grades
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-10 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex items-center mb-5">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mr-4">
                            <i class="fas fa-users text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-blue-900 font-bold text-3xl">Student Management</h1>
                            <p class="text-gray-600 font-medium text-base mt-2">View student scores and add additional attempts</p>
                        </div>
                    </div>
                </div>

                <!-- My Sections -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-layer-group"></i>
                            My Assigned Sections
                        </h3>
                        <button class="mt-2 sm:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="searchSections" placeholder="Search sections..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               onkeyup="filterSections()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="custom-table" id="sectionsTable">
                            <thead>
                                <tr>
                                    <th>Section Name</th>
                                    <th>Year Level</th>
                                    <th>Total Students</th>
                                    <th>Course Code</th>
                                    <th>Time/Day/Room</th>
                                    <th>Academic Year</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sectionsTableBody">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <div class="empty-icon">üè´</div>
                                            <div class="font-semibold text-gray-700 mb-1">Loading Sections...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Sections Container -->
                    <div class="mobile-sections-container" id="mobileSectionsContainer" style="display: none;">
                        <!-- Mobile cards will be inserted here -->
                    </div>

                    <div class="mt-5 text-sm text-gray-600">
                        Showing <span id="sectionCount">0</span> sections
                    </div>
                </div>

                <!-- Student List -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-user-graduate"></i>
                            Student Scores & Attempts
                        </h3>
                        <button class="mt-2 sm:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all" onclick="exportStudents()">
                            <i class="fas fa-file-export"></i>
                            <span>Export Scores</span>
                        </button>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="flex gap-2 mb-4 border-b border-gray-200">
                        <button id="allStudentsTab" class="px-4 py-2 font-semibold text-blue-600 border-b-2 border-blue-600" onclick="switchTab('all')">
                            All Students (<span id="allStudentsCount">0</span>)
                        </button>
                        <button id="overdueTab" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" onclick="switchTab('overdue')">
                            Overdue Tests (<span id="overdueCount">0</span>)
                        </button>
                    </div>
                    
                    <!-- All Students View -->
                    <div id="allStudentsView">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="searchStudents" placeholder="Search students by name or UMaK ID..." 
                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   onkeyup="filterStudents()">
                            
                            <select id="filterSection" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterStudents()">
                                <option value="">All Sections</option>
                            </select>
                            
                            <select id="filterPerformance" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterStudents()">
                                <option value="">All Performance</option>
                                <option value="excellent">Excellent (90-100%)</option>
                                <option value="good">Good (70-89%)</option>
                                <option value="needs-improvement">Needs Improvement (0-69%)</option>
                                <option value="no-attempts">No Attempts Yet</option>
                            </select>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="custom-table" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>UMaK ID</th>
                                        <th>Student Name</th>
                                        <th>Section</th>
                                        <th>Best Score</th>
                                        <th>Average Score</th>
                                        <th>Last Attempt</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="7">
                                            <div class="empty-state">
                                                <div class="empty-icon">üë•</div>
                                                <div class="font-semibold text-gray-700 mb-1">Loading Students...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Mobile Students Container -->
                        <div class="mobile-students-container" id="mobileStudentsContainer" style="display: none;">
                            <!-- Mobile cards will be inserted here -->
                        </div>
                        
                        <div class="mt-5 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="text-sm text-gray-600">
                                Showing <span id="studentCount">0</span> students
                            </div>
                            <div class="flex gap-2">
                                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm transition-all" onclick="previousPage()">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <span class="flex items-center text-sm text-gray-600 px-3">
                                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                                </span>
                                <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm transition-all" onclick="nextPage()">
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Overdue View -->
                    <div id="overdueView" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="searchOverdue" placeholder="Search students or tests..." 
                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   onkeyup="filterOverdueStudents()">
                            
                            <select id="filterOverdueSection" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterOverdueStudents()">
                                <option value="">All Sections</option>
                            </select>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="custom-table">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Section</th>
                                        <th>Overdue Tests</th>
                                        <th>Deadline</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="overdueTableBody">
                                    <tr>
                                        <td colspan="5">
                                            <div class="empty-state">
                                                <div class="empty-icon">‚úÖ</div>
                                                <div class="font-semibold text-gray-700 mb-1">No Overdue Tests</div>
                                                <div class="text-gray-500 text-sm">All students are up to date!</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-950 mt-10 py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h4 class="text-yellow-500 font-bold text-lg text-center mb-5">About CTBL</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The Center for Technology Based Learning serves as the learning management system operating hub, 
                        reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                        center's daily operations.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        Working closely with the Office of the President, the Center for Information Technology, and the 
                        Deans and Directors to support the LMS end-users' day-to-day activity.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The center focuses on implementing new forms of training and determining the validity of data to 
                        support the university's educational objectives.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚≠ê UPDATED: Student Overdue Tests Modal with Sorting and Filtering -->
    <div id="studentTestsModal" class="modal-overlay" style="display: none;" onclick="closeStudentTestsModal()">
        <div class="modal-content" style="max-width: 900px;" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-clipboard-list"></i> <span id="modalStudentName">Student Tests</span>
                </h3>
                <div class="modal-header-controls">
                    <!-- Test Filter Dropdown -->
                    <div class="filter-dropdown">
                        <button class="filter-button" onclick="toggleFilterDropdown(event)">
                            <i class="fas fa-filter"></i>
                            <span id="currentFilterLabel">Filter: All Tests</span>
                            <i class="fas fa-chevron-down sort-icon"></i>
                        </button>
                        <div class="filter-dropdown-content" id="filterDropdown">
                            <div class="filter-option active" onclick="changeFilter('all-tests')">
                                <i class="fas fa-list"></i>
                                <span>All Tests</span>
                                <span class="filter-count" id="count-all">0</span>
                            </div>
                            <!-- Test options will be populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Sorting Dropdown -->
                    <div class="sort-dropdown">
                        <button class="sort-button" onclick="toggleSortDropdown(event)">
                            <i class="fas fa-sort-amount-down"></i>
                            <span id="currentSortLabel">Sort: Newest First</span>
                            <i class="fas fa-chevron-down sort-icon"></i>
                        </button>
                        <div class="sort-dropdown-content" id="sortDropdown">
                            <div class="sort-option active" onclick="changeSort('newest-first')">
                                <i class="fas fa-arrow-down"></i>
                                <span>Newest First</span>
                            </div>
                            <div class="sort-option" onclick="changeSort('oldest-first')">
                                <i class="fas fa-arrow-up"></i>
                                <span>Oldest First</span>
                            </div>
                            <div class="sort-option" onclick="changeSort('test-name-a-z')">
                                <i class="fas fa-sort-alpha-down"></i>
                                <span>Test Name A-Z</span>
                            </div>
                            <div class="sort-option" onclick="changeSort('test-name-z-a')">
                                <i class="fas fa-sort-alpha-up"></i>
                                <span>Test Name Z-A</span>
                            </div>
                            <div class="sort-option" onclick="changeSort('score-high-low')">
                                <i class="fas fa-chart-line"></i>
                                <span>Score: High to Low</span>
                            </div>
                            <div class="sort-option" onclick="changeSort('score-low-high')">
                                <i class="fas fa-chart-bar"></i>
                                <span>Score: Low to High</span>
                            </div>
                            <div class="sort-option" onclick="changeSort('status')">
                                <i class="fas fa-check-circle"></i>
                                <span>Status (Pending First)</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeStudentTestsModal()">&times;</button>
                </div>
            </div>
            
            <div style="max-height: 70vh; overflow-y: auto;">
                <div class="p-6">
                    <div class="table-responsive">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Status</th>
                                    <th>Deadline</th>
                                    <th>Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTestsTableBody">
                                <!-- Tests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end p-6 border-t border-gray-200 bg-gray-50">
                <button class="px-6 py-2.5 bg-gray-700 hover:bg-gray-800 text-white rounded-lg font-semibold transition-all" onclick="closeStudentTestsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- View Section Details Modal -->
    <div id="viewSectionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-layer-group"></i> Section Details
                </h3>
                <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeViewSectionModal()">&times;</button>
            </div>
            
            <div style="max-height: 70vh; overflow-y: auto;">
                <div class="p-6 border-b border-gray-100">
                    <div id="sectionDetailsContent">
                        <!-- Will be populated with section info -->
                    </div>
                </div>
                
                <div class="p-6">
                    <h4 class="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-user-graduate"></i> Students in this Section
                    </h4>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border-radius: 8px;">
                        <table class="custom-table">
                            <thead style="position: sticky; top: 0; background: linear-gradient(90deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%); z-index: 10;">
                                <tr>
                                    <th>UMaK ID</th>
                                    <th>Student Name</th>
                                    <th>Email</th>
                                    <th>Total Attempts</th>
                                    <th>Best Score</th>
                                    <th>Average Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sectionStudentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end p-6 border-t border-gray-200 bg-gray-50">
                <button class="px-6 py-2.5 bg-gray-700 hover:bg-gray-800 text-white rounded-lg font-semibold transition-all" onclick="closeViewSectionModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- View Student Details Modal -->
    <div id="viewStudentModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-user-circle"></i> Student Performance
                </h3>
                <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeViewStudentModal()">&times;</button>
            </div>
            
            <div style="max-height: 70vh; overflow-y: auto;">
                <div class="p-6 border-b border-gray-100">
                    <div id="studentDetailsContent">
                        <!-- Will be populated with student info -->
                    </div>
                </div>
                
                <div class="p-6">
                    <h4 class="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-history"></i> Activity Attempts
                    </h4>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border-radius: 8px;">
                        <table class="custom-table">
                            <thead style="position: sticky; top: 0; background: linear-gradient(90deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%); z-index: 10;">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Activity Type</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attemptsTableBody">
                                <!-- Attempts will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end p-6 border-t border-gray-200 bg-gray-50">
                <button class="px-6 py-2.5 bg-gray-700 hover:bg-gray-800 text-white rounded-lg font-semibold transition-all" onclick="closeViewStudentModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Score Modal -->
    <div id="editScoreModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-purple-600 to-purple-500">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>üìù</span> Edit Student Score
                    </h3>
                    <p class="text-white text-sm mt-1" id="editScoreTestName">Test Name</p>
                </div>
                <button class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all" onclick="closeEditScoreModal()">√ó</button>
            </div>
            <div class="p-6">
                <div class="flex justify-between mb-6 relative">
                    <div class="absolute top-4 left-8 right-8 h-0.5 bg-gray-200 z-0"></div>
                    <div class="step active flex flex-col items-center gap-2 relative z-10" id="step1">
                        <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold step-circle">1</div>
                        <div class="text-xs font-semibold text-purple-600">View Current</div>
                    </div>
                    <div class="step flex flex-col items-center gap-2 relative z-10" id="step2">
                        <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold step-circle">2</div>
                        <div class="text-xs font-semibold text-gray-500">Edit Score</div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 mb-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-700">Test Target</span>
                        <span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm font-bold" id="editScoreTarget">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-gray-700">Student</span>
                        <span class="text-sm font-semibold text-gray-900" id="editScoreStudent">Student Name</span>
                    </div>
                </div>

                <div id="stepContent1">
                    <div class="bg-blue-50 rounded-lg p-4 mb-4 border-l-4 border-blue-500">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-700">Current Result</span>
                            <span class="text-sm font-bold text-gray-900" id="currentResultDisplay">--</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700">Current Score</span>
                            <span class="text-2xl font-bold text-blue-600" id="currentScoreDisplay">--</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-info-circle"></i> Click "Next" to edit this score
                    </p>
                </div>

                <div id="stepContent2" style="display: none;">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Student Result <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-500">üìä</span>
                            <input type="number" class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-semibold" id="newResult" placeholder="Enter result" min="0" step="1">
                        </div>
                        <p class="text-xs text-gray-600 mt-1" id="resultHint">Enter what the student achieved in this test</p>
                    </div>

                    <div id="scorePreview" class="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-500" style="display: none;">
                        <div class="text-xs font-semibold text-yellow-800 mb-1">CALCULATED SCORE</div>
                        <div class="text-4xl font-bold text-yellow-900" id="previewScore">0</div>
                        <div class="text-xs text-yellow-800 mt-2 score-preview-text">Based on the result entered</div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all" onclick="closeEditScoreModal()">Cancel</button>
                <button id="btnNext" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button id="btnSubmit" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all" onclick="submitScore()" style="display: none;">
                    <span>‚úì</span> Save Score
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
   <script type="module">
        import { 
            initializeApp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    import { 
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        getDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        orderBy,
        serverTimestamp,
        limit,
        Timestamp,
        onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
            window.db = db;
            window.collection = collection;
            window.doc = doc;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.serverTimestamp = serverTimestamp;
            window.getDocs = getDocs;
            window.getDoc = getDoc;
            window.query = query;
            window.where = where;
            window.orderBy = orderBy;
            window.limit = limit;
            window.Timestamp = Timestamp;
            window.onSnapshot = onSnapshot;
            window.deleteDoc = deleteDoc;
        // Global variables
        window.currentUser = null;
        window.sections = [];
        window.students = [];
        window.filteredStudents = [];
        window.currentStudentId = null;
        window.currentPage = 1;
        window.itemsPerPage = 10;
        window.filteredSections = [];
        window.overdueStudents = [];
        window.filteredOverdueStudents = [];
        window.currentTab = 'all';
        
        // ‚≠ê NEW: Sorting and filtering state for student tests modal
        window.currentStudentTests = [];
        window.currentStudentTestsFiltered = [];
        window.currentSort = 'newest-first';
        window.currentFilter = 'all-tests';
        window.availableTestTypes = [];

        // Navigation functions
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 1024;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                document.body.classList.add('dropdown-open');
            } else {
                dropdown.classList.add('hidden');
                document.body.classList.remove('dropdown-open');
            }
        }

        function closeProfileDropdown() {
            profileDropdown.classList.add('hidden');
            profileDropdownMobile.classList.add('hidden');
            document.body.classList.remove('dropdown-open');
        }

        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', toggleMobileMenu);
            }
            
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            document.addEventListener('click', closeAllDropdowns);
        });

        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = window.currentProfessor?.fullName || window.currentProfessor?.name || userName || 'Professor';
            const email = window.currentProfessor?.email || 'professor@umak.edu.ph';
            
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        window.refreshData = async function() {
            console.log('Refresh data called');
        };

        window.filterSections = function() {
            console.log('Filter sections called');
        };

        window.filterStudents = function() {
            console.log('Filter students called');
        };

        window.exportStudents = function() {
            console.log('Export students called');
        };

        window.switchTab = function(tab) {
            console.log('Switch tab called:', tab);
        };

        window.previousPage = function() {
            console.log('Previous page called');
        };

        window.nextPage = function() {
            console.log('Next page called');
        };

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('Student management loading for:', user.email);
                    window.currentUser = user;
                    
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Error loading student management:', error);
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    alert('Error loading data: ' + error.message);
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        async function loadSections() {
            try {
                console.log('üìä Loading sections...');
                
                window.sections = [];
                let professorEmail = window.currentUser.email;
                
                // Get professor name
                let professorFullName = null;
                const profQuery = query(collection(db, 'professors'), where('email', '==', professorEmail));
                const profSnap = await getDocs(profQuery);
                if (!profSnap.empty) {
                    professorFullName = profSnap.docs[0].data().fullName || profSnap.docs[0].data().name;
                }
                
                if (!professorFullName) {
                    professorFullName = window.currentUser.displayName || professorEmail.split('@')[0].toUpperCase();
                }
                
                console.log('üë§ Looking for sections of:', professorFullName);
                
                // Get all sections
                const sectionsSnapshot = await getDocs(collection(db, 'sections'));
                
                sectionsSnapshot.forEach(sectionDoc => {
                    const data = sectionDoc.data();
                    const dbProfessor = (data.professor || '').toString().trim();
                    
                    const matches = 
                        dbProfessor === professorFullName ||
                        dbProfessor.toUpperCase().includes(professorFullName.toUpperCase()) ||
                        professorFullName.toUpperCase().includes(dbProfessor.toUpperCase());
                    
                    if (matches) {
                        console.log(`‚úÖ MATCHED! Section: ${data.name}`);
                        
                        const studentCount = Array.isArray(data.students) ? data.students.length : 0;
                        
                       
                        let schedule = '';
                        if (data.time && data.day && data.room) {
                            schedule = `${data.time} / ${data.day} / ${data.room}`;
                        } else if (data.schedule) {
                            schedule = data.schedule; // Use existing schedule if available
                        } else {
                            schedule = 'Not Set';
                        }
                        
                        // Extract academic year from various possible fields
                        let academicYear = '';
                        if (data.academicYear) {
                            academicYear = data.academicYear;
                        } else if (data.createdYear) {
                            academicYear = data.createdYear;
                        } else {
                            academicYear = '2025-2026'; // Default
                        }
                        
                        window.sections.push({
                            id: sectionDoc.id,
                            name: data.name,
                            yearLevel: data.yearLevel || extractYearLevel(data.name),
                            studentCount: studentCount,
                            
                            // Use the combined schedule
                            courseCode: data.courseCode || 'PE 3',
                            schedule: schedule, 
                            createdYear: academicYear,
                            
                            // Store individual components for reference
                            timeSlot: data.time || '',
                            days: data.day || data.days || '',
                            room: data.room || '',
                            semester: data.semester || '',
                            fullSemester: data.fullSemester || '',
                            
                            // Additional details
                            status: 'active',
                            professorName: dbProfessor,
                            description: data.description || '',
                            students: data.students || []
                        });
                    }
                });
                
                console.log(`üìä Total sections loaded: ${window.sections.length}`);
                window.filteredSections = [...window.sections];
                
                if (window.sections.length === 0) {
                    document.getElementById('sectionsTableBody').innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <div class="empty-icon">‚ö†Ô∏è</div>
                                    <div class="empty-title">No Sections Assigned</div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    populateSectionsTable();
                    populateSectionFilters();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading sections:', error);
                alert('Error loading sections: ' + error.message);
            }
        }

async function uploadSectionFromCSV(csvData) {
    try {
        // Parse CSV data
        const sectionInfo = parseCSVData(csvData);
        
        // Create proper Firestore document structure
        const sectionData = {
            // Basic Info
            name: sectionInfo.sectionName,              
            professor: sectionInfo.professorName,       
            
            // Course Details
            courseCode: sectionInfo.courseCode,         
            courseTitle: sectionInfo.courseTitle,        
            courseFileNumber: sectionInfo.fileNumber,    
            
            // Schedule Info (‚≠ê NEW STANDARDIZED FIELDS)
            schedule: sectionInfo.timeDayRoom,           
            timeSlot: sectionInfo.timeSlot,              
            days: sectionInfo.days,                      
            room: sectionInfo.room,                     
            
            // Academic Info (‚≠ê NEW STANDARDIZED FIELDS)
            academicYear: sectionInfo.academicYear,      // "2025-2026"
            semester: sectionInfo.semester,              // "First Semester"
            fullSemester: sectionInfo.fullSemester,      // "First Semester, A.Y. 2025-2026"
            
            // Other Info
            yearLevel: extractYearLevel(sectionInfo.sectionName),  // "3"
            units: sectionInfo.units,                    // "2.0"
            college: sectionInfo.college,                // "COLLEGE OF HUMAN KINETICS"
            
            // Students Array
            students: sectionInfo.students,              // [{name, student_id, email}, ...]
            
            // Metadata
            createdAt: serverTimestamp(),
            createdBy: window.currentUser.email,
            updatedAt: serverTimestamp(),
            status: 'active'
        };
        
        // Save to Firestore
        await addDoc(collection(db, 'sections'), sectionData);
        
        console.log('‚úÖ Section uploaded successfully!');
        return true;
        
    } catch (error) {
        console.error('‚ùå Error uploading section:', error);
        throw error;
    }
}

// ‚≠ê HELPER: Parse CSV data into structured format
function parseCSVData(csvText) {
    const lines = csvText.split('\n');
    
    // Extract data from specific rows based on your CSV structure
    return {
        sectionName: extractValue(lines, 'Section:'),
        professorName: extractValue(lines, 'Faculty:'),
        courseCode: extractValue(lines, 'Course Code:'),
        courseTitle: extractValue(lines, 'Course Title:'),
        fileNumber: extractValue(lines, 'Course File Number:'),
        
        // Parse schedule string: "03:00-05:00 / W / Volleyball Court A"
        timeDayRoom: extractValue(lines, 'Time/Days/Room:'),
        timeSlot: extractSchedulePart(lines, 'Time/Days/Room:', 0),     // "03:00-05:00"
        days: extractSchedulePart(lines, 'Time/Days/Room:', 1),          // "W"
        room: extractSchedulePart(lines, 'Time/Days/Room:', 2),          // "Volleyball Court A"
        
        // Parse academic year: "First Semester, A.Y. 2025-2026"
        fullSemester: extractValue(lines, 0, 4),  // Row 5
        semester: 'First Semester',
        academicYear: '2025-2026',
        
        units: extractValue(lines, 'Units:'),
        college: extractValue(lines, 0, 3),  // Row 4
        
        students: parseStudents(lines)
    };
}

// ‚≠ê HELPER: Extract value from CSV
function extractValue(lines, searchKey, rowIndex = null) {
    if (rowIndex !== null) {
        return lines[rowIndex]?.trim() || '';
    }
    
    for (let line of lines) {
        if (line.includes(searchKey)) {
            return line.split(searchKey)[1]?.trim() || '';
        }
    }
    return '';
}

// ‚≠ê HELPER: Parse schedule string "03:00-05:00 / W / Volleyball Court A"
function extractSchedulePart(lines, searchKey, partIndex) {
    const fullSchedule = extractValue(lines, searchKey);
    if (!fullSchedule) return '';
    
    const parts = fullSchedule.split('/').map(p => p.trim());
    return parts[partIndex] || '';
}

// ‚≠ê HELPER: Parse student list
function parseStudents(lines) {
    const students = [];
    let startParsing = false;
    
    for (let line of lines) {
        // Find where student list starts
        if (line.includes('Name of Students')) {
            startParsing = true;
            continue;
        }
        
        if (startParsing && line.trim()) {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length >= 3) {
                students.push({
                    name: parts[1] + ', ' + parts[0],  // "BULATAO, JEROME"
                    student_id: parts[2],              // "A12239854"
                    email: parts[3] || ''              // "jbulatao.a12239854@umak.edu.ph"
                });
            }
        }
    }
    
    return students;
}
function getCurrentYear() {
    return new Date().getFullYear().toString();
}

function extractYearLevel(sectionName) {
    if (!sectionName) return 'N/A';
    
    const romanNumerals = {
        'I': '1',
        'II': '2',
        'III': '3',
        'IV': '4',
        'V': '5'
    };
    
    const romanMatch = sectionName.match(/^(I{1,3}|IV|V)/);
    if (romanMatch && romanMatch[0]) {
        return romanNumerals[romanMatch[0]] || romanMatch[0];
    }
    
    const numericMatch = sectionName.match(/\d/);
    if (numericMatch) {
        return numericMatch[0];
    }
    
    return 'N/A';
}

        window.loadStudents = async function() {
            try {
                console.log('=== LOADING STUDENTS FOR THIS PROFESSOR ===');

                if (window.sections.length === 0) {
                    console.log('No sections assigned. Skipping student load.');
                    updateStudentsTable([]);
                    return;
                }

                window.students = [];
                const seenStudentIds = new Set();

                for (const section of window.sections) {
                    if (!section.students || !Array.isArray(section.students) || section.students.length === 0) {
                        continue;
                    }

                    for (const rawStudent of section.students) {
                        const studentEmail = rawStudent.email || '';
                        if (!studentEmail || seenStudentIds.has(studentEmail)) continue;
                        seenStudentIds.add(studentEmail);

                        let firstName = '', lastName = '', fullName = rawStudent.name || 'Unknown Student';
                        if (fullName.includes(',')) {
                            const parts = fullName.split(',').map(p => p.trim());
                            lastName = parts[0];
                            firstName = parts.slice(1).join(' ');
                        } else {
                            const nameParts = fullName.split(' ');
                            firstName = nameParts[0] || '';
                            lastName = nameParts.slice(1).join(' ') || '';
                        }

                        let bestScore = 0;
                        let lastAttempt = null;
                        let lastAttemptTest = '';
                        let totalAttempts = 0;
                        let testAttempts = {};

                        if (studentEmail) {
                            const attemptsQuery = query(
                                collection(db, 'testResults'), 
                                where('studentEmail', '==', studentEmail)
                            );
                            const snapshot = await getDocs(attemptsQuery);
                            totalAttempts = snapshot.size;

                            const testBestScores = new Map();
                            
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                const testId = data.testId;
                                const testName = data.testName || 'Unknown Test';
                                const score = calculateTestScore(data.testName, data.result, data.testTarget);
                                
                                if (!testBestScores.has(testId) || score > testBestScores.get(testId)) {
                                    testBestScores.set(testId, score);
                                }
                                
                                if (score > bestScore) bestScore = score;

                                if (!testAttempts[testName]) {
                                    testAttempts[testName] = 0;
                                }
                                testAttempts[testName]++;

                                let attemptTime = null;
                                if (data.submittedAt) {
                                    if (typeof data.submittedAt.toDate === 'function') {
                                        attemptTime = data.submittedAt.toDate();
                                    } else if (data.submittedAt instanceof Date) {  
                                        attemptTime = data.submittedAt;
                                    } else if (typeof data.submittedAt === 'string' || typeof data.submittedAt === 'number') {
                                        attemptTime = new Date(data.submittedAt);
                                    }
                                }
                                if (attemptTime && (!lastAttempt || attemptTime > lastAttempt)) {
                                    lastAttempt = attemptTime;
                                    lastAttemptTest = testName;
                                }
                            });
                            
                            let totalScore = 0;
                            testBestScores.forEach(score => {
                                totalScore += score;
                            });
                            
                            const totalUniqueTests = testBestScores.size;
                            var averageScore = totalUniqueTests > 0 ? Math.round(totalScore / totalUniqueTests) : 0;
                            
                            console.log(`üìä ${fullName}: ${totalUniqueTests} unique tests, Best: ${bestScore}, Avg: ${averageScore}`);
                        }

                        const student = {
                            id: studentEmail,
                            umakId: rawStudent.student_id || rawStudent.studentId || 'N/A',
                            firstName: firstName || 'Unknown',
                            lastName: lastName || '',
                            fullName: fullName,
                            email: studentEmail,
                            section: section.name,
                            yearLevel: section.yearLevel || extractYearLevel(section.name),
                            totalAttempts: totalAttempts,
                            testAttempts: testAttempts,
                            bestScore: bestScore,
                            averageScore: averageScore,
                            lastAttempt: lastAttempt,
                            lastAttemptTest: lastAttemptTest,
                            status: 'active'
                        };

                        console.log(`Student loaded: ${student.fullName} (${student.umakId}) ‚Üí Avg: ${student.averageScore}%`);
                        window.students.push(student);
                    }
                }

                console.log(`Total students loaded: ${window.students.length}`);
                window.filteredStudents = [...window.students];
                window.currentPage = 1;
                updateStudentsTable(window.filteredStudents);
                await loadOverdueStudents();
            } catch (error) {
                console.error('Error loading students:', error);
                alert('Error loading students: ' + error.message);
                updateStudentsTable([]);
            }
        }

function calculateTestScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || result.value || result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    if (testTarget && testTarget > 0) {
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp')) {
            const reps = numericValue;
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        } else if (normalized.includes('plank')) {
            let seconds = numericValue;
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        } else if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        const reps = numericValue;
        if (reps >= 40) return 100;
        if (reps >= 35) return 95;
        if (reps >= 30) return 90;
        if (reps >= 25) return 85;
        if (reps >= 20) return 80;
        if (reps >= 15) return 75;
        if (reps >= 10) return 70;
        if (reps >= 5) return 65;
        return 60;
    } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
        const reps = numericValue;
        if (reps >= 50) return 100;
        if (reps >= 45) return 95;
        if (reps >= 40) return 90;
        if (reps >= 35) return 85;
        if (reps >= 30) return 80;
        if (reps >= 25) return 75;
        if (reps >= 20) return 70;
        if (reps >= 15) return 65;
        return 60;
    } else if (normalized.includes('plank')) {
        let seconds = numericValue;
        if (seconds >= 180) return 100;
        if (seconds >= 150) return 95;
        if (seconds >= 120) return 90;
        if (seconds >= 100) return 85;
        if (seconds >= 80) return 80;
        if (seconds >= 60) return 75;
        if (seconds >= 45) return 70;
        if (seconds >= 30) return 65;
        return 60;
    } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
        const heartRate = numericValue;
        if (heartRate <= 70) return 100;
        if (heartRate <= 80) return 95;
        if (heartRate <= 90) return 90;
        if (heartRate <= 100) return 85;
        if (heartRate <= 110) return 80;
        if (heartRate <= 120) return 75;
        if (heartRate <= 130) return 70;
        return 65;
    } else if (normalized.includes('sit-and-reach')) {
        const distance = numericValue;
        if (distance >= 25) return 100;
        if (distance >= 20) return 95;
        if (distance >= 15) return 90;
        if (distance >= 10) return 85;
        if (distance >= 5) return 80;
        if (distance >= 0) return 75;
        if (distance >= -5) return 70;
        return 65;
    }
    
    return 75;
}

function populateSectionsTable() {
    const tableBody = document.getElementById('sectionsTableBody');
    const sectionCount = document.getElementById('sectionCount');
    
    sectionCount.textContent = window.filteredSections.length;
    
    if (window.filteredSections.length === 0) {
        if (window.sections.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-icon">üè´</div>
                            <div class="empty-title">No Sections Assigned</div>
                            <div class="empty-text">You haven't been assigned to any sections yet. Please contact the Dean or Head Admin.</div>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <div class="empty-title">No Sections Found</div>
                            <div class="empty-text">No sections match your search criteria.</div>
                        </div>
                    </td>
                </tr>
            `;
        }
        return;
    }
    
    let html = '';
    window.filteredSections.forEach(section => {
        const statusClass = section.status === 'active' ? 'status-active' : 'status-inactive';
        const statusText = section.status === 'active' ? 'Active' : 'Inactive';
        
        // Format the schedule display - show "Not Set" in red if empty
        const scheduleDisplay = section.schedule === 'Not Set' ? 
            '<span style="color: #ef4444; font-weight: 600;">Not Set</span>' : 
            `<span style="font-weight: 600; color: #1e3a8a;">${section.schedule}</span>`;
        
        html += `
            <tr>
                <td>
                    <strong style="color: #1e3a8a;">${section.name}</strong>
                    ${section.description ? `<br><small style="color: #64748b;">${section.description}</small>` : ''}
                </td>
                <td><span style="font-weight: 600;">${section.yearLevel || 'N/A'}</span></td>
                <td>
                    <span style="font-weight: 700; color: #3b82f6;">${section.studentCount || 0}</span>
                    <small style="color: #64748b;"> students</small>
                </td>
                <td><span style="font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${section.courseCode || 'N/A'}</span></td>
                <td>${scheduleDisplay}</td>
                <td><strong style="color: #1e3a8a;">${section.createdYear}</strong></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewSectionDetails('${section.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
    
    // Update mobile view
    updateResponsiveViews();
}

function updateStudentsTable(students) {
    const tableBody = document.getElementById('studentsTableBody');
    const studentCount = document.getElementById('studentCount');
    const currentPageElement = document.getElementById('currentPage');
    const totalPagesElement = document.getElementById('totalPages');

    const showAll = isMobileView();
    const displayStudents = showAll ? students : students.slice(
        (window.currentPage - 1) * window.itemsPerPage,
        window.currentPage * window.itemsPerPage
    );

    if (!showAll) {
        const totalPages = Math.ceil(students.length / window.itemsPerPage);
        totalPagesElement.textContent = totalPages || 1;
        currentPageElement.textContent = window.currentPage;
    }

    studentCount.textContent = students.length;

    if (displayStudents.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">No Students Found</div><div class="empty-text">Try adjusting your search or filters.</div></div></td></tr>`;
        return;
    }

    let rowsHTML = '';
    displayStudents.forEach(student => {
        let scoreClass = '', scoreText = 'No attempts';
        if (student.totalAttempts > 0) {
            if (student.bestScore >= 90) { scoreClass = 'score-excellent'; scoreText = 'Excellent'; }
            else if (student.bestScore >= 70) { scoreClass = 'score-good'; scoreText = 'Good'; }
            else { scoreClass = 'score-poor'; scoreText = 'Needs Improvement'; }
        }

        let lastAttemptFormatted = 'No attempts';
        if (student.lastAttempt instanceof Date && !isNaN(student.lastAttempt)) {
            lastAttemptFormatted = `
                <strong>${student.lastAttemptTest || 'Unknown Test'}</strong><br>
                <small style="color: #64748b;">
                    ${student.lastAttempt.toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    })}
                </small>
            `;
        }

        rowsHTML += `
            <tr>
                <td><strong>${student.umakId || 'N/A'}</strong></td>
                <td>${student.firstName} ${student.lastName}</td>
                <td>${student.section || 'N/A'}</td>
                <td>${student.totalAttempts > 0 ? `<span class="score-badge ${scoreClass}">${student.bestScore}%</span><br><small style="color: #64748b;">${scoreText}</small>` : '‚Äî'}</td>
                <td>${student.totalAttempts > 0 ? `<strong>${student.averageScore}%</strong>` : '‚Äî'}</td>
                <td>${lastAttemptFormatted}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewStudentDetails('${student.id}')"><i class="fas fa-eye"></i> View</button>
                    </div>
                </td>
            </tr>`;
    });

    tableBody.innerHTML = rowsHTML;
    
    // Update mobile view
    updateResponsiveViews();
}

// Function to populate mobile sections view
function populateMobileSections(sections) {
    const container = document.getElementById('mobileSectionsContainer');
    if (!container) return;
    
    if (sections.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üè´</div>
                <div class="empty-title">No Sections Found</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    sections.forEach(section => {
        html += `
            <div class="section-card">
                <div class="section-card-row">
                    <span class="section-card-label">Section Name</span>
                    <span class="section-card-value"><strong>${section.name}</strong></span>
                </div>
                <div class="section-card-row">
                    <span class="section-card-label">Year Level</span>
                    <span class="section-card-value">${section.yearLevel || 'N/A'}</span>
                </div>
                <div class="section-card-row">
                    <span class="section-card-label">Total Students</span>
                    <span class="section-card-value">
                        <strong style="color: #3b82f6;">${section.studentCount || 0}</strong>
                    </span>
                </div>
                <div class="section-card-row">
                    <span class="section-card-label">Course Code</span>
                    <span class="section-card-value">${section.courseCode || 'N/A'}</span>
                </div>
                <div class="section-card-row">
                    <span class="section-card-label">Schedule</span>
                    <span class="section-card-value">${section.schedule}</span>
                </div>
                <div class="section-card-row">
                    <span class="section-card-label">Academic Year</span>
                    <span class="section-card-value">${section.createdYear}</span>
                </div>
                <div class="section-card-row" style="border-bottom: none; padding-bottom: 0; margin-bottom: 0;">
                    <span class="section-card-label">Actions</span>
                    <span class="section-card-value">
                        <button class="btn-action btn-view" onclick="viewSectionDetails('${section.id}')" style="padding: 6px 12px; font-size: 12px;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Function to populate mobile students view
function populateMobileStudents(students) {
    const container = document.getElementById('mobileStudentsContainer');
    if (!container) return;
    
    if (students.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üë•</div>
                <div class="empty-title">No Students Found</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    students.forEach(student => {
        let scoreClass = '', scoreText = 'No attempts';
        if (student.totalAttempts > 0) {
            if (student.bestScore >= 90) { 
                scoreClass = 'score-excellent'; 
                scoreText = 'Excellent'; 
            } else if (student.bestScore >= 70) { 
                scoreClass = 'score-good'; 
                scoreText = 'Good'; 
            } else { 
                scoreClass = 'score-poor'; 
                scoreText = 'Needs Improvement'; 
            }
        }
        
        let lastAttemptFormatted = 'No attempts';
        if (student.lastAttempt instanceof Date && !isNaN(student.lastAttempt)) {
            lastAttemptFormatted = student.lastAttempt.toLocaleDateString('en-US', {
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            });
        }
        
        html += `
            <div class="student-card">
                <div class="student-card-header">
                    <div class="student-card-info">
                        <div class="student-card-name">${student.firstName} ${student.lastName}</div>
                        <div class="student-card-id">${student.umakId || 'N/A'}</div>
                    </div>
                    <button class="btn-action btn-view" onclick="viewStudentDetails('${student.id}')" style="padding: 6px 12px; font-size: 12px;">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
                <div class="student-card-details">
                    <div class="student-card-detail">
                        <span class="student-card-label-small">Section</span>
                        <span class="student-card-value">${student.section || 'N/A'}</span>
                    </div>
                    <div class="student-card-detail">
                        <span class="student-card-label-small">Best Score</span>
                        <span class="student-card-value">
                            ${student.totalAttempts > 0 ? 
                                `<span class="score-badge ${scoreClass}" style="font-size: 11px;">${student.bestScore}%</span>` : 
                                '‚Äî'
                            }
                        </span>
                    </div>
                    <div class="student-card-detail">
                        <span class="student-card-label-small">Average</span>
                        <span class="student-card-value">
                            ${student.totalAttempts > 0 ? 
                                `<strong>${student.averageScore}%</strong>` : 
                                '‚Äî'
                            }
                        </span>
                    </div>
                    <div class="student-card-detail">
                        <span class="student-card-label-small">Last Attempt</span>
                        <span class="student-card-value">${lastAttemptFormatted}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Function to check screen size and render appropriate view
function updateResponsiveViews() {
    const isMobile = window.innerWidth <= 768;
    
    // For sections
    const sectionsTable = document.getElementById('sectionsTable');
    const mobileSectionsContainer = document.getElementById('mobileSectionsContainer');
    
    if (sectionsTable && mobileSectionsContainer) {
        if (isMobile) {
            sectionsTable.closest('.table-responsive').style.display = 'none';
            mobileSectionsContainer.style.display = 'block';
            populateMobileSections(window.filteredSections);
        } else {
            sectionsTable.closest('.table-responsive').style.display = 'block';
            mobileSectionsContainer.style.display = 'none';
        }
    }
    
    // For students
    const studentsTable = document.getElementById('studentsTable');
    const mobileStudentsContainer = document.getElementById('mobileStudentsContainer');
    
    if (studentsTable && mobileStudentsContainer) {
        if (isMobile) {
            studentsTable.closest('.table-responsive').style.display = 'none';
            mobileStudentsContainer.style.display = 'block';
            
            // Get current page students for mobile (no pagination on mobile)
            populateMobileStudents(window.filteredStudents);
        } else {
            studentsTable.closest('.table-responsive').style.display = 'block';
            mobileStudentsContainer.style.display = 'none';
        }
    }
}

// Check if mobile view
function isMobileView() {
    return window.innerWidth <= 768;
}

        function populateSectionFilters() {
            const sectionFilter = document.getElementById('filterSection');
            
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            
            window.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = `${section.name} (${section.studentCount} students)`;
                sectionFilter.appendChild(option);
            });
            
            console.log(`‚úì Populated ${sectionFilter.options.length - 1} professor sections`);
            
        }

        const overdueFilter = document.getElementById('filterOverdueSection');
        if (overdueFilter) {
            overdueFilter.innerHTML = '<option value="">All Sections</option>';
            window.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = section.name;
                overdueFilter.appendChild(option);
            });
        }

async function viewSectionDetails(sectionId) {
    try {
        const sectionRef = doc(db, 'sections', sectionId);
        const sectionDoc = await getDoc(sectionRef);
        
        if (!sectionDoc.exists()) {
            alert('Section not found!');
            return;
        }
        
        const sectionData = { id: sectionDoc.id, ...sectionDoc.data() };
        
        const sectionStudents = window.students.filter(student => 
            student.section === sectionData.name
        );
        
        let totalAttempts = 0;
        let totalScore = 0;
        let studentsWithAttempts = 0;
        
        sectionStudents.forEach(student => {
            if (student.totalAttempts > 0) {
                studentsWithAttempts++;
                totalAttempts += student.totalAttempts;
                totalScore += student.averageScore;
            }
        });
        
        const averageScore = studentsWithAttempts > 0 ? Math.round(totalScore / studentsWithAttempts) : 0;
        const completionRate = sectionStudents.length > 0 ? Math.round((studentsWithAttempts / sectionStudents.length) * 100) : 0;
        
        // ‚≠ê‚≠ê‚≠ê FIXED: Properly format the schedule
        let schedule = '';
        if (sectionData.time && sectionData.day && sectionData.room) {
            schedule = `${sectionData.time} / ${sectionData.day} / ${sectionData.room}`;
        } else if (sectionData.schedule) {
            schedule = sectionData.schedule;
        } else {
            schedule = 'Not Set';
        }
        
        // Get academic year properly
        const academicYear = sectionData.academicYear || sectionData.createdYear || sectionData.year || 'N/A';
        
        let html = `
            <div class="student-info-header">
                <div class="student-avatar">
                    <i class="fas fa-users text-white"></i>
                </div>
                <div class="student-basic-info">
                    <div class="student-name">${sectionData.name}</div>
                    <div class="student-id">
                        ${sectionData.courseCode || 'PE 3'} ‚Ä¢ 
                        ${academicYear} ‚Ä¢ 
                        ${schedule}
                    </div>
                </div>
            </div>
            <div class="student-info-grid">
                <div class="info-item">
                    <div class="info-label">Total Students</div>
                    <div class="info-value">
                        <strong style="color: #3b82f6; font-size: 18px;">${sectionStudents.length}</strong>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Schedule</div>
                    <div class="info-value">${schedule}</div>
                </div>

                <div class="info-item">
                    <div class="info-label">Total Attempts</div>
                    <div class="info-value">
                        <strong>${totalAttempts}</strong>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Average Score</div>
                    <div class="info-value">
                        ${averageScore > 0 ? `
                            <span class="score-badge ${averageScore >= 70 ? 'score-excellent' : 'score-poor'}">
                                ${averageScore}%
                            </span>
                        ` : 'No data'}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Completion Rate</div>
                    <div class="info-value">
                        <strong>${completionRate}%</strong>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Professor</div>
                    <div class="info-value">${sectionData.professor || window.currentUser.displayName || window.currentUser.email}</div>
                </div>
        `;
        
        if (sectionData.description) {
            html += `
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Description</div>
                    <div class="info-value" style="font-size: 14px; color: #475569; line-height: 1.5;">
                        ${sectionData.description}
                    </div>
                </div>
            `;
        }
        
        html += `</div>`;
        
        document.getElementById('sectionDetailsContent').innerHTML = html;
        
        let studentsHTML = '';
        if (sectionStudents.length > 0) {
            sectionStudents.forEach(student => {
                let scoreClass = '', scoreText = 'No attempts';
                if (student.totalAttempts > 0) {
                    if (student.bestScore >= 90) { 
                        scoreClass = 'score-excellent'; 
                        scoreText = 'Excellent'; 
                    } else if (student.bestScore >= 70) { 
                        scoreClass = 'score-good'; 
                        scoreText = 'Good'; 
                    } else { 
                        scoreClass = 'score-poor'; 
                        scoreText = 'Needs Improvement'; 
                    }
                }
                
                studentsHTML += `
                    <tr>
                        <td>
                            <strong style="color: #1e3a8a;">${student.umakId || 'N/A'}</strong>
                        </td>
                        <td>
                            ${student.firstName} ${student.lastName}
                        </td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; font-size: 13px; color: #475569;" title="${student.email}">
                            ${student.email || 'N/A'}
                        </td>
                        <td>
                            ${student.totalAttempts || 0}
                        </td>
                        <td>
                            ${student.totalAttempts > 0 ? 
                                `<span class="score-badge ${scoreClass}">${student.bestScore}%</span>` : 
                                '‚Äî'
                            }
                        </td>
                        <td>
                            ${student.totalAttempts > 0 ? 
                                `<strong>${student.averageScore}%</strong>` : 
                                '‚Äî'
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewStudentDetails('${student.id}'); closeViewSectionModal();" style="padding: 6px 12px; font-size: 12px;">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
            studentsHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #64748b; font-size: 14px;">
                        <div style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;">üë•</div>
                        No students found in this section
                    </td>
                </tr>
            `;
        }
        
        document.getElementById('sectionStudentsTableBody').innerHTML = studentsHTML;
        document.getElementById('viewSectionModal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error viewing section details:', error);
        alert('Error: ' + error.message);
    }
}

        function closeViewSectionModal() {
            document.getElementById('viewSectionModal').style.display = 'none';
        }

    async function viewStudentDetails(studentId) {
    try {
        window.currentStudentId = studentId;
        const student = window.students.find(s => s.id === studentId);
        if (!student) {
            alert('Student not found!');
            return;
        }

        const attemptsQuery = query(
            collection(db, 'testResults'), 
            where('studentEmail', '==', student.email)
        );
        const attemptsSnapshot = await getDocs(attemptsQuery);

        const testGroups = {};
        
        attemptsSnapshot.forEach(docSnap => {
            const attempt = { id: docSnap.id, ...docSnap.data() };
            const testId = attempt.testId || attempt.testName;
            
            if (!testGroups[testId]) {
                testGroups[testId] = {
                    testName: attempt.testName || 'Unknown Test',
                    attempts: []
                };
            }
            testGroups[testId].attempts.push(attempt);
        });

        let totalScore = 0, bestScore = 0, totalAttempts = 0;
        
        Object.values(testGroups).forEach(group => {
            group.attempts.forEach(attempt => {
                const score = calculateTestScore(attempt.testName, attempt.result, attempt.testTarget);
                totalScore += score;
                totalAttempts++;
                if (score > bestScore) bestScore = score;
            });
        });

        const averageScore = totalAttempts > 0 ? Math.round(totalScore / totalAttempts) : 0;
        const initials = (student.firstName.charAt(0) + student.lastName.charAt(0)).toUpperCase() || '??';

     
        let sectionSchedule = 'Not Set';
        const studentSection = window.sections.find(s => s.name === student.section);
        if (studentSection) {
            if (studentSection.timeSlot && studentSection.days && studentSection.room) {
                sectionSchedule = `${studentSection.timeSlot} / ${studentSection.days} / ${studentSection.room}`;
            } else if (studentSection.schedule) {
                sectionSchedule = studentSection.schedule;
            }
        }

        let html = `
            <div class="student-info-header">
                <div class="student-avatar">${initials}</div>
                <div class="student-basic-info">
                    <div class="student-name">${student.firstName} ${student.lastName}</div>
                    <div class="student-id">${student.umakId} ‚Ä¢ ${student.section}</div>
                </div>
            </div>
            <div class="student-info-grid">
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value info-value-email">${student.email || 'N/A'}</div>
                </div>
                <div class="info-item"><div class="info-label">Year Level</div><div class="info-value">${student.yearLevel || 'N/A'}</div></div>
                <div class="info-item">
                    <div class="info-label">Section Schedule</div>
                    <div class="info-value">${sectionSchedule}</div>
                </div>
                <div class="info-item"><div class="info-label">Total Tests Taken</div><div class="info-value"><strong>${Object.keys(testGroups).length}</strong></div></div>
                <div class="info-item"><div class="info-label">Best Score</div><div class="info-value">${totalAttempts > 0 ? `<span class="score-badge ${bestScore >= 90 ? 'score-excellent' : bestScore >= 70 ? 'score-good' : 'score-poor'}">${bestScore}%</span>` : 'No attempts'}</div></div>
                <div class="info-item"><div class="info-label">Average Score</div><div class="info-value">${totalAttempts > 0 ? `<strong>${averageScore}%</strong>` : 'No attempts'}</div></div>
                <div class="info-item"><div class="info-label">Status</div><div class="info-value"><span class="status-badge status-active">Active</span></div></div>
            </div>`;

        document.getElementById('studentDetailsContent').innerHTML = html;

        let attemptsHTML = '';
        if (Object.keys(testGroups).length > 0) {
            const sortedTests = Object.entries(testGroups).sort((a, b) => {
                const getLatestTime = (attempts) => {
                    const timestamps = attempts.map(att => {
                        if (!att.submittedAt) return 0;
                        if (typeof att.submittedAt.toMillis === 'function') return att.submittedAt.toMillis();
                        if (att.submittedAt instanceof Date) return att.submittedAt.getTime();
                        if (typeof att.submittedAt === 'string' || typeof att.submittedAt === 'number') return new Date(att.submittedAt).getTime();
                        if (att.submittedAt.seconds && att.submittedAt.nanoseconds) return att.submittedAt.seconds * 1000;
                        return 0;
                    });
                    return Math.max(...timestamps);
                };
                
                return getLatestTime(b[1].attempts) - getLatestTime(a[1].attempts);
            });

            sortedTests.forEach(([testId, group]) => {
                const testName = group.testName;
                const testAttempts = group.attempts;
                
                // Sort attempts by date (oldest first for correct numbering)
                testAttempts.sort((a, b) => {
                    const getTimestamp = (attempt) => {
                        if (!attempt.submittedAt) return 0;
                        if (typeof attempt.submittedAt.toMillis === 'function') return attempt.submittedAt.toMillis();
                        if (attempt.submittedAt instanceof Date) return attempt.submittedAt.getTime();
                        if (typeof attempt.submittedAt === 'string' || typeof attempt.submittedAt === 'number') return new Date(attempt.submittedAt).getTime();
                        if (attempt.submittedAt.seconds && attempt.submittedAt.nanoseconds) return attempt.submittedAt.seconds * 1000;
                        return 0;
                    };
                    
                    return getTimestamp(a) - getTimestamp(b); // oldest first
                });

                const totalAttempts = testAttempts.length;
                
                // Find best score among all attempts
                const bestScoreInTest = Math.max(...testAttempts.map(a => calculateTestScore(a.testName, a.result, a.testTarget)));
                
                // Show ALL attempts for this test
                testAttempts.forEach((attempt, index) => {
                    const attemptNumber = index + 1; // 1, 2, 3, etc.
                    
                    let date = new Date();
                    if (attempt.submittedAt) {
                        if (typeof attempt.submittedAt.toDate === 'function') {
                            date = attempt.submittedAt.toDate();
                        } else if (attempt.submittedAt instanceof Date) {
                            date = attempt.submittedAt;
                        } else if (typeof attempt.submittedAt === 'string' || typeof attempt.submittedAt === 'number') {
                            date = new Date(attempt.submittedAt);
                        } else if (attempt.submittedAt.seconds && attempt.submittedAt.nanoseconds) {
                            date = new Date(attempt.submittedAt.seconds * 1000);
                        }
                    }
                    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const score = calculateTestScore(attempt.testName, attempt.result, attempt.testTarget);
                    let statusClass = score >= 90 ? 'score-excellent' : score >= 70 ? 'score-good' : 'score-poor';
                    let statusText = score >= 90 ? 'Excellent' : score >= 70 ? 'Good' : 'Needs Improvement';
                    
                    const isBestScore = score === bestScoreInTest;
                    
                    const bestScoreIndicator = isBestScore && totalAttempts > 1 ? 
                        '<span style="color: #10b981; font-weight: bold; margin-left: 5px;">üèÜ Best</span>' : '';

                    attemptsHTML += `
                        <tr style="${isBestScore && totalAttempts > 1 ? 'background-color: #f0fdf4;' : ''}">
                            <td>${formattedDate}</td>
                            <td>
                                <strong>${testName}</strong><br>
                                <small style="color: #64748b;">
                                    Attempt ${attemptNumber} of ${totalAttempts}
                                </small>
                            </td>
                            <td>
                                <span class="score-badge ${statusClass}">${score}%</span>${bestScoreIndicator}
                            </td>
                            <td>${statusText}</td>
                            <td>${attempt.timerValue || 'N/A'}</td>
                            <td>
                                <button class="btn-action btn-view" style="padding: 4px 8px; font-size: 11px;" onclick="viewAttemptDetails('${attempt.id}')">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </td>
                        </tr>`;
                });
            });
        } else {
            attemptsHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-history" style="font-size: 24px; opacity: 0.5;"></i><br>No test results recorded yet</td></tr>`;
        }

        document.getElementById('attemptsTableBody').innerHTML = attemptsHTML;
        document.getElementById('viewStudentModal').style.display = 'flex';
    } catch (error) {
        console.error('Error viewing student details:', error);
        alert('Error: ' + error.message);
    }
}

        // Helper function to format activity type
        function formatActivityType(type) {
            const types = {
                'push-up': 'Push-up Test',
                'sit-up': 'Sit-up Test',
                'running': 'Running Test',
                'flexibility': 'Flexibility Test',
                'endurance': 'Endurance Test',
                'other': 'Other Activity'
            };
            return types[type] || type;
        }

        // View attempt details
        async function viewAttemptDetails(attemptId) {
            try {
                const attemptRef = doc(db, 'testResults', attemptId);
                const attemptDoc = await getDoc(attemptRef);
                
                if (!attemptDoc.exists()) {
                    alert('Attempt not found!');
                    return;
                }
                
                const attempt = attemptDoc.data();
                const date = attempt.submittedAt?.toDate ? attempt.submittedAt.toDate() : new Date(attempt.createdAt || Date.now());
                
                alert(
                    `Attempt Details:\n\n` +
                    `Activity: ${formatActivityType(attempt.activityType || 'unknown')}\n` +
                    `Score: ${attempt.score || 0}%\n` +
                    `Date: ${date.toLocaleDateString()}\n` +
                    `Time: ${date.toLocaleTimeString()}\n` +
                    `Duration: ${attempt.duration || 'N/A'} minutes\n` +
                    `Notes: ${attempt.notes || 'No notes provided'}`
                );
                
            } catch (error) {
                console.error('Error viewing attempt details:', error);
                alert('Error: ' + error.message);
            }
        }

        // Add new attempt for student
    async function addNewAttempt() {
    const attemptType = document.getElementById('attemptType').value;
    const attemptScore = document.getElementById('attemptScore').value;
    const attemptNotes = document.getElementById('attemptNotes').value.trim();
    
    // Validation
    if (!attemptType || !attemptScore) {
        alert('Please fill in all required fields.');
        return;
    }
    
    const score = parseInt(attemptScore);
    if (isNaN(score) || score < 0 || score > 100) {
        alert('Please enter a valid score between 0 and 100.');
        return;
    }
    
    try {
        const submitBtn = document.querySelector('#viewStudentModal .btn-submit');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Find student in our loaded data
        const student = window.students.find(s => s.id === window.currentStudentId);
        
        if (!student) {
            throw new Error('Student not found!');
        }
        
        // Create new attempt
        const attemptData = {
            studentId: window.currentStudentId,
            studentName: student.fullName,
            studentEmail: student.email,
            studentSection: student.section,
            activityType: attemptType,
            score: score,
            notes: attemptNotes || null,
            submittedAt: serverTimestamp(),
            createdAt: serverTimestamp(),
            professorId: window.currentUser.uid,
            professorEmail: window.currentUser.email,
            professorName: window.currentUser.displayName || 'Professor'
        };
        
        // Save to testResults collection
        await addDoc(collection(db, 'testResults'), attemptData);
        
        console.log('‚úì New attempt added for student:', student.fullName);
        
        // Clear form
        document.getElementById('attemptType').value = '';
        document.getElementById('attemptScore').value = '';
        document.getElementById('attemptNotes').value = '';
        
        // Refresh student details
        await viewStudentDetails(window.currentStudentId);
        
        // Refresh main student list
        await loadStudents();
        
        alert('Attempt added successfully!');
        
    } catch (error) {
        console.error('Error adding attempt:', error);
        alert('Error: ' + error.message);
        
        const submitBtn = document.querySelector('#viewStudentModal .btn-submit');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Attempt';
    }
}

        // Close view student modal
        function closeViewStudentModal() {
            document.getElementById('viewStudentModal').style.display = 'none';
            window.currentStudentId = null;
        }

        // Filter sections
        function filterSections() {
            const searchTerm = document.getElementById('searchSections').value.toLowerCase();
            
            window.filteredSections = window.sections.filter(section => {
                const matchesSearch = !searchTerm || 
                    section.name.toLowerCase().includes(searchTerm) ||
                    (section.courseCode && section.courseCode.toLowerCase().includes(searchTerm)) ||
                    (section.yearLevel && section.yearLevel.toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            if (window.innerWidth <= 768) {
                // Mobile view
                populateMobileSections(window.filteredSections);
            } else {
                // Desktop view
                populateSectionsTable();
            }
        }

        // Filter students
        function filterStudents() {
            const searchTerm = document.getElementById('searchStudents').value.toLowerCase();
            const sectionFilter = document.getElementById('filterSection').value;
            const performanceFilter = document.getElementById('filterPerformance').value;
            
            window.filteredStudents = window.students.filter(student => {
                // Search term filter
                const matchesSearch = !searchTerm || 
                    student.firstName.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    (student.umakId && student.umakId.toLowerCase().includes(searchTerm));
                
                // Section filter
                const matchesSection = !sectionFilter || student.section === sectionFilter;
                
                // Performance filter
                let matchesPerformance = true;
                if (performanceFilter) {
                    switch (performanceFilter) {
                        case 'excellent':
                            matchesPerformance = student.bestScore >= 90;
                            break;
                        case 'good':
                            matchesPerformance = student.bestScore >= 70 && student.bestScore < 90;
                            break;
                        case 'needs-improvement':
                            matchesPerformance = student.bestScore > 0 && student.bestScore < 70;
                            break;
                        case 'no-attempts':
                            matchesPerformance = student.totalAttempts === 0;
                            break;
                    }
                }
                
                return matchesSearch && matchesSection && matchesPerformance;
            });
            
            window.currentPage = 1; // Reset to first page when filtering
            
            if (window.innerWidth <= 768) {
                // Mobile view
                populateMobileStudents(window.filteredStudents);
            } else {
                // Desktop view
                updateStudentsTable(window.filteredStudents);
            }
        }

        // Pagination functions
        function previousPage() {
            if (window.currentPage > 1) {
                window.currentPage--;
                updateStudentsTable(window.filteredStudents);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(window.filteredStudents.length / window.itemsPerPage);
            if (window.currentPage < totalPages) {
                window.currentPage++;
                updateStudentsTable(window.filteredStudents);
            }
        }

        // Export students data
        function exportStudents() {
            if (window.filteredStudents.length === 0) {
                alert('No students to export.');
                return;
            }

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "UMaK ID,Student Name,Section,Total Attempts,Best Score,Average Score,Last Attempt\n";
            
            window.filteredStudents.forEach(student => {
                const row = [
                    student.umakId || '',
                    `${student.firstName} ${student.lastName}`,
                    student.section || '',
                    student.totalAttempts || 0,
                    student.bestScore || 0,
                    student.averageScore || 0,
                    student.lastAttempt ? 
                        (student.lastAttempt.toDate ? student.lastAttempt.toDate().toLocaleDateString() : 
                         new Date(student.lastAttempt).toLocaleDateString()) : 'No attempts'
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `student_scores_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refresh data
       async function refreshData() {
        try {
            // Show a subtle loading indicator (optional)
            const refreshBtn = event?.target?.closest('.btn-secondary-custom');
            if (refreshBtn) {
                const originalHTML = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
                refreshBtn.disabled = true;
            }
            
            window.currentPage = 1;
            
            // Reload data
            await loadSections();
            await loadStudents();
            
            // Restore button
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshBtn.disabled = false;
            }
            
            console.log('‚úì Data refreshed successfully');
            
        } catch (error) {
            console.error('Error refreshing data:', error);
            alert('Error refreshing data. Please try again.');
        }
    }

        // Setup real-time updates
     function setupRealtimeUpdates() {
    // Listen for section changes where this professor is assigned
    if (window.currentUser && window.currentUser.displayName) {
        const sectionsQuery = query(
            collection(db, 'sections'),
            where('professor', '==', window.currentUser.displayName)
        );
        
        onSnapshot(sectionsQuery, (snapshot) => {
            console.log('üîÑ Professor sections updated');
            loadSections().then(() => {
                loadStudents();
            });
        });
    }
}

        // Switch between tabs
window.switchTab = function(tab) {
    window.currentTab = tab;
    
    const allTab = document.getElementById('allStudentsTab');
    const overdueTab = document.getElementById('overdueTab');
    const allView = document.getElementById('allStudentsView');
    const overdueView = document.getElementById('overdueView');
    
    if (tab === 'all') {
        allTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        allTab.classList.remove('text-gray-600');
        overdueTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        overdueTab.classList.add('text-gray-600');
        allView.classList.remove('hidden');
        overdueView.classList.add('hidden');
    } else {
        overdueTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        overdueTab.classList.remove('text-gray-600');
        allTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        allTab.classList.add('text-gray-600');
        overdueView.classList.remove('hidden');
        allView.classList.add('hidden');
    }
};

        // Load overdue students
        window.loadOverdueStudents = async function() {
            try {
                window.overdueStudents = [];
                const now = new Date();
                
                for (const section of window.sections) {
                    if (!section.students || section.students.length === 0) continue;
                    
                    // Get all scheduled tests for this section
                    const testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('section', '==', section.name),
                        where('isActive', '==', true)
                    );
                    const testsSnapshot = await getDocs(testsQuery);
                    
                    for (const student of section.students) {
                        const studentEmail = student.email || '';
                        if (!studentEmail) continue;
                        
                        // Get student's completed tests
                        const completedQuery = query(
                            collection(db, 'testResults'),
                            where('studentEmail', '==', studentEmail)
                        );
                        const completedSnapshot = await getDocs(completedQuery);
                        
                        // Map of testId -> best result
                        const completedTests = new Map();
                        completedSnapshot.forEach(doc => {
                            const data = doc.data();
                            const testId = data.testId;
                            const score = data.score || calculateTestScore(data.testName, data.result, data.testTarget);
                            
                            if (!completedTests.has(testId) || score > completedTests.get(testId).score) {
                                completedTests.set(testId, {
                                    score: score,
                                    result: data.result,
                                    resultId: doc.id,
                                    submittedAt: data.submittedAt,
                                    status: data.status
                                });
                            }
                        });
                        
                        // Check for overdue tests
                        testsSnapshot.forEach(testDoc => {
                            const test = { id: testDoc.id, ...testDoc.data() };
                            
                            let deadlineDateTime = new Date(test.deadline);
                            if (test.deadlineTime) {
                                const [hours, minutes] = test.deadlineTime.split(':').map(Number);
                                deadlineDateTime.setHours(hours, minutes, 0, 0);
                            } else {
                                deadlineDateTime.setHours(23, 59, 59, 999);
                            }
                            
                            // If test is overdue
                            if (deadlineDateTime < now) {
                                const completedData = completedTests.get(test.id);
                                
                                window.overdueStudents.push({
                                    studentName: student.name || 'Unknown',
                                    studentEmail: studentEmail,
                                    studentId: student.student_id || student.studentId || 'N/A',
                                    section: section.name,
                                    testId: test.id,
                                    testName: test.testName,
                                    testTarget: test.testTarget || 0,
                                    testUnit: test.testUnit || '',
                                    deadline: deadlineDateTime,
                                    deadlineString: formatDeadline(test.deadline, test.deadlineTime),
                                    hasCompleted: !!completedData,
                                    currentScore: completedData?.score || 0,
                                    currentResult: completedData?.result || '',
                                    resultId: completedData?.resultId || null,
                                    status: completedData?.status || 'not-started'
                                });
                            }
                        });
                    }
                }
                
                console.log(`Found ${window.overdueStudents.length} overdue test instances`);
                document.getElementById('overdueCount').textContent = window.overdueStudents.length;
                document.getElementById('allStudentsCount').textContent = window.students.length;
                
                window.filteredOverdueStudents = [...window.overdueStudents];
                renderOverdueTable();
                
            } catch (error) {
                console.error('Error loading overdue students:', error);
            }
        }

function formatDeadline(deadline, deadlineTime) {
    if (!deadline) return 'No deadline';
    const date = new Date(deadline);
    const dateText = date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    let timeText = '';
    if (deadlineTime) {
        const [hours, minutes] = deadlineTime.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const hour12 = hours % 12 || 12;
        timeText = ` ${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }
    return dateText + timeText;
}

// Render overdue table
function renderOverdueTable() {
    const tableBody = document.getElementById('overdueTableBody');
    
    if (window.filteredOverdueStudents.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-title">No Overdue Tests</div>
                        <div class="empty-text">All students are up to date!</div>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Group tests by student
    const studentGroups = {};
    window.filteredOverdueStudents.forEach(item => {
        const key = item.studentEmail;
        if (!studentGroups[key]) {
            studentGroups[key] = {
                studentName: item.studentName,
                studentId: item.studentId,
                studentEmail: item.studentEmail,
                section: item.section,
                tests: []
            };
        }
        studentGroups[key].tests.push(item);
    });
    
    const isMobile = window.innerWidth <= 768;
    
    // Render one row per student
    let html = '';
    Object.values(studentGroups).forEach(group => {
        const testCount = group.tests.length;
        const completedCount = group.tests.filter(t => t.hasCompleted).length;
        const pendingCount = testCount - completedCount;
        
        if (isMobile) {
            // Mobile card view
            html += `
                <tr>
                    <td colspan="5" style="padding: 0;">
                        <div class="student-card" style="margin: 8px; border: 1px solid #fee2e2; background: #fef2f2;">
                            <div class="student-card-header">
                                <div class="student-card-info">
                                    <div class="student-card-name">${group.studentName}</div>
                                    <div class="student-card-id">${group.studentId} ‚Ä¢ ${group.section}</div>
                                </div>
                                <span class="test-count-badge">${testCount}</span>
                            </div>
                            <div class="student-card-details">
                                <div class="student-card-detail">
                                    <span class="student-card-label-small">Overdue Tests</span>
                                    <span class="student-card-value" style="color: #ef4444;">${pendingCount}</span>
                                </div>
                                <div class="student-card-detail">
                                    <span class="student-card-label-small">Completed</span>
                                    <span class="student-card-value" style="color: #10b981;">${completedCount}</span>
                                </div>
                                <div class="student-card-detail">
                                    <span class="student-card-label-small">Actions</span>
                                    <span class="student-card-value">
                                        <button class="btn-action btn-view" onclick="showStudentTests('${group.studentEmail}')" style="padding: 4px 8px; font-size: 11px;">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            // Desktop table view
            html += `
                <tr onclick="showStudentTests('${group.studentEmail}')" style="cursor: pointer;">
                    <td>
                        <strong>${group.studentName}</strong>
                        <span class="test-count-badge">${testCount}</span>
                        <br>
                        <small style="color: #64748b;">${group.studentId}</small>
                    </td>
                    <td>${group.section}</td>
                    <td>
                        <span style="color: #ef4444; font-weight: 600;">${pendingCount} Pending</span>
                        ${completedCount > 0 ? `<br><small style="color: #10b981;">‚úì ${completedCount} Completed</small>` : ''}
                    </td>
                    <td><small style="color: #64748b;">Multiple deadlines</small></td>
                    <td>
                        <button class="btn-action btn-view" onclick="event.stopPropagation(); showStudentTests('${group.studentEmail}')">
                            <i class="fas fa-eye"></i> View Tests
                        </button>
                    </td>
                </tr>
            `;
        }
    });
    
    tableBody.innerHTML = html;
}

// Filter overdue students
window.filterOverdueStudents = function() {
    const searchTerm = document.getElementById('searchOverdue').value.toLowerCase();
    const sectionFilter = document.getElementById('filterOverdueSection').value;
    
    window.filteredOverdueStudents = window.overdueStudents.filter(item => {
        const matchesSearch = !searchTerm ||
            item.studentName.toLowerCase().includes(searchTerm) ||
            item.testName.toLowerCase().includes(searchTerm) ||
            item.studentId.toLowerCase().includes(searchTerm);
        
        const matchesSection = !sectionFilter || item.section === sectionFilter;
        
        return matchesSearch && matchesSection;
    });
    
    renderOverdueTable();
};

    // Enable overdue test for specific student
    window.enableOverdueTest = async function(studentEmail, testId, testName) {
        if (!confirm(`Enable "${testName}" for this student? They will be able to take this test even though it's overdue.`)) {
            return;
        }
        
        try {
            // Check if permission already exists
            const existingPermissionQuery = query(
                collection(db, 'testPermissions'),
                where('studentEmail', '==', studentEmail),
                where('testId', '==', testId)
            );
            const existingSnapshot = await getDocs(existingPermissionQuery);
            
            if (!existingSnapshot.empty) {
                alert('‚ö†Ô∏è This test is already enabled for this student!');
                return;
            }
            
            // Create a special permission record
            await addDoc(collection(db, 'testPermissions'), {
                studentEmail: studentEmail,
                testId: testId,
                testName: testName,
                grantedBy: window.currentUser.email,
                grantedByName: window.currentUser.displayName || window.currentUser.email,
                grantedAt: serverTimestamp(),
                reason: 'Overdue test enabled by professor',
                status: 'active'
            });
            
            alert('‚úÖ Test enabled successfully! Student can now take this test.\n\nNote: This will appear in "My Test Schedule" on Add Activities page.');
            await loadOverdueStudents();
            
        } catch (error) {
            console.error('Error enabling test:', error);
            alert('Error: ' + error.message);
        }
    };

           window.setOverdueScore = function(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore = 0, currentResult = '', resultId = '') {
    window.openEditScoreModal(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore, currentResult, resultId);
};

window.openEditScoreModal = function(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore = 0, currentResult = '', resultId = '') {
    console.log('üîß Opening edit score modal for:', studentName);
    
    editScoreData = {
        studentEmail: studentEmail,
        testId: testId,
        testName: testName,
        testTarget: testTarget || 0,
        testUnit: testUnit || '',
        studentName: studentName,
        resultId: resultId || '', 
        currentScore: currentScore,
        currentResult: currentResult
    };

    // Update modal content
    document.getElementById('editScoreTestName').textContent = testName;
    document.getElementById('editScoreTarget').textContent = `${testTarget} ${testUnit}`;
    document.getElementById('editScoreStudent').textContent = studentName;

    // Display current score
    document.getElementById('currentScoreDisplay').textContent = currentScore > 0 ? currentScore.toFixed(1) : 'No score';
    
    // Display current result
    let resultDisplay = 'No result';
    if (currentResult) {
        if (typeof currentResult === 'string') {
            resultDisplay = currentResult;
        } else if (typeof currentResult === 'number') {
            resultDisplay = `${currentResult} ${testUnit}`;
        } else if (typeof currentResult === 'object') {
            const numValue = currentResult.repetitions || currentResult.time || currentResult.distance || currentResult.value || 0;
            resultDisplay = `${numValue} ${testUnit}`;
        }
    }
    document.getElementById('currentResultDisplay').textContent = resultDisplay;

    // Reset to step 1
    currentStep = 1;
    const newResultInput = document.getElementById('newResult');
    const formHint = document.getElementById('resultHint');
    
    if (newResultInput) {
        newResultInput.value = '';
        newResultInput.classList.remove('border-red-500');
        
        if (formHint) {
            formHint.classList.remove('text-red-600');
            formHint.textContent = 'Enter what the student achieved in this test';
        }
        
        // Set input constraints based on test type
        const testNameLower = testName.toLowerCase();
        if (testNameLower.includes('push-up') || testNameLower.includes('pushup') || 
            testNameLower.includes('sit-up') || testNameLower.includes('situp') ||
            testNameLower.includes('curl-up')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '1';
            newResultInput.placeholder = `Enter repetitions (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} repetitions`;
            }
        } else if (testNameLower.includes('plank')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '1';
            newResultInput.placeholder = `Enter seconds (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} seconds`;
            }
        } else if (testNameLower.includes('sit-and-reach')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '0.1';
            newResultInput.placeholder = `Enter cm (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} cm`;
            }
        } else if (testNameLower.includes('grip')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '0.1';
            newResultInput.placeholder = `Enter kg (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} kg`;
            }
        } else {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.placeholder = 'Enter result';
        }
    }
    
    // Hide score preview
    const preview = document.getElementById('scorePreview');
    if (preview) {
        preview.style.display = 'none';
    }
    
    // Update step UI BEFORE showing modal
    updateStepUI();

    // Show modal
    document.getElementById('editScoreModal').style.display = 'flex';
    console.log('‚úÖ Modal opened successfully');
};

        // Authentication state change handler
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('=== STUDENT MANAGEMENT LOADING ===');
                    console.log('Professor authenticated:', user.email);
                    
                    window.currentUser = user;
                    
                    // Load sections and students
                    await loadSections();
                    await loadStudents();
                    
                    // Setup real-time updates
                    setupRealtimeUpdates();

                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    console.log('‚úì Student management loaded');
                    
                } catch (error) {
                    console.error('Error loading student management:', error);
                    
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    alert('Error loading data from database. Please check console for details.');
                }
            } else {
                console.log('No user, redirecting to login...');
                window.location.href = '/login/index.html';
            }
        });
            
        // Make functions globally available
        window.viewSectionDetails = viewSectionDetails;
        window.closeViewSectionModal = closeViewSectionModal;
        window.viewStudentDetails = viewStudentDetails;
        window.closeViewStudentModal = closeViewStudentModal;
        window.viewAttemptDetails = viewAttemptDetails;
        window.addNewAttempt = addNewAttempt;
        window.exportStudents = exportStudents;
        window.refreshData = refreshData;
        window.filterSections = filterSections;
        window.filterStudents = filterStudents;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.signOut = signOut;
        
        // Add window resize listener
        window.addEventListener('resize', updateResponsiveViews);
        
        // Initialize responsive views on load
        document.addEventListener('DOMContentLoaded', function() {
            // Call this after data is loaded
            setTimeout(updateResponsiveViews, 100);
        });
    </script>
    
    <script>
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.auth);
                    const baseUrl = window.location.origin;
                    window.location.href = baseUrl + '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }
        
        // Edit Score Modal Functions
        let currentStep = 1;
        let editScoreData = {
            studentEmail: '',
            testId: '',
            testName: '',
            testTarget: 0,
            testUnit: '',
            studentResult: 0,
            calculatedScore: 0,
            finalScore: 0,
            notes: ''
        };

        window.openEditScoreModal = function(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore = 0, currentResult = '', resultId = '') {
    editScoreData = {
        studentEmail: studentEmail,
        testId: testId,
        testName: testName,
        testTarget: testTarget || 0,
        testUnit: testUnit || '',
        studentName: studentName,
        resultId: resultId || '',
        currentScore: currentScore,
        currentResult: currentResult
    };

    // Update modal content
    document.getElementById('editScoreTestName').textContent = testName;
    document.getElementById('editScoreTarget').textContent = `${testTarget} ${testUnit}`;
    document.getElementById('editScoreStudent').textContent = studentName;

    // Display current score
    document.getElementById('currentScoreDisplay').textContent = currentScore > 0 ? currentScore.toFixed(1) : 'No score';
    
    // Display current result
    let resultDisplay = 'No result';
    if (currentResult) {
        if (typeof currentResult === 'string') {
            resultDisplay = currentResult;
        } else if (typeof currentResult === 'number') {
            resultDisplay = `${currentResult} ${testUnit}`;
        } else if (typeof currentResult === 'object') {
            const numValue = currentResult.repetitions || currentResult.time || currentResult.distance || currentResult.value || 0;
            resultDisplay = `${numValue} ${testUnit}`;
        }
    }
    document.getElementById('currentResultDisplay').textContent = resultDisplay;

    // Reset to step 1
    currentStep = 1;
    document.getElementById('newScore').value = '';
    document.getElementById('scorePreview').style.display = 'none';
    
    updateStepUI();

    // Show modal
    document.getElementById('editScoreModal').style.display = 'flex';
};

        // Close modal
        window.closeEditScoreModal = function() {
            document.getElementById('editScoreModal').style.display = 'none';
        };

        // Next step
       window.nextStep = function() {
    if (currentStep === 1) {
        currentStep = 2;
        updateStepUI();
    }
};
          
        document.addEventListener('DOMContentLoaded', function() {
    const newResultInput = document.getElementById('newResult');
    if (newResultInput) {
        newResultInput.addEventListener('input', function() {
            const result = parseFloat(this.value);
            const preview = document.getElementById('scorePreview');
            const previewValue = document.getElementById('previewScore');
            
            if (!isNaN(result) && result >= 0) {
                // Calculate score based on result
                const calculatedScore = calculateScoreFromResult(
                    editScoreData.testName,
                    result,
                    editScoreData.testTarget
                );
                
                if (calculatedScore > 0) {
                    preview.style.display = 'block';
                    previewValue.textContent = calculatedScore.toFixed(1);
                } else {
                    preview.style.display = 'none';
                }
            } else {
                preview.style.display = 'none';
            }
        });
    }
});

function calculateScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    // ‚≠ê CRITICAL: Check if this is a professor override with pre-calculated score
    if (result && typeof result === 'object' && result !== null) {
        // If professor already set a final score, use it directly
        if (result.score !== undefined && result.score !== null) {
            const score = parseFloat(result.score);
            if (!isNaN(score) && score >= 0 && score <= 100) {
                console.log(`‚úÖ Using stored professor score: ${score} for ${testName}`);
                return score;
            }
        }
    }
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || 
                      result.value || result.result || result.count || 
                      result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    console.log(`üéØ Calculating: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
    
    // Use test target if available - THIS IS THE KEY SECTION
    if (testTarget && testTarget > 0) {
        // REPETITION TESTS (push-ups, sit-ups, curl-ups)
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp') ||
            normalized.includes('curl-up')) {
            
            const reps = numericValue;
            if (reps >= testTarget) return 100;
            
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            // Apply grading scale
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // PLANK (time-based in seconds)
        if (normalized.includes('plank')) {
            let seconds = numericValue;
            if (seconds >= testTarget) return 100;
            
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // SIT-AND-REACH (flexibility in cm)
        if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            if (distance >= testTarget) return 100;
            
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // GRIP STRENGTH (kg)
        if (normalized.includes('grip')) {
            if (numericValue >= testTarget) return 100;
            
            const percentage = (numericValue / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // 1-MILE RUN (seconds - LOWER IS BETTER)
        if (normalized.includes('mile') || normalized.includes('run')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // STEP TEST (heart rate - LOWER IS BETTER)
        if (normalized.includes('step test') || normalized.includes('3-minute')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    // Fallback to default scoring if no target set
   function calculateDefaultScore(testName, value) {
    const normalized = testName.toLowerCase();
    
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        const reps = value;
        if (reps >= 40) return 100;
        if (reps >= 35) return 95;
        if (reps >= 30) return 90;
        if (reps >= 25) return 85;
        if (reps >= 20) return 80;
        if (reps >= 15) return 75;
        if (reps >= 10) return 70;
        if (reps >= 5) return 65;
        return 60;
    }
    
    if (normalized.includes('sit-up') || normalized.includes('situp') || 
        normalized.includes('curl-up')) {
        const reps = value;
        if (reps >= 50) return 100;
        if (reps >= 45) return 95;
        if (reps >= 40) return 90;
        if (reps >= 35) return 85;
        if (reps >= 30) return 80;
        if (reps >= 25) return 75;
        if (reps >= 20) return 70;
        if (reps >= 15) return 65;
        return 60;
    }
    
    if (normalized.includes('plank')) {
        let seconds = value;
        if (seconds >= 180) return 100;
        if (seconds >= 150) return 95;
        if (seconds >= 120) return 90;
        if (seconds >= 100) return 85;
        if (seconds >= 80) return 80;
        if (seconds >= 60) return 75;
        if (seconds >= 45) return 70;
        if (seconds >= 30) return 65;
        return 60;
    }
    
    if (normalized.includes('grip')) {
        if (value >= 60) return 100;
        if (value >= 55) return 95;
        if (value >= 50) return 90;
        if (value >= 45) return 85;
        if (value >= 40) return 80;
        if (value >= 35) return 75;
        if (value >= 30) return 70;
        return 65;
    }
    
    if (normalized.includes('sit-and-reach')) {
        const distance = value;
        if (distance >= 25) return 100;
        if (distance >= 20) return 95;
        if (distance >= 15) return 90;
        if (distance >= 10) return 85;
        if (distance >= 5) return 80;
        if (distance >= 0) return 75;
        if (distance >= -5) return 70;
        return 65;
    }
    
    if (normalized.includes('mile') || normalized.includes('run')) {
        if (value <= 420) return 100; // 7 minutes
        if (value <= 480) return 95;  // 8 minutes
        if (value <= 540) return 90;  // 9 minutes
        if (value <= 600) return 85;  // 10 minutes
        if (value <= 660) return 80;  // 11 minutes
        if (value <= 720) return 75;  // 12 minutes
        return 70;
    }
    
    if (normalized.includes('step test') || normalized.includes('3-minute')) {
        const heartRate = value;
        if (heartRate <= 70) return 100;
        if (heartRate <= 80) return 95;
        if (heartRate <= 90) return 90;
        if (heartRate <= 100) return 85;
        if (heartRate <= 110) return 80;
        if (heartRate <= 120) return 75;
        if (heartRate <= 130) return 70;
        return 65;
    }
    
    if (normalized.includes('bmi')) {
        const bmi = value;
        if (bmi >= 18.5 && bmi <= 24.9) return 100;
        if (bmi >= 17.0 && bmi < 18.5) return 85;
        if (bmi >= 25.0 && bmi < 27.0) return 85;
        if (bmi >= 16.0 && bmi < 17.0) return 70;
        if (bmi >= 27.0 && bmi < 30.0) return 70;
        return 60;
    }
    
    return 75; // Default score
    }
}

        // Update step UI
        function updateStepUI() {
    console.log('üîÑ Updating step UI, current step:', currentStep);
    
    // Update step indicators
    for (let i = 1; i <= 2; i++) {
        const step = document.getElementById('step' + i);
        const stepContent = document.getElementById('stepContent' + i);
        
        if (!step || !stepContent) {
            console.error('‚ùå Step element not found:', i);
            continue;
        }
        
        if (i < currentStep) {
            step.classList.add('completed');
            step.classList.remove('active');
            stepContent.style.display = 'none';
        } else if (i === currentStep) {
            step.classList.add('active');
            step.classList.remove('completed');
            stepContent.style.display = 'block';
        } else {
            step.classList.remove('active', 'completed');
            stepContent.style.display = 'none';
        }
    }
    
    // Update buttons
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    
    if (!btnNext || !btnSubmit) {
        console.error('‚ùå Button elements not found');
        return;
    }
    
    if (currentStep === 2) {
        btnNext.style.display = 'none';
        btnSubmit.style.display = 'inline-flex';
    } else {
        btnNext.style.display = 'inline-flex';
        btnSubmit.style.display = 'none';
    }
    
    console.log('‚úÖ Step UI updated');
}

       window.submitScore = async function() {
    const newResult = parseFloat(document.getElementById('newResult').value);
    
    if (isNaN(newResult) || newResult < 0) {
        alert('Please enter a valid result');
        return;
    }
    
    // ‚≠ê NEW VALIDATION: Check if result exceeds target
    const testTarget = editScoreData.testTarget;
    if (testTarget && testTarget > 0) {
        const testName = editScoreData.testName.toLowerCase();
        
        // For repetition-based tests (push-ups, sit-ups, curl-ups)
        if (testName.includes('push-up') || testName.includes('pushup') || 
            testName.includes('sit-up') || testName.includes('situp') ||
            testName.includes('curl-up')) {
            if (newResult > testTarget) {
                alert(`‚ùå Error: Maximum repetitions for this test is ${testTarget}. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For time-based tests (plank)
        else if (testName.includes('plank')) {
            if (newResult > testTarget) {
                alert(`‚ùå Error: Maximum time for this test is ${testTarget} seconds. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For flexibility tests (sit-and-reach)
        else if (testName.includes('sit-and-reach')) {
            if (newResult > testTarget) {
                alert(`‚ùå Error: Maximum distance for this test is ${testTarget} cm. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For grip strength
        else if (testName.includes('grip')) {
            if (newResult > testTarget) {
                alert(`‚ùå Error: Maximum grip strength for this test is ${testTarget} kg. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
    }
    
    try {
        const submitBtn = document.getElementById('btnSubmit');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        }
        
        // Calculate the score using the same logic as studentgrades.html
        const calculatedScore = calculateScore(
            editScoreData.testName,
            newResult,
            editScoreData.testTarget
        );
        
        const finalScore = Math.max(0, Math.min(100, Math.round(calculatedScore)));
        const now = new Date();
        
        // ‚≠ê CRITICAL: Get original submittedAt date from existing record
        let originalSubmittedAt = now;
        if (editScoreData.resultId) {
            try {
                const existingDoc = await getDoc(doc(window.db, 'testResults', editScoreData.resultId));
                if (existingDoc.exists()) {
                    originalSubmittedAt = existingDoc.data().submittedAt || now;
                }
            } catch (error) {
                console.warn('Could not retrieve original date:', error);
            }
        }
        
        // ‚≠ê CRITICAL: Preserve original date, add edit timestamp separately
        const resultData = {
            studentEmail: editScoreData.studentEmail,
            testId: editScoreData.testId,
            testName: editScoreData.testName,
            result: newResult,
            rawResult: newResult,
            resultData: {
                value: newResult,
                unit: editScoreData.testUnit
            },
            score: finalScore,
            testTarget: editScoreData.testTarget,
            testUnit: editScoreData.testUnit,
            status: 'completed',
            submittedAt: originalSubmittedAt,  // ‚≠ê KEEP ORIGINAL DATE
            isProfessorOverride: true,
            setByProfessor: true,
            overriddenBy: window.currentUser?.email || '',
            overriddenByName: window.currentUser?.displayName || window.currentUser?.email || 'Professor',
            overriddenAt: now,  // ‚≠ê NEW: Track when professor edited
            lastEditedAt: now   // ‚≠ê NEW: Track last edit time
        };
        
        console.log('üíæ Saving score:', finalScore, 'for', editScoreData.testName);
        console.log('üìÖ Original date preserved:', originalSubmittedAt);
        console.log('üìä Result stored:', newResult, editScoreData.testUnit);
        
        // Save to Firestore
        if (editScoreData.resultId) {
            await updateDoc(doc(window.db, 'testResults', editScoreData.resultId), resultData);
        } else {
            await addDoc(collection(window.db, 'testTests'), resultData);
        }
        
        alert(`‚úÖ Score saved: ${finalScore}/100\nüìÖ Original submission date preserved`);
        closeEditScoreModal();
        
        // Refresh data
        if (window.loadOverdueStudents) await window.loadOverdueStudents();
        if (window.loadStudents) await window.loadStudents();
        
    } catch (error) {
        console.error('‚ùå Error saving score:', error);
        alert('Error: ' + error.message);
        
        const submitBtn = document.getElementById('btnSubmit');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>‚úì</span> Save Score';
        }
    }
};

        document.addEventListener('DOMContentLoaded', function() {
    const newResultInput = document.getElementById('newResult');
    const formHint = document.getElementById('resultHint');
    
    if (newResultInput) {
        newResultInput.addEventListener('input', function() {
            const result = parseFloat(this.value);
            const preview = document.getElementById('scorePreview');
            const previewValue = document.getElementById('previewScore');
            
            // Clear any previous error styling
            this.classList.remove('border-red-500');
            if (formHint) {
                formHint.classList.remove('text-red-600');
                formHint.textContent = 'Enter what the student achieved in this test';
            }
            
            if (!isNaN(result) && result >= 0) {
                // Validate against target
                const testTarget = editScoreData.testTarget;
                if (testTarget && testTarget > 0) {
                    const testName = editScoreData.testName.toLowerCase();
                    
                    // Check if result exceeds target for specific test types
                    let exceedsLimit = false;
                    let maxMessage = '';
                    
                    if (testName.includes('push-up') || testName.includes('pushup') || 
                        testName.includes('sit-up') || testName.includes('situp') ||
                        testName.includes('curl-up')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} repetitions`;
                    } else if (testName.includes('plank')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} seconds`;
                    } else if (testName.includes('sit-and-reach')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} cm`;
                    } else if (testName.includes('grip')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} kg`;
                    }
                    
                    if (exceedsLimit) {
                        // Show error styling
                        this.classList.add('border-red-500');
                        if (formHint) {
                            formHint.classList.add('text-red-600');
                            formHint.textContent = `‚ùå ${maxMessage}`;
                        }
                        preview.style.display = 'none';
                        return;
                    }
                }
                
                // Calculate score if within limits
                const calculatedScore = calculateScore(
                    editScoreData.testName,
                    result,
                    editScoreData.testTarget
                );
                
                const finalScore = Math.max(0, Math.min(100, Math.round(calculatedScore)));
                
                if (!isNaN(finalScore)) {
                    preview.style.display = 'block';
                    previewValue.textContent = finalScore.toFixed(1);
                    
                    // Show grade letter
                    const gradeText = document.querySelector('.score-preview-text');
                    if (gradeText) {
                        gradeText.innerHTML = `Based on the result entered<br>Grade: ${getGradeLetter(finalScore)}`;
                    }
                } else {
                    preview.style.display = 'none';
                }
            } else {
                preview.style.display = 'none';
            }
        });
    }
});

// ‚≠ê NEW: Filter functions for student tests modal
function toggleFilterDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('filterDropdown');
    dropdown.classList.toggle('show');
}

function changeFilter(filterType) {
    window.currentFilter = filterType;
    
    // Update UI
    const filterLabel = document.getElementById('currentFilterLabel');
    const options = document.querySelectorAll('.filter-option');
    
    // Remove active class from all options
    options.forEach(option => option.classList.remove('active'));
    
    // Add active class to selected option
    let labelText = 'Filter: ';
    options.forEach(option => {
        if (option.getAttribute('data-test') === filterType || 
            (filterType === 'all-tests' && option.querySelector('span').textContent === 'All Tests')) {
            option.classList.add('active');
        }
    });
    
    // Update label
    if (filterType === 'all-tests') {
        labelText += 'All Tests';
    } else {
        const testName = getTestNameFromType(filterType);
        labelText += testName;
    }
    filterLabel.textContent = labelText;
    
    // Apply filtering
    filterStudentTests();
    
    // Close dropdown
    document.getElementById('filterDropdown').classList.remove('show');
}

function getTestNameFromType(testType) {
    const testMap = {
        'curl-up': 'Curl-up Test',
        'sit-up': 'Sit-up Test',
        'push-up': 'Push-up Test',
        'plank': 'Plank Test',
        'sit-and-reach': 'Sit and Reach Test',
        'step-test': 'Step Test (3-minute)',
        'grip-strength': 'Grip Strength Test',
        'mile-run': '1-Mile Run',
        'bmi': 'BMI Test',
        'flexibility': 'Flexibility Test'
    };
    return testMap[testType] || testType;
}

function getTestIcon(testName) {
    const testNameLower = testName.toLowerCase();
    if (testNameLower.includes('curl') || testNameLower.includes('sit-up')) {
        return 'fas fa-running';
    } else if (testNameLower.includes('push-up')) {
        return 'fas fa-dumbbell';
    } else if (testNameLower.includes('plank')) {
        return 'fas fa-hourglass-half';
    } else if (testNameLower.includes('sit-and-reach') || testNameLower.includes('flexibility')) {
        return 'fas fa-hands';
    } else if (testNameLower.includes('step')) {
        return 'fas fa-stairs';
    } else if (testNameLower.includes('grip')) {
        return 'fas fa-hand-fist';
    } else if (testNameLower.includes('mile') || testNameLower.includes('run')) {
        return 'fas fa-road';
    } else if (testNameLower.includes('bmi')) {
        return 'fas fa-weight-scale';
    }
    return 'fas fa-clipboard-check';
}

function populateTestFilterOptions(tests) {
    // Extract unique test types
    const testTypes = {};
    tests.forEach(test => {
        const testName = test.testName.toLowerCase();
        let testType = 'other';
        
        // Categorize tests
        if (testName.includes('curl')) {
            testType = 'curl-up';
        } else if (testName.includes('sit-up') && !testName.includes('reach')) {
            testType = 'sit-up';
        } else if (testName.includes('push-up')) {
            testType = 'push-up';
        } else if (testName.includes('plank')) {
            testType = 'plank';
        } else if (testName.includes('sit-and-reach')) {
            testType = 'sit-and-reach';
        } else if (testName.includes('step') || testName.includes('3-minute')) {
            testType = 'step-test';
        } else if (testName.includes('grip')) {
            testType = 'grip-strength';
        } else if (testName.includes('mile') || testName.includes('run')) {
            testType = 'mile-run';
        } else if (testName.includes('bmi')) {
            testType = 'bmi';
        } else if (testName.includes('flexibility')) {
            testType = 'flexibility';
        }
        
        if (!testTypes[testType]) {
            testTypes[testType] = {
                name: getTestNameFromType(testType),
                icon: getTestIcon(testName),
                count: 0
            };
        }
        testTypes[testType].count++;
    });
    
    // Store available test types
    window.availableTestTypes = Object.keys(testTypes);
    
    // Update filter dropdown
    const filterDropdown = document.getElementById('filterDropdown');
    let html = `
        <div class="filter-option active" onclick="changeFilter('all-tests')">
            <i class="fas fa-list"></i>
            <span>All Tests</span>
            <span class="filter-count" id="count-all">${tests.length}</span>
        </div>
    `;
    
    // Add each test type option
    Object.entries(testTypes).forEach(([type, data]) => {
        html += `
            <div class="filter-option" onclick="changeFilter('${type}')" data-test="${type}">
                <i class="${data.icon}"></i>
                <span>${data.name}</span>
                <span class="filter-count" id="count-${type}">${data.count}</span>
            </div>
        `;
    });
    
    filterDropdown.innerHTML = html;
}

function filterStudentTests() {
    if (!window.currentStudentTests || window.currentStudentTests.length === 0) return;
    
    let filteredTests = [];
    
    if (window.currentFilter === 'all-tests') {
        filteredTests = [...window.currentStudentTests];
    } else {
        filteredTests = window.currentStudentTests.filter(test => {
            const testName = test.testName.toLowerCase();
            const testType = window.currentFilter;
            
            switch(testType) {
                case 'curl-up':
                    return testName.includes('curl');
                case 'sit-up':
                    return testName.includes('sit-up') && !testName.includes('reach');
                case 'push-up':
                    return testName.includes('push-up');
                case 'plank':
                    return testName.includes('plank');
                case 'sit-and-reach':
                    return testName.includes('sit-and-reach') || testName.includes('reach');
                case 'step-test':
                    return testName.includes('step') || testName.includes('3-minute');
                case 'grip-strength':
                    return testName.includes('grip');
                case 'mile-run':
                    return testName.includes('mile') || testName.includes('run');
                case 'bmi':
                    return testName.includes('bmi');
                case 'flexibility':
                    return testName.includes('flexibility');
                default:
                    return true;
            }
        });
    }
    
    window.currentStudentTestsFiltered = filteredTests;
    sortStudentTests();
}

// ‚≠ê UPDATED: Sorting functions for student tests modal
function toggleSortDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('sortDropdown');
    dropdown.classList.toggle('show');
}

function changeSort(sortType) {
    window.currentSort = sortType;
    
    // Update UI
    const sortLabel = document.getElementById('currentSortLabel');
    const options = document.querySelectorAll('.sort-option');
    
    // Remove active class from all options
    options.forEach(option => option.classList.remove('active'));
    
    // Add active class to selected option
    let labelText = 'Sort: ';
    options.forEach(option => {
        if (option.querySelector('span').textContent.includes(getSortLabel(sortType))) {
            option.classList.add('active');
        }
    });
    
    // Update label
    labelText += getSortLabel(sortType);
    sortLabel.textContent = labelText;
    
    // Apply sorting
    sortStudentTests();
    
    // Close dropdown
    document.getElementById('sortDropdown').classList.remove('show');
}

function getSortLabel(sortType) {
    switch(sortType) {
        case 'newest-first': return 'Newest First';
        case 'oldest-first': return 'Oldest First';
        case 'test-name-a-z': return 'Test Name A-Z';
        case 'test-name-z-a': return 'Test Name Z-A';
        case 'score-high-low': return 'Score: High to Low';
        case 'score-low-high': return 'Score: Low to High';
        case 'status': return 'Status (Pending First)';
        default: return 'Newest First';
    }
}

function sortStudentTests() {
    if (!window.currentStudentTestsFiltered || window.currentStudentTestsFiltered.length === 0) {
        // If no filtered tests, use all tests
        window.currentStudentTestsFiltered = [...window.currentStudentTests];
    }
    
    const sortedTests = [...window.currentStudentTestsFiltered];
    
    switch(window.currentSort) {
        case 'newest-first':
            sortedTests.sort((a, b) => b.deadline.getTime() - a.deadline.getTime());
            break;
        case 'oldest-first':
            sortedTests.sort((a, b) => a.deadline.getTime() - b.deadline.getTime());
            break;
        case 'test-name-a-z':
            sortedTests.sort((a, b) => a.testName.localeCompare(b.testName));
            break;
        case 'test-name-z-a':
            sortedTests.sort((a, b) => b.testName.localeCompare(a.testName));
            break;
        case 'score-high-low':
            sortedTests.sort((a, b) => {
                const scoreA = a.hasCompleted ? a.currentScore : 0;
                const scoreB = b.hasCompleted ? b.currentScore : 0;
                return scoreB - scoreA;
            });
            break;
        case 'score-low-high':
            sortedTests.sort((a, b) => {
                const scoreA = a.hasCompleted ? a.currentScore : 0;
                const scoreB = b.hasCompleted ? b.currentScore : 0;
                return scoreA - scoreB;
            });
            break;
        case 'status':
            sortedTests.sort((a, b) => {
                // Pending first, then completed
                if (!a.hasCompleted && b.hasCompleted) return -1;
                if (a.hasCompleted && !b.hasCompleted) return 1;
                return b.deadline.getTime() - a.deadline.getTime(); // Then by newest
            });
            break;
    }
    
    renderStudentTestsTable(sortedTests);
}

function renderStudentTestsTable(tests) {
    let html = '';
    
    if (tests.length === 0) {
        html = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;">üìã</div>
                    No tests found for the selected filter
                </td>
            </tr>
        `;
    } else {
        tests.forEach(item => {
            const isEnabled = item.isEnabled || false;
            const hasCompleted = item.hasCompleted;
            const testIcon = getTestIcon(item.testName);
            
            html += `
                <tr style="${hasCompleted ? 'background-color: #f0fdf4;' : ''}">
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="${testIcon}" style="color: ${hasCompleted ? '#10b981' : '#ef4444'}; font-size: 18px;"></i>
                            <div>
                                <strong style="color: ${hasCompleted ? '#10b981' : '#ef4444'};">${item.testName}</strong>
                                ${isEnabled ? '<br><small style="color: #3b82f6;">‚úì Enabled by you</small>' : ''}
                            </div>
                        </div>
                    </td>
                    <td>
                        ${hasCompleted ? 
                            '<span class="status-badge status-active">Completed</span>' : 
                            '<span class="status-badge" style="background: #fee2e2; color: #991b1b;">Pending</span>'
                        }
                    </td>
                    <td>
                        <small style="color: #64748b;">${item.deadlineString}</small>
                        <br>
                        <small style="font-size: 11px; color: #94a3b8;">
                            ${item.deadline.toLocaleDateString('en-US', { 
                                weekday: 'short', 
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'
                            })}
                        </small>
                    </td>
                    <td>
                        ${hasCompleted ? 
                            `<span style="font-weight: 700; color: #1e3a8a;">${item.currentScore.toFixed(1)}%</span>` : 
                            '<span style="color: #64748b;">Not scored</span>'
                        }
                    </td>
                    <td>
                        <div class="action-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${!hasCompleted && !isEnabled ? `
                                <button class="btn-action btn-view" onclick="event.stopPropagation(); enableOverdueTest('${item.studentEmail}', '${item.testId}', '${item.testName}')">
                                    <i class="fas fa-unlock"></i> Enable
                                </button>
                            ` : ''}
                            ${!hasCompleted && isEnabled ? `
                                <button class="btn-action" style="background: #3b82f6; color: white;" disabled>
                                    <i class="fas fa-check-circle"></i> Enabled
                                </button>
                            ` : ''}
                            <button class="btn-action btn-attempt" onclick="event.stopPropagation(); setOverdueScore('${item.studentEmail}', '${item.testId}', '${item.testName}', ${item.testTarget}, '${item.testUnit}', '${item.studentName}', ${hasCompleted ? item.currentScore : 0}, '${hasCompleted ? item.currentResult : ''}', '${item.resultId || ''}')">
                                <i class="fas fa-edit"></i> ${hasCompleted ? 'Edit' : 'Set'} Score
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }
    
    document.getElementById('studentTestsTableBody').innerHTML = html;
}

// ‚≠ê UPDATED: Show student's overdue tests with sorting and filtering
window.showStudentTests = async function(studentEmail) {
    const studentTests = window.filteredOverdueStudents.filter(t => t.studentEmail === studentEmail);
    
    if (studentTests.length === 0) return;
    
    const studentName = studentTests[0].studentName;
    document.getElementById('modalStudentName').textContent = `${studentName}'s Overdue Tests (${studentTests.length})`;
    
    // Get enabled tests
    const permissionsSnapshot = await getDocs(query(
        collection(window.db, 'testPermissions'),
        where('grantedBy', '==', window.currentUser.email)
    ));
    
    const enabledTests = new Map();
    permissionsSnapshot.forEach(doc => {
        const perm = doc.data();
        const key = `${perm.studentEmail}_${perm.testId}`;
        enabledTests.set(key, { id: doc.id });
    });
    
    // Mark which tests are enabled
    const enrichedTests = studentTests.map(item => ({
        ...item,
        isEnabled: enabledTests.has(`${item.studentEmail}_${item.testId}`)
    }));
    
    // Store tests and apply filtering/sorting
    window.currentStudentTests = enrichedTests;
    
    // Populate filter options
    populateTestFilterOptions(enrichedTests);
    
    // Apply current filter
    filterStudentTests();
    
    // Show modal
    document.getElementById('studentTestsModal').style.display = 'flex';
    console.log('üìä Showing', studentTests.length, 'tests for', studentName);
};

// ‚≠ê FIXED: Close modal properly
window.closeStudentTestsModal = function() {
    document.getElementById('studentTestsModal').style.display = 'none';
    window.currentStudentTests = [];
    window.currentStudentTestsFiltered = [];
    window.currentFilter = 'all-tests';
    window.currentSort = 'newest-first';
    
    // Close dropdowns if open
    document.getElementById('sortDropdown').classList.remove('show');
    document.getElementById('filterDropdown').classList.remove('show');
};

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const sortDropdown = document.getElementById('sortDropdown');
    const filterDropdown = document.getElementById('filterDropdown');
    const sortButton = document.querySelector('.sort-button');
    const filterButton = document.querySelector('.filter-button');
    
    if (sortDropdown && sortButton && 
        !sortDropdown.contains(event.target) && 
        !sortButton.contains(event.target)) {
        sortDropdown.classList.remove('show');
    }
    
    if (filterDropdown && filterButton && 
        !filterDropdown.contains(event.target) && 
        !filterButton.contains(event.target)) {
        filterDropdown.classList.remove('show');
    }
});

// ‚≠ê NEW: Get grade letter function
function getGradeLetter(score) {
    if (score >= 97) return 'A+';
    if (score >= 93) return 'A';
    if (score >= 90) return 'A-';
    if (score >= 87) return 'B+';
    if (score >= 83) return 'B';
    if (score >= 80) return 'B-';
    if (score >= 77) return 'C+';
    if (score >= 73) return 'C';
    if (score >= 70) return 'C-';
    if (score >= 67) return 'D+';
    if (score >= 63) return 'D';
    if (score >= 60) return 'D-';
    return 'F';
}

// Calculate score from result (for preview)
function calculateScoreFromResult(testName, result, testTarget) {
    return calculateScore(testName, result, testTarget);
}
    </script>
</body>
</html>