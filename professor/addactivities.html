<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Test Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        
        /* Custom animations for professor dashboard */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-text {
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        /* Custom styles */
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .nav-shadow {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        /* Profile dropdown styles */
        .profile-container {
            position: relative;
        }
        .profile-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .profile-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .profile-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Table styling */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table thead {
            background-color: #f3f2f2;
        }
        .custom-table th {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #1e3a8a;
            font-size: 15px;
            text-align: center;
            padding: 12px 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        .custom-table td {
            font-family: "Inter", Helvetica;
            font-weight: 400;
            color: #000;
            font-size: 14px;
            text-align: center;
            padding: 16px 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        .custom-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .progress-cell {
            font-size: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 14px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 11px;
        }
        .status-active {
            background-color: #a4fbb1;
            color: #000;
        }
        .status-scheduled {
            background-color: #fbbf24;
            color: #000;
        }
        .status-completed {
            background-color: #3b82f6;
            color: #fff;
        }
        .rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 14px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 11px;
        }
        .rating-excellent {
            background-color: #a4fbb1;
            color: #000;
        }
        .rating-good {
            background-color: #3b82f6;
            color: #fff;
        }
        .rating-fair {
            background-color: #fbbf24;
            color: #000;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-action {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-edit {
            background-color: #111b66;
            color: white;
        }
        .btn-edit:hover {
            background-color: #0d1450;
        }
        .btn-cancel {
            background: linear-gradient(180deg, rgba(245, 158, 11, 1) 0%, rgba(251, 191, 36, 1) 100%);
            color: white;
        }
        .btn-cancel:hover {
            opacity: 0.9;
        }
        .btn-view {
            background-color: #111b66;
            color: white;
        }
        .btn-view:hover {
            background-color: #0d1450;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #1e3a8a;
            font-size: 20px;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s;
        }
        .close-modal:hover {
            color: #1e293b;
        }
        .modal-body {
            padding: 25px;
        }
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Empty state */
        .empty-state {
            padding: 60px 40px;
            text-align: center;
        }
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
        }
        .empty-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 12px;
        }
        .empty-text {
            font-family: "Inter", Helvetica;
            font-weight: 400;
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: visible;
            }
            
            .custom-table {
                display: block;
                width: 100%;
                font-size: 14px;
            }
            
            .custom-table thead {
                display: none;
            }
            
            .custom-table tbody {
                display: block;
            }
            
            .custom-table tr {
                display: block;
                margin-bottom: 20px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .custom-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 0;
                border-bottom: 1px solid #f1f5f9;
                text-align: left;
            }
            
            .custom-table td:last-child {
                border-bottom: none;
            }
            
            .custom-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #1e3a8a;
                font-size: 12px;
                text-transform: uppercase;
                flex: 0 0 40%;
            }
            
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }
        }
        
        /* Student selection styles */
        .student-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .student-checkbox-item:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }

        .student-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .student-details {
            font-size: 12px;
            color: #6b7280;
        }

        .selection-summary {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-summary-text {
            font-size: 14px;
            color: #1e40af;
            font-weight: 600;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col justify-center items-center z-50">
        <div class="w-12 h-12 border-4 border-gray-100 border-t-blue-500 rounded-full spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading Test Management...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- Navigation Banner - MATCHING PROFESSOR DASHBOARD -->
        <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4 py-3 sm:py-4">
                    <!-- Logo -->
                    <a href="professor-dashboard.html" class="flex items-center gap-2 sm:gap-3">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <!-- Dashboard -->
                        <a href="professor-dashboard.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-tachometer-alt"></i> 
                            <span>Dashboard</span>
                        </a>
                        
                        <!-- Student Management -->
                        <a href="studentmanagement.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-users"></i> 
                            <span>Student Management</span>
                        </a>
                        
                        <!-- Add Activities (Active) -->
                        <a href="addactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-dumbbell"></i> 
                            <span>Add Activities</span>
                        </a>
                        
                        <!-- Add Lesson -->
                        <a href="addlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-book-open"></i> 
                            <span>Add Lesson</span>
                        </a>
                        
                        <!-- Monitoring Activities -->
                        <a href="monitoringactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-chart-bar"></i> 
                            <span>Monitoring Activities</span>
                        </a>
                        
                        <!-- Grades -->
                        <a href="grades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-graduation-cap"></i> 
                            <span>Grades</span>
                        </a>
                        
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <!-- Mobile Profile Dropdown -->
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <button id="mobileMenuButton" class="text-white p-1 sm:p-2">
                            <i class="bi bi-list text-2xl sm:text-3xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Navigation Menu -->
                <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2 pb-3">
                    <a href="professor-dashboard.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                    </a>
                    <a href="studentmanagement.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-users mr-2"></i> Student Management
                    </a>
                    <a href="addactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm">
                        <i class="fas fa-dumbbell mr-2"></i> Add Activities
                    </a>
                    <a href="addlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-book-open mr-2"></i> Add Lesson
                    </a>
                    <a href="monitoringactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-chart-bar mr-2"></i> Monitoring Activities
                    </a>
                    <a href="grades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-graduation-cap mr-2"></i> Grades
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-10 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Info Banner -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-8">
                    <div class="flex items-center gap-6">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center">
                            <i class="fas fa-dumbbell text-white text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-blue-900 font-bold text-3xl mb-2">Test Management</h2>
                            <p class="text-gray-600">Schedule fitness tests, track progress, and manage student assessments</p>
                        </div>
                    </div>
                </div>
                
                <!-- My Test Schedule Section -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <div class="flex items-center mb-4 sm:mb-0">
                            <i class="fas fa-calendar-check text-blue-600 text-xl mr-3"></i>
                            <h3 class="text-gray-900 font-bold text-xl">My Test Schedule</h3>
                        </div>
                        <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-semibold py-2.5 px-5 rounded-lg flex items-center gap-2 transition-all hover:-translate-y-0.5 hover:shadow-lg" onclick="showScheduleTestModal()">
                            <i class="fas fa-plus"></i> Schedule New Test
                        </button>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="searchSchedule" 
                               class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Search by Test Name or Section" 
                               onkeyup="filterScheduleTable()">
                    </div>
                    
                    <!-- Schedule Table -->
                    <div class="table-responsive">
                        <table class="custom-table" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Section</th>
                                    <th>Date</th>
                                    <th>Deadline</th>
                                    <th>Progress</th>
                                    <th>Attempts Allowed</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="empty-state">
                                            <div class="empty-icon">üìÖ</div>
                                            <div class="empty-title">No Scheduled Tests</div>
                                            <div class="empty-text">You haven't scheduled any tests yet. Click "Schedule New Test" to create your first fitness test schedule.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Recent Test Results Section -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <div class="flex items-center mb-4 sm:mb-0">
                            <i class="fas fa-chart-line text-green-600 text-xl mr-3"></i>
                            <h3 class="text-gray-900 font-bold text-xl">Recent Test Results</h3>
                        </div>
                        <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 text-sm transition-all hover:-translate-y-0.5 hover:shadow-lg" onclick="generateReports()">
                            <i class="fas fa-file-alt"></i> Generate Reports
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchResults" 
                                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Search by student name" 
                                   onkeyup="filterResultsTable()">
                        </div>
                        
                        <select class="form-select border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filterSection" onchange="filterResultsTable()">
                            <option value="">All Sections</option>
                        </select>
                        
                        <select class="form-select border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filterTest" onchange="filterResultsTable()">
                            <option value="">All Tests</option>
                        </select>
                    </div>
                    
                    <!-- Clear Filters Button -->
                    <button class="mb-6 text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center gap-1" onclick="clearResultFilters()">
                        <i class="fas fa-redo"></i> Clear Filters
                    </button>
                    
                    <!-- Results Table -->
                    <div class="table-responsive">
                        <table class="custom-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Section</th>
                                    <th>Date</th>
                                    <th>Test</th>
                                    <th>Score</th>
                                    <th>BMI</th>
                                    <th>Rating</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="empty-state">
                                            <div class="empty-icon">üìä</div>
                                            <div class="empty-title">No Test Results Yet</div>
                                            <div class="empty-text">No students have completed tests yet. Test results will appear here once students start taking and completing their fitness assessments.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-950 mt-10 py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h4 class="text-yellow-500 font-bold text-lg text-center mb-5">About CTBL</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The Center for Technology Based Learning serves as the learning management system operating hub, 
                        reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                        center's daily operations.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        Working closely with the Office of the President, the Center for Information Technology, and the 
                        Deans and Directors to support the LMS end-users' day-to-day activity.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The center focuses on implementing new forms of training and determining the validity of data to 
                        support the university's educational objectives.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Test Modal -->
    <div id="scheduleTestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Schedule New Test</h3>
                <button class="close-modal" onclick="closeScheduleTestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="videoURL">
                        <i class="fab fa-youtube"></i> Instruction Video URL (Optional)
                    </label>
                    <input type="url" class="form-control" id="videoURL" placeholder="https://www.youtube.com/watch?v=...">
                    <small style="color: #64748b; font-size: 12px; margin-top: 5px; display: block;">
                        üì∫ Paste a YouTube video link for test instructions (optional)
                    </small>
                    <small style="color: #3b82f6; font-size: 12px; margin-top: 5px;">
                        üí° Tip: Upload your video to YouTube first, then copy the link here
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testType">Test Type <span style="color: #ef4444;">*</span></label>
                    <select class="form-select" id="testType" required>
                        <option value="">Select Test Type</option>
                        <option value="3-Minute Step Test">3-Minute Step Test</option>
                        <option value="Curl-Up Test">Curl-Up Test</option>
                        <option value="Push-Up Test">Push-Up Test</option>
                        <option value="Sit-and-Reach">Sit-and-Reach Test</option>
                        <option value="Skinfold Caliper">Skinfold Caliper Measurements</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testSection">Section</label>
                    <select class="form-select" id="testSection">
                        <option value="">Select Section</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testDate">Test Date <span style="color: #ef4444;">*</span></label>
                    <input type="date" class="form-control" id="testDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testTime">Test Available Time <span style="color: #ef4444;">*</span></label>
                    <input type="time" class="form-control" id="testTime" value="00:00" required>
                    <small style="color: #64748b; font-size: 12px; margin-top: 5px; display: block;">
                        ‚è∞ Time when students can start taking the test
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testDeadline">Deadline Date <span style="color: #ef4444;">*</span></label>
                    <input type="date" class="form-control" id="testDeadline" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testDeadlineTime">Deadline Time <span style="color: #ef4444;">*</span></label>
                    <input type="time" class="form-control" id="testDeadlineTime" value="23:59" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="attemptsAllowed">Attempts Allowed</label>
                    <select class="form-select" id="attemptsAllowed">
                        <option value="1">1 Attempt</option>
                        <option value="2">2 Attempts</option>
                        <option value="3">3 Attempts</option>
                    </select>
                </div>
                
                <div class="form-group" id="testTargetGroup" style="display: none;">
                    <label class="form-label" id="testTargetLabel">Test Target</label>
                    <input type="number" class="form-control" id="testTarget" min="1">
                    <small class="text-muted" id="testTargetHint"></small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="testInstructions">Additional Instructions (Optional)</label>
                    <textarea class="form-control" id="testInstructions" rows="3" placeholder="Add any specific instructions for this test..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors" onclick="closeScheduleTestModal()">Cancel</button>
                <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-4 rounded-lg transition-all hover:-translate-y-0.5" onclick="scheduleTest()">Schedule Test</button>
            </div>
        </div>
    </div>

    <!-- Edit Test Modal -->
    <div id="editTestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Test</h3>
                <button class="close-modal" onclick="closeEditTestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Test Type</label>
                    <input type="text" class="form-control" id="editTestName" readonly style="background-color: #f3f4f6;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Section</label>
                    <input type="text" class="form-control" id="editTestSection" readonly style="background-color: #f3f4f6;">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editTestDate">Test Date <span style="color: #ef4444;">*</span></label>
                    <input type="date" class="form-control" id="editTestDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTestTime">Test Available Time <span style="color: #ef4444;">*</span></label>
                    <input type="time" class="form-control" id="editTestTime" value="00:00" required>
                    <small style="color: #64748b; font-size: 12px; margin-top: 5px; display: block;">
                        ‚è∞ Time when students can start taking the test
                    </small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTestDeadline">Deadline Date <span style="color: #ef4444;">*</span></label>
                    <input type="date" class="form-control" id="editTestDeadline" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editTestDeadlineTime">Deadline Time <span style="color: #ef4444;">*</span></label>
                    <input type="time" class="form-control" id="editTestDeadlineTime" required>
                </div>
                
                <div class="form-group" id="editTestTargetGroup" style="display: none;">
                    <label class="form-label" id="editTestTargetLabel">Test Target <span style="color: #ef4444;">*</span></label>
                    <input type="number" class="form-control" id="editTestTarget" min="1">
                    <small class="text-muted" id="editTestTargetHint"></small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Attempts Allowed</label>
                    <input type="text" class="form-control" id="editAttemptsAllowed" readonly style="background-color: #f3f4f6;">
                </div>
                
                <input type="hidden" id="editTestId">
            </div>
            <div class="modal-footer">
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors" onclick="closeEditTestModal()">Cancel</button>
                <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-4 rounded-lg transition-all hover:-translate-y-0.5" onclick="saveEditTest()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Manage Students Modal -->
    <div id="manageStudentsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Manage Test Access</h3>
                    <p style="font-size: 12px; color: #64748b; margin-top: 5px;" id="testInfoHeader">Select students who can take this test</p>
                </div>
                <button class="close-modal" onclick="closeManageStudentsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Selection Summary -->
                <div class="selection-summary">
                    <span class="selection-summary-text">
                        <i class="fas fa-users"></i> <span id="selectedCount">0</span> of <span id="totalCount">0</span> students selected
                    </span>
                    <div class="bulk-actions">
                        <button type="button" onclick="selectAllStudentsInModal()" class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-1 px-3 rounded text-sm">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button type="button" onclick="deselectAllStudentsInModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-1 px-3 rounded text-sm">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="form-group">
                    <input type="text" 
                           class="form-control" 
                           id="studentSearchBox" 
                           placeholder="üîç Search students by name or student number..."
                           onkeyup="filterStudentList()">
                </div>

                <!-- Students List -->
                <div id="studentsListContainer" 
                     style="max-height: 400px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px; background: #f9fafb;">
                    <p style="text-align: center; color: #64748b; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading students...
                    </p>
                </div>

                <input type="hidden" id="currentTestId">
            </div>
            <div class="modal-footer">
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors" onclick="closeManageStudentsModal()">Cancel</button>
                <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-4 rounded-lg transition-all hover:-translate-y-0.5" onclick="saveStudentSelection()">
                    <i class="fas fa-save"></i> Save Selection
                </button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            doc, 
            getDoc, 
            addDoc, 
            serverTimestamp,
            onSnapshot,
            deleteDoc,
            updateDoc  
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements for navigation
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        // Event Listeners for navigation
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile menu toggle
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', toggleMobileMenu);
            }
            
            // Profile dropdowns
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', closeAllDropdowns);
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        // Profile dropdown
        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 1024;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                document.body.classList.add('dropdown-open');
            } else {
                dropdown.classList.add('hidden');
                document.body.classList.remove('dropdown-open');
            }
        }

        function closeProfileDropdown() {
            profileDropdown.classList.add('hidden');
            profileDropdownMobile.classList.add('hidden');
            document.body.classList.remove('dropdown-open');
        }

        // Close all dropdowns when clicking outside
        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        // View profile function
        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        // Logout function
        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        // Function to update profile picture
        function updateProfilePicture(photoURL, userName) {
            // For navigation
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = currentUser?.displayName || userName || 'Professor';
            const email = currentUser?.email || 'professor@umak.edu.ph';
            
            // Use provided photo URL or create initial avatar
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            // Update all profile pictures for navigation
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            // Update names
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            // Update emails
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        // Global variables
        window.currentUser = null;
        window.assignedSections = [];
        window.currentTestStudents = [];
        window.selectedStudentEmails = new Set();
        window.currentManagingTestId = null;

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('User authenticated:', user.email);
                    
                    // Update profile picture with Google photo
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    window.currentUser = user;
                    
                    await loadScheduledTests(user.email, user.uid);
                    await loadTestResults(user.email, user.uid);
                    setupRealTimeUpdates(user.email, user.uid);
                    setupRealTimeResultUpdates(user.email, user.uid);
                    setupTestVisibilityUpdates();
                    
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                } catch (error) {
                    console.error('Error loading data:', error);
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        // Function to get rating based on score
        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'rating-excellent' };
            if (score >= 80) return { text: 'Good', class: 'rating-good' };
            if (score >= 70) return { text: 'Fair', class: 'rating-fair' };
            return { text: 'Needs Improvement', class: 'rating-fair' };
        }

        async function loadScheduledTests(userEmail, userId) {
            try {
                console.log('=== LOADING SCHEDULED TESTS ===');
                console.log('Professor email:', userEmail);
                console.log('Professor UID:', userId);
                
                // STEP 1: Get professor's name
                console.log('Step 1: Checking professors collection...');
                let professorName = '';
                
                const professorsQuery = query(
                    collection(db, 'professors'),
                    where('email', '==', userEmail)
                );
                const professorsSnapshot = await getDocs(professorsQuery);
                
                if (!professorsSnapshot.empty) {
                    const professorData = professorsSnapshot.docs[0].data();
                    professorName = professorData.name || '';
                    console.log('‚úì Professor found:', professorName);
                }
                
                // If not found in professors collection, try users collection
                if (!professorName) {
                    console.log('Checking users collection...');
                    const usersQuery = query(
                        collection(db, 'users'),
                        where('email', '==', userEmail)
                    );
                    const usersSnapshot = await getDocs(usersQuery);
                    
                    if (!usersSnapshot.empty) {
                        const userData = usersSnapshot.docs[0].data();
                        professorName = userData.name || '';
                        console.log('‚úì Professor found in users:', professorName);
                    }
                }
                
                window.assignedSections = [];
                
                // STEP 2: Find all sections where this professor is assigned
                console.log('Step 2: Checking sections collection...');
                const sectionsQuery = query(collection(db, 'sections'));
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                console.log('Total sections in database:', sectionsSnapshot.size);
                
                // Use a Set to track unique section names
                const seenSections = new Set();
                
                for (const docSnap of sectionsSnapshot.docs) {
                    const sectionData = docSnap.data();
                    
                    // Check if this professor teaches this section (match by name or email)
                    const isProfessorAssigned = 
                        sectionData.professor === professorName ||
                        sectionData.professorEmail === userEmail ||
                        (sectionData.professor && professorName && 
                         sectionData.professor.toLowerCase() === professorName.toLowerCase());
                    
                    if (isProfessorAssigned) {
                        // Skip if we've already added this section
                        if (seenSections.has(sectionData.name)) {
                            console.log(`‚ö†Ô∏è Skipping duplicate section: ${sectionData.name}`);
                            continue;
                        }
                        
                        console.log(`‚úì Found assigned section: ${sectionData.name}`);
                        seenSections.add(sectionData.name);
                        
                        // Get student count from the section's students array
                        const actualStudentCount = sectionData.students ? sectionData.students.length : 0;
                        
                        window.assignedSections.push({
                            section: sectionData.name,
                            students: actualStudentCount,
                            courseCode: sectionData.courseCode || 'PE 3',
                            time: sectionData.time || 'Not Set',
                            day: sectionData.day || 'Not Set',
                            room: sectionData.room || 'Not Set'
                        });
                        
                        console.log(`  - ${sectionData.name}: ${actualStudentCount} students`);
                        console.log(`  - Schedule: ${sectionData.time || 'N/A'} / ${sectionData.day || 'N/A'} / ${sectionData.room || 'N/A'}`);
                    }
                }
                
                console.log('=== FINAL ASSIGNED SECTIONS ===');
                console.log('Total unique sections:', window.assignedSections.length);
                console.log('Sections:', window.assignedSections);
                
                // STEP 3: Load scheduled tests
                console.log('Step 3: Loading scheduled tests...');
                
                let testsQuery;

                if (window.assignedSections.length > 0) {
                    const sectionNames = window.assignedSections.map(s => s.section);
                    // Firestore 'in' operator has a limit of 10 items
                    const limitedSections = sectionNames.slice(0, 10);
                    
                    testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('professorEmail', '==', userEmail),
                        where('section', 'in', limitedSections)
                    );
                } else {
                    testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('professorEmail', '==', userEmail)
                    );
                }
                
                let testsSnapshot = await getDocs(testsQuery);
                
                if (testsSnapshot.empty) {
                    console.log('No tests by email, trying userId...');
                    testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('professorId', '==', userId)
                    );
                    testsSnapshot = await getDocs(testsQuery);
                }
                
                // Load enabled test permissions
                const permissionsQuery = query(
                    collection(db, 'testPermissions'),
                    where('grantedBy', '==', userEmail)
                );
                const permissionsSnapshot = await getDocs(permissionsQuery);
                const enabledTestsMap = new Map();
                
                permissionsSnapshot.forEach(doc => {
                    const perm = doc.data();
                    if (!enabledTestsMap.has(perm.testId)) {
                        enabledTestsMap.set(perm.testId, []);
                    }
                    enabledTestsMap.get(perm.testId).push(perm.studentEmail);
                });
                
                const tableBody = document.getElementById('scheduleTableBody');

                if (!testsSnapshot.empty) {
                    let html = '';
                    let hasVisibleTests = false;
                    
                    testsSnapshot.forEach((docSnap) => {
                        const test = docSnap.data();
                        
                        const deadlineDateTime = new Date(test.deadlineDateTime);
                        const now = new Date();
                        
                        // Show test if it's either not overdue OR enabled for students
                        const isOverdue = deadlineDateTime < now;
                        const isEnabled = enabledTestsMap.has(docSnap.id);
                        const enabledCount = isEnabled ? enabledTestsMap.get(docSnap.id).length : 0;
                        
                        // Show if: not overdue, OR is enabled
                        if (!isOverdue || isEnabled) {
                            hasVisibleTests = true;
                            
                            const status = test.status || 'scheduled';
                            const statusClass = status === 'active' ? 'status-active' : 
                                               status === 'completed' ? 'status-completed' : 
                                               'status-scheduled';
                            
                            const totalStudents = test.totalStudents || 0;
                            const completedStudents = test.completedStudents || 0;
                            const progress = totalStudents > 0 ? `${completedStudents}/${totalStudents}` : '0/0';
                            
                            // Get section schedule info if available
                            const sectionInfo = window.assignedSections.find(s => s.section === test.section);
                            const scheduleInfo = sectionInfo ? 
                                `${sectionInfo.time} / ${sectionInfo.day} / ${sectionInfo.room}` : 
                                'Not Set';
                            
                            html += `
                            <tr style="${isEnabled && isOverdue ? 'background-color: #f0f9ff;' : ''}">
                                <td data-label="Test Name">
                                    ${test.testName || 'Unnamed Test'}
                                    ${isEnabled && isOverdue ? `<br><small style="color: #3b82f6; font-weight: 600;">‚úì Enabled for ${enabledCount} student${enabledCount > 1 ? 's' : ''}</small>` : ''}
                                </td>
                                <td data-label="Section">
                                    ${test.section || 'N/A'}<br>
                                    <small style="color: #64748b; font-size: 12px;">${scheduleInfo}</small>
                                </td>
                                <td data-label="Date">${test.date || 'N/A'}</td>
                                <td data-label="Deadline">${test.deadline || 'N/A'} ${test.deadlineTime || ''}</td>
                                <td data-label="Progress" class="progress-cell">${progress}</td>
                                <td data-label="Attempts">${test.attemptsAllowed || '1'}</td>
                                <td data-label="Status">
                                    <span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                                    ${isOverdue ? '<br><small style="color: #ef4444;">‚ö†Ô∏è Overdue</small>' : ''}
                                </td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" onclick="editTest('${docSnap.id}')">Edit</button>
                                        <button class="btn-action btn-view" onclick="manageStudents('${docSnap.id}', '${test.testName}', '${test.section}')">Students</button>
                                        <button class="btn-action btn-cancel" onclick="deleteTest('${docSnap.id}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                         }
                    });
                    
                   if (!hasVisibleTests) {
                    if (window.assignedSections.length > 0) {
                        let sectionsInfo = window.assignedSections.map(s => `${s.section} (${s.students} students)`).join(', ');
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <div class="empty-icon">üìÖ</div>
                                        <div class="empty-title">No Active Test Schedules</div>
                                        <div class="empty-text">
                                            You have been assigned: <strong>${sectionsInfo}</strong><br><br>
                                            All scheduled tests have expired or you haven't created any tests yet.<br>
                                            Click "Schedule New Test" to create a fitness test for your assigned section(s).
                                        </div>
                                    </td>
                            </tr>
                        `;
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <div class="empty-icon">‚ö†Ô∏è</div>
                                        <div class="empty-title">No Sections Assigned</div>
                                        <div class="empty-text">
                                            You have not been assigned to any sections yet.<br><br>
                                            Please contact the Secretary to assign you to a section.
                                        </div>
                                    </td>
                            </tr>
                        `;
                    }
                } else {
                    tableBody.innerHTML = html;  
                }
                    
                    console.log('‚úì Loaded', testsSnapshot.size, 'scheduled tests');
                } else {
                    if (window.assignedSections.length > 0) {
                        let sectionsInfo = window.assignedSections.map(s => `${s.section} (${s.students} students)`).join(', ');
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <div class="empty-icon">üìÖ</div>
                                        <div class="empty-title">No Test Schedules</div>
                                        <div class="empty-text">
                                            You have been assigned: <strong>${sectionsInfo}</strong><br><br>
                                            You haven't scheduled any tests yet.<br>
                                            Click "Schedule New Test" to create a fitness test for your assigned section(s).
                                        </div>
                                    </td>
                            </tr>
                        `;
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <div class="empty-icon">‚ö†Ô∏è</div>
                                        <div class="empty-title">No Sections Assigned</div>
                                        <div class="empty-text">
                                            You have not been assigned to any sections yet.<br><br>
                                            Please contact the Secretary to assign you to a section.
                                        </div>
                                    </td>
                            </tr>
                        `;
                    }
                }
                
                console.log('=== LOAD COMPLETE ===');
                
            } catch (error) {
                console.error('=== ERROR LOADING SCHEDULED TESTS ===');
                console.error('Error:', error);
            }
        }

        function setupRealTimeUpdates(userEmail, userId) {
            try {
                console.log('Setting up real-time updates for:', userEmail);
                
                let testsQuery;

                if (window.assignedSections.length > 0) {
                    const sectionNames = window.assignedSections.map(s => s.section);
                    testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('professorEmail', '==', userEmail),
                        where('section', 'in', sectionNames)
                    );
                } else {
                    testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('professorEmail', '==', userEmail)
                    );
                }
                
                onSnapshot(testsQuery, (snapshot) => {
                    console.log('üîÑ Real-time update triggered');
                    loadScheduledTests(userEmail, userId);
                }, (error) => {
                    console.error('‚ùå Real-time listener error:', error);
                });
                
            } catch (error) {
                console.error('Error setting up real-time updates:', error);
            }
        }

        async function loadTestResults(userEmail, userId) {
            try {
                console.log('Loading test results for:', userEmail);
                
                // Populate filter dropdowns
                const filterSection = document.getElementById('filterSection');
                const filterTest = document.getElementById('filterTest');

                // Clear existing options (keep "All Sections" and "All Tests")
                filterSection.innerHTML = '<option value="">All Sections</option>';
                filterTest.innerHTML = '<option value="">All Tests</option>';

                // Add section options
                if (window.assignedSections && window.assignedSections.length > 0) {
                    const uniqueSections = new Set();
                    window.assignedSections.forEach(section => {
                        if (!uniqueSections.has(section.section)) {
                            uniqueSections.add(section.section);
                            const option = document.createElement('option');
                            option.value = section.section;
                            option.textContent = `${section.section} (${section.students} students)`;
                            filterSection.appendChild(option);
                        }
                    });
                }
                
                let resultsQuery;

                if (window.assignedSections.length > 0) {
                    const sectionNames = window.assignedSections.map(s => s.section);
                    
                    resultsQuery = query(
                        collection(db, 'testResults'),
                        orderBy('submittedAt', 'desc')
                    );
                } else {
                    resultsQuery = query(
                        collection(db, 'testResults'),
                        orderBy('submittedAt', 'desc')
                    );
                }
                
                const resultsSnapshot = await getDocs(resultsQuery);
                
                const tableBody = document.getElementById('resultsTableBody');

                if (!resultsSnapshot.empty) {
                    let html = '';
                    let allResults = [];
                    
                    // Collect all results
                    resultsSnapshot.forEach((docSnap) => {
                        const result = docSnap.data();
                        
                        // Filter by assigned sections
                        if (window.assignedSections.length > 0) {
                            const sectionNames = window.assignedSections.map(s => s.section);
                            if (!sectionNames.includes(result.section)) {
                                return;
                            }
                        }
                        
                        allResults.push({ id: docSnap.id, ...result });
                    });
                    
                    console.log('üìä Total results found:', allResults.length);
                    
                    // Group by STUDENT + TEST and keep BEST score
                    const bestResults = {};
                    
                    allResults.forEach((result) => {
                        // Create unique key for each student+test combination
                        const key = `${result.studentEmail}_${result.testId}`;
                        
                        // Calculate score for this result
                        const score = calculateTestScore(result.testName, result.resultData || result.result, result.testTarget);
                        
                        // If this is the first result for this student+test, or if it's a better score
                        if (!bestResults[key] || score > bestResults[key].score) {
                            bestResults[key] = {
                                ...result,
                                calculatedScore: score
                            };
                            console.log(`‚úÖ Best score for ${result.studentName} - ${result.testName}: ${score}`);
                        }
                    });
                    
                    // Convert to array and sort by date (most recent first)
                    const filteredResults = Object.values(bestResults).sort((a, b) => 
                        new Date(b.submittedAt) - new Date(a.submittedAt)
                    );
                    
                    console.log('üìà Showing best scores for', filteredResults.length, 'student-test combinations');
                    
                    // Display results (limit to 20 most recent)
                    filteredResults.slice(0, 20).forEach((result) => {
                        const score = result.calculatedScore;
                        const rating = getRating(score);
                        
                        // Calculate BMI if available
                        const bmi = result.bmi || 'N/A';
                        
                        // Format date
                        const date = result.submittedAt ? 
                            new Date(result.submittedAt).toLocaleDateString() : 
                            'N/A';
                        
                        // Show attempt info
                        const attemptInfo = result.attemptNumber ? 
                            `Best: Attempt ${result.attemptNumber}/${result.attemptsAllowed}` : 
                            'N/A';
                        
                        html += `
                        <tr>
                            <td data-label="Student">${result.studentName || 'Unknown'}</td>
                            <td data-label="Section">${result.section || 'N/A'}</td>
                            <td data-label="Date">${date}</td>
                            <td data-label="Test">${result.testName || 'N/A'}<br><small class="text-muted">${attemptInfo}</small></td>
                            <td data-label="Score"><strong>${score}</strong></td>
                            <td data-label="BMI">${bmi}</td>
                            <td data-label="Rating"><span class="rating-badge ${rating.class}">${rating.text}</span></td>
                            <td data-label="Actions">
                                <button class="btn-action btn-view" onclick="viewDetails('${result.id}', '${result.testName}', '${result.result}', '${result.studentName}', '${date}', '${score}', '${result.timerValue || 'N/A'}', '${(result.notes || 'No notes').replace(/'/g, "\\'")}', '${attemptInfo}')">View Details</button>
                            </td>
                        </tr>
                    `;
                    });
                    
                    if (filteredResults.length > 0) {
                        tableBody.innerHTML = html;
                        console.log('‚úÖ Displayed', Math.min(filteredResults.length, 20), 'best test results');
                        
                        // Populate test filter with unique test names from results
                        const uniqueTests = new Set();
                        filteredResults.forEach(result => {
                            if (result.testName) {
                                uniqueTests.add(result.testName);
                            }
                        });

                        uniqueTests.forEach(testName => {
                            const option = document.createElement('option');
                            option.value = testName;
                            option.textContent = testName;
                            filterTest.appendChild(option);
                        });
                        
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <div class="empty-icon">üìä</div>
                                        <div class="empty-title">No Test Results Yet</div>
                                        <div class="empty-text">No students have completed tests yet in your assigned sections.</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon">üìä</div>
                                    <div class="empty-title">No Test Results Yet</div>
                                    <div class="empty-text">No students have completed tests yet. Test results will appear here once students start taking and completing their fitness assessments.</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading test results:', error);
                const tableBody = document.getElementById('resultsTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <div class="empty-title">Error Loading Results</div>
                                <div class="empty-text">${error.message}</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function calculateTestScore(testName, result, testTarget = null) {
            const normalized = testName.toLowerCase();
            
            let numericValue = 0;
            
            // Extract numeric value from result
            if (typeof result === 'string') {
                const match = result.match(/(\d+\.?\d*)/);
                if (match) {
                    numericValue = parseFloat(match[1]);
                } else {
                    numericValue = parseFloat(result) || 0;
                }
            } else {
                numericValue = parseFloat(result) || 0;
            }
            
            console.log(`üéØ Scoring: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
            
            // If professor set a target, use target-based scoring
            if (testTarget && testTarget > 0) {
                
                // REPETITION TESTS (push-ups, sit-ups, curl-ups)
                if (normalized.includes('push-up') || normalized.includes('pushup') || 
                    normalized.includes('sit-up') || normalized.includes('situp') ||
                    normalized.includes('curl-up') || normalized.includes('curl up')) {
                    
                    // Perfect score if meets or exceeds target
                    if (numericValue >= testTarget) return 100;
                    
                    const percentage = (numericValue / testTarget) * 100;
                    if (percentage >= 90) return 95;
                    if (percentage >= 80) return 90;
                    if (percentage >= 70) return 85;
                    if (percentage >= 60) return 80;
                    if (percentage >= 50) return 75;
                    if (percentage >= 40) return 70;
                    return Math.max(50, Math.round(percentage));
                }
                
                // PLANK (seconds)
                if (normalized.includes('plank')) {
                    // Convert MM:SS to seconds if needed
                    if (typeof result === 'string' && result.includes(':')) {
                        const [mins, secs] = result.split(':').map(Number);
                        numericValue = (mins * 60) + secs;
                    }
                    
                    if (numericValue >= testTarget) return 100;
                    
                    const percentage = (numericValue / testTarget) * 100;
                    if (percentage >= 90) return 95;
                    if (percentage >= 80) return 90;
                    if (percentage >= 70) return 85;
                    if (percentage >= 60) return 80;
                    if (percentage >= 50) return 75;
                    return Math.max(50, Math.round(percentage));
                }
                
                // GRIP STRENGTH (kg)
                if (normalized.includes('grip')) {
                    if (numericValue >= testTarget) return 100;
                    
                    const percentage = (numericValue / testTarget) * 100;
                    if (percentage >= 90) return 95;
                    if (percentage >= 80) return 90;
                    if (percentage >= 70) return 85;
                    if (percentage >= 60) return 80;
                    if (percentage >= 50) return 75;
                    return Math.max(50, Math.round(percentage));
                }
                
                // SIT-AND-REACH (cm)
                if (normalized.includes('sit-and-reach')) {
                    if (numericValue >= testTarget) return 100;
                    
                    const percentage = (numericValue / testTarget) * 100;
                    if (percentage >= 90) return 95;
                    if (percentage >= 80) return 90;
                    if (percentage >= 70) return 85;
                    if (percentage >= 60) return 80;
                    if (percentage >= 50) return 75;
                    return Math.max(50, Math.round(percentage));
                }
                
                // 1-MILE RUN (seconds - LOWER IS BETTER)
                if (normalized.includes('mile') || normalized.includes('run')) {
            // Convert MM:SS to total seconds if needed
                    if (typeof result === 'string' && result.includes(':')) {
                        const [mins, secs] = result.split(':').map(Number);
                        numericValue = (mins * 60) + secs;
                    }
                    
                    // CRITICAL FIX: Convert testTarget from MINUTES to SECONDS
                    const targetInSeconds = testTarget * 60;
                    
                    // If student time is <= target, perfect score
                    if (numericValue <= targetInSeconds) return 100;
                    
                    const percentage = (targetInSeconds / numericValue) * 100;
                    if (percentage >= 90) return 95;
                    if (percentage >= 80) return 90;
                    if (percentage >= 70) return 85;
                    if (percentage >= 60) return 80;
                    if (percentage >= 50) return 75;
                    return Math.max(50, Math.round(percentage));
                }
                
                // STEP TEST (heart rate - LOWER IS BETTER)
                if (normalized.includes('step test') || normalized.includes('3-minute')) {
                    if (numericValue <= testTarget) return 100;
                    
                    const percentage = (testTarget / numericValue) * 100;
                    if (percentage >= 90) return 95;
                    if (percentage >= 80) return 90;
                    if (percentage >= 70) return 85;
                    if (percentage >= 60) return 80;
                    if (percentage >= 50) return 75;
                    return Math.max(50, Math.round(percentage));
                }
            }
            
            // Fallback to default scoring if no target set
            if (normalized.includes('push-up') || normalized.includes('pushup')) {
                if (numericValue >= 40) return 100;
                if (numericValue >= 30) return 90;
                if (numericValue >= 20) return 80;
                if (numericValue >= 15) return 70;
                if (numericValue >= 10) return 60;
                return 50;
            } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
                if (numericValue >= 50) return 100;
                if (numericValue >= 40) return 90;
                if (numericValue >= 30) return 80;
                if (numericValue >= 20) return 70;
                if (numericValue >= 15) return 60;
                return 50;
            } else if (normalized.includes('plank')) {
                if (numericValue >= 120) return 100;
                if (numericValue >= 90) return 90;
                if (numericValue >= 60) return 80;
                if (numericValue >= 45) return 70;
                if (numericValue >= 30) return 60;
                return 50;
            } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
                if (numericValue <= 80) return 100;
                if (numericValue <= 100) return 90;
                if (numericValue <= 120) return 80;
                if (numericValue <= 140) return 70;
                if (numericValue <= 160) return 60;
                return 50;
            } else if (normalized.includes('mile') || normalized.includes('run')) {
                if (numericValue <= 420) return 100;
                if (numericValue <= 480) return 90;
                if (numericValue <= 540) return 80;
                if (numericValue <= 600) return 70;
                if (numericValue <= 660) return 60;
                return 50;
            } else if (normalized.includes('sit-and-reach')) {
                if (numericValue >= 20) return 100;
                if (numericValue >= 15) return 90;
                if (numericValue >= 10) return 80;
                if (numericValue >= 5) return 70;
                if (numericValue >= 0) return 60;
                return 50;
            } else if (normalized.includes('grip')) {
                if (numericValue >= 60) return 100;
                if (numericValue >= 50) return 90;
                if (numericValue >= 40) return 80;
                if (numericValue >= 30) return 70;
                return 60;
            } else if (normalized.includes('curl-up')) {
                if (numericValue >= 75) return 100;
                if (numericValue >= 50) return 90;
                if (numericValue >= 30) return 80;
                if (numericValue >= 20) return 70;
                return 60;
            }
            
            return 75; // Default fallback
        }

        function setupRealTimeResultUpdates(userEmail, userId) {
            try {
                console.log('Setting up real-time result updates...');
                
                // Use a simpler query without composite index requirements
                const resultsQuery = query(
                    collection(db, 'testResults'),
                    orderBy('submittedAt', 'desc')
                );
                
                onSnapshot(resultsQuery, (snapshot) => {
                    console.log('üîÑ Real-time results update triggered');
                    loadTestResults(userEmail, userId);
                }, (error) => {
                    console.error('‚ùå Real-time results listener error:', error);
                });
                
            } catch (error) {
                console.error('Error setting up real-time results updates:', error);
            }
        }

        function setupTestVisibilityUpdates() {
            try {
                console.log('üîî Setting up test visibility real-time updates...');
                
                // Listen for new tests
                const testsRef = collection(db, 'scheduledTests');
                onSnapshot(testsRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            console.log('üÜï New test added:', change.doc.data().testName);
                            // Refresh the tests list
                            if (window.currentUser) {
                                loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error setting up test visibility updates:', error);
            }
        }

        // Open Manage Students Modal
        window.manageStudents = async function(testId, testName, section) {
            try {
                console.log('üìã Opening student management for test:', testId);
                
                // Store current test ID
                window.currentManagingTestId = testId;
                document.getElementById('currentTestId').value = testId;
                
                // Update header
                document.getElementById('testInfoHeader').textContent = `${testName} - ${section}`;
                        
                        // Reset button state before showing modal
                        const saveBtn = document.querySelector('#manageStudentsModal .btn-success');
                        const cancelBtn = document.querySelector('#manageStudentsModal .btn-secondary');
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Selection';
                        }
                        if (cancelBtn) {
                            cancelBtn.disabled = false;
                        }
                        
                        // Show modal
                        document.getElementById('manageStudentsModal').style.display = 'flex';
                        
                        // Load test data to get currently selected students
                        const testDoc = await getDoc(doc(db, 'scheduledTests', testId));
                        const testData = testDoc.data();
                        
                        // Auto-select all students if none selected yet
                        if (!testData.selectedStudents || testData.selectedStudents.length === 0) {
                            console.log('üîÑ No students selected yet, will auto-select all after loading');
                            window.selectedStudentEmails = new Set();
                            window.autoSelectAll = true; // Flag to auto-select after loading
                        } else {
                            // Initialize selected students from saved data
                            window.selectedStudentEmails = new Set(testData.selectedStudents || []);
                            window.autoSelectAll = false;
                        }
                        
                        // Load students from this section
                        await loadStudentsForTest(section);
                        
                    } catch (error) {
                        console.error('Error opening student management:', error);
                        alert('Error loading students: ' + error.message);
                        
                        // Reset button state on error too
                        const saveBtn = document.querySelector('#manageStudentsModal .btn-success');
                        const cancelBtn = document.querySelector('#manageStudentsModal .btn-secondary');
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Selection';
                        }
                        if (cancelBtn) {
                            cancelBtn.disabled = false;
                        }
                    }
                };

        // Load students for the test's section
        async function loadStudentsForTest(section) {
            const container = document.getElementById('studentsListContainer');
            
            try {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading students...</p>';
                
                // Query students in this section
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('section', '==', section)
                );
                
                const studentsSnapshot = await getDocs(studentsQuery);
                
                if (studentsSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No students found in this section</p>';
                    window.currentTestStudents = [];
                    updateStudentSelectionCount();
                    return;
                }
                
                // Store students
                window.currentTestStudents = [];
                studentsSnapshot.forEach((doc) => {
                    const student = { id: doc.id, ...doc.data() };
                    window.currentTestStudents.push(student);
                });
                
                 // Sort by name
                window.currentTestStudents.sort((a, b) => {
                    const nameA = a.displayName || a.name || a.email;
                    const nameB = b.displayName || b.name || b.email;
                    return nameA.localeCompare(nameB);
                });
                
                // Auto-select all students if flag is set
                if (window.autoSelectAll) {
                    console.log('üîÑ Auto-selecting all students...');
                    window.currentTestStudents.forEach(student => {
                        window.selectedStudentEmails.add(student.email);
                    });
                    console.log(`‚úÖ Auto-selected ${window.selectedStudentEmails.size} students`);
                    window.autoSelectAll = false; // Reset flag
                }
                
                console.log(`‚úÖ Loaded ${window.currentTestStudents.length} students`);
                console.log(`üìä ${window.selectedStudentEmails.size} students currently selected`);
                
                renderStudentListForTest();
                
            } catch (error) {
                console.error('Error loading students:', error);
                container.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Error loading students</p>';
            }
        }

        // Render student list with checkboxes
        function renderStudentListForTest(filterText = '') {
            const container = document.getElementById('studentsListContainer');
            
            // Filter students if search text provided
            let studentsToShow = window.currentTestStudents;
            if (filterText) {
                const searchLower = filterText.toLowerCase();
                studentsToShow = window.currentTestStudents.filter(student => {
                    const name = (student.displayName || student.name || '').toLowerCase();
                    const number = (student.studentNumber || '').toLowerCase();
                    const email = (student.email || '').toLowerCase();
                    return name.includes(searchLower) || number.includes(searchLower) || email.includes(searchLower);
                });
            }
            
            if (studentsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No students found</p>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            studentsToShow.forEach((student) => {
                const displayName = student.displayName || student.name || student.email;
                const studentNumber = student.studentNumber || 'N/A';
                const isChecked = window.selectedStudentEmails.has(student.email);
                
                html += `
                    <label class="student-checkbox-item">
                        <input type="checkbox" 
                               value="${student.email}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleStudentInTest('${student.email}')">
                        <div class="student-info">
                            <div class="student-name">${displayName}</div>
                            <div class="student-details">${studentNumber} ‚Ä¢ ${student.email}</div>
                        </div>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            updateStudentSelectionCount();
        }

        // Toggle individual student selection
        window.toggleStudentInTest = function(studentEmail) {
            if (window.selectedStudentEmails.has(studentEmail)) {
                window.selectedStudentEmails.delete(studentEmail);
            } else {
                window.selectedStudentEmails.add(studentEmail);
            }
            updateStudentSelectionCount();
        };

        // Select all students
        window.selectAllStudentsInModal = function() {
            window.currentTestStudents.forEach(student => {
                window.selectedStudentEmails.add(student.email);
            });
            renderStudentListForTest();
        };

        // Deselect all students
        window.deselectAllStudentsInModal = function() {
            window.selectedStudentEmails.clear();
            renderStudentListForTest();
        };

        // Update selection count display
        function updateStudentSelectionCount() {
            document.getElementById('selectedCount').textContent = window.selectedStudentEmails.size;
            document.getElementById('totalCount').textContent = window.currentTestStudents.length;
        }

        // Filter student list based on search
        window.filterStudentList = function() {
            const searchBox = document.getElementById('studentSearchBox');
            const filterText = searchBox.value;
            renderStudentListForTest(filterText);
        };

        // Save student selection
        window.saveStudentSelection = async function() {
            const testId = document.getElementById('currentTestId').value;
            
            if (window.selectedStudentEmails.size === 0) {
                if (!confirm('No students selected. This means no one will be able to take this test. Continue?')) {
                    return;
                }
            }
            
            const saveBtn = document.querySelector('#manageStudentsModal .btn-success');
            const cancelBtn = document.querySelector('#manageStudentsModal .btn-secondary');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Disable buttons
                saveBtn.disabled = true;
                cancelBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                // Convert Set to Array
                const selectedStudentsArray = Array.from(window.selectedStudentEmails);
                
                // Update test document
                await updateDoc(doc(db, 'scheduledTests', testId), {
                    selectedStudents: selectedStudentsArray,
                    totalStudents: selectedStudentsArray.length,
                    updatedAt: serverTimestamp()
                });
                
                console.log('‚úÖ Updated test with', selectedStudentsArray.length, 'selected students');
                
                // Create/update notifications for selected students
                const testDoc = await getDoc(doc(db, 'scheduledTests', testId));
                const testData = testDoc.data();
                
                // Delete old notifications for this test
                const oldNotificationsQuery = query(
                    collection(db, 'notifications'),
                    where('testId', '==', testId)
                );
                const oldNotifications = await getDocs(oldNotificationsQuery);
                const deletePromises = [];
                oldNotifications.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // Create new notifications for selected students
                const notificationPromises = [];
                for (const studentEmail of selectedStudentsArray) {
                    const student = window.currentTestStudents.find(s => s.email === studentEmail);
                    if (student) {
                        const notificationData = {
                            type: 'new_test',
                            title: 'Fitness Test Available',
                            message: `${testData.testName} has been assigned to you. Deadline: ${testData.deadline} at ${testData.deadlineTime}`,
                            section: testData.section,
                            testName: testData.testName,
                            testId: testId,
                            testDate: testData.date,
                            deadline: testData.deadline,
                            deadlineTime: testData.deadlineTime,
                            studentEmail: studentEmail,
                            studentId: student.id,
                            isRead: false,
                            createdAt: serverTimestamp(),
                            timestamp: new Date().toISOString()
                        };
                        notificationPromises.push(
                            addDoc(collection(db, 'notifications'), notificationData)
                        );
                    }
                }
                
                await Promise.all(notificationPromises);
                console.log(`‚úÖ Created ${notificationPromises.length} notifications`);
                
                // Reset button state BEFORE closing modal
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                
                // Close modal
                closeManageStudentsModal();
                
                // Show success message
                alert(`‚úÖ Successfully assigned test to ${selectedStudentsArray.length} student(s)!`);
                
                // Reload the schedule
                await loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                
            } catch (error) {
                console.error('‚ùå Error saving student selection:', error);
                alert('Error saving: ' + error.message);
                
                // Reset button state on error
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        };

        // Close modal
        window.closeManageStudentsModal = function() {
            const modal = document.getElementById('manageStudentsModal');
            modal.style.display = 'none';
            
            // Reset button state when closing
            const saveBtn = document.querySelector('#manageStudentsModal .btn-success');
            const cancelBtn = document.querySelector('#manageStudentsModal .btn-secondary');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Selection';
            }
            if (cancelBtn) {
                cancelBtn.disabled = false;
            }
            
            // Clear search and selections
            document.getElementById('studentSearchBox').value = '';
            window.selectedStudentEmails.clear();
            window.currentTestStudents = [];
            window.currentManagingTestId = null;
        };

        // Show schedule test modal
        window.showScheduleTestModal = function() {
            console.log('Opening schedule modal...');
            
            const modal = document.getElementById('scheduleTestModal');
            const sectionSelect = document.getElementById('testSection');
            
            // Clear previous options
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            
            if (window.assignedSections && window.assignedSections.length > 0) {
                const uniqueSections = [];
                const seenSections = new Set();
                
                window.assignedSections.forEach(section => {
                    if (!seenSections.has(section.section)) {
                        seenSections.add(section.section);
                        uniqueSections.push(section);
                    }
                });
                
                uniqueSections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.section;
                    option.textContent = `${section.section} (${section.students} students) - ${section.time || 'TBA'} / ${section.day || 'TBA'} / ${section.room || 'TBA'}`;
                    sectionSelect.appendChild(option);
                });
                
                console.log('‚úì Added', uniqueSections.length, 'unique sections to dropdown');
            } else {
                const option = document.createElement('option');
                option.value = "no-sections";
                option.textContent = "No sections assigned - Contact Head Admin";
                option.disabled = true;
                sectionSelect.appendChild(option);
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('testDate').value = today;
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('testDeadline').value = nextWeek.toISOString().split('T')[0];
            document.getElementById('testDeadlineTime').value = '23:59';
            document.getElementById('testTime').value = '00:00';
            const testTypeSelect = document.getElementById('testType');
            testTypeSelect.removeEventListener('change', handleTestTypeChange);
            testTypeSelect.addEventListener('change', handleTestTypeChange);
            
            const submitBtn = document.querySelector('#scheduleTestModal .btn-success');
            const cancelBtn = document.querySelector('#scheduleTestModal .btn-secondary');
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Schedule Test';
            }
            if (cancelBtn) {
                cancelBtn.disabled = false;
            }
            modal.style.display = 'flex';
        };

        function handleTestTypeChange(event) {
            const testType = event.target.value;
            const targetGroup = document.getElementById('testTargetGroup');
            const targetLabel = document.getElementById('testTargetLabel');
            const targetInput = document.getElementById('testTarget');
            const targetHint = document.getElementById('testTargetHint');
            
            if (!testType) {
                targetGroup.style.display = 'none';
                return;
            }
            
            const normalizedType = testType.toLowerCase();
            
            // 3-Minute Step Test (Fixed Duration)
            if (normalizedType.includes('3-minute') || normalizedType.includes('step test')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Duration (minutes)';
                targetInput.placeholder = 'Duration is fixed at 3 minutes';
                targetInput.value = '3';
                targetInput.readOnly = true;
                targetHint.textContent = 'This test has a fixed duration of 3 minutes';
            }
            // Curl-Up Test
            else if (normalizedType.includes('curl-up')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Curl-Ups';
                targetInput.placeholder = 'Enter target number of curl-ups';
                targetInput.value = '25';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target number of abdominal curls (one every 3 seconds)';
            }
            // Push-Up Test
            else if (normalizedType.includes('push-up') || normalizedType.includes('pushup')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Push-ups';
                targetInput.placeholder = 'Enter target number of push-ups';
                targetInput.value = '20';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target number of push-ups students should aim to complete';
            }
            // Sit-and-Reach
            else if (normalizedType.includes('sit-and-reach')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Distance (cm)';
                targetInput.placeholder = 'Enter target distance in cm';
                targetInput.value = '15';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target reach distance in centimeters';
            }
            // Skinfold Caliper
            else if (normalizedType.includes('skinfold')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Body Fat %';
                targetInput.placeholder = 'Enter target body fat percentage';
                targetInput.value = '15';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target body fat percentage (requires trained professional)';
            }
            else {
                targetGroup.style.display = 'none';
            }
        }

        // Schedule test function - FIXED VERSION
        window.scheduleTest = async function() {
            const testType = document.getElementById('testType').value;
            const testSection = document.getElementById('testSection').value;
            const testDate = document.getElementById('testDate').value;
            const testTime = document.getElementById('testTime').value;
            const testDeadline = document.getElementById('testDeadline').value;
            const testDeadlineTime = document.getElementById('testDeadlineTime').value;
            const attemptsAllowed = document.getElementById('attemptsAllowed').value;
            const testInstructions = document.getElementById('testInstructions').value;
            const testTarget = document.getElementById('testTarget').value;
            const videoURL = document.getElementById('videoURL').value;

            if (!testType || !testSection || !testDate || !testTime || !testDeadline || !testDeadlineTime) {
                alert('Please fill in all required fields.');
                return;
            }

            const testDateTime = new Date(`${testDate}T${testTime}`);
            const now = new Date();
            
            if (testDateTime < now) {
                alert('‚ùå Error: Test date and time cannot be in the past.\n\nPlease select a future date and time.');
                return;
            }

            const deadlineDateTime = new Date(`${testDeadline}T${testDeadlineTime}`);
            
            if (deadlineDateTime <= testDateTime) {
                alert('‚ùå Error: Deadline must be after the test date and time.');
                return;
            }

            if (testSection === "no-sections") {
                alert('You need to be assigned to a section before scheduling tests.');
                return;
            }

            if (videoURL && !videoURL.includes('youtube.com') && !videoURL.includes('youtu.be')) {
                alert('Please provide a valid YouTube URL or leave it empty');
                return;
            }

            const submitBtn = document.querySelector('#scheduleTestModal .btn-success');
            const cancelBtn = document.querySelector('#scheduleTestModal .btn-secondary');
            const originalText = submitBtn.textContent;

            try {
                submitBtn.disabled = true;
                cancelBtn.disabled = true;
                submitBtn.textContent = 'Scheduling...';

                // Get section information including schedule
                const sectionInfo = window.assignedSections.find(s => s.section === testSection);
                
                // Get all student emails from the selected section
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('section', '==', testSection)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                const allStudentEmails = [];
                studentsSnapshot.forEach((doc) => {
                    const studentData = doc.data();
                    if (studentData.email) {
                        allStudentEmails.push(studentData.email);
                    }
                });
                
                console.log(`‚úÖ Found ${allStudentEmails.length} students in section ${testSection}`);
                console.log(`üìÖ Section schedule: ${sectionInfo?.time || 'N/A'} / ${sectionInfo?.day || 'N/A'} / ${sectionInfo?.room || 'N/A'}`);

                // Calculate status BEFORE creating testData object
                let status = 'scheduled';
                if (testDateTime <= now && deadlineDateTime >= now) {
                    status = 'active';
                } else if (deadlineDateTime < now) {
                    status = 'completed';
                }

                // Create testData object with ALL students auto-selected and SECTION SCHEDULE INFO
                const testData = {
                    testName: testType,
                    section: testSection,
                    date: testDate,
                    time: testTime,
                    dateTime: testDateTime.toISOString(),
                    deadline: testDeadline,
                    deadlineTime: testDeadlineTime,
                    deadlineDateTime: deadlineDateTime.toISOString(),
                    attemptsAllowed: parseInt(attemptsAllowed),
                    instructions: testInstructions,
                    testTarget: testTarget ? parseInt(testTarget) : null,
                    videoURL: videoURL || null,
                    professorEmail: window.currentUser.email,
                    professorId: window.currentUser.uid,
                    professorName: window.currentUser.displayName || window.currentUser.email,
                    status: status,
                    totalStudents: allStudentEmails.length,
                    completedStudents: 0,
                    selectedStudents: allStudentEmails, // AUTO-SELECT ALL STUDENTS
                    // ADD SECTION SCHEDULE INFORMATION
                    sectionTime: sectionInfo?.time || 'Not Set',
                    sectionDay: sectionInfo?.day || 'Not Set',
                    sectionRoom: sectionInfo?.room || 'Not Set',
                    courseCode: sectionInfo?.courseCode || 'PE 3',
                    createdAt: serverTimestamp(),
                    isVisible: true,
                    isActive: true,
                    visibleToStudents: true
                };

                console.log('üìù Scheduling test:', testData);
                
                const docRef = await addDoc(collection(db, 'scheduledTests'), testData);
                console.log('‚úÖ Test added with ID:', docRef.id);
                
                // Create notifications for ALL students automatically
                const notificationPromises = [];
                for (const studentEmail of allStudentEmails) {
                    const student = studentsSnapshot.docs.find(doc => doc.data().email === studentEmail);
                    if (student) {
                        const studentData = student.data();
                        const notificationData = {
                            type: 'new_test',
                            title: 'Fitness Test Available',
                            message: `${testType} has been assigned to you. Deadline: ${testDeadline} at ${testDeadlineTime}`,
                            section: testSection,
                            testName: testType,
                            testId: docRef.id,
                            testDate: testDate,
                            deadline: testDeadline,
                            deadlineTime: testDeadlineTime,
                            studentEmail: studentEmail,
                            studentId: student.id,
                            isRead: false,
                            createdAt: serverTimestamp(),
                            timestamp: new Date().toISOString()
                        };
                        notificationPromises.push(
                            addDoc(collection(db, 'notifications'), notificationData)
                        );
                    }
                }
                
                await Promise.all(notificationPromises);
                console.log(`‚úÖ Created ${notificationPromises.length} notifications for students`);
                
                closeScheduleTestModal();
                alert(`‚úÖ Test scheduled successfully!\n\nAutomatically assigned to ${allStudentEmails.length} student(s) in ${testSection}.\n\nSchedule: ${sectionInfo?.time || 'TBA'} / ${sectionInfo?.day || 'TBA'} / ${sectionInfo?.room || 'TBA'}`);
                
                await loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                
            } catch (error) {
                console.error('‚ùå Error scheduling test:', error);
                alert('Error scheduling test: ' + error.message);
                
                submitBtn.disabled = false;
                cancelBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        };

        // Delete test function
        async function deleteTest(testId) {
            if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'scheduledTests', testId));
                    alert('Test deleted successfully!');
                    await loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                } catch (error) {
                    console.error('‚ùå Error deleting test:', error);
                    alert('Error deleting test: ' + error.message);
                }
            }
        }

        // Edit test function
        window.editTest = async function(testId) {
            try {
                console.log('üîß Opening edit modal for test:', testId);

                const scheduleModal = document.getElementById('scheduleTestModal');
                if (scheduleModal) {
                    scheduleModal.style.display = 'none';
                }
                
                const modal = document.getElementById('editTestModal');
                if (!modal) {
                    console.error('Edit modal not found!');
                    alert('Error: Modal not found. Please refresh the page.');
                    return;
                }
                
                modal.style.display = 'flex';
                
                const testDoc = await getDoc(doc(db, 'scheduledTests', testId));
                
                if (!testDoc.exists()) {
                    alert('Test not found');
                    return;
                }
                
                const testData = testDoc.data();
                console.log('üìã Test data:', testData);
                
                document.getElementById('editTestName').value = testData.testName || '';
                document.getElementById('editTestSection').value = testData.section || '';
                document.getElementById('editTestDate').value = testData.date || '';
                document.getElementById('editTestTime').value = testData.time || '00:00';
                document.getElementById('editTestDeadline').value = testData.deadline || '';
                document.getElementById('editTestDeadlineTime').value = testData.deadlineTime || '23:59';
                document.getElementById('editAttemptsAllowed').value = `${testData.attemptsAllowed || 1} Attempt(s)`;
                document.getElementById('editTestId').value = testId;
                
                const targetGroup = document.getElementById('editTestTargetGroup');
                const targetLabel = document.getElementById('editTestTargetLabel');
                const targetInput = document.getElementById('editTestTarget');
                const targetHint = document.getElementById('editTestTargetHint');
                
                const normalized = testData.testName.toLowerCase();
                
                if (normalized.includes('push-up') || normalized.includes('pushup')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Push-ups';
                    targetInput.value = testData.testTarget || 20;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target number of push-ups';
                } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Sit-ups';
                    targetInput.value = testData.testTarget || 30;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target number of sit-ups';
                } else if (normalized.includes('curl-up')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Curl-Ups';
                    targetInput.value = testData.testTarget || 25;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target number of curl-ups';
                } else if (normalized.includes('plank')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Duration (seconds)';
                    targetInput.value = testData.testTarget || 60;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target plank duration in seconds';
                } else if (normalized.includes('grip')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Grip Strength (kg)';
                    targetInput.value = testData.testTarget || 40;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target grip strength in kg';
                } else if (normalized.includes('sit-and-reach')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Distance (cm)';
                    targetInput.value = testData.testTarget || 15;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target reach distance in cm';
                } else if (normalized.includes('mile') || normalized.includes('run')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Time (minutes)';
                    targetInput.value = testData.testTarget || 8;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target completion time in minutes';
                } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Duration (minutes)';
                    targetInput.value = testData.testTarget || 3;
                    targetInput.readOnly = true;
                    targetHint.textContent = 'Fixed duration of 3 minutes';
                } else if (normalized.includes('skinfold')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Body Fat %';
                    targetInput.value = testData.testTarget || 15;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target body fat percentage';
                } else {
                    targetGroup.style.display = 'none';
                }
                
                // Enable buttons
                const saveBtn = document.querySelector('#editTestModal .btn-success');
                const cancelBtn = document.querySelector('#editTestModal .btn-secondary');
                
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                }
                
                console.log('‚úÖ Edit modal opened successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading test:', error);
                alert('Error loading test data: ' + error.message);
            }
        };

        window.closeEditTestModal = function() {
            document.getElementById('editTestModal').style.display = 'none';
        };

        window.saveEditTest = async function() {
            const testId = document.getElementById('editTestId').value;
            const newDate = document.getElementById('editTestDate').value;
            const newTime = document.getElementById('editTestTime').value;
            const newDeadline = document.getElementById('editTestDeadline').value;
            const newDeadlineTime = document.getElementById('editTestDeadlineTime').value;
            const newTarget = document.getElementById('editTestTarget').value;
            
            if (!newDate || !newTime || !newDeadline || !newDeadlineTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate test date + time is not in the past
            const testDateTime = new Date(`${newDate}T${newTime}`);
            const now = new Date();
            
            if (testDateTime < now) {
                alert('‚ùå Error: Test date and time cannot be in the past.\n\nPlease select a future date and time.');
                return;
            }
            
            // Validate deadline is after test date + time
            const deadlineDateTime = new Date(`${newDeadline}T${newDeadlineTime}`);
            
            if (deadlineDateTime <= testDateTime) {
                alert('‚ùå Error: Deadline must be after the test date and time.');
                return;
            }
                
                const saveBtn = document.querySelector('#editTestModal .btn-success');
                const cancelBtn = document.querySelector('#editTestModal .btn-secondary');
                const originalText = saveBtn.textContent;
                
                try {
                    saveBtn.disabled = true;
                    cancelBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                    
                    const updateData = {
                    date: newDate,
                    time: newTime,
                    dateTime: testDateTime.toISOString(),
                    deadline: newDeadline,
                    deadlineTime: newDeadlineTime,
                    deadlineDateTime: deadlineDateTime.toISOString(),
                    testTarget: newTarget ? parseInt(newTarget) : null,
                    updatedAt: serverTimestamp()
                };
                    
                    if (testDateTime <= now && deadlineDateTime >= now) {
                    updateData.status = 'active';
                } else if (deadlineDateTime < now) {
                    updateData.status = 'completed';
                } else {
                    updateData.status = 'scheduled';
                }
                    
                    await updateDoc(doc(db, 'scheduledTests', testId), updateData);
                    
                    closeEditTestModal();
                    alert('‚úÖ Test updated successfully!');
                    await loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                    
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert('Error updating test: ' + error.message);
                    saveBtn.disabled = false;
                    cancelBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            };

        // Export functions to window
        window.loadScheduledTests = loadScheduledTests;
        window.loadTestResults = loadTestResults;
        window.deleteTest = deleteTest;
    </script>

    <script>
        // Filter functions
        function filterScheduleTable() {
            const input = document.getElementById('searchSchedule');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('scheduleTable');
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td');
                let showRow = false;
                
                // Check each column for matches
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            showRow = true;
                            break;
                        }
                    }
                }
                
                tr[i].style.display = showRow ? '' : 'none';
            }
        }
        
        function filterResultsTable() {
            const searchInput = document.getElementById('searchResults');
            const sectionFilter = document.getElementById('filterSection');
            const testFilter = document.getElementById('filterTest');
            
            const searchValue = searchInput.value.toUpperCase();
            const sectionValue = sectionFilter.value.toUpperCase();
            const testValue = testFilter.value.toUpperCase();
            
            const table = document.getElementById('resultsTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td');
                
                // Skip if it's the empty state row
                if (td.length === 1) {
                    continue;
                }
                
                let showRow = true;
                
                // Search filter (student name - column 0)
                if (searchValue) {
                    const studentName = td[0] ? (td[0].textContent || td[0].innerText).toUpperCase() : '';
                    if (studentName.indexOf(searchValue) === -1) {
                        showRow = false;
                    }
                }
                
                // Section filter (column 1)
                if (showRow && sectionValue) {
                    const section = td[1] ? (td[1].textContent || td[1].innerText).toUpperCase() : '';
                    if (section.indexOf(sectionValue) === -1) {
                        showRow = false;
                    }
                }
                
                // Test filter (column 3)
                if (showRow && testValue) {
                    const test = td[3] ? (td[3].textContent || td[3].innerText).toUpperCase().split('\n')[0] : '';
                    if (test.indexOf(testValue) === -1) {
                        showRow = false;
                    }
                }
                
                tr[i].style.display = showRow ? '' : 'none';
            }
            
            // Count visible rows
            let visibleCount = 0;
            for (let i = 1; i < tr.length; i++) {
                if (tr[i].style.display !== 'none' && tr[i].getElementsByTagName('td').length > 1) {
                    visibleCount++;
                }
            }
            
            // Show "no results" message if nothing visible
            if (visibleCount === 0 && (searchValue || sectionValue || testValue)) {
                const tableBody = document.getElementById('resultsTableBody');
                const emptyRow = tableBody.querySelector('tr[data-filter-empty]');
                
                if (!emptyRow) {
                    const newEmptyRow = document.createElement('tr');
                    newEmptyRow.setAttribute('data-filter-empty', 'true');
                    newEmptyRow.innerHTML = `
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">üîç</div>
                                <div class="empty-title">No Results Found</div>
                                <div class="empty-text">Try adjusting your filters or search criteria.</div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(newEmptyRow);
                }
            } else {
                // Remove filter empty message if exists
                const emptyRow = document.querySelector('tr[data-filter-empty]');
                if (emptyRow) {
                    emptyRow.remove();
                }
            }
        }
        
        function clearResultFilters() {
            document.getElementById('searchResults').value = '';
            document.getElementById('filterSection').value = '';
            document.getElementById('filterTest').value = '';
            filterResultsTable();
        }
        
        // Close schedule test modal
        window.closeScheduleTestModal = function() {
            document.getElementById('scheduleTestModal').style.display = 'none';
            
            // Clear form
            document.getElementById('testType').value = '';
            document.getElementById('testSection').value = '';
            document.getElementById('testDate').value = '';
            document.getElementById('testDeadline').value = '';
            document.getElementById('testDeadlineTime').value = '23:59';
            document.getElementById('attemptsAllowed').value = '1';
            document.getElementById('testInstructions').value = '';
            document.getElementById('testTarget').value = '';
            document.getElementById('videoURL').value = '';
            document.getElementById('testTime').value = '00:00';
            
            document.getElementById('testTargetGroup').style.display = 'none';
            
            if (window.currentUser) {
                loadScheduledTests(window.currentUser.email, window.currentUser.uid);
            }
        };
        
        // View details function
        function viewDetails(resultId, testName, result, studentName, date, score, timerValue, notes, attemptInfo) {
            // Create a modal to show detailed results
            const modalHtml = `
                <div class="modal-overlay" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Test Result Details</h3>
                            <button class="close-modal" onclick="closeResultModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <strong>Student:</strong> ${studentName}
                                </div>
                                <div>
                                    <strong>Test:</strong> ${testName}
                                </div>
                                <div>
                                    <strong>Date:</strong> ${date}
                                </div>
                                <div>
                                    <strong>Score:</strong> ${score}/100
                                </div>
                                <div>
                                    <strong>Result:</strong> ${result}
                                </div>
                                <div>
                                    <strong>Timer:</strong> ${timerValue}
                                </div>
                            </div>
                            <div>
                                <strong>Attempt:</strong> ${attemptInfo}
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>Notes:</strong><br>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 5px;">
                                    ${notes || 'No notes provided'}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors" onclick="closeResultModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeResultModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        // Generate reports function
        function generateReports() {
            alert('Report generation feature coming soon!');
        }
        
        // Cancel test function (placeholder)
        function cancelTest(testId) {
            if (confirm('Are you sure you want to cancel this test?')) {
                alert(`Test ${testId} cancellation will be implemented by head admin.\n\nThis will:\n- Mark the test as cancelled\n- Notify students\n- Update the schedule`);
            }
        }
    </script>
</body>
</html>